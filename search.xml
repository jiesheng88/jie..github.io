<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>【Java-项目】功能1——分页查询显示</title>
      <link href="/2021/06/30/java-xiang-mu-gong-neng-1-fen-ye-cha-xun-xian-shi/"/>
      <url>/2021/06/30/java-xiang-mu-gong-neng-1-fen-ye-cha-xun-xian-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="1-分页查询"><a href="#1-分页查询" class="headerlink" title="1 分页查询"></a>1 分页查询</h2><h3 id="1-1-配置pageHelper依赖"><a href="#1-1-配置pageHelper依赖" class="headerlink" title="1.1 配置pageHelper依赖"></a>1.1 配置pageHelper依赖</h3><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 分页插件依赖 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>pagehelper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${pagehelper-version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h3 id="1-2-创建接收数据的公共类"><a href="#1-2-创建接收数据的公共类" class="headerlink" title="1.2 创建接收数据的公共类"></a>1.2 创建接收数据的公共类</h3><p>EasyUI 中只接受两个数据：</p><ul><li>当前页面要显示的数据——<font color='red'><strong>用List&lt;?&gt; 来接收，注意泛型是？</strong></font></li><li>总的数据个数——long类型</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EasyUIDataGrid</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 当前显示页的数据</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> rows<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 总的数据个数</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> total<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p><strong>注意：</strong></p><p>为什么是List&lt;?&gt;，而不是List&lt; Object&gt;</p><p><font color='red'><strong>一句话：因为数据的类型是不固定的，无法确定泛型；而List&lt; Object&gt;只能装Object类型的数据</strong></font></p><ol><li><p><strong>List&lt; String&gt;和List&lt; Object&gt;不是父子关系</strong></p><ul><li>在Java中，虽然任何java对象都是Object的子类，但是List&lt; Object&gt;使用的是泛型。<font color='red'><strong>泛型是不可变。即对于任何2个不同类型的type1和type2，List&lt; Type1&gt;即不是List&lt; Type2&gt;的子类型，也不是List&lt; Type2&gt;的超类型。</strong></font>因此，String和Object是父子关系，但是<font color='red'><strong>List&lt; String&gt;和List&lt; Object&gt;之间没有继承关系。</strong></font></li></ul></li><li><p><strong>List&lt;?&gt;是什么？</strong></p><ul><li>因为List&lt; String&gt;和List&lt; Object&gt;之间没有继承关系，<font color='red'>但是考虑到代码的通用性，我们又希望有一种类型，可以“兼容”List&lt; String&gt;和List&lt; Object&gt;。所以泛型里提供了“?”统配符</font>。</li><li>统配符的用法:<ul><li>“?”表示无上下界</li><li>“? extends classA”表示以classA为上界,即以classA为父类</li><li>“? super classA”表示以classA为下界,即以classA为子类</li></ul></li></ul></li><li><p><strong>List&lt;?&gt;和List&lt; Object&gt;有什么区别？</strong></p><ul><li><font color='red'><strong>List&lt; Object&gt;接受泛型是Object的List对象，List&lt;?&gt;接受泛型是任意类型的List对象。</strong></font></li></ul></li></ol><h3 id="1-3-Dubbo服务方实现分页"><a href="#1-3-Dubbo服务方实现分页" class="headerlink" title="1.3 Dubbo服务方实现分页"></a>1.3 Dubbo服务方实现分页</h3><p>因为分页功能是对数据库操作，所以实现在Dubbo服务方。</p><ol><li>在ego-service中创建接口</li></ol><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TbItemDubboService</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 商品分页查询     * @param pageNum    页码     * @param pageSize    每页显示数量     * @return     */</span>    EasyUIDataGrid <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ol start="2"><li>在ego-service-impl中编写分页功能<ol><li><font color='red'>先设置分页条件</font>：<code>PageHelper.startPage(pageNum, pageSize);</code></li><li><font color='red'>根据条件查询数据库，得到数据列表list</font>：<code>List&lt;TbItem&gt; list = tbItemMapper.selectByExample(new TbItemExample());</code></li><li><font color='red'>利用PageInfo来封装上一步查询到的数据列表list</font>：<code>PageInfo&lt;TbItem&gt; pi = new PageInfo&lt;&gt;(list);</code></li></ol></li></ol><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TbItemDubboServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TbItemDubboService</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> TbItemMapper tbItemMapper<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> EasyUIDataGrid <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1.必须先设置分页查询条件</span>        PageHelper<span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2.查询全部数据</span>        List<span class="token operator">&lt;</span>TbItem<span class="token operator">></span> list <span class="token operator">=</span> tbItemMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TbItemExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3.开始分页</span>        <span class="token comment" spellcheck="true">/* 利用PageInfo来获取rows和total，PageInfo必须传入查询的全部数据list         * PageInfo的生成参数中包含了总记录数total和每页显示数据的结果集list         * */</span>        PageInfo<span class="token operator">&lt;</span>TbItem<span class="token operator">></span> pi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 4.放入到EasyUIDataGrid实体类，并返回</span>        EasyUIDataGrid easyUIDataGrid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EasyUIDataGrid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        easyUIDataGrid<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        easyUIDataGrid<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>pi<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> easyUIDataGrid<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-pageHelper分页查询原理"><a href="#2-pageHelper分页查询原理" class="headerlink" title="2 pageHelper分页查询原理"></a>2 pageHelper分页查询原理</h2><h3 id="2-1-分页条件和得到数据list"><a href="#2-1-分页条件和得到数据list" class="headerlink" title="2.1 分页条件和得到数据list"></a>2.1 分页条件和得到数据list</h3><ol><li><code>PageHelper.startPage(pageNum, pageSize);</code></li></ol><p>将所有信息封装在一个Page对象page里面，并返回</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 开始分页     *     * @param pageNum  页码     * @param pageSize 每页显示数量     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>E<span class="token operator">></span> Page<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token function">startPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 开始分页     *     * @param pageNum  页码     * @param pageSize 每页显示数量     * @param count    是否进行count查询     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>E<span class="token operator">></span> Page<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token function">startPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">boolean</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> count<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 开始分页     *     * @param pageNum    页码     * @param pageSize   每页显示数量     * @param count      是否进行count查询     * @param reasonable 分页合理化,null时用默认配置     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>E<span class="token operator">></span> Page<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token function">startPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">boolean</span> count<span class="token punctuation">,</span> Boolean reasonable<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> count<span class="token punctuation">,</span> reasonable<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 开始分页，将所有信息封装在一个Page对象page里面，并返回     *         * @param pageNum      页码     * @param pageSize     每页显示数量     * @param count        是否进行count查询     * @param reasonable   分页合理化,null时用默认配置     * @param pageSizeZero true且pageSize=0时返回全部结果，false时分页,null时用默认配置     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>E<span class="token operator">></span> Page<span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token function">startPage</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">boolean</span> count<span class="token punctuation">,</span> Boolean reasonable<span class="token punctuation">,</span> Boolean pageSizeZero<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建一个Page对象page，将所有信息封装在里面</span>        Page<span class="token operator">&lt;</span>E<span class="token operator">></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>        page<span class="token punctuation">.</span><span class="token function">setReasonable</span><span class="token punctuation">(</span>reasonable<span class="token punctuation">)</span><span class="token punctuation">;</span>        page<span class="token punctuation">.</span><span class="token function">setPageSizeZero</span><span class="token punctuation">(</span>pageSizeZero<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//当已经执行过orderBy的时候</span>        Page<span class="token operator">&lt;</span>E<span class="token operator">></span> oldPage <span class="token operator">=</span> SqlUtil<span class="token punctuation">.</span><span class="token function">getLocalPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPage <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> oldPage<span class="token punctuation">.</span><span class="token function">isOrderByOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            page<span class="token punctuation">.</span><span class="token function">setOrderBy</span><span class="token punctuation">(</span>oldPage<span class="token punctuation">.</span><span class="token function">getOrderBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        SqlUtil<span class="token punctuation">.</span><span class="token function">setLocalPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> page<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>上面的方法才是真正分页调用的地方，原来是对传入参数封装到Page这个类，继续，发现getLocalPage和setLoaclPage这两个方法，很可疑，跟进，看看他到底做了啥，</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 获取Page参数     *     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Page<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">getLocalPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> LOCAL_PAGE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setLocalPage</span><span class="token punctuation">(</span>Page page<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOCAL_PAGE<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal<span class="token operator">&lt;</span>Page<span class="token operator">></span> LOCAL_PAGE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>Page<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这里就是<font color='red'><strong>将封装后的Page类对象page保存到本地线程变量里面</strong></font>。</p><p>ThreadLocal类有4个方法：set(设置当前线程的线程局部变量的值)、get、remove、initialValue。ThreadLocal能够为每一个线程维护变量的副本，使每个线程独立开来，参数互不影响，确保线程之间的独立性。</p><p>详细资料可以参考：<a href="https://blog.csdn.net/u013521220/article/details/73604917" target="_blank" rel="noopener">彻底理解ThreadLocal</a></p><p>所以，ThreadLocal类就是保存了当前分页线程的page对象参数。有赋值就有取值，那么在下面的分页过程中，肯定在哪边取到了这个threadLocal的page参数。</p><ol start="2"><li><strong>执行SQL语句</strong></li></ol><ul><li>先是进入mybatis的MapperPoxy这个代理类，最后执行的execute方法</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> ExceptionUtil<span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">final</span> MapperMethod mapperMethod <span class="token operator">=</span> <span class="token function">cachedMapperMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> mapperMethod<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> Object <span class="token function">execute</span><span class="token punctuation">(</span>SqlSession sqlSession<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>  Object result<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>SqlCommandType<span class="token punctuation">.</span>INSERT <span class="token operator">==</span> command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SqlCommandType<span class="token punctuation">.</span>UPDATE <span class="token operator">==</span> command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SqlCommandType<span class="token punctuation">.</span>DELETE <span class="token operator">==</span> command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SqlCommandType<span class="token punctuation">.</span>SELECT <span class="token operator">==</span> command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">hasResultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">executeWithResultHandler</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token function">executeForMany</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token function">executeForMap</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token function">executeForCursor</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      Object param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>      result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SqlCommandType<span class="token punctuation">.</span>FLUSH <span class="token operator">==</span> command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">flushStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Unknown execution method for: "</span> <span class="token operator">+</span> command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">"Mapper method '"</span> <span class="token operator">+</span> command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token operator">+</span> <span class="token string">" attempted to return null from a method with a primitive return type ("</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>然后进入MapperMethod这个类的execute方法，由于执行的是select操作，并且查询出多条，所以就到了executeForMany这个方法中，后面继续跟进代码SqlSessionTemplate,DefaultSqlSession，最后可以看到代码进入了Plugin这个类的invoke方法中</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    Set<span class="token operator">&lt;</span>Method<span class="token operator">></span> methods <span class="token operator">=</span> signatureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> methods<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Invocation</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> ExceptionUtil<span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><font color='red'><strong>interceptor是mybatis的拦截器，而PageHelper这个类就实现了interceptor接口，调用其中的intercept方法。</strong></font></p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * Mybatis拦截器方法，这一步嵌套为了在出现异常时也可以清空Threadlocal     *     * @param invocation 拦截器入参     * @return 返回执行结果     * @throws Throwable 抛出异常     */</span>    <span class="token keyword">public</span> Object <span class="token function">processPage</span><span class="token punctuation">(</span>Invocation invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Object result <span class="token operator">=</span> <span class="token function">_processPage</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> result<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">clearLocalPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * Mybatis拦截器方法     *     * @param invocation 拦截器入参     * @return 返回执行结果     * @throws Throwable 抛出异常     */</span>    <span class="token keyword">private</span> Object <span class="token function">_processPage</span><span class="token punctuation">(</span>Invocation invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token keyword">final</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Page page <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//支持方法参数时，会先尝试获取Page</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportMethodsArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>            page <span class="token operator">=</span> <span class="token function">getPage</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//分页信息</span>        RowBounds rowBounds <span class="token operator">=</span> <span class="token punctuation">(</span>RowBounds<span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//支持方法参数时，如果page == null就说明没有分页条件，不需要分页查询</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>supportMethodsArguments <span class="token operator">&amp;&amp;</span> page <span class="token operator">==</span> null<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//当不支持分页参数时，判断LocalPage和RowBounds判断是否需要分页</span>                <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportMethodsArguments <span class="token operator">&amp;&amp;</span> SqlUtil<span class="token punctuation">.</span><span class="token function">getLocalPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> rowBounds <span class="token operator">==</span> RowBounds<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//不支持分页参数时，page==null，这里需要获取</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportMethodsArguments <span class="token operator">&amp;&amp;</span> page <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                page <span class="token operator">=</span> <span class="token function">getPage</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token function">doProcessPage</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> page<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><ul><li>获取ThreadLocal中的page对象</li></ul><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 获取分页参数     *     * @param args     * @return 返回Page对象     */</span>    <span class="token keyword">public</span> Page <span class="token function">getPage</span><span class="token punctuation">(</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取ThreadLocal中的page对象</span>        Page page <span class="token operator">=</span> <span class="token function">getLocalPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">==</span> null <span class="token operator">||</span> page<span class="token punctuation">.</span><span class="token function">isOrderByOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Page oldPage <span class="token operator">=</span> page<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//这种情况下,page.isOrderByOnly()必然为true，所以不用写到条件中</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> null <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> RowBounds<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> page <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> oldPage<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">RowBounds</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> RowBounds<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span> <span class="token punctuation">{</span>                RowBounds rowBounds <span class="token operator">=</span> <span class="token punctuation">(</span>RowBounds<span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetAsPageNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span>rowBounds<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rowBoundsWithCount<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>rowBounds<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rowBounds<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rowBoundsWithCount<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//offsetAsPageNum=false的时候，由于PageNum问题，不能使用reasonable，这里会强制为false</span>                    page<span class="token punctuation">.</span><span class="token function">setReasonable</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    page <span class="token operator">=</span> <span class="token function">getPageFromObject</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPage <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                page<span class="token punctuation">.</span><span class="token function">setOrderBy</span><span class="token punctuation">(</span>oldPage<span class="token punctuation">.</span><span class="token function">getOrderBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">setLocalPage</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//分页合理化</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getReasonable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            page<span class="token punctuation">.</span><span class="token function">setReasonable</span><span class="token punctuation">(</span>reasonable<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//当设置为true的时候，如果pagesize设置为0（或RowBounds的limit=0），就不执行分页，返回全部结果</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getPageSizeZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            page<span class="token punctuation">.</span><span class="token function">setPageSizeZero</span><span class="token punctuation">(</span>pageSizeZero<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> page<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><ul><li>跟进代码，发现进入了doProcessPage方法，通过反射机制，<font color='red'>首先查询出数据总数量</font>，然后进行分页SQL的拼装，MappedStatement的getBoundSql</li><li>继续，跟进代码，发现，最终分页的查询，调到了PageStaticSqlSource类的getPageBoundSql中</li><li>进入getPageSql这个方法，发现，进入了OracleParser类中（还有很多其他的Parser，适用于不同的数据库）</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">getPageSql</span><span class="token punctuation">(</span>String sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>    StringBuilder sqlBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sqlBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"select * from ( select tmp_page.*, rownum row_id from ( "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sqlBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>    sqlBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" ) tmp_page where rownum &lt;= ? ) where row_id > ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> sqlBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>终于，原来分页的SQL是在这里拼装起来的。</p><p><strong>总结：</strong></p><ul><li>PageHelper首先将前端传递的参数保存到page这个对象中</li><li>接着将page的副本存放入ThreadLoacl中，这样可以保证分页的时候，参数互不影响</li><li>接着<font color='red'>利用了mybatis提供的拦截器，取得ThreadLocal的值，重新拼装分页SQL，完成分页</font>。</li></ul><p>详细资料可以参考：<a href="https://blog.csdn.net/qq_21996541/article/details/79796117" target="_blank" rel="noopener">浅析pagehelper分页原理</a></p><h3 id="2-2-PageInfo封装数据list"><a href="#2-2-PageInfo封装数据list" class="headerlink" title="2.2 PageInfo封装数据list"></a>2.2 PageInfo封装数据list</h3><p>PageInfo类中保存的属性，有以下这些：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PageInfo</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//当前页</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> pageNum<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//每页的数量</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//当前页的数量</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//排序</span>    <span class="token keyword">private</span> String orderBy<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//由于startRow和endRow不常用，这里说个具体的用法</span>    <span class="token comment" spellcheck="true">//可以在页面中"显示startRow到endRow 共size条数据"</span>    <span class="token comment" spellcheck="true">//当前页面第一个元素在数据库中的行号</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> startRow<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//当前页面最后一个元素在数据库中的行号</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> endRow<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//总记录数</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> total<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//总页数</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> pages<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//结果集</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//第一页</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> firstPage<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//前一页</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> prePage<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//下一页</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> nextPage<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//最后一页</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> lastPage<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//是否为第一页</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isFirstPage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//是否为最后一页</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isLastPage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//是否有前一页</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> hasPreviousPage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//是否有下一页</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> hasNextPage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//导航页码数</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> navigatePages<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//所有导航页号</span>    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> navigatepageNums<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>PageInfo类封装数据list</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**     * 包装Page对象     *     * @param list     */</span>    <span class="token keyword">public</span> <span class="token function">PageInfo</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 包装Page对象     *     * @param list          page结果     * @param navigatePages 页码数量     */</span>    <span class="token keyword">public</span> <span class="token function">PageInfo</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> navigatePages<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token keyword">instanceof</span> <span class="token class-name">Page</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// list转成page对象</span>            Page page <span class="token operator">=</span> <span class="token punctuation">(</span>Page<span class="token punctuation">)</span> list<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pageNum <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>orderBy <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getOrderBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pages <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> page<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//由于结果是>startRow的，所以实际的需要+1</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>startRow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>endRow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>startRow <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getStartRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//计算实际的endRow（最后一页的时候特殊）</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>endRow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startRow <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pages <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>startRow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>endRow <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>navigatePages <span class="token operator">=</span> navigatePages<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//计算导航页</span>            <span class="token function">calcNavigatepageNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//计算前后页，第一页，最后一页</span>            <span class="token function">calcPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//判断页面边界</span>            <span class="token function">judgePageBoudary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><p>查询出的PageInfo类中数据，如下所示：</p><pre class=" language-json"><code class="language-json"><span class="token property">"total"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token property">"list"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>        <span class="token property">"userId"</span><span class="token operator">:</span> <span class="token string">"2510109292"</span><span class="token punctuation">,</span>        <span class="token property">"userName"</span><span class="token operator">:</span> <span class="token string">"何老师"</span><span class="token punctuation">,</span>        <span class="token property">"userAge"</span><span class="token operator">:</span> <span class="token number">43</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>        <span class="token property">"userId"</span><span class="token operator">:</span> <span class="token string">"25930291056"</span><span class="token punctuation">,</span>        <span class="token property">"userName"</span><span class="token operator">:</span> <span class="token string">"李老师"</span><span class="token punctuation">,</span>        <span class="token property">"userAge"</span><span class="token operator">:</span> <span class="token number">37</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"pageNum"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"pageSize"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"startRow"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"endRow"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token property">"pages"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"prePage"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"nextPage"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"isFirstPage"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">"isLastPage"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">"hasPreviousPage"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">"hasNextPage"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token property">"navigatePages"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span><span class="token property">"navigatepageNums"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"navigateFirstPage"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"navigateLastPage"</span><span class="token operator">:</span> <span class="token number">5</span></code></pre><h2 id="3-pageHelper踩过的坑"><a href="#3-pageHelper踩过的坑" class="headerlink" title="3 pageHelper踩过的坑"></a>3 pageHelper踩过的坑</h2><h3 id="3-1-PageHelper-startPage-pageNum-pageSize）的位置"><a href="#3-1-PageHelper-startPage-pageNum-pageSize）的位置" class="headerlink" title="3.1 PageHelper.startPage(pageNum, pageSize）的位置"></a>3.1 PageHelper.startPage(pageNum, pageSize）的位置</h3><p><font color='red'><strong>PageHelper.startPage(pageNum, pageSize) 只对该语句以后的第一个查询语句得到的数据进行分页！！！</strong></font></p><p>譬如：下面这段代码本来想根据 userName 以及 userCompany 进行条件查询的，但是 startPage() 后面紧跟的不是 userMapper.getUserList(userName, userCompany)，因此，分页“并不会生效”，或者说分页用错地方了，用在 userMapper.getById(id) 上了，自然看不到想要的效果。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 设置分页查询条件</span>PageHelper<span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 根据id查询</span><span class="token keyword">int</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 根据 userName 和 userCompany 进行条件查询</span>List<span class="token operator">&lt;</span>User<span class="token operator">></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getUserList</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> userCompany<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span class="token keyword">return</span> xxx<span class="token punctuation">;</span></code></pre><h3 id="3-2-没有把分页查询的结果（原有的-List）返回，而是返回了一个重新赋值后的-List"><a href="#3-2-没有把分页查询的结果（原有的-List）返回，而是返回了一个重新赋值后的-List" class="headerlink" title="3.2 没有把分页查询的结果（原有的 List）返回，而是返回了一个重新赋值后的 List"></a>3.2 没有把分页查询的结果（原有的 List）返回，而是返回了一个重新赋值后的 List</h3><p>遇到的场景是：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 设置分页查询条件</span>PageHelper<span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 根据 userName 和 userCompany 进行条件查询</span>List<span class="token operator">&lt;</span>User<span class="token operator">></span> userList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getUserList</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> userCompany<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 但是我并不是要返回下面这样的：</span><span class="token comment" spellcheck="true">//PageInfo&lt;User> pageInfo2 = new PageInfo&lt;>(userList);</span><span class="token comment" spellcheck="true">//return pageInfo2;</span><span class="token comment" spellcheck="true">// 而是需要对 User 对象的某些属性重新进行赋值，并返回其进一步封装之后的对象，例如 UserDto（不是 User）</span>List<span class="token operator">&lt;</span>UserDto<span class="token operator">></span> userDtoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">foreach</span><span class="token punctuation">(</span>User user <span class="token operator">:</span> userList<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 对user的属性重新赋值，并构造新的对象 UserDto</span>    <span class="token comment" spellcheck="true">// ....</span>    user<span class="token punctuation">.</span><span class="token function">setXxx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    UserDto userDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDto</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>    userDtoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userDto<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>PageInfo<span class="token operator">&lt;</span>UserDto<span class="token operator">></span> pageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>userDtoList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> pageInfo<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这样得到的分页相关属性是不对的。</span></code></pre><p><strong>解决方法：</strong></p><p>1、方法一：新建pageInfo </p><p>虽然 pageInfo 的分页相关属性不正确，但是<font color='red'>前面 List 对应的 pageInfo2 的分页相关属性是正确的，所以可以让最终返回的 pageInfo 的属性也重新进行赋值</font>。</p><pre class=" language-java"><code class="language-java">PageInfo<span class="token operator">&lt;</span>PatientDto<span class="token operator">></span> pageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>userDtoList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 重新对 PageInfo 的分页属性进行赋值</span>pageInfo<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setStartRow</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getStartRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setEndRow</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getEndRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setPages</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setPrePage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getPrePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setNextPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getNextPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setIsFirstPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">isIsFirstPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setIsLastPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">isIsLastPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setHasPreviousPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">isHasPreviousPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setHasNextPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">isHasNextPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setNavigatePages</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getNavigatePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setNavigatepageNums</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getNavigatepageNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setNavigateFirstPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getNavigateFirstPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pageInfo<span class="token punctuation">.</span><span class="token function">setNavigateLastPage</span><span class="token punctuation">(</span>pageInfo2<span class="token punctuation">.</span><span class="token function">getNavigateLastPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>2、方法二：新建数据list</p><p><font color='red'><strong>重用PageInfo对象</strong></font>，直接对分页后的PageInfo对象中的list集合进行操作</p><ul><li><font color='red'>先取出PageInfo里的list集合数据</font></li><li><font color='red'>再对数据进行相关操作</font></li><li><font color='red'>将操作完后的list集合再次存到PageInfo里，进行return</font></li></ul><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> list<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setList</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> PageInfo<span class="token operator">&lt;</span>HdQueryVo<span class="token operator">></span> <span class="token function">getRecordsByView</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNo<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>        PageInfo<span class="token operator">&lt;</span>HdQueryVo<span class="token operator">></span> source <span class="token operator">=</span> PageHelper<span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doSelectPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            actionMapper<span class="token punctuation">.</span><span class="token function">getActionByView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 需要转换的对象</span>        PageInfo<span class="token operator">&lt;</span>HdQueryVo<span class="token operator">></span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 复制分页属性</span>        BeanUtils<span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 对查询的list进行下一步操作，比如类型转换后</span>        List<span class="token operator">&lt;</span>HdQueryVo<span class="token operator">></span> collect <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>HdQueryVo<span class="token operator">></span> hdQueryVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>HdQueryVo hdQueryVo <span class="token operator">:</span> collect<span class="token punctuation">)</span> <span class="token punctuation">{</span>            HdQueryVo hdQueryVoSingle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HdQueryVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdId</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdType</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdTitle</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdStartDate</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdStartDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdEndDate</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdEndDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdStatus</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdImage</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdNumber</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setGmtCreate</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getGmtCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setGmtModified</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getGmtModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdJoinUsers</span><span class="token punctuation">(</span>onlineWorksMapper<span class="token punctuation">.</span><span class="token function">getOnlineJoinUsers</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                hdQueryVoSingle<span class="token punctuation">.</span><span class="token function">setHdJoinUsers</span><span class="token punctuation">(</span>offlineUsersMapper<span class="token punctuation">.</span><span class="token function">getOfflineJoinUsers</span><span class="token punctuation">(</span>hdQueryVo<span class="token punctuation">.</span><span class="token function">getHdId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            hdQueryVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hdQueryVoSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 加工后的数据放入新的pageinfo</span>        target<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>hdQueryVos<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> target<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h2 id="4-分页查询扩展"><a href="#4-分页查询扩展" class="headerlink" title="4 分页查询扩展"></a>4 分页查询扩展</h2><h3 id="4-1-百万级及以上数据量下的分页查询"><a href="#4-1-百万级及以上数据量下的分页查询" class="headerlink" title="4.1 百万级及以上数据量下的分页查询"></a>4.1 百万级及以上数据量下的分页查询</h3><p>使用PageHelper实现分页功能在数据量较少的情况下还好。但如果数据库扩增PageHelper就会出现明显的性能问题。几十万甚至上百万的单表数据查询性能缓慢，需要几秒乃至十几秒的查询时间。<font color='red'>主要原因是pageHelper在拼接Limit之前，需要进行依次全表查询，统计全表的数据个数</font></p><ol><li><p><strong>业务上的优化</strong></p><ul><li>限制用户分页，不允许进行过大的分页。比如说百度的分页，它最多只能跳转到一定页数，用户再往下翻页也只显示最后一页。</li><li>禁用count(*)，不去查询总条数，不计算总页数，不设计跳页的功能</li></ul></li></ol><ol start="2"><li><strong>SQL层面优化方式</strong></li></ol><p>首先分析SQL语句，limit在数据量少或者页数比较靠前的时候查询效率是比较高的。(单表数据量百万进行测试)</p><p>select * from user where age = 10 limit 1,10;结果显示0.43s</p><p><strong>当where条件后的结果集较大并且页数达到一个量级整个SQL的查询效率就十分低下(哪怕where的条件加上了索引也不行)</strong>。</p><p>select * from user where age = 10 limit 100000,10;结果显示4.73s</p><p>那有什么解决方案呢？mysql就不能单表数据量超百万乃至千万嘛？答案是NO，显然是可以的。</p><p>SELECT a.* FROM USER a<br>INNER JOIN<br>    <strong>(SELECT id FROM USER WHERE age = 10 LIMIT 100000,10) b</strong><br>ON a.id = b.id;</p><p>结果0.53s</p><blockquote><p>我们可以使用  <code>SELECT id FROM USER WHERE age = 10 LIMIT 100000,10</code> 充当子查询，这样就只在索引中查询id，而不用回表查；然后根据子查询得出来的id集合再去查对应的select * 数据即可;</p></blockquote><p>完美解决了查询效率问题！！！<font color='red'><strong>其中需要对where条件增加索引</strong></font>，id因为是主键自带索引。select返回减少回表可以提升查询性能，所以<font color='red'><strong>采用查询主键字段后进行关联大幅度提升了查询效率</strong></font>。</p><p>所以，<font color='red'><strong>只能是SQL优化入手，自己书写分页器</strong></font>，PageHelper想要优化需要在拦截器的拼接SQL部分进行重构。</p><hr><p>参考资料：</p><ol><li><a href="https://blog.csdn.net/demon_2018/article/details/89815079" target="_blank" rel="noopener">PageHelper分页插件的一些坑</a></li><li><a href="https://jishuin.proginn.com/p/763bfbd59b68" target="_blank" rel="noopener">PageHelper分页后，对list操作会导致分页无效的原因分析</a></li><li><a href="https://blog.csdn.net/baidu_38083619/article/details/82463058" target="_blank" rel="noopener">浅谈PageHelper插件分页实现原理及大数据量下SQL查询效率问题解决</a></li><li><a href="https://juejin.im/post/5f0de4d06fb9a07e8a19a641" target="_blank" rel="noopener">上亿数据怎么玩深度分页？兼容MySQL + ES + MongoDB</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> 项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 项目 </tag>
            
            <tag> 分页查询 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】Java比较器Comparable和Comparator</title>
      <link href="/2021/06/25/mian-shi-java-java-bi-jiao-qi-comparable-he-comparator/"/>
      <url>/2021/06/25/mian-shi-java-java-bi-jiao-qi-comparable-he-comparator/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Comparable-接口"><a href="#1-Comparable-接口" class="headerlink" title="1 Comparable 接口"></a>1 <strong>Comparable</strong> 接口</h2><p><font color='red'>Comparable接口是排序接口</font>，只能是<font color='red'>类来实现Comparable接口</font>。既然实现Comparable接口的类支持排序，那么“ <font color='red'>实现了Comparable接口的类的对象的List列表（或数组）</font>”，可以通过Collections.sort(或Arrays.sort)进行排序。</p><p><font color='red'>“实现Comparable接口的类的对象”可以用作“有序映射(如TreeMap)”中的键或“有序集合(TreeSet)”中的元素</font>，而不需要指定比较器。</p><blockquote><p>Comparable接口定义</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>T o<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>compareTo() 方法用于两种方式的比较：<ul><li>字符串与对象进行比较</li><li><font color='red'>按字典顺序比较两个字符串</font></li><li>如果想进行两个数字之间的比较，<font color='red'>必须是两个包装类之间的比较</font>。<font color='blue'>可以是一个 Byte, Double, Integer, Float, Long 或 Short 类型的参数。</font></li></ul></li></ul><blockquote><p>示例代码</p></blockquote><ol><li><strong>Person类定义</strong></li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Person类实现Comparable接口，使该类具有排序的功能 * @author jie * @date 2021-07-06 10:44 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span>Person<span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 实现 “Comparable&lt;String>” 的接口，即重写compareTo&lt;T t>函数。     * 这里是通过“person的名字”进行比较的     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>注意：</p><ul><li>实现的Comparable接口的<font color='red'>泛型必须是待排序的类</font></li><li>compareTo()传入的参数是<font color='red'>待排序类的对象</font></li><li>compareTo() <font color='red'>不能直接对int类型的age进行排序</font>，如果想使用compareTo()进行排序，必须<font color='red'>将int类型的age转成Integer类型的age</font></li></ul><ol start="2"><li><strong>在main()中，我们创建了Person的List数组(list)</strong></li></ol><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>Person<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 添加对象到ArrayList中</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"AAA"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ol start="3"><li><strong>打印list里的全部元素</strong></li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 打印list的原始序列</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Original sort, list:%s\n"</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**运行结果：Original sort, list:[Person{age=20, name='ccc'}, Person{age=30, name='AAA'}, Person{age=10, name='bbb'}, Person{age=40, name='ddd'}] */</span></code></pre><ol start="4"><li><strong>通过Collections的sort()函数，对list进行排序</strong></li></ol><p>正如前面所说，<font color='red'>实现了Comparable接口的类的对象的List列表（或数组）</font>”，可以通过Collections.sort(或Arrays.sort)进行排序。</p><p>由于Person实现了Comparable接口，因此通过sort()排序时，会根据Person支持的排序方式，即 <font color='red'>compareTo(Person person) 所定义的规则进行排序</font>。如下：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 对list进行排序</span><span class="token comment" spellcheck="true">// 这里会根据“Person实现的Comparable&lt;String>接口”进行排序，即会根据“name”进行排序</span>Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name sort, list:%s\n"</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**运行结果：Name sort, list:[Person{age=30, name='AAA'}, Person{age=10, name='bbb'}, Person{age=20, name='ccc'}, Person{age=40, name='ddd'}] */</span></code></pre><h2 id="2-Comparator-接口"><a href="#2-Comparator-接口" class="headerlink" title="2 Comparator 接口"></a>2 Comparator 接口</h2><p><font color='red'>Comparator 是比较器接口</font>。</p><p>我们若需要控制某个类的次序，而该类本身不支持排序(即没有实现Comparable接口)；那么，我们可以建立一个“该类的比较器”来进行排序。这个“比较器”只需要实现Comparator接口即可。</p><p>也就是说，我们可以通过“<strong>实现Comparator类来新建一个比较器</strong>”，然后通过该比较器对类进行排序。</p><blockquote><p>Comparator接口定义</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparator</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>T o1<span class="token punctuation">,</span> T o2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p>示例代码</p></blockquote><ol><li><strong>Person类定义</strong></li></ol><p>① 实现Comparable接口</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 实现Comparable接口，使该类具有排序的功能 * @author jie * @date 2021-07-06 14:49 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonComparable</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span>PersonComparable<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    String name<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 实现 “Comparable&lt;String>” 的接口，即重写compareTo&lt;T t>函数。     * 这里是通过“personComparable的name属性”进行比较的     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>PersonComparable personComparable<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>personComparable<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></code></pre><p>② 未实现Comparable接口</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span>Person<span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ol start="2"><li><strong>在main()中，创建Person的List数组(list)</strong></li></ol><p>① 实现了Comparable接口</p><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>PersonComparable<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 添加对象到ArrayList中</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonComparable</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonComparable</span><span class="token punctuation">(</span><span class="token string">"AAA"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonComparable</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonComparable</span><span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>② 未实现Comparable接口</p><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>Person<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 添加对象到ArrayList中</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"AAA"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"ddd"</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ol start="3"><li><strong>利用Comparator比较器对列表进行排序</strong></li></ol><blockquote><p>Collections.sort()定义</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 使用lambda表达式实现Comparator接口，即自定义排序规则</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">,</span> Comparator<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>    list<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>Comparator接口里的<code>int compare(T o1, T o2)</code></p><ul><li><p>当比较的两个参数是对象时，需要对象实现Comparable接口</p></li><li><p>当比较的两个参数是字符串时，需要使用<code>compareTo()</code>来比较</p></li><li><p>当比较的两个参数是数值时，直接使用<code>减号 -</code>来比较</p></li></ul><blockquote><p>比较的两个参数是对象</p></blockquote><p>① 实现了Comparable接口</p><pre class=" language-java"><code class="language-java">Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这里o1, o2表示的是list列表里单个元素表示的对象，即PersonComparable类的对象</span>    <span class="token keyword">return</span> o1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"排序后："</span><span class="token operator">+</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**运行结果：排序后：[PersonComparable{age=30, name='AAA'}, PersonComparable{age=10, name='bbb'}, PersonComparable{age=20, name='ccc'}, PersonComparable{age=40, name='ddd'}] */</span></code></pre><p>等价于 Collections.sort(list)，正好对应了前面所说的。</p><p>② 未实现Comparable接口</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210706150400.png" alt=""></p><p>程序直接报错，编译都过不了。</p><p><strong>总结：</strong></p><ul><li>实现了Comparable接口的类，可以通过Comparator比较器来进行排序，排序的规则是类中重写的compareTo()方法中自定义的（这里是按照name排序）</li><li><font color='red'>未实现Comparable接口的类，无法通过Comparator比较器来进行排序</font>。</li></ul><blockquote><p>比较的两个参数是字符串或包装类</p></blockquote><p>① 未实现Comparable接口</p><pre class=" language-java"><code class="language-java">Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 根据name排序，这里o1, o2表示的是list列表里单个元素表示的对象</span>    <span class="token keyword">return</span> o1<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name排序后："</span> <span class="token operator">+</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**运行结果：name排序后：[Person{age=30, name='AAA'}, Person{age=10, name='bbb'}, Person{age=20, name='ccc'}, Person{age=40, name='ddd'}] */</span></code></pre><p>② 实现Comparable接口</p><p>和未实现Comparable接口的结果一样，能按照name正常排序。</p><blockquote><p>比较的两个参数是数值</p></blockquote><p>① 未实现Comparable接口</p><pre class=" language-java"><code class="language-java">Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 根据age排序</span>    <span class="token keyword">return</span> o1<span class="token punctuation">.</span>age <span class="token operator">-</span> o2<span class="token punctuation">.</span>age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"age排序后："</span> <span class="token operator">+</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**运行结果：age排序后：[Person{age=10, name='bbb'}, Person{age=20, name='ccc'}, Person{age=30, name='AAA'}, Person{age=40, name='ddd'}] */</span></code></pre><p>② 实现Comparable接口</p><pre class=" language-java"><code class="language-java">Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">return</span> o1<span class="token punctuation">.</span>age <span class="token operator">-</span> o2<span class="token punctuation">.</span>age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"排序后："</span><span class="token operator">+</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**运行结果：排序后：[PersonComparable{age=10, name='bbb'}, PersonComparable{age=20, name='ccc'}, PersonComparable{age=30, name='AAA'}, PersonComparable{age=40, name='ddd'}] */</span></code></pre><p>会覆盖Comparable接口中compareTo()方法中自定义的排序规则， 和未实现Comparable接口的结果一样，能按照age正常排序。</p><blockquote><p>数组Arrays工具类同理</p></blockquote><pre class=" language-java"><code class="language-java">Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>persons<span class="token punctuation">,</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 根据name排序，这里o1, o2表示的是list列表里单个元素表示的对象</span>    <span class="token keyword">return</span> o1<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>persons<span class="token punctuation">,</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 根据age排序</span>    <span class="token keyword">return</span> o1<span class="token punctuation">.</span>age <span class="token operator">-</span> o2<span class="token punctuation">.</span>age<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h2><p>Comparable是排序接口；若一个类实现了Comparable接口，就意味着“该类支持排序”。<br>而Comparator是比较器；<font color='red'>我们若需要控制某个类的次序，可以建立一个“该类的比较器”来进行排序</font>。</p><p>我们不难发现：Comparable相当于“内部比较器”，而Comparator相当于“外部比较器”。</p><ul><li>Comparable接口，只是为了将类可以按照自定义的排序规则排序，<font color='red'>在重写的compareTo()方法中，字符串类型的参数可以直接比较，而数值类型的必须使用对应的包装类进行比较</font>。</li><li>“ <font color='red'>实现了Comparable接口的类的对象的List列表（或数组）</font>”，可以通过Collections.sort(或Arrays.sort)进行排序。相当于是Comparator接口中重写的compare()方法，比较的是两个对象。</li><li>Comparator接口中重写的compare()方法，<font color='red'>当比较的两个参数是字符串或包装类时，需要使用<code>compareTo()</code>来比较</font></li><li>Comparator接口中重写的compare()方法，<font color='red'>当比较的两个参数是数值时，直接使用<code>减号 -</code>来比较</font></li></ul><hr><p>参考资料：</p><ol><li><a href="https://www.cnblogs.com/skywang12345/p/3324788.html" target="_blank" rel="noopener">Java 中 Comparable 和 Comparator 比较</a></li></ol><hr>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 面试 </tag>
            
            <tag> Comparable和Comparator总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】JDK动态代理和CGLIB动态代理</title>
      <link href="/2021/06/20/mian-shi-java-jdk-dong-tai-dai-li-he-cglib-dong-tai-dai-li/"/>
      <url>/2021/06/20/mian-shi-java-jdk-dong-tai-dai-li-he-cglib-dong-tai-dai-li/</url>
      
        <content type="html"><![CDATA[<h2 id="1-代理模式"><a href="#1-代理模式" class="headerlink" title="1 代理模式"></a>1 代理模式</h2><p>代理模式是Java的常用设计模式。它的要素有如下要求：</p><ul><li><font color='red'><strong>公共接口：代理类和委托类（被代理类）要有相同的接口</strong></font>；</li><li><font color='red'><strong>代理类增强服务：代理类主要负责为委托类（被代理类）预处理消息、过滤消息、把消息转发给委托类（被代理类），以及事后处理消息等</strong></font>；</li><li><strong><font color='red'>两个对象关联</font></strong>：代理类与委托类（被代理类）之间通常存在关联关系，<strong><font color='red'>一个代理类的对象与一个委托类（被代理类）的对象相关联</font></strong>，<font color='blue'>代理类的对象本身并不真正实现服务，而是通过调用委托类（被代理类）的对象的相关方法，来提供特定的服务</font>。</li></ul><p>简单来说就是，<font color='red'>我们在访问实际对象时，是通过代理对象来访问的，代理模式就是在访问实际对象时引入一定程度的间接性，因为这种间接性，可以附加多种用途</font>。</p><p>可以举个不恰当的生活中例子，加以理解。原告张三因为家暴想向法院申请离婚，为了提高胜率，原告张三找了个代理律师全权负责，律师在原告张三陈述的事实基础上，还添加了法律条文及离婚后财产分配等内容。</p><p>针对上面的例子，其中：</p><ul><li>委托类（被代理类）：原告张三</li><li>代理类：张三的律师</li><li>他俩的公共接口：可以认为是想打赢这个官司</li><li>委托类的方法：离婚</li><li>代理类增强的服务：法律条文及离婚后财产分配等内容</li></ul><h2 id="2-静态代理"><a href="#2-静态代理" class="headerlink" title="2 静态代理"></a>2 静态代理</h2><h3 id="2-1-静态代理介绍"><a href="#2-1-静态代理介绍" class="headerlink" title="2.1 静态代理介绍"></a>2.1 静态代理介绍</h3><p>静态代理：有程序员创建或特定工具自动生成源码，也就是<font color='red'><strong>在编译时就已经将接口、被代理类、代理类等确定下来了</strong></font>。在程序运行之前，代理类的.class文件就已经生成。</p><h3 id="2-2-静态代理简单实现"><a href="#2-2-静态代理简单实现" class="headerlink" title="2.2 静态代理简单实现"></a>2.2 静态代理简单实现</h3><p>写一个简单的静态代理的例子：假如一个班的同学要向老师交班费，但是都是通过班长把自己的钱转交给老师。这里，班长代理学生上交班费，班长就是学生的代理。</p><ol><li><strong>创建公共接口具体行为</strong></li></ol><p>首先，我们创建一个Person公共接口。这个接口就是学生（被代理类），和班长（代理类）的公共接口，他们都有上交班费的行为。这样，学生上交班费就可以让班长来代理执行。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 创建Person公共接口 */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//上交班费</span>    <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ol start="2"><li><strong>被代理类对象实现接口，完成具体的业务逻辑</strong></li></ol><p>被代理类——Student类实现Person接口。Student可以具体实施上交班费的动作：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 被代理类实现公共接口 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Student</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"上交班费50元"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ol start="3"><li><strong>代理类实现公共接口，完成委托类预处理消息、过滤消息、把消息转发给委托类，以及事后处理消息等。</strong></li></ol><p>StudentsProxy类，<font color='red'><strong>这个类也实现了Person公共接口，同时还持有一个学生类对象</strong></font>。由于实现了Peson接口，同时持有一个学生对象，那么他可以代理学生类对象执行上交班费（执行giveMoney()方法）行为。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 代理类实现Person公共接口，同时保存一个被代理类的对象——学生，这样就可以通过代理类产生学生行为 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentsProxy</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//被代理类的对象——学生</span>    Student stu<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通过构造器传入具体的代理类对象</span>    <span class="token keyword">public</span> <span class="token function">StudentsProxy</span><span class="token punctuation">(</span>Person stu<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 只代理学生对象</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>stu<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Student<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>stu <span class="token operator">=</span> <span class="token punctuation">(</span>Student<span class="token punctuation">)</span>stu<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//代理上交班费，调用被代理学生的上交班费行为</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 可以附加多种用途</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"张三最近学习有进步！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stu<span class="token punctuation">.</span><span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ol start="4"><li><strong>客户端使用操作与分析</strong></li></ol><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticProxyTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//被代理类（学生张三），他的班费上交由代理对象monitor（班长）完成</span>        Person zhangsan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//生成代理对象，并将被代理对象（张三）传给代理对象</span>        Person monitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StudentsProxy</span><span class="token punctuation">(</span>zhangsan<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//班长代理上交班费</span>        monitor<span class="token punctuation">.</span><span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>代理模式最重要的要素：</p><ul><li><strong><font color='red'>一个公共接口（Person）</font></strong></li><li><strong><font color='red'>一个实现了公共接口的被代理类（Student）</font></strong></li><li><strong><font color='red'>一个实现了公共接口的代理类（StudentProxy）</font></strong></li><li><strong><font color='red'>代理类持有的被代理类的对象，代为执行被代理类的实例方法</font></strong>。</li></ul><p>只需要在代理类中帮张三上交班费之前，执行其他操作就可以了。这种操作，也是使用代理模式的一个很大的优点。</p><p><strong><font color='red'>最直白的就是在Spring中的面向切面编程（AOP），我们能在一个切点之前执行一些操作，在一个切点之后执行一些操作，这个切点就是一个个方法</font></strong>。这些方法所在类肯定就是被代理了，在代理过程中切入了一些其他操作。其实也是切面思想的主要思路。</p><h2 id="3-动态代理"><a href="#3-动态代理" class="headerlink" title="3 动态代理"></a>3 动态代理</h2><h3 id="3-1-动态代理介绍"><a href="#3-1-动态代理介绍" class="headerlink" title="3.1 动态代理介绍"></a>3.1 动态代理介绍</h3><p><strong><font color='red'>代理类在程序运行时创建的代理方式被称为动态代理。</font></strong></p><p>上面的静态代理例子中，代理类（StudentProxy）是自己定义好的，在程序运行之前就已经编译完成的。</p><p>然而对于动态代理来说，代理类并不是Java代码中定义的，而是在运行时根据我们在Java代码中的“指示”动态生成。<font color='red'><strong>相比于静态代理，动态代理的优势在于可以很方便的对代理类的所有方法进行统一的处理，而不用修改代理类中的每个方法。</strong></font></p><h3 id="3-2-JDK动态代理实现"><a href="#3-2-JDK动态代理实现" class="headerlink" title="3.2 JDK动态代理实现"></a>3.2 JDK动态代理实现</h3><p>在Java的<font color='red'><strong>java.lang.reflect包下提供了一个Proxy类和一个InvocationHandler接口，通过这个类和这个接口可以生成JDK动态代理类和动态代理对象。</strong></font></p><ol><li><strong>创建公共接口的具体行为</strong></li></ol><p>跟上面静态代理一样：首先，我们创建一个Person公共接口。这个接口就是学生（被代理类），和班长（代理类）的公共接口，他们都有上交班费的行为。这样，学生上交班费就可以让班长来代理执行。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 创建Person公共接口 */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//上交班费</span>    <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ol start="2"><li><strong>被代理类对象实现接口，完成具体的业务逻辑</strong></li></ol><p>跟上面静态代理一样：被代理类——Student类实现Person接口。Student可以具体实施上交班费的动作：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 被代理类实现公共接口 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Student</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">"上交班费50元"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ol start="3"><li><strong><font color='red'>代理类实现InvocationHandler接口</font>，完成委托类预处理消息、过滤消息、把消息转发给委托类，以及事后处理消息等。</strong></li></ol><p><strong><font color='blue'>这里是跟静态代理不一样的地方，实现的是InvocationHandler接口，而不是公共接口</font></strong>。</p><p><strong><font color='red'>创建StudentInvocationHandler类，实现InvocationHandler接口，在这个类中有一个被代理对象obj。</font></strong></p><p><strong><font color='red'>InvocationHandler接口中有一个invoke方法，所有执行被代理对象的方法都会被替换成执行invoke方法。在invoke方法中执行被代理对象obj的相应方法。</font></strong></p><p><strong><font color='red'>在代理过程中，我们真正执行被代理对象的方法前可以加入自己其他的处理，来增强被代理对象的方法</font></strong>。这也是Spring中的AOP的实现主要原理，<strong><font color='red'>这里还涉及到一个很重要的关于Java反射方面的基础知识</font></strong>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// invocationHandler持有的被代理对象</span>    <span class="token keyword">private</span> Object obj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通过构造器传入具体的被代理对象</span>    <span class="token keyword">public</span> <span class="token function">StudentInvocationHandler</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * @param proxy     代表动态代理对象     * @param method    代表被代理对象的方法     * @param args      代表被代理对象的方法传入的实参     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行之前的操作</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行之前的操作....\t 被代理对象的方法是："</span><span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 方法传入的参数是："</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行</span>        <span class="token comment" spellcheck="true">// method.invoke() 表示执行被代理对象的方法，其中第一个参数是被代理对象，第二个参数是传入方法中的实参</span>        Object result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行之前的操作</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行之后的操作....\t 被代理对象的方法执行后的结果是："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ol start="4"><li><strong>客户端使用操作与分析</strong></li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * JDK动态代理 *  1、需要有一个接口，即接口的实现类 *  2、创建接口实现类的代理对象 * * newProxyInstance(ClassLoader loader, Class&lt;?>[] interfaces, InvocationHandler h) *  1、loader: 用哪个类加载器去加载代理对象 *  2、interfaces:动态代理类需要实现的接口 *  3、h:动态代理方法在执行时，会调用h里面的invoke方法去执行 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDKProxyTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建被代理对象</span>        Person zhangsan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 创建一个与被代理对象相关联的InvocationHandler</span>        StudentInvocationHandler studentInvocationHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StudentInvocationHandler</span><span class="token punctuation">(</span>zhangsan<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 利用Proxy类创建代理对象studentProxy来代理zhangsan，代理对象的每个执行方法都会替换执行Invocation中的invoke方法</span>        ClassLoader loader <span class="token operator">=</span> JDKProxyTest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> <span class="token punctuation">{</span>Person<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        InvocationHandler h <span class="token operator">=</span> studentInvocationHandler<span class="token punctuation">;</span>        Person studentProxy <span class="token operator">=</span> <span class="token punctuation">(</span>Person<span class="token punctuation">)</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 代理执行上交班费的方法</span>        studentProxy<span class="token punctuation">.</span><span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624153804.png" style="zoom:67%;" /><p>我们前面说到，<strong><font color='red'>动态代理的优势在于可以很方便的对代理类的所有方法进行统一的处理，而不用修改代理类中每个的方法</font></strong>。是因为被代理类的所有方法，都是通过在InvocationHandler中的invoke方法被调用的，所以我们<font color='red'><strong>只要在invoke方法中统一处理，就可以对代理类的素有方法进行相同的操作了</strong></font>。</p><p>动态代理的过程，代理对象和被代理对象的关系不像静态代理那样一目了然，清晰明了。因为动态代理的过程中，<font color='blue'>我们并没有实际看到代理类，也没有很清晰地的看到代理类的具体样子</font>，而且<font color='red'>动态代理中被代理对象和代理对象是通过InvocationHandler来完成的代理过程的</font>，其中具体是怎样操作的，为什么代理对象执行的方法都会通过InvocationHandler中的invoke方法来执行。带着这些问题，我们就需要对java动态代理的源码进行简要的分析，弄清楚其中缘由。</p><blockquote><p>JDK动态代理运行错误</p></blockquote><ol><li><p><code>java反射错误：object is not an instance of declaring class</code></p><p>解决方法：<font color='red'>一般是接口类型不对，检查下<code>Class&lt;?&gt;[] interfaces = {UserDaoImpl.class};</code></font></p></li><li><p><code>被代理类没有实现接口：com.jie.aop.UserDaoImpl is not an interface</code></p><p>如下，被代理类没有实现接口：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624205733.png" style="zoom:80%;" /><p>如下，JDK动态代理代码：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624210126.png" style="zoom:80%;" /><p>报错：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624210222.png" style="zoom:80%;" /><p>修改为：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624210459.png" style="zoom:80%;" /></li></ol><h3 id="3-3-JDK动态代理源码分析"><a href="#3-3-JDK动态代理源码分析" class="headerlink" title="3.3 JDK动态代理源码分析"></a>3.3 JDK动态代理源码分析</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 源码注释：Returns an instance of a proxy class for the specified interfaces *          that dispatches method invocations to the specified invocation handler. * 注释翻译：返回指定接口的代理类的实例，该接口将方法调用分派到指定的调用处理程序 */</span><span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">newProxyInstance</span><span class="token punctuation">(</span>ClassLoader loader<span class="token punctuation">,</span>                                      Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>                                      InvocationHandler h<span class="token punctuation">)</span>  <span class="token keyword">throws</span> IllegalArgumentException<span class="token punctuation">{</span>    Objects<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> intfs <span class="token operator">=</span> interfaces<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> SecurityManager sm <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">checkProxyAccess</span><span class="token punctuation">(</span>Reflection<span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loader<span class="token punctuation">,</span> intfs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*     * Look up or generate the designated proxy class.     * 查找或生成指定的代理类。     */</span>    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cl <span class="token operator">=</span> <span class="token function">getProxyClass0</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> intfs<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*     * Invoke its constructor with the designated invocation handler.     * 使用指定的调用处理程序调用其构造函数。     */</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">checkNewProxyPermission</span><span class="token punctuation">(</span>Reflection<span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cons <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>constructorParams<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> InvocationHandler ih <span class="token operator">=</span> h<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Modifier<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>cl<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token operator">&lt;</span>Void<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">public</span> Void <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    cons<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> cons<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>h<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span><span class="token operator">|</span>InstantiationException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Throwable t <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token punctuation">(</span>RuntimeException<span class="token punctuation">)</span> t<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>最重要的是下面这四个位置的语句：</p><pre class=" language-java"><code class="language-java"><span class="token number">1</span><span class="token punctuation">.</span><span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> intfs <span class="token operator">=</span> interfaces<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">2</span><span class="token punctuation">.</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cl <span class="token operator">=</span> <span class="token function">getProxyClass0</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> intfs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">3</span><span class="token punctuation">.</span><span class="token keyword">final</span> Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cons <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>constructorParams<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">4</span><span class="token punctuation">.</span><span class="token keyword">return</span> cons<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>h<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>其中最应该关注的是：<font color='red'><strong><code>Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</code>，因为在这里产生了代理类</strong></font>。后面代码中的构造器也是通过这里产生的类来获得，可以看出，这个类的产生就是整个动态代理的关键，由于是动态生成的类文件，我这里不具体进入分析如何产生的这个类文件，只需要知道<font color='red'><strong>这个类文件是缓存在java虚拟机中的</strong></font>。</p><p>接下来我们对class文件进行反编译，看看JDK为我们生成了什么内容：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>InvocationHandler<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Proxy<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>UndeclaredThrowableException<span class="token punctuation">;</span><span class="token keyword">import</span> proxy<span class="token punctuation">.</span>Person<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> $Proxy0 <span class="token keyword">extends</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span> <span class="token keyword">static</span> Method m1<span class="token punctuation">;</span>  <span class="token keyword">private</span> <span class="token keyword">static</span> Method m2<span class="token punctuation">;</span>  <span class="token keyword">private</span> <span class="token keyword">static</span> Method m3<span class="token punctuation">;</span>  <span class="token keyword">private</span> <span class="token keyword">static</span> Method m0<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**  * 注意这里是生成代理类的构造方法，方法参数为InvocationHandler类型，  * 看到这，是不是就有点明白，为何代理对象调用方法都是执行InvocationHandler中的invoke方法，而InvocationHandler又持有一个  * 被代理对象的实例。  *  * super(paramInvocationHandler)，是调用父类Proxy的构造方法。  * 父类持有：protected InvocationHandler h;  * Proxy构造方法：  *    protected Proxy(InvocationHandler h) {  *         Objects.requireNonNull(h);  *         this.h = h;  *     }  */</span>  <span class="token keyword">public</span> $<span class="token function">Proxy0</span><span class="token punctuation">(</span>InvocationHandler paramInvocationHandler<span class="token punctuation">)</span>    <span class="token keyword">throws</span>   <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>paramInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//这个静态块本来是在最后的，我把它拿到前面来，方便描述</span>   <span class="token keyword">static</span>  <span class="token punctuation">{</span>    <span class="token keyword">try</span>    <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">//看看这儿静态块儿里面有什么，是不是找到了giveMoney方法。请记住giveMoney通过反射得到的名字m3，其他的先不管</span>      m1 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"equals"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      m2 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 被代理对象的方法</span>      m3 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"proxy.Person"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"giveMoney"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      m0 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> localNoSuchMethodException<span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodError</span><span class="token punctuation">(</span>localNoSuchMethodException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> localClassNotFoundException<span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoClassDefFoundError</span><span class="token punctuation">(</span>localClassNotFoundException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**  * 这里调用被代理对象的giveMoney方法，直接就调用了InvocationHandler中的invoke方法，并把m3传了进去。  * this.h.invoke(this, m3, null); 这里简单明了。  * 代理对象持有一个InvocationHandler对象，InvocationHandler对象持有一个被代理对象，再联系到InvacationHandler中的invoke方法。嗯，就是这样。  */</span>  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">giveMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">throws</span>   <span class="token punctuation">{</span>    <span class="token keyword">try</span>    <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> m3<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token operator">|</span>RuntimeException localError<span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">throw</span> localError<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> localThrowable<span class="token punctuation">)</span>    <span class="token punctuation">{</span>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UndeclaredThrowableException</span><span class="token punctuation">(</span>localThrowable<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">//注意，这里为了节省篇幅，省去了toString，hashCode、equals方法的内容。原理和giveMoney方法一毛一样。</span><span class="token punctuation">}</span></code></pre><p>由上面的反编译文件，可以看出，JDK为我们生成了一个叫做<font color='red'><strong>$Proxy0（这个名字后面的0是编号，有多个代理类会依次递增）的代理类，这个代理类文件是放在内存中的，我们在创建代理对象时，就是通过反射获得这个代理类的构造方法，然后创建的代理对象</strong></font>。</p><p>我们<font color='red'><strong>可以将InvocationHandler看成是一个中介类，该中介类持有一个被代理对象，在invoke方法中调用了被代理对象的相应方法。然后通过聚合的方式持有被代理对象的引用，把外部对invoke的调用最终都转为对被代理对象的调用。</strong></font></p><p><strong><em>总结：</em></strong></p><ul><li><p>生成的代理类<code>$Proxy0</code>继承了<code>Proxy</code>类，并且实现了公共接口<code>Person</code></p><ul><li>代理类继承了Proxy类，所以也就决定了<font color='red'><strong>java动态代理只能对接口进行代理，Java的继承机制注定了这些动态代理类们无法实现对class的动态代理</strong></font>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> $Proxy0 <span class="token keyword">extends</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></li><li><p>上面的动态代理的例子，其实就是AOP的一个简单实现了，在目标对象的方法执行之前和执行之后进行了处理。<strong>Spring的AOP实现其实也是用了Proxy和InvocationHandler这两个东西的</strong>。</p></li></ul><h3 id="3-4-InvocationHandler接口和Proxy类详解"><a href="#3-4-InvocationHandler接口和Proxy类详解" class="headerlink" title="3.4 InvocationHandler接口和Proxy类详解"></a>3.4 InvocationHandler接口和Proxy类详解</h3><p><font color='red'>InvocationHandler接口是代理对象的调用处理程序实现的一个接口，每一个代理对象都有一个关联的调用程序。在代理对象调用方法时，方法调用被编码分派到调用程序的invoke方法。</font></p><p>当我们通过动态代理对象调用一个方法时候，这个方法的调用就会被转发到实现<code>InvocationHandler</code>接口类的<code>invoke</code>方法来调用，看如下<code>invoke</code>方法：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**  * proxy：代理对象：com.sun.proxy.$Proxy0  * method：被代理对象的方法的Method对象  * args：代理对象方法传递的参数  */</span><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable<span class="token punctuation">;</span></code></pre><p><code>Proxy</code>类就是用来创建一个代理对象的类，它提供了很多方法，但是我们最常用的是<code>newProxyInstance</code>方法。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">newProxyInstance</span><span class="token punctuation">(</span>ClassLoader loader<span class="token punctuation">,</span>                                             Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>                                             InvocationHandler h<span class="token punctuation">)</span></code></pre><p>这个方法的作用就是创建一个代理类对象，它接收三个参数，我们来看下几个参数的含义：</p><ul><li><code>loader</code>：一个<code>ClassLoader</code>对象，定义了由哪个<code>ClassLoader</code>对象对生成的代理类进行加载。</li><li><code>interfaces</code>：一个<code>interface</code>对象数组，表示我们将要给我们的代理对象提供一组什么样的接口，<font color='red'>如果我们提供了这样一个接口对象数组，那么也就是声明了代理类要实现哪些接口</font>，代理类就可以调用接口声明的所有方法。</li><li><code>h</code>：一个<code>InvocationHandler</code>对象，表示的是当动态代理对象调用方法的时候会关联到哪一个<code>InvocationHandler</code>对象上，并最终由其调用。</li></ul><h3 id="3-5-JDK动态代理和CGLIB动态代理代码示例比较"><a href="#3-5-JDK动态代理和CGLIB动态代理代码示例比较" class="headerlink" title="3.5 JDK动态代理和CGLIB动态代理代码示例比较"></a>3.5 JDK动态代理和CGLIB动态代理代码示例比较</h3><ol><li><strong>定义创建用户管理接口</strong></li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 创建公共接口 */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">update</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ol start="2"><li><strong>用户管理实现类，实现用户管理接口(被代理的实现类)</strong></li></ol><p>① JDK动态代理写法：被代理类实现公共接口</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * JDK动态代理写法：被代理类实现公共接口，完成具体的业务逻辑 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDao</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">update</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>② CGLIB动态代理写法：被代理类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * CGLIB动态代理写法：被代理类，完成具体的业务逻辑 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">update</span><span class="token punctuation">(</span>String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ol start="3"><li><strong>JDK动态代理实现</strong></li></ol><p>① 创建与动态代理对象相关联的InvocationHandler</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 创建UserDaoInvocationHandler，实现InvocationHandler接口 *  作用：动态代理对象相关联的InvocationHandler *  1、持有一个被代理对象 *  2、通过有参构造器的方式传递被代理对象 *  3、使用invoke()方法来增强代理对象的方法 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoInvocationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// invocationHandler持有的被代理对象</span>    <span class="token keyword">private</span> Object obj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通过有参构造器的方式传递被代理对象</span>    <span class="token keyword">public</span> <span class="token function">UserDaoInvocationHandler</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 增强的逻辑     * @param proxy     动态代理对象     * @param method    被代理对象中的方法     * @param args      被代理对象中的方法传入的参数     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行之前的操作</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法之前执行...\t 传入的方法是："</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"，该方法传入的参数为"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 被代理对象中的方法执行</span>        Object res <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行之前的操作</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法之后执行...\t 代理的对象是："</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>② 创建动态代理对象</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * JDK动态代理 *  JDK代理的接口 * * newProxyInstance(ClassLoader loader, Class&lt;?>[] interfaces, InvocationHandler h) *  1、loader: 用哪个类加载器去加载代理对象 *  2、interfaces:动态代理类需要实现的接口 *  3、h:动态代理方法在执行时，会调用h里面的invoke方法去执行 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDKProxy</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1、创建被代理对象</span>        UserDao userDaoImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2、创建一个与被代理对象相关联的InvocationHandler</span>        UserDaoInvocationHandler userDaoInvocationHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDaoInvocationHandler</span><span class="token punctuation">(</span>userDaoImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3、利用Proxy类创建代理对象userDaoProxy来代理userDaoImpl，</span>        <span class="token comment" spellcheck="true">//  代理对象的每个执行方法都会替换执行Invocation中的invoke方法</span>        ClassLoader loader <span class="token operator">=</span> JDKProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> <span class="token punctuation">{</span>UserDao<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        InvocationHandler h <span class="token operator">=</span> userDaoInvocationHandler<span class="token punctuation">;</span>        UserDao userDaoProxy <span class="token operator">=</span> <span class="token punctuation">(</span>UserDao<span class="token punctuation">)</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 4、代理对象执行被代理对象的方法</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> userDaoProxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最终运行结果："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624211828.png" style="zoom:80%;" /><ol start="4"><li><strong>CGLIB代理</strong></li></ol><p>① 需要先导入 asm-3.3.1.jar 和 cglib-2.2.2.jar 两个包</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624212026.png" alt=""></p><p>② 创建与动态代理对象相关联的MethodInterceptor</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 创建UserDaoMethodInterceptor，实现MethodInterceptor接口 *  作用：动态代理对象相关联的MethodInterceptor *  1、持有一个被代理对象 *  2、通过有参构造器的方式传递被代理对象 *  3、使用invoke()方法来增强代理对象的方法 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoMethodInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 被代理对象</span>    <span class="token keyword">private</span> Object obj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通过有参构造器的方式传递被代理对象</span>    <span class="token keyword">public</span> <span class="token function">UserDaoMethodInterceptor</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     *     * @param proxyInstance 代理子类实例     * @param method        被代理对象的方法     * @param args          被代理对象的方法传入的参数     * @param methodProxy   用来调用代理子类中的基类方法副本，或委托基类中的原方法。     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span>Object proxyInstance<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> MethodProxy methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行之前的操作</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法之前执行...\t 传入的方法是："</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"，该方法传入的参数为"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法之前执行...\t 代理子类的类名是："</span> <span class="token operator">+</span> proxyInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 被代理对象中的方法执行</span>        <span class="token comment" spellcheck="true">// 第一种方法：使用 method.invoke(obj, args)</span>        Object result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 第二种方法：使用 methodProxy.invokeSuper(proxyInstance, args)</span><span class="token comment" spellcheck="true">//        Object result = methodProxy.invokeSuper(proxyInstance, args);</span>        <span class="token comment" spellcheck="true">// 被代理对象的方法执行之前的操作</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"方法之后执行...\t 代理的对象是："</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>③ 创建动态代理对象</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * CGLIB动态代理 *  代理的是类 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CGLIBProxy</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1、创建被代理对象</span>        UserDaoImpl userDaoImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2、创建动态代理对象相关联的MethodInterceptor</span>        UserDaoMethodInterceptor userDaoMethodInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDaoMethodInterceptor</span><span class="token punctuation">(</span>userDaoImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3、创建动态代理对象</span>        Enhancer enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//设置父类(即被代理类),因为Cglib是针对指定的类生成一个子类，所以需要指定父类</span>        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>userDaoImpl<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//设置回调</span>        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>userDaoMethodInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//创建并返回代理对象</span>        UserDaoImpl userDaoProxy <span class="token operator">=</span> <span class="token punctuation">(</span>UserDaoImpl<span class="token punctuation">)</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 4、利用动态代理对象调用原方法</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> userDaoProxy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最终运行结果："</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210624212247.png" style="zoom:80%;" /><h3 id="3-6-JDK和CGLIB动态代理总结"><a href="#3-6-JDK和CGLIB动态代理总结" class="headerlink" title="3.6 JDK和CGLIB动态代理总结"></a>3.6 JDK和CGLIB动态代理总结</h3><ul><li><p><strong><font color='red'>JDK动态代理只能对实现了接口的类生成代理，而不能针对类 ，使用的是 Java反射技术实现，生成类的过程比较高效</font></strong>。</p></li><li><p><strong><font color='red'>CGLIB是针对类实现代理，主要是对指定的类生成一个子类，覆盖其中的方法 ，使用asm字节码框架实现，相关执行的过程比较高效，生成类的过程可以利用缓存弥补，因为是继承，所以该类或方法最好不要声明成final</font></strong> </p></li><li><p><font color='red'><strong>JDK代理是不需要第三方库支持</strong></font>，只需要JDK环境就可以进行代理，<font color='red'><strong>使用条件:实现<code>InvocationHandler</code> + 使用<code>Proxy.newProxyInstance</code>产生代理对象 + 被代理的对象必须要实现接口</strong></font></p></li><li><p><font color='red'><strong>CGLib必须依赖于CGLib的类库</strong></font>，但是它需要类来实现任何接口代理的是指定的类生成一个子类，覆盖其中的方法，是一种继承。</p><p><strong><font color='red'>当针对接口编程的环境下推荐使用JDK的代理</font></strong>。</p></li></ul><hr><p>参考资料：</p><ol><li><a href="https://blog.csdn.net/xiaofeng10330111/article/details/105633821" target="_blank" rel="noopener">代理模式的使用总结</a></li></ol><hr>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 面试 </tag>
            
            <tag> JDK动态代理和CGLIB动态代理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】HashMap底层原理</title>
      <link href="/2021/06/17/mian-shi-java-hashmap-di-ceng-yuan-li/"/>
      <url>/2021/06/17/mian-shi-java-hashmap-di-ceng-yuan-li/</url>
      
        <content type="html"><![CDATA[<h2 id="1-HashMap-底层原理"><a href="#1-HashMap-底层原理" class="headerlink" title="1 HashMap 底层原理"></a>1 HashMap 底层原理</h2><p><strong>哈希表</strong></p><p><strong>哈希表的主干就是数组</strong>，比如我们要新增或查找某个元素，我们通过把当前元素的关键字 通过某个函数映射到数组中的某个位置，通过数组下标一次定位就可完成操作。<font color='red'>存储位置 = f(关键字)</font>。其中，这个函数f一般称为哈希函数，这个函数的设计好坏会直接影响到哈希表的优劣。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211622.png" alt="" style="zoom:67%;" /><p><strong>哈希冲突</strong></p><p>如果两个不同的元素，通过哈希函数得出的实际存储地址相同怎么办？也就是说，当我们对某个元素进行哈希运算，得到一个存储地址，然后要进行插入的时候，发现已经被其他元素占用了，其实这就是所谓的<font color='blue'>哈希冲突</font>，也叫哈希碰撞。</p><p>哈希冲突的解决方案有多种</p><ul><li>开放定址法：发生冲突，继续寻找下一块未被占用的存储地址；</li><li>散列函数法；</li><li>链地址法：数组+链表的方式</li></ul><blockquote><p>HashMap是使用了哪些方法来有效解决哈希冲突的?</p></blockquote><ul><li><font color='blue'>HashMap即是采用了<strong>链地址法</strong>，也就是数组+链表的方式。</font></li><li><strong><font color='blue'>使用2次扰动函数（hash函数）来降低哈希冲突的概率，使得数据分布更平均；</font></strong></li><li><strong><font color='blue'>引入红黑树进一步降低遍历的时间复杂度，使得遍历更快；</font></strong></li></ul><p><strong>HashMap实现原理</strong></p><p><font color='red'>一句话：数组+链表+红黑树！！！</font></p><p>HashMap的整体结构如下</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210518203014.png" alt="HashMap的整体结构" style="zoom:67%;" /><p>简单来说，<strong><font color='red'>HashMap由数组+链表/红黑树组成的，数组是HashMap的主体，链表/红黑树则是为了解决哈希冲突而存在的</font></strong>。</p><ol><li>当添加一个元素（key-value）时，就<font color='red'>首先根据元素key的hashCode来计算hash值</font>，以此<font color='red'>确定插入数组中的位置(hash&amp;length-1)</font>；</li><li>存储时，如果<font color='red'>出现hash值相同的key</font>，此时有两种情况。<ul><li>如果key相同，则覆盖原始值；</li><li>如果key不同（出现冲突），则将当前的key-value放入链表中（<font color='red'>因为有可能hashCode相同，但两个对象却是不相同的</font>）</li></ul></li><li>Jdk 1.8中对HashMap的实现做了优化，<font color='red'>当链表中的节点数据超过八个之后，该链表会转为红黑树来提高查询效率</font>，从原来的O(n)到O(logn)</li><li>获取时，直接找到hash值对应的下标，在进一步判断key是否相同，从而找到对应值。</li></ol><blockquote><p>为什么会出现hash值相同的情况？</p></blockquote><p><font color='red'>HashMap中的hash算法是：hashCode的高16位 异或 hashCode的低16位</font>（<code>hash = (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code>）。</p><p>HashMap中根据hash值找对应数组下标：<font color='red'>数组长度减一 与运算 hash 值</font>（<code>index = (n - 1) &amp; hash</code>）。</p><p>由上面两个公式可得出，<font color='red'>两个key的数组下标相同 —&gt; 两个key的hash值相同 —&gt; 两个key的hashCode相同</font></p><blockquote><p>JAVA 两个对象不同为什么他们的hashcode有可能相同？</p></blockquote><p>hashCode是jdk根据对象的地址或者字符串或者数字算出来的int类型的数值。</p><p>hashCode()  的作用是获取哈希码，也称为散列码；<font color='red'>将该对象的内部地址转换成一个int整数返回</font>。这个哈希码的作用是确定该对象在哈希表中的索引位置。hashCode()  定义在JDK的Object.java中，这就意味着Java中的任何类都包含有hashCode()函数。</p><p>散列表存储的是键值对(key-value)，它的特点是：能根据“键”快速的检索出对应的“值”。这其中就利用到了散列码！（可以快速找到所需要的对象）</p><p>1、<strong>以“HashSet 如何检查重复”为例子来说明为什么要有 hashCode？</strong></p><p><font color='red'>一句话：先判断hashcode是否相等，再判断是否equals。 </font></p><ol><li><p>当把对象加入HashSet时，HashSet会先计算对象的hashCode值来判断对象的加入位置，同时也会与其他已经加入的对象的hashCode值比较；</p></li><li><p>如果没有相同hashCode值，HashSet会假设对象没有重复出现；</p><p>如果发现相同hashCode值的对象，这时就会调用equals()方法来检验hashCode相等的两个对象是否真的相同。</p></li><li><p>如果两者相同，HashSet 就不会让其加入操作成功；</p><p>如果两者不同，就会重新散列到其他位置。</p></li></ol><p>2、<strong>hashCode()与equals()的相关规定</strong></p><ol><li><p><code>A.equals(B)==true</code> –&gt; <code>A.hashCode()==B.hashCode()</code> （<font color='red'>两个对象相同，equals相同，则hashCode必须相同</font>）</p><p><font color='red'>因此<strong>若重写equals()方法，则 必须重写hashCode()方法</strong>。</font></p></li><li><p><font color='red'><strong>两个对象的hashCode相同，两个对象不一定相同！！</strong>！</font></p></li></ol><p><font color='blue'>hashCode() 的默认行为是对堆上的对象产生独特值。<strong>如果没有重写 hashCode()，则该 class 的两个对象无论如何都不会相等（即使这两个对象指向相同的数据）</strong></font></p><h3 id="1-1-HashMap的主干–Node数组"><a href="#1-1-HashMap的主干–Node数组" class="headerlink" title="1.1 HashMap的主干–Node数组"></a>1.1 HashMap的主干–<code>Node</code>数组</h3><p>HashMap的主干是一个<code>Node</code>数组。Node是HashMap的基本组成单元，每一个Node包含一个key-value键值对。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//HashMap的主干数组，可以看到就是一个Node数组，初始值为空数组{}，主干数组的长度一定是2的次幂。</span><span class="token keyword">transient</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span></code></pre><p><strong><em>tips：</em></strong></p><ul><li>列表以及数组：长度初始值都是<font color='red'>16</font>，当实际长度达到<font color='red'>0.75</font>时，便会扩容，扩容长度是数组长度的<font color='red'>0.5</font>。</li><li>Map：长度初始值是16，当实际长度达到0.75时，便会扩容，扩容长度是Map长度的<font color='red'>1</font>倍。</li><li><font color='red'>扩容：map一倍，列表一半</font>。</li></ul><h3 id="1-2-静态内部类Node"><a href="#1-2-静态内部类Node" class="headerlink" title="1.2 静态内部类Node"></a>1.2 静态内部类<code>Node</code></h3><p><code>Node</code>是HashMap中的一个静态内部类。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Node是单向链表，它实现了Map.Entry接口</span><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//对key的hashcode值进行hash运算后得到的值，存储在Node中，用来定位数组索引位置</span>    <span class="token keyword">final</span> K key<span class="token punctuation">;</span>    V value<span class="token punctuation">;</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//链表的下一个node</span>    <span class="token comment" spellcheck="true">//构造函数：Hash值 键 值 下一个节点</span>    <span class="token function">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> hash<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//判断两个node是否相等,若key和value都相等，返回true。可以与自身比较为true</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">></span> e <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token operator">--</span><span class="token operator">></span><span class="token punctuation">)</span>o<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="1-3-红黑树"><a href="#1-3-红黑树" class="headerlink" title="1.3 红黑树"></a>1.3 红黑树</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//红黑树</span><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TreeNode</span><span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> <span class="token punctuation">{</span>    TreeNode<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> parent<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 父节点</span>    TreeNode<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> left<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//左子树</span>    TreeNode<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> right<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//右子树</span>    TreeNode<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> prev<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// needed to unlink next upon deletion</span>    <span class="token keyword">boolean</span> red<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//颜色属性</span>    <span class="token function">TreeNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V val<span class="token punctuation">,</span> Node<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//返回当前节点的根节点</span>    <span class="token keyword">final</span> TreeNode<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> r <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> p<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>                <span class="token keyword">return</span> r<span class="token punctuation">;</span>            r <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="1-4-HashMap-中几个重要数据"><a href="#1-4-HashMap-中几个重要数据" class="headerlink" title="1.4 HashMap()中几个重要数据"></a>1.4 HashMap()中几个重要数据</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span><span class="token punctuation">,</span> Cloneable<span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 362498820763181265L<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// aka 16</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//最大容量</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> DEFAULT_LOAD_FACTOR <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//填充比</span>    <span class="token comment" spellcheck="true">//当add一个元素到某个位桶，其链表长度达到8时将链表转换为红黑树</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> UNTREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MIN_TREEIFY_CAPACITY <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>    <span class="token keyword">transient</span> Node<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//存储元素的数组</span>    <span class="token keyword">transient</span> Set<span class="token operator">&lt;</span>map<span class="token punctuation">.</span>entry<span class="token operator">&lt;</span>k<span class="token punctuation">,</span>v<span class="token operator">>></span> entrySet<span class="token punctuation">;</span>    <span class="token keyword">transient</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//存放元素的个数</span>    <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//被修改的次数fast-fail机制</span>    <span class="token keyword">int</span> threshold<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//临界值 当实际大小(容量*填充比)超过临界值时，会进行扩容 </span>    <span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//填充比</span><span class="token punctuation">}</span></code></pre><ul><li>数组初始大小：16</li><li>加载因子(填充比)：0.75</li><li>扩容比率：1</li><li>链表转红黑树的阈值：8</li></ul><p><strong>为什么需要使用加载因子，为什么需要扩容呢？</strong></p><p>因为如果填充比很大，说明利用的空间很多，如果<font color='blue'>一直不进行扩容的话，链表就会越来越长，这样查找的效率很低</font>，因为链表的长度很大（当然最新版本使用了红黑树后会改进很多），扩容之后，<font color='red'>将原来链表数组的每一个链表分成奇偶两个子链表分别挂在新链表数组的散列位置</font>，这样就减少了每个链表的长度，增加查找效率。</p><h3 id="1-5-put-方法"><a href="#1-5-put-方法" class="headerlink" title="1.5 put()方法"></a>1.5 put()方法</h3><p>当我们put的时候，首先计算 <code>key</code>的<code>hash</code>值，这里调用了<code>hash</code>方法，<code>hash</code>方法实际是让<code>key.hashCode()</code>与<code>key.hashCode()&gt;&gt;&gt;16</code>进行异或操作，高16bit补0，一个数和0异或不变，所以 hash 函数大概的作用就是：<font color='red'><strong>高16bit不变，低16bit和高16bit做了一个异或，目的是减少碰撞</strong></font>。</p><p>按照函数注释，因为bucket数组大小是2的幂，计算下标<code>index = (table.length - 1) &amp; hash</code>，如果不做 hash 处理，相当于散列生效的只有几个低 bit 位，为了减少散列的碰撞，设计者综合考虑了速度、作用、质量之后，使用高16bit和低16bit异或来简单处理减少碰撞，而且JDK8中用了复杂度 O（logn）的树结构来提升碰撞下的性能。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211716.png" style="zoom:80%;" /><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> V <span class="token function">put</span><span class="token punctuation">(</span>K key<span class="token punctuation">,</span> V value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 实现Map.put和相关方法 * @param hash  对key的hashcode进一步计算，得到哈希值，确保散列均匀 * @param key    指定参数key * @param value    指定参数value * @param onlyIfAbsent    如果为true，即使指定参数key在map中已经存在，也不会替换value * @param evict        如果为false，数组table在创建模式中 * @return    如果value被替换，则返回旧的value，否则返回null。当然，可能key对应的value就是null。 */</span><span class="token keyword">final</span> V <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 临时变量，存储Map的数组table</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// key，value组成的一个Node</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 步骤1：为空分配内存</span>    <span class="token comment" spellcheck="true">// 如果table数组为空数组{}，为table分配实际内存，调用扩容函数resize()进行初始化，initialCapacity 默认是1&lt;&lt;4(2^4=16)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 步骤2：不冲突，直接添加</span>    <span class="token comment" spellcheck="true">// 如果table在(n-1) &amp; hash 索引处的值为空，就新建一个节点插入在该位置</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 有哈希冲突,开始处理冲突</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>            Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span> K k<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 步骤3：哈希冲突，节点key存在，直接覆盖value </span>        <span class="token comment" spellcheck="true">// 检查第一个节点Node的hash与待插入key的hash是否一致，并且第一个节点Node 是否equals(待插入key)，如果一致，则证明key已存在，覆盖修改该节点即可</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 将第一个元素赋值给e，用e来记录</span>            e <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 步骤4：判断该链为红黑树 </span>        <span class="token comment" spellcheck="true">// hash值不相等，即key不相等；为红黑树结点</span>        <span class="token comment" spellcheck="true">// 如果当前元素类型为TreeNode，表示为红黑树，putTreeVal返回待存放的node, e可能为null</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 放入树中</span>            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 步骤5：该链为链表 </span>        <span class="token comment" spellcheck="true">// 为链表结点</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 往后遍历链表，长度超过8且容量大于64时，链表转成红黑树。在末尾添加数据或覆盖相同的key</span>            <span class="token comment" spellcheck="true">// 在链表最末插入结点</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 到达链表的尾部</span>                <span class="token comment" spellcheck="true">//判断该链表尾部指针是不是空的</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 在尾部插入新结点</span>                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//判断链表的长度是否达到转化红黑树的临界值，临界值为8</span>                    <span class="token comment" spellcheck="true">// 如果冲突的节点数达到8个，看是否需要改变冲突节点的存储结构，由原来的链表变成红黑树？</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// -1 for 1st</span>                        <span class="token comment" spellcheck="true">// treeifyBin首先判断当前hashMap的长度，如果不足64，只进行resize，扩容table，</span>                        <span class="token comment" spellcheck="true">// 如果达到64，那么将冲突的存储结构为红黑树</span>                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 判断链表中结点的key值与插入的元素的key值是否相等</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 用于遍历数组中的链表，与前面的e = p.next组合，可以遍历链表</span>                p <span class="token operator">=</span> e<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//判断当前的key已经存在的情况下，再来一个相同的hash值、key值时，返回新来的value这个值</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// existing mapping for key，就是key的Value存在</span>            <span class="token comment" spellcheck="true">// 记录e的value</span>            V oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>             <span class="token comment" spellcheck="true">// onlyIfAbsent为false或者旧值为null</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> null<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//用新值替换旧值</span>                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 访问后回调</span>            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 返回旧值</span>            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 结构性修改</span>    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 步骤6：实际容量大于门限则扩容</span>    <span class="token comment" spellcheck="true">// 如果当前容量大于门限，门限是容量*0.75</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//扩容两倍</span>    <span class="token comment" spellcheck="true">// 插入后回调</span>    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>简单总结：</strong></p><ol><li><p>为空初始化。</p><p>判断键值对数组table[i]是否为空或为null，否则执行resize()进行扩容；</p></li><li><p>索引处为空，直接插入。</p><p>根据键值key计算hash值得到插入的数组索引 i (<code>i = hash&amp;(length-1)</code>)，<font color='red'>如果table[i]==null，直接新建节点添加</font>，转向⑥，如果table[i]不为空，即哈希冲突，转向③；</p></li><li><p>哈希冲突，首个元素与key相同，直接覆盖。</p><p>判断table[i]的<font color='red'>首个元素是否和key一样(先比较hash，再比较equals())，如果相同直接覆盖value</font>，否则转向④，<font color='red'>这里的相同指的是hashCode以及equals！！！！；</font></p></li><li><p>哈希冲突，首个元素与key不相同，红黑树直接插入。</p><p>判断table[i] 是否为treeNode，即table[i] 是否是红黑树，<font color='red'>如果是红黑树，则直接在树中插入键值对</font>，否则转向⑤；</p></li><li><p>哈希冲突，首个元素与key不相同，链表是否转红黑树，不转在链表处理。</p><p>遍历table[i]，判断链表长度是否大于8，<font color='red'>大于8且数组长度大于64的话把链表转换为红黑树</font>，在红黑树中执行插入操作，否则进行链表的插入操作；遍历过程中若发现key已经存在直接覆盖value即可；</p></li><li><p>是否扩容</p><p>插入成功后，判断实际存在的键值对数量size是否超多了最大容量threshold，如果超过，进行扩容。</p></li></ol><h3 id="6-get-方法"><a href="#6-get-方法" class="headerlink" title="6 get() 方法"></a>6 get() 方法</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> V <span class="token function">get</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">final</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//Entry对象数组</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> first<span class="token punctuation">,</span> e<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//在tab数组中经过散列的第一个位置</span>    <span class="token keyword">int</span> n<span class="token punctuation">;</span> K k<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 1.获取数组中的位置。找到插入的第一个Node，方法是hash值和n-1相与，tab[(n - 1) &amp; hash]</span>    <span class="token comment" spellcheck="true">// 在同一链表上的hash值相同</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token punctuation">(</span>first <span class="token operator">=</span> tab<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 2.查看链表第一个节点。检查第一个Node是不是要找的Node</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>             <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> first<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> first<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3.第一个不是，遍历链表或红黑树。找到key值和hash值都相同的Node</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> first<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 3.1 红黑树情况的查找</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>first<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTreeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 3.2 链表情况下的查找</span>            <span class="token keyword">do</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token keyword">return</span> e<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>简单总结：</strong></p><ul><li>get(key)方法时<font color='red'>获取key的hash值</font>；</li><li>计算<font color='red'>hash&amp;(n-1)得到在链表数组中的位置</font>first=tab[hash&amp;(n-1)]；</li><li>判断first的key是否与参数key相等，<font color='red'>不等就遍历后面的链表找到相同的key值返回对应的Value值即可</font>。</li></ul><h3 id="7-扩容机制resize"><a href="#7-扩容机制resize" class="headerlink" title="7 扩容机制resize()"></a>7 扩容机制resize()</h3><p>构造hash表时，如果不指明初始大小，<font color='blue'>默认大小为16</font>（即Node数组大小16），如果Node[]数组中的元素达到（<font color='red'>填充比*Node.length</font>）重新调整HashMap大小 变为<font color='red'>原来2倍大小</font>,扩容很耗时。</p><p><font color='red'>根据在同一个桶的位置中进行判断(<code>e.hash &amp; oldCap</code>)是否为0，重新进行hash分配后</font>，该元素的位置要么停留在原始位置，要么移动到原始位置+增加的数组大小这个位置上</p><pre class=" language-java"><code class="language-java"><span class="token keyword">final</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span>    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/*如果旧表的长度不是空*/</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 超过最大值就不再扩充了，就只好随你碰撞去吧</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">>=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//扩容前的数组大小如果已经达到最大(2^30)了</span>            threshold <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//修改阈值为int的最大值(2^31-1)，这样以后就不会扩容了</span>            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/*把新表的长度设置为旧表长度的两倍，newCap=2*oldCap*/</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span>                 oldCap <span class="token operator">>=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">/*把新表的门限设置为旧表门限的两倍，newThr=oldThr*2*/</span>            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// double threshold</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/*如果旧表的长度的是0，就是说第一次初始化表*/</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// initial capacity was placed in threshold</span>        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>               <span class="token comment" spellcheck="true">// zero initial threshold signifies using defaults</span>        newCap <span class="token operator">=</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">;</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DEFAULT_LOAD_FACTOR <span class="token operator">*</span> DEFAULT_INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 计算新的resize上限</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//新表长度乘以加载因子</span>        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> MAXIMUM_CAPACITY <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>MAXIMUM_CAPACITY <span class="token operator">?</span>                  <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span>    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span><span class="token string">"unchecked"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">/*下面开始构造新表，初始化表中的数据*/</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//把新表赋值给table</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//原表不为空,要把原表中数据移动到新表中    </span>        <span class="token comment" spellcheck="true">/*遍历原来的旧表*/</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 当前节点e不为空</span>                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token comment" spellcheck="true">// 当前节点e的next为空，证明长度小于8，仍是链表结构</span>                    <span class="token comment" spellcheck="true">// 直接放在新表的e.hash &amp; (newCap - 1)位置</span>                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 红黑树结构的情况</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">/*如果e后边有链表,到这里表示e后面带着个单链表，需要遍历单链表，将每个结点重新计算在新表的位置，并进行搬运 */</span>                <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// preserve order保证顺序</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> loHead <span class="token operator">=</span> null<span class="token punctuation">,</span> loTail <span class="token operator">=</span> null<span class="token punctuation">;</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> hiHead <span class="token operator">=</span> null<span class="token punctuation">,</span> hiTail <span class="token operator">=</span> null<span class="token punctuation">;</span>                    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">;</span>                    <span class="token keyword">do</span> <span class="token punctuation">{</span>                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//记录下一个结点</span>                        <span class="token comment" spellcheck="true">//新表是旧表的两倍容量，实例上就把单链表拆分为两队，</span>                        <span class="token comment" spellcheck="true">//e.hash&amp;oldCap为偶数一队，e.hash&amp;oldCap为奇数一对</span>                        <span class="token comment" spellcheck="true">// 原来的hash值新增的那个bit是1还是0，是0的话，索引不变</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 原索引</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> null<span class="token punctuation">)</span>                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 原来的hash值新增的那个bit是1还是0，是1的话，索引变为：原索引+oldCap</span>                        <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> null<span class="token punctuation">)</span>                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token keyword">else</span>                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//lo队不为null，放在新表原位置</span>                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//hi队不为null，放在新表j+oldCap位置</span>                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>使用的是2次幂的扩展(指长度扩为原来2倍)，所以，元素的位置要么是在原位置，要么是在原位置再移动2次幂的位置。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211806.png" style="zoom: 67%;" /><p>元素在重新计算hash之后，因为n变为2倍，那么n-1的mask范围在高位多1bit(红色)，因此新的index就会发生这样的变化：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211844.png" style="zoom:67%;" /><h3 id="8-为何HashMap的数组长度一定是2的次幂？-即每次扩容一倍"><a href="#8-为何HashMap的数组长度一定是2的次幂？-即每次扩容一倍" class="headerlink" title="8 为何HashMap的数组长度一定是2的次幂？(即每次扩容一倍)"></a>8 为何HashMap的数组长度一定是2的次幂？(即每次扩容一倍)</h3><p>如果数组进行扩容，数组长度发生变化，而存储位置 index = hash&amp;(length-1)，index也可能会发生变化，需要重新计算index。 index = hash&amp;(length-1)就相当于hiindex = hash % length。</p><p>hashMap的数组长度一定保持2的次幂，比如16的二进制表示为 10000，那么length-1就是15，二进制为01111，同理扩容后的数组长度为32，二进制表示为100000，length-1为31，二进制表示为011111。</p><p>从下图例子，我们也能看到<font color='red'>扩容前后数组长度都是2的次幂，这样会保证长度减一后，低位全为1，而扩容后只有最高位一位差异，也就是多出了最左位的1</font>。31与15相比，15的第五位为0，31的第五位为1，其余四位都为1。这样在扩容后，主要看hash二进制表示的第五位，<font color='red'>是0的话，新索引值与旧索引值相同；是1的话，新索引值=旧索引值+旧数组的长度</font>。</p><p>即hash值的新散列下标是不是需要加旧数组的长度，只要看hash值的第五位是不是1就行了。巧妙的是，<font color='red'>位运算的方法就是hash值与旧数组的长度16(10000)来按位与，其结果只能是10000或是00000，便能判断hash值的第五位是不是为0</font>。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210519142228.png" style="zoom:50%;" /><h3 id="9-为何重写equals方法需同时重写hashCode方法"><a href="#9-为何重写equals方法需同时重写hashCode方法" class="headerlink" title="9 为何重写equals方法需同时重写hashCode方法"></a>9 为何重写equals方法需同时重写hashCode方法</h3><p>各种资料上都会提到<font color='red'>“重写equals时也要同时覆盖hashcode”</font>，我们举个小例子来看看，如果重写了equals而不重写hashcode会发生什么样的问题。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTest</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token punctuation">{</span>        <span class="token keyword">int</span> idCard<span class="token punctuation">;</span>        String name<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token keyword">int</span> idCard<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>idCard <span class="token operator">=</span> idCard<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object o<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> o<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            Person person <span class="token operator">=</span> <span class="token punctuation">(</span>Person<span class="token punctuation">)</span> o<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//两个对象是否等值，通过idCard来确定</span>            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idCard <span class="token operator">==</span> person<span class="token punctuation">.</span>idCard<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>        HashMap<span class="token operator">&lt;</span>Person<span class="token punctuation">,</span>String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Person<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Person person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">,</span><span class="token string">"乔峰"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//put到hashmap中去</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span><span class="token string">"天龙八部"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//get取出，从逻辑上讲应该能输出“天龙八部”</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结果:"</span><span class="token operator">+</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">,</span><span class="token string">"萧峰"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>实际输出结果：<font color='red'>null</font></p><p><strong>原因</strong>：尽管我们在进行get和put操作的时候，使用的key从逻辑上讲是等值的（通过equals比较是相等的），但由于没有重写hashCode方法，所以put操作时，key(hashcode1)–&gt;hash–&gt;indexFor–&gt;最终索引位置 ，而通过key取出value的时候 key(hashcode1)–&gt;hash–&gt;indexFor–&gt;最终索引位置，由于hashcode1不等于hashcode2，导致没有定位到一个数组位置而返回逻辑上错误的值null（也有可能碰巧定位到一个数组位置，但是也会判断其entry的hash值是否相等，上面get方法中有提到。）</p><p>所以，在重写equals的方法的时候，必须注意重写hashCode方法，同时还要保证通过equals判断相等的两个对象，调用hashCode方法要返回同样的整数值。而如果equals判断不相等的两个对象，其hashCode可以相同（只不过会发生哈希冲突，应尽量避免）。</p><h3 id="10-JDK7和-JDK8中HashMap的大致变化"><a href="#10-JDK7和-JDK8中HashMap的大致变化" class="headerlink" title="10 JDK7和 JDK8中HashMap的大致变化"></a>10 JDK7和 JDK8中HashMap的大致变化</h3><ul><li>1.7中采用数组+链表，1.8采用的是数组+链表/红黑树，即在<font color='red'>1.8中链表长度超过一定长度（默认为8）后就改成红黑树存储</font>。</li><li>1.7扩容时需要重新计算哈希值和索引位置，1.8并不重新计算哈希值，巧妙地采用和扩容后容量进行&amp;操作来计算新的索引位置，只需要看看原来的hash值新增的那个bit是1还是0就好了，是0的话索引没变，是1的话索引变成“原索引+oldCap”。</li><li>1.7是采用<font color='blue'>表头插入法</font>插入链表，1.8采用的是<font color='blue'>尾部插入</font>法。 </li><li>在1.7中采用表头插入法，在扩容时会改变链表中元素原本的顺序，以至于<font color='red'>在并发场景下导致链表成环的问题</font>；在1.8中采用尾部插入法，在扩容时会保持链表元素原本的顺序，就不会出现链表成环的问题了。</li></ul><table><thead><tr><th align="center">不同</th><th align="center">JDK 1.7</th><th align="center">JDK 1.8</th></tr></thead><tbody><tr><td align="center">存储结构</td><td align="center">数组 + 链表</td><td align="center">数据 + 链表/红黑树</td></tr><tr><td align="center">初始化方式</td><td align="center">单独函数：<code>inflateTable()</code></td><td align="center">集成到了扩容函数<code>resize()</code>中</td></tr><tr><td align="center">hash值计算方式</td><td align="center">扰动处理 = 9次扰动 = 4次位运算 + 5次异或运算</td><td align="center">扰动处理 = 2次扰动 = 1次位运算 + 1次异或运算</td></tr><tr><td align="center">存放数据的规则</td><td align="center">无冲突时，存放到数组；<br>冲突时，存放到链表</td><td align="center">无冲突时，存放到数组；<br>冲突 &amp; 链表长度 &lt;= 8时，存放单链表<br>冲突 &amp; 链表长度 &lt; 8时，链表转红黑树</td></tr><tr><td align="center">插入数据方式</td><td align="center">头插法（先将原位置的数据移到后1位，在插入数据到该位置）</td><td align="center">尾插法（直接插入到链表尾部/红黑树）</td></tr><tr><td align="center">扩容后存储位置的计算方式</td><td align="center">全部按照原来的方式重新计算<br>（即hashCode -&gt;&gt; 扰动函数 -&gt;&gt; (h&amp;length-1)）</td><td align="center">按照扩容后的规律计算<br>（即扩容后的位置 = 原位置 or 原位置+旧数组容量）</td></tr></tbody></table><h2 id="2-ConcurrentHashMap-底层原理"><a href="#2-ConcurrentHashMap-底层原理" class="headerlink" title="2 ConcurrentHashMap 底层原理"></a>2 ConcurrentHashMap 底层原理</h2><h3 id="2-1-HashMap-和-ConcurrentHashMap-的区别"><a href="#2-1-HashMap-和-ConcurrentHashMap-的区别" class="headerlink" title="2.1 HashMap 和 ConcurrentHashMap 的区别"></a>2.1 HashMap 和 ConcurrentHashMap 的区别</h3><ol><li><p>都是 key-value 形式的存储数据。<font color='red'>HashMap的键值对允许有null，但是ConCurrentHashMap都不允许。</font></p></li><li><p><font color='red'>HashMap 是线程不安全的，ConcurrentHashMap 是 JUC 下的线程安全的</font>。</p></li><li><p><font color='red'>HashMap 底层数据结构</font>是数组 + 链表（JDK 1.8 之前）。JDK 1.8 之后是数组 + 链表 + 红黑树。当链表中元素个数达到 8 的时候，链表的查询速度不如红黑树快，链表会转为红黑树，红黑树查询速度快；HashMap 初始数组大小为 16（默认），当出现扩容的时候，以 0.75 * 数组大小的方式进行扩容；</p></li><li><p>ConcurrentHashMap 在 JDK 1.8 之前是采用分段锁来实现的 Segment + HashEntry，Segment 数组大小默认是 16，2 的 n 次方，<font color='red'>对整个桶数组进行了分割分段(Segment)，然后在每一个分段上都用lock锁进行保护</font>，相对于HashTable的synchronized锁的粒度更精细了一些，并发性能更好。</p><p>JDK 1.8 之后，<font color='red'>采用 Node + CAS + Synchronized 来保证并发安全进行实现</font>。</p><p><strong>HashTable</strong>:</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618164156.png" alt="HashTable" style="zoom:80%;" /></li></ol><p><strong>JDK1.7的ConcurrentHashMap：</strong></p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618164427.png" alt="JDK1.7的ConcurrentHashMap" style="zoom:80%;" /><p><strong>JDK1.8的ConcurrentHashMap（TreeBin: 红黑二叉树节点 Node: 链表节点）：</strong></p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618164541.png" alt="JDK1.8的ConcurrentHashMap"  /><h3 id="2-2-ConcurrentHashMap-底层具体实现知道吗？实现原理是什么？"><a href="#2-2-ConcurrentHashMap-底层具体实现知道吗？实现原理是什么？" class="headerlink" title="2.2 ConcurrentHashMap 底层具体实现知道吗？实现原理是什么？"></a>2.2 ConcurrentHashMap 底层具体实现知道吗？实现原理是什么？</h3><blockquote><p>JDK 1.7</p></blockquote><p>首先将数据分为一段一段的存储，然后给每一段数据配一把锁，当一个线程占有锁访问其中一段数据时，其他段的数据也能被其他线程访问。</p><p>在JDK1.7中，ConcurrentHashMap采用Segment + HashEntry 的方式进行实现，结构如下：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618190641.png" style="zoom:80%;" /><p>一个ConcurrentHashMap里包含一个Segment数组。<font color='red'>Segment的结构和HashMap类似，是一种数组和链表结构</font>，<font color='red'>一个Segment包含一个HashEntry数组</font>，每个HashEntry是一个链表结构的元素，每个Segment守护着一个HashEntry数组里的元素，<font color='red'>当对HashEntry数组的数据进行修改时，必须首先获得对应的Segment的锁</font>。</p><ul><li>该类包含两个静态内部类 HashEntry 和 Segment。前者用来封装映射表的键值对，后者用来充当锁的角色。</li><li><font color='red'>Segment 是一种可重入锁ReentrantLock</font>，每个Segment 守护一个HashEntry数组里的元素，当对HashEntry数组的数据进行修改时，必须首先获得对应的Segment锁。</li></ul><blockquote><p>JDK1.8</p></blockquote><p>在JDK1.8中，放弃了Segment臃肿的设计，<strong><font color='red'>取而代之的是Node + CAS + Synchronized来保证并发安全</font></strong>。<strong><font color='red'>Synchronized只锁当前链表或红黑树二叉树的首节点</font></strong>，这样只要hash不冲突，就不会产生并发，效率又提高了N倍。</p><p>在JDK1.8中，结构如下:</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618191702.png" style="zoom:80%;" /><p><strong>插入过程：</strong></p><p>整体代码：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** Implementation for put and putIfAbsent */</span><span class="token keyword">final</span> V <span class="token function">putVal</span><span class="token punctuation">(</span>K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null <span class="token operator">||</span> value <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// 获取key的hash值</span>    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// tab为空时，初始化</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// i = (n - 1) &amp; hash) 索引位置，索引位置处的Node还没有初始化，则调用CAS插入相应的数据</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> null<span class="token punctuation">,</span>                         <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// no lock when adding to empty bin</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            V oldVal <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 对当前链表或红黑二叉树的首节点加锁</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 索引位置处的值为加锁的首节点，也即索引位置处的Node不为空</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 如果是链表结构</span>                    <span class="token comment" spellcheck="true">// fh = f.hash,如果该节点的hash不小于0，则遍历链表更新节点或插入新节点；</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 遍历链表</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            K ek<span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// 两者hash相同，key也相同，直接更新key的值即可</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>                                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>                                 <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>                                    <span class="token comment" spellcheck="true">// 更新key的值</span>                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                            Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// 遍历到链表结尾</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// 在链表尾部插入新节点</span>                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>                                                          value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token comment" spellcheck="true">// 如果是红黑树结构</span>                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">;</span>                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 插入节点</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">)</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>                                                              value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 如果binCount不为0，说明put操作对数据产生了影响</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 如果当前链表的个数达到8个，则通过treeifyBin方法转化为红黑树</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD<span class="token punctuation">)</span>                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 如果oldVal不为空，说明是一次更新操作，没有对元素个数产生影响，则直接返回旧值；</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> null<span class="token punctuation">)</span>                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 如果插入的是一个新节点，则执行addCount()方法尝试更新元素个数baseCount；</span>    <span class="token function">addCount</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li><p>如果相应位置的Node还没有初始化，则调用CAS插入相应的数据</p><pre class=" language-java"><code class="language-java"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// no lock when adding to empty bin</span><span class="token punctuation">}</span></code></pre></li><li><p>如果相应位置的Node不为空，且当前该节点不处于移动状态，则对该节点加synchronized锁，如果该节点的hash不小于0，则遍历链表更新节点或插入新节点。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>        K ek<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>             <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>                e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul><h2 id="3-相关面试题"><a href="#3-相关面试题" class="headerlink" title="3 相关面试题"></a>3 相关面试题</h2><h3 id="3-1-如何实现HashMap的有序？"><a href="#3-1-如何实现HashMap的有序？" class="headerlink" title="3.1 如何实现HashMap的有序？"></a>3.1 如何实现HashMap的有序？</h3><p><strong><font color='red'>使用 <code>LinkedHashMap</code> 或是 <code>TreeMap</code>。</font></strong></p><blockquote><p>LinkedHashMap实现有序</p></blockquote><p><font color='red'><code>LinkedHashMap</code>内部维护了一个单链表，有头尾节点</font>，同时LinkedHashMap节点Entry内部<font color='red'>除了继承HashMap的Node属性，还有before 和 after用于标识前置节点和后置节点。可以实现按插入的顺序或访问顺序排序。</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * The head (eldest) of the doubly linked list.*/</span><span class="token keyword">transient</span> LinkedHashMap<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> head<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**  * The tail (youngest) of the doubly linked list.*/</span><span class="token keyword">transient</span> LinkedHashMap<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> tail<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//将加入的p节点添加到链表末尾</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">linkNodeLast</span><span class="token punctuation">(</span>LinkedHashMap<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>  LinkedHashMap<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> last <span class="token operator">=</span> tail<span class="token punctuation">;</span>  tail <span class="token operator">=</span> p<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">==</span> null<span class="token punctuation">)</span>    head <span class="token operator">=</span> p<span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token punctuation">{</span>    p<span class="token punctuation">.</span>before <span class="token operator">=</span> last<span class="token punctuation">;</span>    last<span class="token punctuation">.</span>after <span class="token operator">=</span> p<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//LinkedHashMap的节点类</span><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">HashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token punctuation">{</span>  Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> before<span class="token punctuation">,</span> after<span class="token punctuation">;</span>  <span class="token function">Entry</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>TreeMap实现有序</p></blockquote><p><strong><font color='red'>TreeMap是按照Key的自然顺序或者Comprator的顺序进行排序</font></strong>，内部是通过红黑树来实现。</p><ul><li>TreeMap实现了SortedMap接口，它是一个key有序的Map类</li><li>要么<font color='red'>key所属的类实现Comparable接口</font>，或者是<font color='red'>自定义一个实现了Comparator接口的比较器，传给TreeMap</font>用于key的比较。</li></ul><pre class=" language-java"><code class="language-java">TreeMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>String o1<span class="token punctuation">,</span> String o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> o2<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="3-2-链表红黑树如何互相转换？阈值多少？"><a href="#3-2-链表红黑树如何互相转换？阈值多少？" class="headerlink" title="3.2 链表红黑树如何互相转换？阈值多少？"></a>3.2 链表红黑树如何互相转换？阈值多少？</h3><ol><li><p><strong><font color='red'>链表转红黑树的阈值为：8</font></strong></p><p>经过计算，在hash函数设计合理的情况下，发生hash碰撞8次的几率为百万分之6，从概率上讲，阈值为8足够用</p></li><li><p><strong><font color='red'>红黑树转链表的阈值为：6</font></strong></p><p>因为<font color='red'>如果hash碰撞次数在8附近徘徊，可能会频繁发生链表和红黑树的互相转化操作</font>，为了预防这种情况的发生。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 面试 </tag>
            
            <tag> HashMap底层原理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-JUC】多线程JUC</title>
      <link href="/2021/06/15/mian-shi-juc-duo-xian-cheng-juc/"/>
      <url>/2021/06/15/mian-shi-juc-duo-xian-cheng-juc/</url>
      
        <content type="html"><![CDATA[<hr><p><font color='red'>多线程口诀要点</font>：</p><ul><li><p>线程    操作    资源类</p></li><li><p>判断    工作    通知</p></li><li><p>防止虚假唤醒</p></li></ul><hr><h2 id="1-基础回顾"><a href="#1-基础回顾" class="headerlink" title="1 基础回顾"></a>1 基础回顾</h2><h3 id="1-1-什么是JUC？"><a href="#1-1-什么是JUC？" class="headerlink" title="1.1 什么是JUC？"></a>1.1 什么是JUC？</h3><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211118.png" style="zoom: 80%;" /><p><code>java.util</code>工具包。</p><h3 id="1-2-线程和进程？"><a href="#1-2-线程和进程？" class="headerlink" title="1.2 线程和进程？"></a>1.2 线程和进程？</h3><blockquote><p>进程和线程</p></blockquote><p><strong>进程：</strong>一个程序，QQ.exe Music.exe 程序的集合。任务管理里面可以看到进程。一个进程往往可以包含多个线程。</p><p><strong>线程</strong>：开了一个进程Typora，写字，自动保存（线程负责的）。Java默认有2个线程，main线程和GC守护线程。</p><p>对于Java而言，<code>Thread</code>、<code>Runnable</code>、<code>Callable</code>可以创建线程。</p><p><strong>Java真的可以开启线程吗？？开不了！！!</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**         * This method is not invoked for the main method thread or "system"         * group threads created/set up by the VM. Any new functionality added         * to this method in the future may have to also be added to the VM.         *         * A zero status value corresponds to state "NEW".         */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>threadStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* Notify the group that this thread is about to be started         * so that it can be added to the group's list of threads         * and the group's unstarted count can be decremented. */</span>    group<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">)</span> <span class="token punctuation">{</span>                group<span class="token punctuation">.</span><span class="token function">threadStartFailed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">/* do nothing. If start0 threw a Throwable then                  it will be passed up the call stack */</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 本地方法，调用Java Native Interface</span><span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="1-3-并发和并行"><a href="#1-3-并发和并行" class="headerlink" title="1.3 并发和并行"></a>1.3 并发和并行</h3><p><strong>并发：</strong>多线程操作同一个资源。单核CPU，模拟出来多条线程，CPU的快速交替。</p><p><strong>并行：</strong>多个人一起行走。多核CPU，多个线程可以同时执行。可以使用线程池操作。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 获取CPU的内核数量</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>并发编程的本质：充分利用CPU的资源。</strong></p><h3 id="1-4-线程有几个状态？"><a href="#1-4-线程有几个状态？" class="headerlink" title="1.4 线程有几个状态？"></a>1.4 线程有几个状态？</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> State <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 新建线程</span>    NEW<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 运行</span>    RUNNABLE<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 阻塞</span>    BLOCKED<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 等待，死等</span>    <span class="token comment" spellcheck="true">// 在对象上的线程调用了Object.wait()会进入WAITING状态，直到另一个线程在这个对象上调用了Object.notify()或Object.notifyAll()方法才能恢复</span>    <span class="token comment" spellcheck="true">// object.wait 和 notify、notifyAll 是等待-通知模式。用于在一定的条件下，调用 wait 方法，线程会释放锁，不会发生阻塞。</span>    WAITING<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 超时等待，过时不候</span>    TIMED_WAITING<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 终止</span>    TERMINATED<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="1-5-wait和sleep的区别"><a href="#1-5-wait和sleep的区别" class="headerlink" title="1.5 wait和sleep的区别"></a>1.5 wait和sleep的区别</h3><p><strong>1、来自不同的类</strong></p><p>wait =&gt; Object</p><p>sleep =&gt; Thread</p><p><strong>2、关于锁的释放</strong></p><p><font color='red'>wait 会释放锁</font>，<font color='blue'>sleep 睡觉了，抱着锁睡觉了，不会释放</font>！</p><p><strong>3、使用的范围是不同的</strong></p><p><font color='red'>wait必须在同步代码块中使用</font>。</p><p>sleep可以在任何地方使用。</p><h3 id="1-6-Lambda表达式"><a href="#1-6-Lambda表达式" class="headerlink" title="1.6 Lambda表达式"></a>1.6 Lambda表达式</h3><p>Lambda表达式是<font color='red'>针对接口</font>的，实现接口里的抽象方法。</p><blockquote><p>Java中接口的变化</p></blockquote><ul><li><p>JDK1.7中，接口包含以下内容</p><ul><li>常量</li><li>抽象方法</li></ul></li><li><p>JDK1.8中，接口还包含了以下内容</p><ul><li><font color='red'>默认方法</font><ul><li><font color='red'>被default修饰的会有默认实现</font>，不影响Lambda表达式的使用，其实现类不必强行实现默认方法</li></ul></li><li><font color='red'>静态方法</font><ul><li><font color='red'>被static修饰的</font>，实现类无法继承。</li></ul></li></ul></li><li><p>JDK1.9中，接口还包含了</p><ul><li>私有方法</li></ul></li></ul><blockquote><p>可用于Lambda表达式的接口要求</p></blockquote><ul><li><font color='red'>接口中只能有一个未被实现的抽象方法</font><ul><li>抽象方法默认是带abstract修饰的。</li></ul></li><li><font color='blue'>默认方法（default）、静态方法（static）不影响</font>。</li></ul><blockquote><p>Lambda表达式书写技巧</p></blockquote><ul><li><font color='red'>拷贝小括号，写死右箭头，落地大括号</font></li><li><font color='blue'>@FunctionalInterface</font>(默认一个方法的时候，自动加上)</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 定义接口</span><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">interface</span> <span class="token class-name">Foo</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 只能有一个抽象方法</span><span class="token comment" spellcheck="true">//    public void sayHello();    // 无参无返回值</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">sumNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 有参有返回值</span>    <span class="token comment" spellcheck="true">// 默认方法</span>    <span class="token keyword">public</span> <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> x<span class="token operator">/</span>y<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mv</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"staic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> x<span class="token operator">*</span>y<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1.匿名内部类写法</span><span class="token comment" spellcheck="true">//        Foo foo = new Foo() {</span><span class="token comment" spellcheck="true">//            </span><span class="token comment" spellcheck="true">//            @Override</span><span class="token comment" spellcheck="true">//            public void sayHello() {</span><span class="token comment" spellcheck="true">//                System.out.println("hello，匿名内部类");</span><span class="token comment" spellcheck="true">//            }</span><span class="token comment" spellcheck="true">//        };</span>        <span class="token comment" spellcheck="true">// 2.Lambda表达式写法：拷贝小括号，写死右箭头，落地大括号</span>        <span class="token comment" spellcheck="true">// 实现无参抽象方法的内容</span><span class="token comment" spellcheck="true">//        Foo foo = () -> {</span><span class="token comment" spellcheck="true">//            System.out.println("hello，Lambda表达式");</span><span class="token comment" spellcheck="true">//        };</span>        <span class="token comment" spellcheck="true">// 实现有参有返回值抽象方法的内容</span>        Foo foo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"有参，有返回值"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> x<span class="token operator">+</span>y<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        foo.sayHello();</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span><span class="token function">sumNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Foo<span class="token punctuation">.</span><span class="token function">mv</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-Lock锁"><a href="#2-Lock锁" class="headerlink" title="2 Lock锁"></a>2 Lock锁</h2><p>多线程编程企业级套路+模板，下面以卖票的例子来说明。</p><ul><li>在<font color='blue'>高内聚低耦合</font>的前提下， <font color='red'>线程    操作(资源类中对外暴露操作方法）    资源类</font></li></ul><h3 id="2-1-Synchronized"><a href="#2-1-Synchronized" class="headerlink" title="2.1 Synchronized"></a>2.1 Synchronized</h3><p>首先以Synchronized加锁+Lambda表达式的方式书写。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 真正的多线程开发，公司中的开发 * 线程就是一个单独的资源类，没有任何附属的操作！ */</span><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Ticket</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 属性：初始值</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> numbers <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 操作(对外提供的方法)</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>numbers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"卖出了第"</span><span class="token operator">+</span><span class="token punctuation">(</span>numbers<span class="token operator">--</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"张票，还剩"</span><span class="token operator">+</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 并发：多个线程操作同一个资源类</span>        Ticket ticket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// A与B合卖这30张票，每个人理论上可以卖40张票</span>        <span class="token comment" spellcheck="true">// A、B两个人，所以需要实现两个线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ticket<span class="token punctuation">.</span><span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ticket<span class="token punctuation">.</span><span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-Lock锁"><a href="#2-2-Lock锁" class="headerlink" title="2.2 Lock锁"></a>2.2 Lock锁</h3><p>Synchronized虽好，但是大多公司使用的是Lock锁，所以把Synchronized写法改成Lock写法。</p><p>Lock锁是使用在资源类中的，来替换Synchronized。Lock锁使用三部曲：</p><ol><li><font color='red'>创建锁Lock lock = new ReentrantLock();</font></li><li><font color='red'>加锁 lock.lock();</font></li><li><font color='red'>释放锁 lock.unlock();</font></li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Ticket</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 属性：初始值</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> numbers <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 1.创Lock锁</span>    Lock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 操作(对外提供的方法)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 必须是：try{加锁}finally{释放锁}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 2.加锁</span>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 方法内容</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>numbers <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"卖出了第"</span><span class="token operator">+</span><span class="token punctuation">(</span>numbers<span class="token operator">--</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"张票，还剩"</span><span class="token operator">+</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"张票"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 3.释放锁</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 并发：多个线程操作同一个资源类</span>        Ticket ticket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// A、B、C合卖这30张票，每个人理论上可以卖40张票</span>        <span class="token comment" spellcheck="true">// A、B、C个人，所以需要实现三个线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ticket<span class="token punctuation">.</span><span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ticket<span class="token punctuation">.</span><span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ticket<span class="token punctuation">.</span><span class="token function">saleTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>Synchronized和Lock的区别</p></blockquote><p>1、Synchronized是内置的<font color='red'>Java关键字</font>，Lock是一个<font color='red'>Java类</font>。</p><p>2、Synchronized无法判断锁的状态，Lock可以判断是否获取到了锁。</p><p>3、Synchronized会自动释放锁。<font color='blue'>Lock需要手动释放锁，如果不释放锁，就会<strong>死锁</strong></font>。</p><p>4、Synchronized <font color='blue'>线程1（获得锁，阻塞），线程2（等待，傻傻的等）</font>；Lock锁就可能不会死等。</p><p>5、Synchronized 可重入锁，不可以中断，非公平锁；Lock 可重入锁，可以中断锁，非公平（可以自己设置）。</p><p>6、Synchronized 适合锁<font color='red'>少量</font>的代码同步问题；Lock 适合锁<font color='red'>大量</font>的同步代码。</p><h3 id="2-3-八锁理论"><a href="#2-3-八锁理论" class="headerlink" title="2.3 八锁理论"></a>2.3 八锁理论</h3><p>synchronized实现同步的基础：java中的每一个对象都可以作为锁。</p><p>具体表现为以下三种形式。</p><ol><li><p>对于<font color='blue'>普通同步方法</font>，<font color='red'>锁的是当前对象this</font>。</p></li><li><p>对于<font color='blue'>同步方法块</font>，<font color='red'>锁的是synchronized括号里配置的对象</font>。</p></li><li><p>对于<font color='blue'>静态同步方法</font>，<font color='red'>锁是当前类的class对象</font>。</p></li></ol><p>因此，问题的关键是：<font color='red'>明确锁的是对象this，还是类Class！！！</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span>  <span class="token class-name">Phone</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 利用 TimeUnit 来设置睡眠时间，更精确</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"*************sendEmail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"***********sendMS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 普通方法</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"*************sendHello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lock8Demo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 定义资源类</span>        Phone phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Phone phone2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 多线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            phone<span class="token punctuation">.</span><span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//            phone.sendMS();</span><span class="token comment" spellcheck="true">//            phone.sayHello();</span>            phone2<span class="token punctuation">.</span><span class="token function">sendMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>1.标准访问，先打印邮件还是短信? </p><p>ans：邮件</p></blockquote><blockquote><p>2.邮件方法中先暂停4秒后打印，先打印邮件还是短信?</p><p>ans：邮件</p></blockquote><p><strong><em>原因</em></strong>：<font color='red'>对象锁。本次锁的是对象this。</font></p><p><strong><em>例子</em></strong>：两个人(两个线程)同时抢一个手机(同一个对象)，一个人发邮件，一个人发短信，<font color='red'>先到先得</font>。</p><ul><li><font color='blue'>一个对象</font>里面如果有<font color='blue'>多个synchronized方法</font>，某一个时刻内，只要一个线程去调用其中的一个synchronized方法了，<font color='red'>其他的线程都只能等待</font>，换句话说，某一个时刻内，只能有唯一一个线程去访问这些synchronized方法，<font color='red'>锁的是当前对象this，被锁定后，其他的线程都不能进入到当前对象的其他的synchronized方法</font>。</li></ul><blockquote><p>3.资源类中新增sayHello普通方法，先打印邮件还是sayHello普通方法？</p><p>ans：sayHello</p></blockquote><p><strong><em>原因：</em></strong><font color='red'>加个普通方法，与同步锁无关</font>。</p><blockquote><p>4.两部手机，各调用一个方法，先打印邮件还是短信? </p><p>ans：短信</p></blockquote><p><strong><em>原因：</em></strong><font color='blue'>换成两个对象后，不是同一把锁了，互不干扰</font>，因为打印邮件要等4秒，所以先打印短信；如果去掉等4秒，则会先打印邮件（打印邮件的线程在前，先得到锁。？？？线程获取锁的顺序？？？）。</p><p><strong><em>例子</em></strong>：两个人两部手机（两个线程、两个对象），各干各的，不存在争抢</p><ul><li>当一个线程试图访问同步代码块时，它<font color='red'>首先必须得到锁</font>，退出或抛出异常时必须释放锁。也就是说如果一个实例对象的普通同步方法获取锁后，<font color='blue'>该实例对象的其他普通同步方法必须等待获取锁的方法释放锁后才能获取锁</font>，可是<font color='red'>别的实例对象的普通同步方法因为跟该实例对象的普通同步方法用的是不同的锁，所以无需等待该实例对象已获取锁的普通同步方法释放锁就可以获取他们自己的锁</font>。</li></ul><blockquote><p>5.两个静态同步方法，同一部手机，先打印邮件还是短信?</p><p>ans：邮件</p></blockquote><blockquote><p>6.两个静态同步方法，两部手机，先打印邮件还是短信?</p><p>ans：邮件</p></blockquote><p><strong><em>原因：</em></strong><font color='red'>全局锁。锁的是同一个类Class，先到先得。</font></p><p><strong><em>例子：</em></strong>类Class就相当于是造手机时的模板，对象手机对应于真实的一台台手机。</p><ul><li><font color='red'>所有的静态同步方法用的也是同一把锁–类对象本身</font>。</li></ul><blockquote><p>7.一个静态同步方法，一个普通同步方法，同一部手机，先打印邮件还是短信?</p><p>ans：短信</p></blockquote><blockquote><p>8.一个静态同步方法，一个普通同步方法，二部手机，先打印邮件还是短信?</p><p>ans：短信</p></blockquote><p><strong><em>原因：</em></strong><font color='red'>一个锁的是类Class，一个锁的是对象，两个是不同的锁，互不影响。</font>因为打印邮件要等4秒，所以先打印短信；如果去掉等4秒，则会先打印邮件（打印邮件的线程在前，先得到锁）。</p><p><strong><em>例子：</em></strong>一个锁的是造手机的模板，一个锁的是手机本身</p><ul><li>这<font color='red'>两把锁(this/class)是两个不同的对象</font>，所以静态同步方法与非静态同步方法之间是不会有静态条件的。但是一旦一个静态同步方法获取锁后，<font color='blue'>其他的静态同步方法都必须等待该方法释放锁后才能获取锁</font>，而不管是同一个实例对象的静态同步方法之间，还是不同的实例对象的静态同步方法之间，<font color='red'>只要它们同一个类的实例对象</font>。</li></ul><h2 id="3-生产者和消费者问题"><a href="#3-生产者和消费者问题" class="headerlink" title="3 生产者和消费者问题"></a>3 生产者和消费者问题</h2><blockquote><p>案例</p></blockquote><p>题目：现在有两个线程，可以操作初始值为零的一个变量，实现一个线程对该变量加一，一个线程对该变量减一，实现交替，来10轮，变量初始值为0。</p><p>进一步：如果是四个线程，两个线程对该变量加一，两个线程对该变量减一，实现交替？</p><h3 id="3-1-防止线程的虚假唤醒"><a href="#3-1-防止线程的虚假唤醒" class="headerlink" title="3.1 防止线程的虚假唤醒"></a>3.1 防止线程的虚假唤醒</h3><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211227.png" alt="虚假唤醒"></p><h3 id="3-2-线程通信—Synchronized版本"><a href="#3-2-线程通信—Synchronized版本" class="headerlink" title="3.2 线程通信—Synchronized版本"></a>3.2 线程通信—Synchronized版本</h3><blockquote><p>口诀</p></blockquote><ul><li>高内聚低耦合前提下，<font color='red'>线程    操作    资源类</font></li><li><font color='red'>判断   干活    通知</font></li><li><font color='blue'>多线程交互</font>中，必须要防止多线程虚假唤醒(<font color='red'>判断用while，不能用if</font>)</li></ul><p>与synchronized锁配合的<font color='red'>线程等待是Object.wait</font>与<font color='red'>线程通知是Object.notify/Object.notifyAll</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 线程之间的通信问题：生产者和消费者问题！ */</span><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Resource1</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 属性：初始值</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 操作</span>    <span class="token comment" spellcheck="true">// synchronized加锁方式</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 判断（一定要用while防止虚假唤醒）</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 工作</span>        num<span class="token operator">++</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 通知</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 判断</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 工作</span>        num<span class="token operator">--</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 通知</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源</span>        Resource1 resource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 多线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="3-3-线程通信—Lock版本"><a href="#3-3-线程通信—Lock版本" class="headerlink" title="3.3 线程通信—Lock版本"></a>3.3 线程通信—Lock版本</h3><p>对于java.util.concurrent.locks.<font color='red'>ReentrantLock 重入锁</font>，Lock锁实现线程通信是通过java.util.concurrent.locks.<font color='red'>Condition</font>，<font color='blue'>Condition与重入锁是通过lock.newCondition()方法</font>产生一个与当前重入锁绑定的Condtion实例，我们通知该实例来控制线程的等待(<font color='red'>condition.await()</font>)与通知(<font color='red'>condition.signalAll()</font>)。</p><p><strong>Condition介绍</strong></p><ul><li>Condition将Object监视器方法(wait、notify和notifyAll)分解为不同的对象，通过将它们与任意的Lock实现结合使用，实现每个对象有多个等待集的效果。Lock替换synchronized方法和语句的使用，<font color='red'>Condition替换了Object 监视器方法的使用</font>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Resource1</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 属性：初始值</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 创Lock锁</span>    Lock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// </span>    Condition condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 操作</span>    <span class="token comment" spellcheck="true">// Lock加锁方式</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 加锁</span>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 判断（一定要用while防止虚假唤醒）</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//                this.wait();</span>                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 工作</span>            num<span class="token operator">++</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 通知</span><span class="token comment" spellcheck="true">//            this.notifyAll();</span>            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 判断</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//                this.wait();</span>                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 工作</span>            num<span class="token operator">--</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 通知</span><span class="token comment" spellcheck="true">//            this.notifyAll();</span>            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源</span>        Resource1 resource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 多线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="3-4-Lock版本精准通知"><a href="#3-4-Lock版本精准通知" class="headerlink" title="3.4 Lock版本精准通知"></a>3.4 Lock版本精准通知</h3><blockquote><p>案例</p></blockquote><p>多线程之间按顺序调用，实现A -&gt;B -&gt;C，三个线程启动，要求如下：</p><p>A打印5次，B打印10次，C打印15次，接着，A打印5次，B打印10次，C打印15次 ………. 来10轮</p><blockquote><p>分析</p></blockquote><ul><li><p><font color='blue'>synchronized无法精确唤醒相应进程</font>，只能使用Lock锁来实现。</p></li><li><p><font color='red'>Condition的强大之处在于，对于一个锁，我们可以为多个线程间建立不同的Condition。</font></p></li></ul><blockquote><p>口诀</p></blockquote><ul><li>高内聚低耦合前提下，<font color='red'>线程    操作    资源类</font></li><li><font color='red'>判断   干活    通知</font></li><li><font color='blue'>多线程交互</font>中，必须要防止多线程虚假唤醒(<font color='red'>判断用while，不能用if</font>)</li><li><font color='red'>标志位(通过标志位来区分需要唤醒的不同进程)</font></li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Resource1</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 属性：标志位（用于定点唤醒线程）</span>    <span class="token comment" spellcheck="true">// 1代表A线程、2代表B线程、3代表C线程</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 创Lock锁</span>    Lock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 定义三个条件，分别对应标志位flag的1、2、3</span>    Condition condition1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Condition condition2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Condition condition3 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 操作</span>    <span class="token comment" spellcheck="true">// A打印五次</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print5</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 判断(不轮到我工作时，我便一直等待)</span>            <span class="token comment" spellcheck="true">// 防止虚假唤醒</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// A线程等待</span>                condition1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 会释放当前锁，进入等待状态，需要被其他线程通过signal()或signalAll()唤醒</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 工作</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 唤醒</span>            <span class="token comment" spellcheck="true">// A打印五次后，该B打印</span>            <span class="token comment" spellcheck="true">// 修改标志位</span>            flag <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 唤醒B线程</span>            condition2<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// B打印十次</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print10</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 判断</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                condition2<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 工作</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 唤醒</span>            <span class="token comment" spellcheck="true">// B打印十次后，该C打印</span>            flag <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>            condition3<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// C打印十五次</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print15</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 判断</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                condition3<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 工作</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 唤醒</span>            <span class="token comment" spellcheck="true">// C打印十五次后，该A打印</span>            flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            condition1<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源</span>        Resource1 resource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 多线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">print5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// TODO Auto-generated catch block</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">print10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// TODO Auto-generated catch block</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    resource1<span class="token punctuation">.</span><span class="token function">print15</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// TODO Auto-generated catch block</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong><em>tips：</em></strong></p><ul><li>await()与signal()调用流程<ul><li>在调用await()方法<font color='blue'>前线程必须获得重入锁</font>，调用await()方法<font color='blue'>后线程会释放当前占用的锁</font>。</li><li>在调用signal()方法时当前线程也<font color='blue'>必须获得相应重入锁</font>，调用signal()方法后系统会从condition.await()等待队列中<font color='blue'>唤醒一个线程</font>。</li><li>当线程被唤醒后，它就会<font color='red'>尝试重新获得与之绑定的重入锁</font>，一旦获取成功将继续执行。</li><li>调用signal()方法<font color='blue'>后一定要释放当前占用的锁</font>，这样<font color='blue'>被唤醒的线程才能有获得锁的机会</font>，才能继续执行。</li></ul></li><li>print5()方法中，如果flag不等于1，A线程就调用await()方法，使A线程进入等待状态，同时释放锁。直到print15()方法中，flag等于3，C线程修改flag为1，且调用condition1.signal()时，A线程会被精准唤醒，重新竞争到锁后，代码继续往下执行。</li></ul><h2 id="4-集合类不安全"><a href="#4-集合类不安全" class="headerlink" title="4 集合类不安全"></a>4 集合类不安全</h2><h3 id="4-1-List"><a href="#4-1-List" class="headerlink" title="4.1 List"></a>4.1 List</h3><blockquote><p>测试List集合不安全</p></blockquote><p>无论 <code>ArrayList</code> 还是 <code>LinkedList</code> ，都会报并发修改异常 <font color='red'><code>java.util.ConcurrentModificationException</code></font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 不同线程对同一资源的读操作、写操作。</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Exception in thread "Thread-107" java.util.ConcurrentModificationException</span><span class="token comment" spellcheck="true">// 会报并发修改异常</span></code></pre><blockquote><p>解决方案</p></blockquote><ul><li><p><code>Vector()</code></p><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p><code>Collections.synchronizedList()</code>。使用集合工具类。</p><pre class=" language-java"><code class="language-java"> List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p><code>CopyOnWriteArrayList()</code>。<font color='red'>写时复制，读写分离</font></p><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul><blockquote><p>CopyOnWriteArrayList() 的add()方法</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// CopyOnWriteArrayList 的add()方法，读写分离的思想！</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>E e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> ReentrantLock lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 1、当前对象加锁</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 2、在末尾扩容一个单位</span>        <span class="token comment" spellcheck="true">// 列表转成数组</span>        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获取列表长度</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 复制原数组内容，长度比原长度加一</span>        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3、在把扩容后的空间，填上需要add的内容</span>        <span class="token comment" spellcheck="true">// 在新数组末尾添加数据</span>        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 4、将新数组转成列表</span>        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 标志位</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>写时复制思想</p></blockquote><p>CopyOnWrite容器即写时复制的容器。往一个容器添加元素的时候，不直接往当前容器Object[]添加，而是<font color='red'>现将当前容器Object[]进行Copy</font>，复制出一个新的容器Object[] newElements，然后<font color='red'>新的容器Object[] newElements里添加元素</font>，添加完元素之后，<font color='red'>再将原容器的引用指向新的容器setArray(newElements);</font>。这样做的好处是<font color='blue'>可以对CopyOnWrite容器进行并发的读，而不需要加锁</font>，因为当前容器不会添加任何元素。所以CopyOnWrite容器也是一种读写分离的思想，读和写不同的容器。</p><h3 id="4-2-Set"><a href="#4-2-Set" class="headerlink" title="4.2 Set"></a>4.2 Set</h3><blockquote><p>测试Set集合不安全</p></blockquote><p>报 <font color='red'><code>java.util.ConcurrentModificationException</code></font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestSet</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Set<span class="token operator">&lt;</span>Integer<span class="token operator">></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 不同线程对同一资源的读操作、写操作。</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// java.util.ConcurrentModificationException</span></code></pre><blockquote><p>解决方案</p></blockquote><ul><li><p><code>Collections.synchronizedSet</code></p><pre class=" language-java"><code class="language-java">Set<span class="token operator">&lt;</span>String<span class="token operator">></span> set <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p><code>CopyOnWriteArraySet</code></p><ul><li>底层还是使用<code>CopyOnWriteArrayList</code>进行实例化</li></ul><pre class=" language-java"><code class="language-java">Set<span class="token operator">&lt;</span>String<span class="token operator">></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token function">CopyOnWriteArraySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    al <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li></ul><blockquote><p>HashSet底层是什么？</p></blockquote><ul><li>HashSet<font color='red'>底层就是HashMap</font></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>HashSet的add()方法，是<font color='red'>使用map的put方法，添加key-value键值对，其中值添加到key中，value为一个Object类型的常量</font>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// value为Object类型的常量</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Object PRESENT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// add()方法是在map中添加k-v</span><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>E e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> PRESENT<span class="token punctuation">)</span><span class="token operator">==</span>null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="4-3-Map"><a href="#4-3-Map" class="headerlink" title="4.3 Map"></a>4.3 Map</h3><blockquote><p>测试Map不安全</p></blockquote><p>报 <font color='red'><code>java.util.ConcurrentModificationException</code></font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 不同线程对同一资源的读操作、写操作。</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// java.util.ConcurrentModificationException</span></code></pre><blockquote><p>解决方案</p></blockquote><ul><li><p>使用<code>Collections的synchronizedMap</code>方法</p><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">synchronizedMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>使用<code>ConcurrentHashMap</code></p><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul><p><strong>ConcurrentHashMap相关知识：<a href="https://www.cnblogs.com/huangjuncong/p/9478505.html" target="_blank" rel="noopener">https://www.cnblogs.com/huangjuncong/p/9478505.html</a></strong></p><h2 id="5-Callable接口"><a href="#5-Callable接口" class="headerlink" title="5 Callable接口"></a>5 Callable接口</h2><p>Callable接口，是一种让线程执行完成后，能够返回结果的。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617162134.png" style="zoom:80%;" /><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/* 比较 Runnable接口与 Callable接口 */</span><span class="token comment" spellcheck="true">// Runnable接口</span><span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Callable接口</span><span class="token keyword">class</span> <span class="token class-name">MyThread2</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Integer <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">1080</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><font color='blue'>Callable接口与Runnable接口的不同之处</font>：</p><ul><li>Callable接口<font color='red'>有返回值</font>，即Callable&lt;&gt;泛型中是什么类型，返回值就是什么类型。</li><li>Callable接口<font color='red'>会抛出异常</font>。</li><li><font color='red'>覆写方法不一样</font>，Callable接口中是call，Runnable接口中是run。</li></ul><p>我们实现Callable接口，也需要实现call方法，但是这个时候我们还需要有返回值，这个<font color='red'>Callable接口的应用场景一般就在于批处理业务</font>，比如转账的时候，需要给一会返回结果的状态码回来，代表本次操作成功还是失败。</p><p> Callable 被线程执行后，可以返回值，<font color='red'>这个返回值可以被 Future 拿到</font>，也就是说，<font color='red'>Future 可以拿到异步执行任务的返回值</font>。</p><p><strong>Future接口</strong></p><p>Future表示<font color='red'>异步计算的结果</font>。提供的方法用于<font color='red'>检查计算是否完成、等待其完成以及检索计算的结果</font>。</p><ul><li><code>cancel(boolean mayInterruptIfRunning)</code>：尝试取消执行此任务。 如果任务已经完成，已经被取消或由于某种其他原因而无法取消，则此尝试将失败。如果成功，并且当cancel时此任务尚未启动，则此任务不应运行。 如果任务已经开始，那么mayInterruptIfRunning参数确定是否执行此任务的线程应该以试图停止任务被中断。 </li><li><code>isDone()</code>：确定任务是正常完成还是被取消。如果任务完成，返回true。</li><li><code>get()</code>：结果只能在计算完成时使用方法get进行检索，必要时阻塞，直到它准备好。</li></ul><p>Future 接口表示异步任务，是一个可能还没有完成的异步任务的结果。所以说 Callable用于产生结果，Future 用于获取结果。</p><p><strong>FutureTask 类</strong></p><p><font color='red'>FutureTask类实现了Future接口</font>，<font color='blue'>表示一个异步运算的任务</font>。其中包含启动和取消计算、查询查看计算是否完成以及检索计算结果的方法。<font color='red'>只有计算完成后才能检索结果</font>；如果计算尚未完成，get方法将阻塞。</p><p><font color='red'>FutureTask 里面可以传入一个 Callable 的具体实现类，可以对这个异步运算的任务的结果进行等待获取、判断是否已经完成、取消任务等操作</font>。只有当运算完成的时候结果才能取回，如果运算尚未完成 get 方法将会阻塞。</p><p>一个 FutureTask 对象可以对调用了 Callable 和 Runnable 的对象进行包装，由于 FutureTask 也是Runnable 接口的实现类，所以 FutureTask 也可以放入线程池中。</p><blockquote><p>代码测试</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CallableDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Runnable接口实现线程</span>        MyThread myThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Thread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>myThread<span class="token punctuation">)</span><span class="token punctuation">;</span>        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Callable接口实现线程---第3种获得多线程的方式</span>        MyThread2 myThread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Thread的构造方法中只能传入Runnable接口，无法传入Callable接口</span>        <span class="token comment" spellcheck="true">// 所以需要找到Callable接口与Runnable接口之间的桥梁</span>        <span class="token comment" spellcheck="true">// 该桥梁需要实现Runnable接口，而 FutureTask类实现了Runnable接口，而且该类的构造方法传入的是Callable接口</span><span class="token comment" spellcheck="true">//        FutureTask&lt;Integer> futureTask = new FutureTask&lt;>(myThread2);</span>        <span class="token comment" spellcheck="true">// FutureTask类传入的是Lambda表达式实现的Callable接口，带有返回值，表示这是一个异步运算任务</span>        FutureTask<span class="token operator">&lt;</span>Integer<span class="token operator">></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Callable接口~~~~Lambda表达式"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span>  <span class="token number">123</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">,</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 结果会被缓存，只会打印一次</span>        <span class="token comment" spellcheck="true">// 等待计算完成，然后检索其结果。</span>        <span class="token comment" spellcheck="true">// 这个get()可能会产生阻塞！也就是说 futureTask.get() 需要放在最后执行，这样不会导致主线程阻塞</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210520192221.png" alt=""></p><ul><li>有缓存！</li><li>结果可能需要等待，会阻塞！</li><li>更详细关于get()方法产生阻塞的思想，参考下面视频：<a href="https://www.bilibili.com/video/BV1vE411D7KE?p=54" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1vE411D7KE?p=54</a></li></ul><p><strong><em>注意：</em></strong></p><ul><li><p>使用下面算法，使用类似于自旋锁的方式来进行<font color='blue'>判断是否运行完毕</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 判断futureTask是否计算完成</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>futureTask<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></li><li><p><font color='blue'>多个线程执行 一个FutureTask的时候，只会计算一次</font></p><pre class=" language-java"><code class="language-java">FutureTask<span class="token operator">&lt;</span>Integer<span class="token operator">></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 开启两个线程计算futureTask</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">,</span> <span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">,</span> <span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p><font color='blue'>如果要两个线程同时计算任务的话，那么需要这样写，需要定义两个futureTask</font></p><pre class=" language-java"><code class="language-java">FutureTask<span class="token operator">&lt;</span>Integer<span class="token operator">></span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>FutureTask<span class="token operator">&lt;</span>Integer<span class="token operator">></span> futureTask2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 开启两个线程计算futureTask</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">,</span> <span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask2<span class="token punctuation">,</span> <span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ul><h2 id="6-三种线程通信的常用辅助类"><a href="#6-三种线程通信的常用辅助类" class="headerlink" title="6 三种线程通信的常用辅助类"></a>6 三种线程通信的常用辅助类</h2><h3 id="6-1-CountDownLatch"><a href="#6-1-CountDownLatch" class="headerlink" title="6.1 CountDownLatch"></a>6.1 CountDownLatch</h3><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524211958.png" alt=""></p><p><code>CountDownLatch</code>维护了一个计数器，有两个核心方法：<code>countDown()</code> 和 <code>await()</code>：</p><ul><li>当计数器的值不为零时，一个或多个线程调用await方法时，这些线程会进入阻塞状态。  </li><li>其他线程调用<code>countDown</code>方法会将计数器减1(调用countDown方法的线程不会阻塞)。</li><li>当计数器的值变为0时，因await方法阻塞的线程会被唤醒，继续执行。</li></ul><p>应用场景举例：学生全部都走完了，班长才能走人锁门。</p><blockquote><p><strong>CountDownLatch 代码示例</strong></p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 案例： * 教室中5名学生,当5名学生全部出教室后,班长(即main线程)才能关教室门。 * 不关心这5名学生出教室的先后顺序。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreeAuxiliaryClassDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 测试 CountDownLatch 计数器</span>        CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 初始化次数为 5</span>        <span class="token comment" spellcheck="true">// 五个人先后离开教室后，班长main线程才能离开教室</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 离开了教室!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 计数器减1操作</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 等待上述线程执行完成（等待计数减为 0）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t最后离开了教室！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p><strong>CountDownLatch + 枚举类的使用</strong></p></blockquote><p><font color='red'>枚举类很重要，有时候使用枚举类会有奇效。</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 定义枚举类 * 可以通过 CountryEnum.ONE 获得齐国对应的 CountryEnum 对象 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span> CountryEnum <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 第一个表示编号 retCode     * 第二个表示国家 retMsg     */</span>    <span class="token function">ONE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"齐"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TWO</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"楚"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">THREE</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"燕"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">FOUR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"赵"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">FIVE</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">"魏"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SIX</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"韩"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Integer retCode<span class="token punctuation">;</span>    <span class="token keyword">private</span> String retMsg<span class="token punctuation">;</span>    <span class="token function">CountryEnum</span><span class="token punctuation">(</span>Integer retCode<span class="token punctuation">,</span> String retMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>retCode <span class="token operator">=</span> retCode<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>retMsg <span class="token operator">=</span> retMsg<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Integer <span class="token function">getRetCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> retCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getRetMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> retMsg<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRetCode</span><span class="token punctuation">(</span>Integer retCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>retCode <span class="token operator">=</span> retCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRetMsg</span><span class="token punctuation">(</span>String retMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>retMsg <span class="token operator">=</span> retMsg<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 根据序号 idx，获取对应的国家     * @param idx     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> CountryEnum <span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">int</span> idx<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取枚举类中的所有值</span>        CountryEnum<span class="token punctuation">[</span><span class="token punctuation">]</span> countryEnums <span class="token operator">=</span> CountryEnum<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>CountryEnum countryEnum <span class="token operator">:</span> countryEnums<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">==</span> countryEnum<span class="token punctuation">.</span><span class="token function">getRetCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> countryEnum<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 利用枚举类来封装6国 * main线程表示秦国，其余6个线程表示6国，来模拟秦灭六国 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// CountDownLatch 计数器</span>        CountDownLatch countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 六个线程模拟六国</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 国被灭"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 计数器减一</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>CountryEnum<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRetMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 等待上述线程执行完成（等待计数减为 0）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t ***秦国一统天下****"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615211440.png" style="zoom: 80%;" /><h3 id="6-2-CyclicBarrier"><a href="#6-2-CyclicBarrier" class="headerlink" title="6.2 CyclicBarrier"></a>6.2 CyclicBarrier</h3><p>和CountDownLatch相反，需要集齐七颗龙珠，召唤神龙。也就是做加法，开始是0，加到某个值的时候就执行。</p><p>CyclicBarrier的字面意思就是可循环（cyclic）使用的屏障（Barrier）。它要求做的事情是，让一组线程到达一个屏障（也可以叫同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会开门，所有被屏障拦截的线程才会继续干活，线程进入屏障通过CyclicBarrier的await方法</p><p>应用场景举例：七个人来齐了，才能开会，人不够，一直等。</p><blockquote><p>测试代码</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 案例： * 7个领导要开会,必须人来齐了才能开始。 */</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 测试 CyclicBarrier</span>    <span class="token comment" spellcheck="true">/**    * 定义一个循环屏障，参数1：需要累加的值，参数2 需要执行的方法    */</span>    CyclicBarrier cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 七个人齐了，开会</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"七个人齐了，开会！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t来了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 先到的被阻塞，等全部线程完成后，才能执行方法</span>                cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 不够七个人的话，就一直等</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>在 Java 中 CycliBarriar 和 CountdownLatch 有什么区别？</p></blockquote><p>CountDownLatch与CyclicBarrier都是用于控制并发的工具类，都可以理解成维护的就是一个计数器，但是这两者还是各有不同侧重点的：</p><ul><li><p><strong>CountDownLatch</strong>一般用于<font color='red'>某个线程A等待若干个其他线程执行完任务之后，它才执行</font>，CountDownLatch强调一个线程等多个线程完成某件事情。</p><p>CyclicBarrier一般用于<font color='red'>一组线程互相等待至某个状态，然后这一组线程再同时执行</font>，CyclicBarrier是多个线程互等，等大家都完成，再携手共进。</p></li><li><p>调用<strong>CountDownLatch</strong>的<strong>countDown</strong>方法后，当前线程<font color='red'>并不会阻塞，会继续往下执行</font>。</p><p>调用<strong>CyclicBarrier</strong>的<strong>await</strong>方法，<font color='red'>会阻塞当前线程</font>，直到CyclicBarrie<font color='red'>r指定的线程全部都到达了指定点的时候，才能继续往下执行</font>；</p></li><li><p><strong>CountDownLatch</strong>方法比较少，操作比较简单。</p><p><strong>CyclicBarrier</strong>提供的方法更多，比如能够通过getNumberWaiting()，isBroken()这些方法获取当前多个线程的状态，并且CyclicBarrier的构造方法可以传入barrierAction，指定当所有线程都到达时执行的业务功能；</p></li><li><p><strong>CountDownLatch</strong>是<font color='red'>不能复用的</font>，而<strong>CyclicLatch</strong>是<font color='red'>可以复用的</font>。</p></li></ul><h3 id="6-3-Semaphore"><a href="#6-3-Semaphore" class="headerlink" title="6.3 Semaphore"></a>6.3 Semaphore</h3><p>信号量主要用于两个目的：</p><ul><li>一是用于多个共享资源的互斥使用；</li><li>一是用于<font color='red'>并发线程数的控制</font></li></ul><p>构造器 <code>Semaphore(int)</code> 用于<font color='red'>指定共享资源的数目</font>，如果设定为 1 ，则 Semaphore 信号量退化为 Lock 锁或者 synchronized 锁。</p><p>在信号量上我们定义两种操作：</p><ul><li><strong>acquire</strong>（获取）：当一个线程调用 acquire 操作时，它要么成功获得信号量（同时信号量减1），要么一直等待下去，直到有其它线程释放信号量，或是超时。</li><li><strong>release</strong>（释放）：实际上会将信号量加1，然后唤醒等待的线程。</li></ul><p>应用场景举例：多个线程抢少量资源。6辆车抢3个车位。</p><blockquote><p>测试代码</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 案例： * 6辆车抢4个车位,只有抢到车位的车释放了之后,后面的车才能抢到。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreeAuxiliaryClassDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 测试 Semaphore</span>        <span class="token comment" spellcheck="true">/**        * 初始化一个信号量为3，默认是false 非公平锁， 模拟3个停车位        */</span>        Semaphore semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 模拟资源类，有4个空车位</span>        <span class="token comment" spellcheck="true">// 六个线程，即六辆车</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 代表一辆车，已经占用了该车位</span>                    semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 申请资源，没有申请到的等待下去</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"号车抢到了车位~~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 暂停一会线程</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"号车离开了车位"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 释放停车位</span>                    semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 释放资源，唤醒等待的线程</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210519210125.png" style="zoom:80%;" /><h2 id="7-读写锁-ReadWriteLock"><a href="#7-读写锁-ReadWriteLock" class="headerlink" title="7 读写锁 ReadWriteLock"></a>7 读写锁 ReadWriteLock</h2><p><code>ReadWriteLock</code>读写锁，一个用于只读操作，一个用于写入。</p><blockquote><p>对同一个资源，五个线程读，五个线程写？</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MyCache</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//volatile:，保证可见性，不保证原子性，一个线程修改后，通知更新</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 写操作</span>    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">put</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---写入数据"</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程暂停一会</span>            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---写入成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 读操作</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---读取数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程暂停一会</span>            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---读取完成"</span><span class="token operator">+</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyCache myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 五个写线程</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Lambda表达式中不能直接使用变量，只能使用final修饰的变量</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span> tempInt<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 五个读线程</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210520194827.png" style="zoom:67%;" /><p><strong><em>出现的问题：</em></strong></p><p>写入数据的时候，还没写入完成，其他线程就开始读取数据，破坏了数据的一致性。所以<font color='red'>需要在统一数据写入完成后，才能读取数据。</font>因此需要使用<code>ReadWriteLock</code>读写锁。</p><p>使用<code>ReadWriteLock</code>可以解决这个问题，它保证：</p><ul><li>只允许一个线程写入（其他线程既不能写入也不能读取）；</li><li>没有写入时，多个线程允许同时读（提高性能）。</li><li><font color='red'>适合读多写少的场景</font>。</li></ul><blockquote><p>使用<code>ReadWriteLock</code></p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 多个线程同时读一个资源类没有任何问题，所以为了满足并发量，读取共享资源应该可以同时进行。 * 但是，如果有一个线程想去写共享资源，就不应该再有其他线程可以对该资源进行读或写。 * 独占锁(写锁)：一次只能被一个线程写。 * 共享锁(读锁)：多个线程可以同时读。 * ReadWriteLock *         读-读 可以共存 *         读-写 不能共存 *         写-写 不能共存 */</span><span class="token keyword">class</span> <span class="token class-name">MyCache</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//volatile:，保证可见性，不保证原子性，一个线程修改后，通知更新</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 读写锁</span>    ReadWriteLock readWriteLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 写操作 写锁 只有一个线程独占</span>    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">put</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 写锁加锁</span>        readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---写入数据"</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程暂停一会</span>            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---写入成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 读操作 读锁    所有线程都可读</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 读锁加锁</span>        readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---读取数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程暂停一会</span>            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" ---读取完成"</span><span class="token operator">+</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyCache myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 五个写线程</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// Lambda表达式中不能直接使用变量，只能使用final修饰的变量</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span> tempInt<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 五个读线程</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p><strong><em>为什么读操作也要加锁？</em></strong></p></blockquote><p>ans：<font color='red'>读的时候如果没有加锁，读到一半可能会有线程写入数据 从而导致读取的数据出错，给读加锁就不会出现这个问题</font>。怕读到一半，被其他线程插入写，这样就导致读到的数据是连续的。</p><h2 id="8-阻塞队列-BlockingQueue"><a href="#8-阻塞队列-BlockingQueue" class="headerlink" title="8 阻塞队列 BlockingQueue"></a>8 阻塞队列 BlockingQueue</h2><h3 id="8-1-阻塞队列的用处"><a href="#8-1-阻塞队列的用处" class="headerlink" title="8.1 阻塞队列的用处"></a>8.1 阻塞队列的用处</h3><blockquote><p>阻塞和队列</p></blockquote><p><font color='red'>阻塞：必须要阻塞/不得不阻塞</font>。</p><p><strong>什么情况下会使用阻塞队列：多线程并发处理，线程池！</strong></p><p>阻塞队列是一个队列，在数据结构中起的作用如下图所示。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210520203749.png" alt="阻塞队列"></p><p><font color='red'>线程1往阻塞队列里添加元素，线程2从阻塞队列中移除元素</font>。</p><p><strong><em>注意</em></strong>：</p><ul><li>当阻塞队列是<font color='red'>空</font>的，从队列中<font color='blue'>获取</font>元素的操作将会被<font color='blue'>阻塞</font>，直到其他线程往空的队列里插入新的元素。</li><li>当阻塞队列是<font color='red'>满</font>的，从队列中<font color='blue'>添加</font>元素的操作将会被<font color='blue'>阻塞</font>，直到其他线程从队列里移除一个或多个元素或者完全清空，使队列变得空闲起来并后续新增。</li></ul><blockquote><p>阻塞队列UML图</p></blockquote><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210520210623.png" alt=""></p><h3 id="8-2-阻塞队列的种类分析"><a href="#8-2-阻塞队列的种类分析" class="headerlink" title="8.2 阻塞队列的种类分析"></a>8.2 阻塞队列的种类分析</h3><table><thead><tr><th align="center">阻塞队列的种类</th><th align="center">介绍</th></tr></thead><tbody><tr><td align="center"><font color='red'>ArrayBlockingQueue</font></td><td align="center">由<font color='blue'>数组</font>结构组成的<font color='red'>有界阻塞队列</font></td></tr><tr><td align="center"><font color='red'>LinkedBlockingQueue</font></td><td align="center">由<font color='blue'>链表</font>结构组成的<font color='red'>有界阻塞队列</font>（大小默认值为Integer.MAX_VALUE）</td></tr><tr><td align="center"><font color='purple'>SynchronousQueue</font></td><td align="center">不存储元素的阻塞队列，也即<font color='purple'>单个元素的队列</font>。<font color='blue'>每个插入操作必须等到另一个线程调用移出操作，否则插入操作一直处于阻塞状态</font>，吞吐量通常要高</td></tr><tr><td align="center">LinkedBlocking<font color='red'>Deque</font></td><td align="center">由链表组成的<font color='red'>双向阻塞队列</font></td></tr><tr><td align="center">PriorityBlockingQueue</td><td align="center">支持优先级排序的无界阻塞队列</td></tr><tr><td align="center">DelayQueue</td><td align="center">使用优先级队列实现的延迟无界阻塞队列</td></tr><tr><td align="center">LinkedTransferQueue</td><td align="center">由链表组成的无界阻塞队列</td></tr></tbody></table><blockquote><p>阻塞队列四组API</p></blockquote><table><thead><tr><th align="center">方式类型</th><th align="center">抛出异常</th><th align="center">特殊值</th><th align="center">阻塞等待</th><th align="center">超时等待</th></tr></thead><tbody><tr><td align="center">添加</td><td align="center">add(e)</td><td align="center">offer(e)</td><td align="center">put(e)</td><td align="center">offer(e,time,unit)</td></tr><tr><td align="center">移除</td><td align="center">remove()</td><td align="center">poll()</td><td align="center">take()</td><td align="center">poll(time,unit)</td></tr><tr><td align="center">查看队首元素</td><td align="center">element()</td><td align="center">peek()</td><td align="center">\</td><td align="center">\</td></tr></tbody></table><table><thead><tr><th>种类</th><th></th></tr></thead><tbody><tr><td>抛出异常</td><td>当阻塞队列满时，再往队列里add插入元素会抛IllegalStateException: Queue full<br/>当阻塞队列空时，再往队列里remove移除元素会抛NoSuchElementException</td></tr><tr><td>特殊值</td><td>插入方法，成功true，失败false<br>移除方法，成功返回出队列的元素，队列里没有就返回null</td></tr><tr><td>阻塞等待</td><td>当阻塞队列满时，生产者线程继续往队列里push插入元素，队列会一直阻塞生产者线程，直到put数据或是响应中断退出<br/>当阻塞队列空时，消费者线程试图从队列里take移除元素，队列会一直阻塞消费者线程直到队列可用</td></tr><tr><td>超时等待</td><td>当阻塞队列满时，队列会阻塞生产者线程一定时间，超过限时后生产者线程会退出</td></tr></tbody></table><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 抛出异常*/</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 阻塞队列的大小为3</span>    BlockingQueue<span class="token operator">&lt;</span>Integer<span class="token operator">></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 添加</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>    <span class="token comment" spellcheck="true">// Exception in thread "main" java.lang.IllegalStateException: Queue full</span>    <span class="token comment" spellcheck="true">//System.out.println(blockingQueue.add(4));</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">element</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 查看队首元素</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"**************************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 移除</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span>    <span class="token comment" spellcheck="true">// Exception in thread "main" java.util.NoSuchElementException</span>    <span class="token comment" spellcheck="true">//System.out.println(blockingQueue.remove());</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 不抛出异常,有返回值*/</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 阻塞队列的大小为3</span>    BlockingQueue<span class="token operator">&lt;</span>Integer<span class="token operator">></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 添加</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"****************************************"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 移除</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 查看队首元素 3</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// null</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 阻塞等待（一直阻塞）*/</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 阻塞队列的大小为3</span>    BlockingQueue<span class="token operator">&lt;</span>Integer<span class="token operator">></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 添加</span>    blockingQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    blockingQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    blockingQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//blockingQueue.put(4);  // 会一直阻塞等待</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 2</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 3</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 一直阻塞等待</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 超时等待（过时不候）*/</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 阻塞队列的大小为3</span>    BlockingQueue<span class="token operator">&lt;</span>Integer<span class="token operator">></span> blockingQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 添加</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 阻塞队列满了 等5s,如果还在阻塞就放弃本次添加</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 移除</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 阻塞队列空了 等5S,如果还在阻塞就放弃本次移除</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="8-3-SynchronousQueue"><a href="#8-3-SynchronousQueue" class="headerlink" title="8.3 SynchronousQueue"></a>8.3 SynchronousQueue</h3><p><code>SynchronousQueue</code>同步队列，进去一个元素，必须等待取出来之后，才能往里面再放一个元素。<strong>最多只能放一个元素！</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>ymy<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>BlockingQueue<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>SynchronousQueue<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 同步队列 * T1线程向同步队列中放元素,必须等T2线程取出元素,T1线程才能继续放元素。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousQueueDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        BlockingQueue<span class="token operator">&lt;</span>Integer<span class="token operator">></span> synchronousQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t put 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                synchronousQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t put 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                synchronousQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t put 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                synchronousQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"T1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t take \t"</span> <span class="token operator">+</span> synchronousQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t take \t"</span> <span class="token operator">+</span> synchronousQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t take \t"</span> <span class="token operator">+</span> synchronousQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"T2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="8-4-生产者消费者模式3-0"><a href="#8-4-生产者消费者模式3-0" class="headerlink" title="8.4 生产者消费者模式3.0"></a>8.4 生产者消费者模式3.0</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 资源类 */</span><span class="token keyword">class</span> <span class="token class-name">ShareData</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 这里使用了volatile是为了保持数据的可见性，也就是当FLAG修改时，要马上通知其他线程进行修改     * FLAG = true：默认开启，进行生产 + 消费     */</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> FLAG <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 使用原子保证类，而不用number     */</span>    <span class="token keyword">private</span> AtomicInteger atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 要考虑：通配、适用（传接口，不能传具体实现类）     * 这里不能为了满足条件，而实例化成一个具体的SynchronousBlockingQueue     */</span>    BlockingQueue<span class="token operator">&lt;</span>String<span class="token operator">></span> blockingQueue <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 而应该采用依赖注入里面的，构造注入方法传入     * @param blockingQueue     */</span>    <span class="token keyword">public</span> <span class="token function">ShareData</span><span class="token punctuation">(</span>BlockingQueue<span class="token operator">&lt;</span>String<span class="token operator">></span> blockingQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>blockingQueue <span class="token operator">=</span> blockingQueue<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 查看接口具体的落地实现类名称</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockingQueue<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 生产     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 待插入队列中的数据</span>        String data <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 标志位，往队列中存入数据成功与否</span>        <span class="token keyword">boolean</span> retValue<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 判断</span>        <span class="token comment" spellcheck="true">// 多线程环境的判断，一定要使用while进行，防止出现虚假唤醒</span>        <span class="token comment" spellcheck="true">// 当FALG为true时，生产线程可以进入，开始生产</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 工作：原子整形对象加 1</span>            data <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 将数据放入阻塞队列</span>            <span class="token comment" spellcheck="true">// 2秒存入1个data</span>            retValue <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> 2L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>retValue<span class="token punctuation">)</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 插入队列："</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 插入队列："</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">"失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 这里暂停一秒，是为了消费线程正好及时消费</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******* 生产后，休息一秒钟 ******"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 生产停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 消费     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 存储队列取出的内容</span>        String retValue <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 多线程环境的判断，一定要使用while进行，防止出现虚假唤醒</span>        <span class="token comment" spellcheck="true">// 当FLAG为true的时候，消费线程可以进入，开始消费</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 从阻塞队列中取出数据</span>            <span class="token comment" spellcheck="true">// 2秒取出 1个data</span>            retValue <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>2L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>retValue<span class="token operator">==</span>null <span class="token operator">||</span> retValue<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// retValue==null 证明队列中没有数据了，就将FLAG设为false，退出</span>                FLAG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 超过2秒，消费失败，队列中已为空，退出"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 退出消费队列</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 消费队列："</span> <span class="token operator">+</span> retValue  <span class="token operator">+</span> <span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 消费停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 停止生产与消费     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>FLAG <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * volatile/CAS/atomicInteger/BlockQueue/线程交互/原子引用 * 使用阻塞队列实现生产者消费者模式 * 一个初始值为0的变量，两个线程对其交替操作，一个加1，一个减1，来5轮 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProdConsumer_BlockQueueDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 传入具体的实现类， ArrayBlockingQueue</span>        <span class="token comment" spellcheck="true">// 因为传入的是ArrayBlockingQueue，如果操作不当，生产线程就会生产很多数据，保存在队列中</span>        ShareData shareData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShareData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 生产线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 生产线程启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                shareData<span class="token punctuation">.</span><span class="token function">myProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"producer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 消费线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 消费线程启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                shareData<span class="token punctuation">.</span><span class="token function">myConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"consumer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 5秒后，停止生产和消费</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"5秒后，生产和消费线程停止，main线程结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shareData<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210616210632.png" style="zoom:80%;" /><h2 id="9-线程池"><a href="#9-线程池" class="headerlink" title="9 线程池"></a>9 线程池</h2><h3 id="9-1-线程池介绍"><a href="#9-1-线程池介绍" class="headerlink" title="9.1 线程池介绍"></a>9.1 线程池介绍</h3><p>在一个应用程序中，我们需要多次使用线程，也就意味着，我们需要多次创建并销毁线程。而创建并销毁线程的过程势必会消耗内存。而在Java中，内存资源是及其宝贵的，所以，我们就提出了线程池的概念。</p><p><strong>线程池的优势：</strong></p><p>线程池做的工作主要是控制运行的线程数量，<font color='red'>处理过程中将任务放入队列</font>，然后在线程创建后启动这些任务，<font color='red'>如果线程数量超过最大数量，超过数量的线程排队等候</font>，等其他线程执行完毕，再从队列中取出任务来执行。</p><p><strong>主要特点</strong>：<font color='red'><strong>线程复用；控制最大并发数；管理线程。</strong></font></p><ul><li><strong>降低系统资源消耗。</strong>通过重用已存在的线程，降低线程创建和销毁造成的消耗。</li><li><strong>提高响应速度。</strong>当有任务到达时，通过复用已存在的线程，无需等待新线程的创建便能立即执行。</li><li><strong>提高线程的可管理性。</strong>线程是稀缺资源，如果无限制创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。</li></ul><h3 id="9-2-三大方法"><a href="#9-2-三大方法" class="headerlink" title="9.2 三大方法"></a>9.2 三大方法</h3><p>Java中线程池是通过<code>Executor</code>框架实现的，该框架中用到了<code>ExecutorService</code>、<code>ThreadPoolExecutor</code>这几个类。</p><p>类似于Arrays工具类，创建线程池使用线程池工具类<code>Executors</code>去创建。三种常见的方法如下：<code>Executors.newFixedThreadPool(int)</code>、<code>Executors.newSingleThreadExecutor()</code>和<code>Executors.newCachedThreadPool()</code>。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524100802.png" alt="" style="zoom:67%;" /><blockquote><p>Executor 接口</p></blockquote><p>Executor 接口只有一个<code>execute</code>方法。我们平常创建并启动线程会使用 <code>new Thread().start()</code> ，而 Executor 中的 execute 方法替代了显示创建线程的方式。Executor 的设计初衷就是将任务提交和任务执行细节进行解藕。</p><p><font color='red'>execute方法接收一个 <code>Runnable</code> 实例</font>，它用来执行一个任务，而任务就是一个实现了 Runnable 接口的类，但是<font color='red'> execute 方法不能接收实现了 <code>Callable</code> 接口的类</font>，也就是说，execute 方法不能接收具有返回值的任务。</p><blockquote><p>ExecutorService 接口</p></blockquote><p>ExecutorService 也是一个接口，它是 Executor 的拓展，提供了一些 Executor 中没有的方法。</p><ul><li><strong>shutdown</strong>()</li></ul><p><code>shutdown</code> 方法调用后，ExecutorService 会有序关闭正在执行的任务，但是不接受新任务。如果任务已经关闭，那么这个方法不会产生任何影响。</p><ul><li><strong>shutdownNow</strong>()</li></ul><p><code>shutdownNow</code> 会尝试停止关闭所有正在执行的任务，停止正在等待的任务，并返回正在等待执行的任务列表。</p><p>ExecutorService 不仅能够包容 <code>Runnable</code> 对象，还能够接纳 <code>Callable</code> 对象。在 ExecutorService 中，<code>submit</code> 方法扮演了这个角色。</p><ol><li><code>Executors.newFixedThreadPool(int)</code></li></ol><p>创建一个线程池，一池有N个固定的线程，有固定线程数的线程。执行长期任务性能好。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 一个池子有5个工作线程，类似于银行有5个工作窗口</span>    ExecutorService threadPool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 模拟有10个顾客来银行办理业务，目前池子中有5个工作人员提供服务</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 使用线程池的execute方法来创建线程</span>            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 办理业务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 关闭线程池</span>        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524102700.png" alt=""></p><ol start="2"><li><code>Executors.newSingleThreadExecutor()</code></li></ol><p>一个任务一个任务的执行，一池线程</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 一池一个线程，类似于银行只有1个工作窗口</span>    ExecutorService threadPool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 模拟有10个顾客来银行办理业务，目前池子中有5个工作人员提供服务</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 办理业务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 关闭线程池</span>        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524103035.png" alt=""></p><ol start="3"><li><code>Executors.newCachedThreadPool()</code></li></ol><p>执行很多短期异步任务，线程池根据需要创建新线程，但在先前构建的线程可用时将重用它们，可扩容。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 一个池子有n个工作线程</span>    ExecutorService threadPool <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 模拟有10个顾客来银行办理业务，目前池子中有5个工作人员提供服务</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 办理业务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 关闭线程池</span>        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524103358.png" alt=""></p><p>虽然以上三个方法可以很方便的创建线程池，但是<font color='red'>在工作中是严禁使用的</font>。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524212057.png" alt="阿里巴巴开发手册" style="zoom:67%;" /><h3 id="9-3-七大参数"><a href="#9-3-七大参数" class="headerlink" title="9.3 七大参数"></a>9.3 七大参数</h3><p><strong>创建线程池的底层使用的是<font color='red'>ThreadPoolExecutor</font></strong></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// SingleThreadPool 一池一线程</span><span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>                                0L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// FixedThreadPool 一池固定线程</span><span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> nThreads<span class="token punctuation">,</span>                                  0L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>                                  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// CachedThreadPool 一池多线程(线程数量可以伸缩)</span><span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span>                                  60L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>                                  <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p><code>ThreadPoolExecutor</code>七大参数描述</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> ExecutorService <span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FinalizableDelegatedExecutorService</span>        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>                                0L<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>                                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 核心线程池大小</span>                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 最大核心线程池大小</span>                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 超时了,没被调用就会释放</span>                          TimeUnit unit<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// 超时单位</span>                          BlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> workQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span>         Executors<span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultHandler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 核心线程池大小</span>                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 最大核心线程池大小</span>                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 超时了,没有人调用就会释放</span>                          TimeUnit unit<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 超时单位</span>                          BlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> workQueue<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 阻塞队列</span>                          ThreadFactory threadFactory<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// 线程工厂，创建线程，一般使用默认值</span>                          RejectedExecutionHandler handler <span class="token comment" spellcheck="true">// 拒绝策略) {</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>        maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>        maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>        keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> null <span class="token operator">||</span> threadFactory <span class="token operator">==</span> null <span class="token operator">||</span> handler <span class="token operator">==</span> null<span class="token punctuation">)</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>acc <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span>        null <span class="token operator">:</span>    AccessController<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><table><thead><tr><th align="center">七大参数</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center"><code>corePoolSize</code></td><td align="center">线程池中的常驻核心线程数</td></tr><tr><td align="center"><code>maximumPoolSize</code></td><td align="center">线程池中能够容纳同时执行的最大线程数，此值必须大于等于1</td></tr><tr><td align="center"><code>keepAliveTime</code></td><td align="center">多余的空闲线程的存活时间。<br>当前池中线程数量超过<code>corePoolSize</code>时，当空闲时间达到<code>keepAliveTime</code>时，<br>多余线程会被销毁直到只剩下<code>corePoolSize</code>个线程为止。</td></tr><tr><td align="center"><code>unit</code></td><td align="center"><code>keepAliveTime</code>的单位</td></tr><tr><td align="center"><code>BlockingQueue&lt;Runnable&gt; workQueue</code></td><td align="center">任务队列（阻塞队列），被提交但是尚未被执行的队列</td></tr><tr><td align="center"><code>ThreadFactory threadFactory</code></td><td align="center">表示生成线程池中工作线程的线程工厂，用于创建线程。一般默认值即可。</td></tr><tr><td align="center"><code>RejectedExecutionHandler handler</code></td><td align="center">拒绝策略。表示当阻塞队列满了，并且工作线程大于等于线程池的最大线程数(<code>maximumPoolSize</code>)时，如何拒绝请求执行的runnable的策略。</td></tr></tbody></table><ol><li><code>corePoolSize</code></li></ol><p>刚开始创建了一个线程池，此时是没有任何线程的，这个很好理解，因为我现在没有任务可以执行啊，创建线程干啥啊？而且创建线程还有开销啊，所以等到任务过来时再创建线程也不晚。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524212132.png" style="zoom:67%;" /><ol start="2"><li><code>keepAliveTime</code></li></ol><p><font color='red'>在默认情况下，这个参数只在线程数量大于 corePoolSize 时才会生效</font>。当线程数量大于 corePoolSize 时，如果任意一个空闲的线程的等待时间 &gt; keepAliveTime 后，那么这个线程会被剔除，直到线程数量等于 corePoolSize 为止。如果调用了 allowCoreThreadTimeOut 方法，线程数量在 corePoolSize 范围内也会生效，直到线程减为 0。</p><ol start="3"><li><code>workQueue</code></li></ol><p>有三种阻塞队列可供选择：</p><ul><li><code>SynchronousQueue</code>: 基于<code>阻塞队列(BlockingQueue)</code>的实现，它会直接将任务交给消费者，必须等队列中的添加元素被消费后才能继续添加新的元素。使用 SynchronousQueue 阻塞队列一般要求maximumPoolSizes 为无界，也就是 Integer.MAX_VALUE，避免线程拒绝执行操作。</li><li><code>LinkedBlockingQueue</code>：LinkedBlockingQueue 是一个无界缓存等待队列。当前执行的线程数量达到 corePoolSize 的数量时，剩余的元素会在阻塞队列里等待。</li><li><code>ArrayBlockingQueue</code>：ArrayBlockingQueue 是一个有界缓存等待队列，可以指定缓存队列的大小，当正在执行的线程数等于 corePoolSize 时，多余的元素缓存在 ArrayBlockingQueue 队列中等待有空闲的线程时继续执行，当 ArrayBlockingQueue 已满时，加入 ArrayBlockingQueue 失败，会开启新的线程去执行，当线程数已经达到最大的 maximumPoolSizes 时，再有新的元素尝试加入 ArrayBlockingQueue时会报错</li></ul><ol start="4"><li><code>handler</code></li></ol><p>拒绝策略主要有以下取值：</p><ul><li><p><code>ThreadPoolExecutor.AbortPolicy</code>：直接抛出RejectedExecutionException异常，阻止系统正常运行。</p></li><li><p><code>ThreadPoolExecutor.DiscardPolicy</code>：默默丢弃无法处理的任务，不予任何处理也不抛出异常。如果允许任务丢失，这是最好的策略。</p></li><li><p><code>ThreadPoolExecutor.CallerRunsPolicy</code>：既不抛出异常，也不抛弃任务。而是将某些任务回退到调用线程（提交任务的线程）处理该任务</p></li><li><p><code>ThreadPoolExecutor.DiscardOldestPolicy</code>：不抛出异常，但是抛弃队列中等待最久的任务，然后把当前任务加入到队列中，尝试再次提交当前任务。</p></li></ul><h3 id="9-4-线程池状态"><a href="#9-4-线程池状态" class="headerlink" title="9.4 线程池状态"></a>9.4 线程池状态</h3><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524212209.png" style="zoom:67%;" /><ul><li><code>RUNNING</code></li></ul><p>如果线程池处于 RUNNING 状态下的话，<font color='blue'>能够接收新任务，也能处理正在运行的任务</font>。线程池一旦创建出来就会处于 RUNNING 状态，并且线程池中的有效线程数为 0。</p><ul><li><code>SHUTDOWN</code></li></ul><p>在调用 shutdown 方法后，线程池的状态会由 RUNNING -&gt; SHUTDOWN 状态，位于 SHUTDOWN 状态的线程池<font color='red'>能够处理正在运行的任务，但是不能接受新的任务</font>。</p><ul><li><code>STOP</code></li></ul><p>在调用 shutdownNow 方法时，程序会从 RUNNING/SHUTDOWN -&gt; STOP 状态，处于 STOP 状态的线程池，<font color='red'>不接收新任务，不处理已添加的任务，并且会中断正在处理的任务</font>。</p><ul><li><code>TIDYING</code></li></ul><p>TIDYING 状态有个前置条件，分为两种：一种是是当线程池位于 SHUTDOWN 状态下，阻塞队列和线程池中的线程数量为空时，会由 SHUTDOWN -&gt; TIDYING；另一种是当线程池位于 STOP 状态下时，线程池中的数量为空时，会由 STOP -&gt; TIDYING 状态。</p><p>转换为 TIDYING 的线程池会调用 <code>terminated</code>这个钩子方法，terminated 在 ThreadPoolExecutor 类中是空实现，若用户想在线程池变为 TIDYING 时，进行相应的处理，可以通过重载 terminated 函数来实现。</p><ul><li><code>TERMINATED</code></li></ul><p>TERMINATED 状态是线程池的最后一个状态，线程池处在 TIDYING 状态时，执行完terminated 方法之后，就会由 TIDYING -&gt; TERMINATED 状态。此时表示线程池的彻底终止。</p><h3 id="9-5-线程池底层工作原理"><a href="#9-5-线程池底层工作原理" class="headerlink" title="9.5 线程池底层工作原理"></a>9.5 线程池底层工作原理</h3><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524205505.png" alt="线程池底层工作原理" style="zoom:67%;" /><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524205540.png" alt="处理流程图" style="zoom: 80%;" /><blockquote><p>银行办理业务模拟线程池</p></blockquote><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210524205839.png" alt=""></p><p><strong>工作原理</strong>：</p><p>1、在创建了线程池后，开始等待请求。</p><p>2、当调用<code>execute()</code>方法添加一个请求任务时，线程池会做出如下判断：</p><p>​    2.1 如果正在运行的线程数量小于核心线程数<code>corePoolSize</code>，那么马上创建线程运行这个任务；</p><p>​    2.2  如果正在运行的线程数量大于或等于核心线程数<code>corePoolSize</code>，那么将这个任务<font color='red'>放入阻塞队列中</font>；</p><p>​    2.3 如果这个时候阻塞队列满了且正在运行的线程数量还小于<code>maximumPoolSize</code>，那么<font color='red'>立即创建新的线程（非核心线程）来运行这个任务</font>（<font color='blue'>类似于银行候客厅满了之后，新来的人直接在新增的业务窗口办理业务</font>）；</p><p>​    2.4 如果阻塞队列满了且正在运行的线程数量大于或等于<code>maximumPoolSize</code>，那么线程池会<font color='red'>启动饱和拒绝策略来执行</font>。</p><p>3、当一个线程完成任务时，它会从阻塞队列中取出下一个任务来执行。</p><p>4、当一个线程无事可做超过一定时间（<code>keepAliveTime</code>）时，线程会判断：</p><p>​    4.1 如果当前运行的线程数大于<code>corePoolSize</code>，那么这个线程会被立即停掉；</p><p>​    4.2 所以线程池的所有任务完成后，<font color='red'>它最终会收缩到<code>corePoolSize</code>的大小。</font></p><p>上面指出了 execute 的运行过程，整体上来说这个执行过程把非常重要的点讲解出来了，但是不够细致，详情参考：<a href="https://mp.weixin.qq.com/s/O8ul1xRJPU18hDE62Ps9Tw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/O8ul1xRJPU18hDE62Ps9Tw</a></p><p>以顾客去银行办理业务为例，谈谈线程池的底层工作原理</p><ol><li>最开始假设来了两个顾客，因为corePoolSize为2，因此这两个顾客直接能够去窗口办理</li><li>后面又来了三个顾客，因为corePool已经被顾客占用了，因此只有去候客区，也就是阻塞队列中等待</li><li>后面的人又陆陆续续来了，候客区可能不够用了，因此需要申请增加处理请求的窗口，这里的窗口指的是线程池中的线程数，以此来解决线程不够用的问题</li><li>假设受理窗口已经达到最大数，并且请求数还是不断递增，此时候客区和线程池都已经满了，为了防止大量请求冲垮线程池，已经需要开启拒绝策略</li><li>临时增加的线程会因为超过了最大存活时间，就会销毁，最后从最大数削减到核心数</li></ol><h3 id="9-6-四大拒绝策略"><a href="#9-6-四大拒绝策略" class="headerlink" title="9.6 四大拒绝策略"></a>9.6 四大拒绝策略</h3><ol><li><p><strong>默认拒绝策略：AbortPolicy</strong></p><p>触发条件是，请求的线程大于 阻塞队列大小 + 最大线程数 （比如8） 的时候，也就是说第9个线程来获取线程池中的线程时，就会抛出异常从而报错退出。</p></li><li><p><strong>CallerRunsPolicy</strong></p><p>回退策略，就是把任务丢回给原来的请求开启线程。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617105520.png" style="zoom:80%;" /></li><li><p>*<em>DiscardPolicy *</em></p><p><font color='red'>线程池会自动把后面新来的任务都直接丢弃，也不报异常</font>，当<font color='red'>任务无关紧要的时候，可以采用这个方式</font></p></li><li><p><strong>DiscardOldestPolicy</strong></p><p><font color='red'>线程池会把阻塞队列中等待最久的任务替换掉。</font></p></li></ol><h3 id="9-6-手动创建线程池"><a href="#9-6-手动创建线程池" class="headerlink" title="9.6 手动创建线程池"></a>9.6 手动创建线程池</h3><p>根据阿里java开发手册，不能使用executes创建线程池，需要使用<code>ThreadPoolExecutor</code>手动创建。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 自定义线程池：创建了一个 核心线程数为2，最大线程数为5，并且阻塞队列数为3的线程池</span><span class="token comment" spellcheck="true">// this(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,</span><span class="token comment" spellcheck="true">//             Executors.defaultThreadFactory(), defaultHandler);</span><span class="token comment" spellcheck="true">// 手写线程池</span><span class="token keyword">final</span> Integer corePoolSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">final</span> Integer maximumPoolSize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">final</span> Long keepAliveTime <span class="token operator">=</span> 1L<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 自定义线程池，只改变了LinkedBlockingQueue的队列大小</span>ExecutorService executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>    corePoolSize<span class="token punctuation">,</span>    maximumPoolSize<span class="token punctuation">,</span>    keepAliveTime<span class="token punctuation">,</span>    TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// 确定LinkedBlockingQueue的队列大小</span>    Executors<span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 默认拒绝策略</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    </code></pre><h3 id="9-7-线程池大小的设置"><a href="#9-7-线程池大小的设置" class="headerlink" title="9.7 线程池大小的设置"></a>9.7 线程池大小的设置</h3><p>一般需要根据<font color='red'>任务类型</font>来配置线程池大小</p><ol><li><p>CPU 密集型任务</p><p>CPU密集的意思是该任务<font color='red'>需要大量的运算，而没有阻塞</font>，CPU一直全速运行</p><p>CPU密集任务只有在真正的多核CPU上才可能得到加速（通过多线程）</p><p>CPU密集型任务配置尽可能少的线程数量：</p><p><font color='red'>建议合理的线程数值是 <code>CPU核数 + 1</code>。</font></p></li></ol><pre class=" language-java"><code class="language-java">最大线程到底该如何定义：<span class="token number">1</span>、CPU密集型，电脑是几核，就是几，可以保证CPU的效率最高。   <span class="token comment" spellcheck="true">// 获得处理器的核数</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><ol start="2"><li><p>I/O 密集型任务</p><p>IO密集型，即该任务<font color='red'>需要大量的IO操作，即大量的阻塞</font></p><p>所以IO密集型任务中使用多线程可以大大的加速程序的运行，即使在单核CPU上，这种加速主要就是利用了被浪费掉的阻塞时间。</p><ul><li>由于IO密集型任务线程并不是一直在执行任务，则可能多的线程，可以参考 Brain Goetz 的推荐方法 <strong><font color='blue'>线程数 = CPU核数 × (1 + 平均等待时间/平均工作时间)</font></strong>。<font color='red'>参考值可以是 CPU 核数 * 2</font>。</li><li>IO密集时，大部分线程都被阻塞，故需要多配置线程数：参考公式：<font color='red'>CPU核数 / (1 - 阻塞系数)， 阻塞系数在0.8 ~ 0.9左右</font></li></ul></li></ol><h2 id="10-四大函数式接口"><a href="#10-四大函数式接口" class="headerlink" title="10 四大函数式接口"></a>10 四大函数式接口</h2><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525200652.png" alt=""></p><h3 id="10-1-函数型接口-Function-lt-T-R-gt"><a href="#10-1-函数型接口-Function-lt-T-R-gt" class="headerlink" title="10.1 函数型接口 Function&lt;T,R&gt;"></a>10.1 函数型接口 Function&lt;T,R&gt;</h3><p>对类型为T的对象应用操作，并返回结果。结果是R类型的对象（<font color='red'>即有一个输入和一个输出</font>）。只有一个方法：<font color='red'>R apply(T t)</font>。</p><blockquote><p>代码测试</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Function接口</span><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Function</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> R<span class="token operator">></span> <span class="token punctuation">{</span>    R <span class="token function">apply</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Function 函数型接口，有输入参数，有输出。 * 只要是函数型接口，可以用lambda表达式简写。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FunctionDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 函数型接口 Function&lt;T,R>，使用lambda表达式实现唯一的apply方法</span>        Function<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> function <span class="token operator">=</span> t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="10-2-断定型接口-Predicate-lt-T-gt"><a href="#10-2-断定型接口-Predicate-lt-T-gt" class="headerlink" title="10.2 断定型接口 Predicate&lt; T&gt;"></a>10.2 断定型接口 Predicate&lt; T&gt;</h3><p>断定型接口：有一个类型为T的输入参数，满足某种约束条件，返回值为布尔值（<font color='red'>即有一个输入参数，布尔类型的固定输出类型</font>）。只有一个方法：<font color='red'>boolean  test(T  t)</font>。</p><blockquote><p>代码测试</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Predicate 接口</span><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Predicate</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 断定型接口：有一个输入参数,返回值为布尔值。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FunctionDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 断定性接口 Predicate&lt;T>，唯一方法test方法</span>        Predicate<span class="token operator">&lt;</span>String<span class="token operator">></span> predicate <span class="token operator">=</span> t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>predicate<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="10-3-消费型接口-Consumer-lt-T-gt"><a href="#10-3-消费型接口-Consumer-lt-T-gt" class="headerlink" title="10.3 消费型接口 Consumer&lt; T&gt;"></a>10.3 消费型接口 Consumer&lt; T&gt;</h3><p>消费型接口：只有类型为T的输入参数，进行操作，但是没有返回值（<font color='red'>即只有一个输入参数，输出参数为void</font>）。只有一个方法：<font color='red'>void  accept(T  t)</font></p><blockquote><p>代码测试</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Consumer 接口</span><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Consumer</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 消费型接口：只有输入参数，没有返回值。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FunctionDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 消费型接口 Consumer&lt;T>，唯一方法accept</span>        Consumer<span class="token operator">&lt;</span>String<span class="token operator">></span> consumer <span class="token operator">=</span> t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>        consumer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="10-4供给型接口-Supplier-lt-R-gt"><a href="#10-4供给型接口-Supplier-lt-R-gt" class="headerlink" title="10.4供给型接口 Supplier&lt; R&gt;"></a>10.4供给型接口 Supplier&lt; R&gt;</h3><p>供给型接口：没有输入参数，只有类型为R的返回值（<font color='red'>即没有输入参数，有输出参数</font>）。只有一个方法：<font color='red'>R  get()</font></p><blockquote><p>代码测试</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Supplier 接口</span><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Supplier</span><span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token punctuation">{</span>    R <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 供给型接口：没有输入参数,只有返回值！ */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FunctionDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 供给型接口 Supplier&lt;R>，唯一方法 get</span>        Supplier<span class="token operator">&lt;</span>String<span class="token operator">></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token keyword">return</span> <span class="token string">"李四"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="11-Stream流式计算"><a href="#11-Stream流式计算" class="headerlink" title="11 Stream流式计算"></a>11 Stream流式计算</h2><blockquote><p>什么是stream流式计算？</p></blockquote><p>流是数据渠道，用于操作数据源（集合、数组等）所生成元素序列。</p><p><font color='red'>集合讲的是数据，流讲的是计算！</font></p><p>代码示例</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 过滤器</span><span class="token comment" spellcheck="true">// 输入参数是一个断定型接口（一个输入参数，固定boolean型输出参数）</span>Stream<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>Predicate<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> predicate<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 循环输出</span><span class="token comment" spellcheck="true">// 输入参数是一个消费型接口（一个输入参数，无输出参数）</span><span class="token keyword">void</span> <span class="token function">forEach</span><span class="token punctuation">(</span>Consumer<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> action<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// map映射</span><span class="token comment" spellcheck="true">// 输入参数是一个函数型接口（一个类型为T的输入参数，一个类型为R的输出参数）</span><span class="token operator">&lt;</span>R<span class="token operator">></span> Stream<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">map</span><span class="token punctuation">(</span>Function<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">R</span><span class="token operator">></span> mapper<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 自定义排序方法</span><span class="token comment" spellcheck="true">// 输入参数是一个Comparator接口</span>Stream<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">sorted</span><span class="token punctuation">(</span>Comparator<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> comparator<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparator</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>T o1<span class="token punctuation">,</span> T o2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>ymy<span class="token punctuation">.</span>stream<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>ymy<span class="token punctuation">.</span>User<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 题目要求：现在有5个用户，找出同时满足以下条件的用户： * 1、ID必须是偶数 * 2、年龄必须大于24岁 * 3、用户名转成大写字母 * 4、用户名字母倒着排序 * 5、只输出一个用户 * filter(Predicate&lt;? super T> predicate); 断定型接口 * Stream&lt;R> map(Function&lt;? super T, ? extends R> mapper); 函数型接口 * sorted(Comparator&lt;? super T> comparator); 函数式接口 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StreamDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        User u1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User u2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User u3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User u4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User u5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token string">"e"</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>User<span class="token operator">></span> list <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>u1<span class="token punctuation">,</span>u2<span class="token punctuation">,</span>u3<span class="token punctuation">,</span>u4<span class="token punctuation">,</span>u5<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 流式计算</span>        <span class="token comment" spellcheck="true">// 第一步：利用过滤器获取id为偶数的用户</span><span class="token comment" spellcheck="true">//        list.stream().filter(t -> {</span><span class="token comment" spellcheck="true">//            return t.getId() % 2 == 0;</span><span class="token comment" spellcheck="true">//        }).forEach((t)->{</span><span class="token comment" spellcheck="true">//            System.out.println(t.getId());</span><span class="token comment" spellcheck="true">//        });</span>        <span class="token comment" spellcheck="true">// 第二步：利用过滤器获取age>25的用户</span>        <span class="token comment" spellcheck="true">// 第三步：使用map映射，将小写转成大写</span>        <span class="token comment" spellcheck="true">// 第四步：使用sorted进行排序</span>        <span class="token comment" spellcheck="true">// 第五步：使用limit取出前一个用户</span>        list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">24</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// o2.compareTo(o1) 表示逆序排列</span>            <span class="token keyword">return</span> o2<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="12-ForkJoin"><a href="#12-ForkJoin" class="headerlink" title="12 ForkJoin"></a>12 ForkJoin</h2><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525211449.png" alt="ForkJoin" style="zoom:80%;" /><h3 id="12-1-ForkJoin简介"><a href="#12-1-ForkJoin简介" class="headerlink" title="12.1 ForkJoin简介"></a>12.1 ForkJoin简介</h3><p><code>ForkJoin</code>在<code>JDK1.7</code>就有了，<font color='blue'>并行执行任务，提高效率</font>。大数据量！<font color='red'>类似于递归，只不过是拆分出来的子任务放在一个单独的线程上运行。</font></p><p>大数据：Map、Reduce（把大任务拆分为小任务）。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525211624.png" alt=""></p><blockquote><p>ForkJoin特点：工作窃取！（能者多劳）</p></blockquote><p><strong>这个里面维护的都是双端队列</strong>。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525211842.png" style="zoom:80%;" /><h3 id="12-2-ForkJoin的使用"><a href="#12-2-ForkJoin的使用" class="headerlink" title="12.2 ForkJoin的使用"></a>12.2 ForkJoin的使用</h3><blockquote><p>ForkJoinPool</p></blockquote><p>ForkJoinPool 是 JDK7 引入的线程池，核心思想是将大的任务拆分成多个小任务（即 fork），然后在将多个小任务处理汇总到一个结果上（即 join）。它提供基本的线程池功能，支持设置最大并发线程数，支持任务排队，支持线程池停止，支持线程池使用情况监控，也是AbstractExecutorService 的子类，主要引入了“工作窃取”机制，在多CPU计算机上处理性能更佳。</p><p>主要方法是<code>submit()</code>，用来提交一个 ForkJoinTask 来执行。 </p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ForkJoinPool </span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinPool</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExecutorService</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 提交一个 ForkJoinTask 来执行</span>    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> ForkJoinTask<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">submit</span><span class="token punctuation">(</span>ForkJoinTask<span class="token operator">&lt;</span>T<span class="token operator">></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 虽然也可以直接传入 Callable、Runable 接口，但底层都是转成了 ForkJoinTask 来执行。</span>    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> ForkJoinTask<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">submit</span><span class="token punctuation">(</span>Callable<span class="token operator">&lt;</span>T<span class="token operator">></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> ForkJoinTask<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">submit</span><span class="token punctuation">(</span>Runnable task<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> ForkJoinTask<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">submit</span><span class="token punctuation">(</span>Runnable task<span class="token punctuation">,</span> T result<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>ForkJoinTask</p></blockquote><p>ForkJoinTask：我们要使用ForkJoin框架，必须<font color='red'>首先创建一个ForkJoin任务</font>。<font color='blue'>它提供在任务中执行fork()和join()操作的机制</font>，通常情况下我们<font color='red'>不需要直接继承ForkJoinTask类，而只需要继承它的子类</font>，Fork/Join框架提供了以下两个子类：</p><ul><li><code>RecursiveAction</code>：用于<font color='red'>没有</font>返回结果的任务。</li><li><code>RecursiveTask</code> ：用于<font color='red'>有</font>返回结果的任务。</li></ul><p><font color='red'>ForkJoinTask需要通过ForkJoinPool来执行</font>，任务分割出的子任务会添加到当前工作线程所维护的双端队列中，进入队列的头部。当一个工作线程的队列里暂时没有任务时，它会随机从其他工作线程的队列的尾部获取一个任务。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ForkJoinTask 是一个线程实体，即一个线程的操作</span><span class="token comment" spellcheck="true">// ForkJoinTask 实现了 Future 接口，类似于Callable接口，可以通过get获取线程的返回值。</span><span class="token comment" spellcheck="true">// abstract class 表明该类是抽象类，需要被继承，所以我们使用的都是其子类RecursiveTask、RecursiveAction</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinTask</span><span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span>V<span class="token operator">></span><span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 在当前任务正在运行的池中异步执行此任务</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> ForkJoinTask<span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 当计算完成后，返回计算结果</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> V <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 等待计算完成，然后检索其结果</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> V <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>RecursiveTask</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ForkJoinTask的子类，但该类仍是一个抽象类，需要我们自定义类继承该类</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">RecursiveTask</span><span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">ForkJoinTask</span><span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这个方法执行主要的计算</span>    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> V <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p>测试代码</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 自定义 ForkJoinTask，继承自 RecursiveTask类</span><span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Integer ADJUST_VALUE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> begin<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> result<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> begin<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>begin <span class="token operator">=</span> begin<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Integer <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 如果差值小于10，不用拆分，直接计算</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end<span class="token operator">-</span>begin<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> ADJUST_VALUE<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> begin<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> end <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result <span class="token operator">+=</span> i<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 从中间拆分成两部分，分别计算</span>            <span class="token keyword">int</span> middle <span class="token operator">=</span> begin <span class="token operator">+</span> <span class="token punctuation">(</span>end<span class="token operator">-</span>begin<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>            MyTask task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> middle<span class="token punctuation">)</span><span class="token punctuation">;</span>            MyTask task2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span>middle<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 使用 fork 异步执行任务</span>            task1<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            task2<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 使用 join 获取计算结果</span>            result <span class="token operator">=</span> task1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> task2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 分支合并框架 * ForkJoinPool * ForkJoinTask * RecursiveTask */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1.创建自定义的 RecursiveTask</span>        MyTask task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyTask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2.创建线程池 ForkJoinPool</span>        ForkJoinPool threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3.将 ForkJoinTask 提交到线程池，获得 ForkJoinTask</span>        ForkJoinTask<span class="token operator">&lt;</span>Integer<span class="token operator">></span> forkJoinTask <span class="token operator">=</span> threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 4.获取 ForkJoinTask 的最终结果</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>forkJoinTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 5.关闭线程池 ForkJoinPool</span>        threadPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="13-异步回调"><a href="#13-异步回调" class="headerlink" title="13 异步回调"></a>13 异步回调</h2><p>详细信息，参考博客：<a href="https://segmentfault.com/a/1190000021954023" target="_blank" rel="noopener">https://segmentfault.com/a/1190000021954023</a></p><h3 id="13-1-Future-与-CompletableFuture"><a href="#13-1-Future-与-CompletableFuture" class="headerlink" title="13.1 Future 与 CompletableFuture"></a>13.1 Future 与 CompletableFuture</h3><p>一些业务场景我们需要使用多线程异步执行任务，加快任务执行速度。 Java 提供 <code>Runnable</code> <code>Future&lt;V&gt;</code> 两个接口用来实现异步任务逻辑。</p><p>虽然 <code>Future&lt;V&gt;</code> 可以获取任务执行结果，但是获取方式十分不便。我们不得不使用<code>Future</code>的<code>get</code>方法阻塞调用线程，或者使用轮询方式 <code>Future</code>的<code>isDone</code>方法判断任务是否结束，再获取结果。</p><p>举一个生活上的例子，假如我们需要出去旅游，需要完成三个任务：</p><ul><li>任务一：订购航班</li><li>任务二：订购酒店</li><li>任务三：订购租车服务</li></ul><p>很显然任务一和任务二没有相关性，可以单独执行。但是任务三必须等待任务一与任务二结束之后，才能订购租车服务。</p><p>JDK8 之后，Java 新增一个功能十分强大的类：<code>CompletableFuture</code>。单独使用这个类就可以轻松的完成上面的需求。</p><p>对比 <code>Future&lt;V&gt;</code>，<code>CompletableFuture</code> 优点在于：</p><ul><li>不需要手工分配线程，JDK 自动分配</li><li>代码语义清晰，异步任务链式调用</li><li>支持编排异步任务</li></ul><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210526195404.jpg" alt="CompletableFuture方法" style="zoom:80%;" /><h3 id="13-2-CompletableFuture-使用"><a href="#13-2-CompletableFuture-使用" class="headerlink" title="13.2 CompletableFuture 使用"></a>13.2 CompletableFuture 使用</h3><blockquote><p>创建 CompletableFuture 实例</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 前两个方法， runAsync 不支持返回值，而 supplyAsync可以支持返回结果。</span><span class="token comment" spellcheck="true">// 这个两个方法默认将会使用公共的 ForkJoinPool 线程池执行，这个线程池默认线程数是 CPU 的核数。</span><span class="token keyword">public</span> <span class="token keyword">static</span> CompletableFuture<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">runAsync</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>U<span class="token operator">></span> CompletableFuture<span class="token operator">&lt;</span>U<span class="token operator">></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span>Supplier<span class="token operator">&lt;</span>U<span class="token operator">></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 使用共享线程池将会有个弊端，一旦有任务被阻塞，将会造成其他任务没机会执行。</span><span class="token comment" spellcheck="true">// 所以强烈建议使用后两个方法，根据任务类型不同，主动创建线程池，进行资源隔离，避免互相干扰</span><span class="token keyword">public</span> <span class="token keyword">static</span> CompletableFuture<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">runAsync</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">,</span> Executor executor<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>U<span class="token operator">></span> CompletableFuture<span class="token operator">&lt;</span>U<span class="token operator">></span> <span class="token function">supplyAsync</span><span class="token punctuation">(</span>Supplier<span class="token operator">&lt;</span>U<span class="token operator">></span> supplier<span class="token punctuation">,</span> Executor executor<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>CompletableFuture 使用</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFutureDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 没有返回值的异步回调</span>        <span class="token comment" spellcheck="true">// runAsync 不支持返回值</span>        CompletableFuture<span class="token operator">&lt;</span>Void<span class="token operator">></span> completableFuture <span class="token operator">=</span> CompletableFuture<span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 没有返回值，update mysql ok!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        completableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 获取阻塞执行结果</span>        <span class="token comment" spellcheck="true">// 有返回值的异步回调</span>        <span class="token comment" spellcheck="true">// supplyAsync 支持有返回值</span>        CompletableFuture<span class="token operator">&lt;</span>Integer<span class="token operator">></span> completableFuture2 <span class="token operator">=</span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 有返回值，insert MySQL ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">1024</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        completableFuture2<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******t："</span><span class="token operator">+</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 正常的返回结果</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******action："</span><span class="token operator">+</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 错误信息</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******exception"</span><span class="token operator">+</span>fn<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 可以获取到错误的返回结果</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210526202515.png" alt=""></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompletableFutureDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 没有返回值的异步回调</span>        <span class="token comment" spellcheck="true">// runAsync 不支持返回值</span>        CompletableFuture<span class="token operator">&lt;</span>Void<span class="token operator">></span> completableFuture <span class="token operator">=</span> CompletableFuture<span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 没有返回值，update mysql ok!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        completableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 获取阻塞执行结果</span>        <span class="token comment" spellcheck="true">// 有返回值的异步回调</span>        <span class="token comment" spellcheck="true">// supplyAsync 支持有返回值</span>        CompletableFuture<span class="token operator">&lt;</span>Integer<span class="token operator">></span> completableFuture2 <span class="token operator">=</span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 有返回值，insert MySQL ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 添加一个异常</span>            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">1024</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        completableFuture2<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******t："</span><span class="token operator">+</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// 正常的返回结果</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******action："</span><span class="token operator">+</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 错误信息</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exceptionally</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"******exception"</span><span class="token operator">+</span>fn<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 可以获取到错误的返回结果</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210526202907.png" style="zoom:80%;" /><h2 id="14-JMM"><a href="#14-JMM" class="headerlink" title="14 JMM"></a>14 JMM</h2><p><code>JMM</code>（Java内存模型 Java Memory Model，简称JMM）：Java线程共享内存模型，本身是一种抽象的概念并不真实存在，它描述的是一组规则或规范，<font color='blue'>通过这组规范定义了程序中各个变量（包括实例字段、静态字段和构成数组对象的元素）的访问方式</font>。</p><p><strong>JMM的三大特性：</strong></p><p>1、原子性</p><p>2、可见性</p><p>3、有序性</p><hr><p><strong>JMM关于同步的约定：</strong></p><p>1、线程<font color='red'>解锁前</font>，必须把<font color='red'>共享变量的值<strong>立刻</strong>刷新回主内存</font>。</p><p>2、线程<font color='red'>加锁前</font>，必须<font color='red'>读取主内存中的最新的值到自己的工作内存中</font>。</p><p>3、加锁和解锁是<font color='red'>同一把锁</font>。</p><hr><blockquote><p>原子性</p></blockquote><p><strong><font color='red'>原子性是不可分割，完整性</font></strong>。也即某个线程正在做某个具体业务时，中间不可以被加塞或者分割， 需要整体完成，<strong>要么同时成功，要么同时失败</strong>（类比数据库原子性）。</p><blockquote><p>可见性</p></blockquote><p><strong><em>注：</em></strong>JMM模型不要与JVM内存模型是不一样的。JMM指定 JVM如何使用计算机的<font color='blue'>内存 (RAM)</font>。JVM是整个计算机的模型，因此该模型自然包含一个内存模型——也就是 JMM。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210610212737.png" style="zoom:80%;" /><ol><li>由于JVM运行程序的实体是线程，而每个线程创建时JVM都会为其创建一个<font color='red'>工作内存</font>，<font color='red'>工作内存是每个线程私有的数据区域</font>。</li><li>JMM中规定<font color='red'>所有变量都存储在主内存中</font>，主内存是<font color='red'>共享内存区域，所有线程都可以访问</font>，但<font color='red'>线程改变变量的操作（读取赋值等）必须在工作内存中进行</font>。</li><li>一个线程如果想要修改主内存中的变量，<font color='red'><strong>首先要将变量从主内存中拷贝到自己的工作内存，然后对变量进行操作，操作完成后再将变量写会主内存，不能直接操作主内存中的变量</strong></font>，各个线程中的工作内存中存储着<strong>主内存中的变量副本拷贝</strong>，因此不同的线程间无法访问对方的工作内存。</li><li>线程间的通信（传值）必须通过主内存来完成，其简要访问过程如下图：</li></ol><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210610213130.png" alt="" style="zoom:80%;" /><p>通过前面对JMM的介绍，我们知道各个线程对主内存中共享变量的操作都是各个线程各自<font color='blue'>拷贝</font>到自己的工作内存进行操作后再写回到主内存中的。</p><p>这就可能存在一个线程AAA修改了共享变量X的值但还未写回主内存时，另外一个线程BBB又对主内存中同一个共享变量X进行操作，但此时A线程工作内存中共享变量x对线程B来说并不可见，<font color='blue'>这种工作内存与主内存同步延迟现象就造成了可见性问题</font>。</p><blockquote><p>有序性</p></blockquote><p>JMM是允许编译器和处理器对<font color='red'>指令重排序</font>（后面再具体讲解）的，但是规定了 as-if-serial语义，即<font color='red'>不管怎么重排序，程序的执行结果不能改变</font>。</p><p>多线程有序性引起的问题我们可以看一个典型的例子：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">OrderExample</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">int</span> i <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>如果这个类的writer()和read()方法是在不同的线程中运行的。那么writer()中的方法可能会被重排序为<code>flag = true;</code>先执行。这个时候如果该线程被中断，换到执行reader()的线程执行，此时flag为true，进入if判断就<font color='red'>会自然认为a=1</font>，但是<font color='red'>这个时候a还是0</font>.这里大概就能理解重排序带来的问题了。</p><p><strong>指令重排序的优点：</strong>如果前后程序语句没有依赖性的话，指令重排序有可能会提高程序的运行效率。</p><blockquote><p>JMM的8种操作</p></blockquote><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617162403.png" style="zoom:80%;" /><p>关于主内存与工作内存之间的交互协议，即一个变量如何从主内存拷贝到工作内存。如何从工作内存同步到主内存中的实现细节。java内存模型定义了8种操作来完成。<strong>这8种操作每一种都是原子操作</strong>。8种操作如下：</p><ul><li>lock(锁定)：作用于主内存，它把一个变量标记为一条线程独占状态；</li><li>read(读取)：作用于主内存，它把变量值从主内存传送到线程的工作内存中，以便随后的load动作使用；</li><li>load(载入)：作用于工作内存，它把read操作的值放入工作内存中的变量副本中；</li><li>use(使用)：作用于工作内存，它把工作内存中的值传递给执行引擎，每当虚拟机遇到一个需要使用这个变量的指令时候，将会执行这个动作；</li><li>assign(赋值)：作用于工作内存，它把从执行引擎获取的值赋值给工作内存中的变量，每当虚拟机遇到一个给变量赋值的指令时候，执行该操作；</li><li>store(存储)：作用于工作内存，它把工作内存中的一个变量传送给主内存中，以备随后的write操作使用；</li><li>write(写入)：作用于主内存，它把store传送值放到主内存中的变量中。</li><li>unlock(解锁)：作用于主内存，它将一个处于锁定状态的变量释放出来，释放后的变量才能够被其他线程锁定；</li></ul><p>Java内存模型还规定了执行上述8种基本操作时必须满足如下规则:</p><ul><li><p>不允许read和load、store和write操作之一单独出现（即不允许一个变量从主存读取了但是工作内存不接受，或者从工作内存发起会写了但是主存不接受的情况），以上两个操作必须按顺序执行，但没有保证必须连续执行，也就是说，read与load之间、store与write之间是可插入其他指令的。</p></li><li><p>不允许一个线程丢弃它的最近的assign操作，即变量在工作内存中改变了之后必须把该变化同步回主内存。</p></li><li><p>不允许一个线程无原因地（没有发生过任何assign操作）把数据从线程的工作内存同步回主内存中。</p></li><li><p>一个新的变量只能从主内存中“诞生”，不允许在工作内存中直接使用一个未被初始化（load或assign）的变量，换句话说就是对一个变量实施use和store操作之前，必须先执行过了assign和load操作。</p></li><li><p>一个变量在同一个时刻只允许一条线程对其执行lock操作，但lock操作可以被同一个条线程重复执行多次，多次执行lock后，只有执行相同次数的unlock操作，变量才会被解锁。</p></li><li><p>如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前，需要重新执行load或assign操作初始化变量的值。</p></li><li><p>如果一个变量实现没有被lock操作锁定，则不允许对它执行unlock操作，也不允许去unlock一个被其他线程锁定的变量。</p></li><li><p>对一个变量执行unlock操作之前，必须先把此变量同步回主内存（执行store和write操作）。</p></li></ul><h2 id="15-volatile"><a href="#15-volatile" class="headerlink" title="15 volatile"></a>15 volatile</h2><h3 id="15-1-谈谈你对volatile的理解"><a href="#15-1-谈谈你对volatile的理解" class="headerlink" title="15.1 谈谈你对volatile的理解"></a>15.1 谈谈你对volatile的理解</h3><p><strong><font color='red'>volatile是java虚拟机提供的轻量级同步机制</font></strong>。</p><p><strong>volatile的三大特性：</strong></p><p>1、保证可见性。</p><p>2、不保证原子性。</p><p>3、禁止指令重排，即保证了有序性。</p><p>JMM的三大特性，volatile只保证了两个，即可见性和有序性，不满足原子性</p><h3 id="15-2-volatile-保证可见性"><a href="#15-2-volatile-保证可见性" class="headerlink" title="15.2 volatile 保证可见性"></a>15.2 volatile 保证可见性</h3><blockquote><p>volatile可见性代码验证</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 模拟主内存中的共享数据</span><span class="token keyword">class</span> <span class="token class-name">MyData</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTo60</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 未加volatile，验证一个线程操作共享数据时，另一个线程不可见 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyData myData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 线程，操作共享数据</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" get number:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程等待一段时间，假设在进行计算</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 修改数据</span>            myData<span class="token punctuation">.</span><span class="token function">addTo60</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 获取修改后的数据</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" update number value:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" get number:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>myData<span class="token punctuation">.</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// main线程持有共享数据的拷贝，一直为0，陷入循环</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 按道理这个值是不可能打印出来的，因为主线程运行的时候，number的值为0，所以一直在循环</span>            <span class="token comment" spellcheck="true">// 如果能输出这句话，说明AAA线程在睡眠3秒后，更新的number的值，重新写入到主内存，并被main线程感知到了</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" mission is over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>输出结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614102934.png" style="zoom:80%;" /><p>结果分析：</p><p>1、BBB线程没有停止，没有输出 mission is over。说明没有用volatile修饰的变量，是没有可见性。AAA线程中虽然对共享数据进行了修改，但是BBB线程中仍然是最初共享数据的拷贝，一直为0</p><p>当我们修改MyData类中的成员变量时，并且添加volatile关键字修饰。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 模拟主内存中的共享数据</span><span class="token keyword">class</span> <span class="token class-name">MyData</span><span class="token punctuation">{</span>    <span class="token keyword">volatile</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTo60</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * volatile关键字，是为了增加线程之间的可见性，只要有一个线程修改了内存中的值，其它线程也能马上感知 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyData myData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 线程，操作共享数据</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" get number:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程等待一段时间，假设在进行计算</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 修改数据</span>            myData<span class="token punctuation">.</span><span class="token function">addTo60</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 获取修改后的数据</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" update number value:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" get number:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>myData<span class="token punctuation">.</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// main线程持有共享数据的拷贝，一直为0，陷入循环</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" mission is over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614103252.png" style="zoom:80%;" /><p>结果分析：</p><p>1、共享数据被volatile关键字修饰后，当AAA线程修改了共享数据后，BBB线程也感知到修改后的数据，输出了 mission is over。</p><p><font color='red'>注意代码顺序：</font></p><p><font color='blue'>将修改数据代码与等待时间代码调换一下，结果就不一样了。</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 模拟主内存中的共享数据</span><span class="token keyword">class</span> <span class="token class-name">MyData</span><span class="token punctuation">{</span>    <span class="token keyword">volatile</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTo60</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 未加volatile，验证一个线程操作共享数据时，另一个线程不可见 * volatile关键字，是为了增加线程之间的可见性，只要有一个线程修改了内存中的值，其它线程也能马上感知 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyData myData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 线程，操作共享数据</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" get number:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 修改数据</span>            myData<span class="token punctuation">.</span><span class="token function">addTo60</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程等待一段时间，假设在进行计算</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 获取修改后的数据</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" update number value:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" get number:"</span><span class="token operator">+</span>myData<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>myData<span class="token punctuation">.</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// main线程持有共享数据的拷贝，一直为0，陷入循环</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" mission is over"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614103449.png" style="zoom:80%;" /><p>分析结果：</p><p>1、BBB线程输出了 mission is over，证明BBB线程感知到了共享数据的改变，由上图可看出BBB线程获取到的共享数据是AAA线程修改后的数据。应该是AAA线程修改完共享数据后，写回了主内存，导致BBB线程一开始获取到的共享数据是60</p><p>2、<font color='red'>等待时间代码表示的是现实中操作花费的时间，必须放在修改数据之前。</font></p><h3 id="15-3-volatile-不保证原子性"><a href="#15-3-volatile-不保证原子性" class="headerlink" title="15.3 volatile 不保证原子性"></a>15.3 volatile 不保证原子性</h3><blockquote><p>volatile不保证原子性代码验证</p></blockquote><p>原子性：不可分割！线程A在执行任务的时候，是不能被打扰的，也不能被分割，要么同时成功，要么同时失败。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MyData2</span><span class="token punctuation">{</span>    <span class="token keyword">volatile</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        number<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 验证volatile 不保证原子性 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileAtomicityDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyData2 myData2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 创建20个线程，每个线程里面进行1000次循环</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    myData2<span class="token punctuation">.</span><span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 等待上面20个线程都计算完成后，再用main线程取得最终的结果值</span>        <span class="token comment" spellcheck="true">// 通过 Thread.activeCount()，来感知20个线程是否执行完毕</span>        <span class="token comment" spellcheck="true">// 这里判断线程数是否大于2，为什么是2？因为默认是有两个线程的，一个main线程，一个gc线程</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 查看最终的值</span>        <span class="token comment" spellcheck="true">// 假设volatile保证原子性，那么输出的值应该为：  20 * 1000 = 20000</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" finally number value:"</span><span class="token operator">+</span>myData2<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 最终输出结果：都是小于20000的</span></code></pre><p>结果分析：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614112709.png" alt="数值丢失原因" style="zoom: 67%;" /><p><code>number++</code> 在多线程下是线程不安全的。</p><p>我们可以将该代码编译成字节码，可以看出<code>number++</code>被编译成了3条指令：</p><ul><li>第一步：执行<code>getfield</code>，从主内存中拿到原始数据<code>number</code>；</li><li>第二步：执行<code>idd</code>，进行加1操作；</li><li>第三步：执行<code>putfield</code>，把累加结果写回主内存。</li></ul><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614111240.png" style="zoom:67%;" /><p>如果我们没有加<code>synchronized</code>，那么第一步就可能存在着，三个线程同时通过<code>getfield</code>命令，拿到了主内存中的number值，然后三个线程在各自的工作内存中进行加1操作，但<font color='red'>他们并发进行 <code>iadd</code> 命令的时候，因为只能一个进行写，所以其它操作会被挂起</font>。</p><p>假设1线程，先进行了写操作，在写完后，volatile的可见性，应该需要告诉其它两个线程，主内存的值已经被修改了，但是<font color='red'>因为太快了</font>，<font color='red'>其它两个线程，陆续执行 <code>iadd</code>命令，进行写入操作，这就造成了其他线程没有接收到主内存number的改变，从而覆盖了原来的值</font>，出现写丢失，这样也就让最终的结果少于20000。</p><blockquote><p>volatile不保证原子性解决代码</p></blockquote><ul><li>可加 synchronized 解决，但它是重量级同步机制，性能上有所顾虑。</li><li>还可以<font color='red'>使用 JUC 下面的原子包装类</font>，即刚刚的 int 类型的 number ，可以使用 <code>AtomicInteger</code>来代替</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>jie<span class="token punctuation">.</span>juc<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span>AtomicInteger<span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">MyData2</span><span class="token punctuation">{</span>    <span class="token keyword">volatile</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * int类型的原子包装类     */</span>    AtomicInteger number2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        number<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPlusPlus2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 底层使用的是自旋锁</span>        number2<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 验证volatile 不保证原子性 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileAtomicityDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyData2 myData2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 创建20个线程，每个线程里面进行1000次循环</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    myData2<span class="token punctuation">.</span><span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    myData2<span class="token punctuation">.</span><span class="token function">addPlusPlus2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 等待上面20个线程都计算完成后，再用main线程取得最终的结果值</span>        <span class="token comment" spellcheck="true">// 通过 Thread.activeCount()，来感知20个线程是否执行完毕</span>        <span class="token comment" spellcheck="true">// 这里判断线程数是否大于2，为什么是2？因为默认是有两个线程的，一个main线程，一个gc线程</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 查看最终的值</span>        <span class="token comment" spellcheck="true">// 假设volatile保证原子性，那么输出的值应该为：  20 * 1000 = 20000</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" finally number value:"</span><span class="token operator">+</span>myData2<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" finally number2 value:"</span><span class="token operator">+</span>myData2<span class="token punctuation">.</span>number2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614114454.png" style="zoom:80%;" /><h3 id="15-4-volatile-禁止指令重排"><a href="#15-4-volatile-禁止指令重排" class="headerlink" title="15.4 volatile 禁止指令重排"></a>15.4 volatile 禁止指令重排</h3><blockquote><p>指令重排</p></blockquote><p>指令重排序，就是出于优化考虑，CPU执行指令的顺序跟程序员自己编写的顺序不一致。</p><p>计算机在执行程序时，为了提高性能，编译器和处理器常常会对指令重排，一般分为以下三种：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614143142.png" alt="指令重排" style="zoom:67%;" /><ul><li>单线程环境下可以确保程序最终执行结果和代码顺序执行的结果一致。</li><li>处理器在进行重排序时必须要考虑<strong><font color='red'>指令之间的数据依赖性</font></strong>。</li><li>多线程环境中线程交替执行，由于<font color='red'>编译器优化重排</font>的存在，<font color='red'>两个线程中使用的变量能否保证一致性是无法确定的</font>，结果无法预测。</li></ul><ol><li><p>指令重排—example1</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> mySort<span class="token punctuation">{</span>    <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//语句1</span>    <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//语句2</span>    × <span class="token operator">=</span> × <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//语句3</span>    y <span class="token operator">=</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//语句4</span><span class="token punctuation">}</span></code></pre><p>按照单线程环境下，执行顺序是1    2    3    4</p><p>但是在多线程环境下，可能出现以下的顺序：</p><ul><li>2    1    3    4</li><li>1    3    2    4</li></ul><p>问题：请问语句4可以重排后变成第一个条吗？答：<font color='red'>不能</font>。因为<font color='blue'>语句4需要依赖于 y的申明，以及x的申明，故因为存在数据依赖，无法首先执行</font>。</p></li><li><p>指令重排—example2</p><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y <span class="token operator">=</span> <span class="token number">0</span></code></pre><table><thead><tr><th align="center">线程1</th><th align="center">线程2</th></tr></thead><tbody><tr><td align="center">x = a;</td><td align="center">y = b;</td></tr><tr><td align="center">b = 1;</td><td align="center">a = 2;</td></tr><tr><td align="center">结果：x = 0; y = 0</td><td align="center"></td></tr></tbody></table><p>因为上面的代码，不存在数据的依赖性，因此编译器可能对数据进行重排</p><table><thead><tr><th align="center">线程1</th><th align="center">线程2</th></tr></thead><tbody><tr><td align="center">b = 1;</td><td align="center">a = 2;</td></tr><tr><td align="center">x = a;</td><td align="center">y = b;</td></tr><tr><td align="center">结果：x = 2; y = 1</td><td align="center"></td></tr></tbody></table><p>这样造成的结果，和最开始的就不一致了，这就是导致重排后，结果和最开始的不一样，因此为了防止这种结果出现，volatile就规定禁止指令重排，为了保证数据的一致性。</p></li><li><p>指令重排—example3</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReSortSeqDemo</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//语句1</span>        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//语句2</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method02</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>            a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">//语句3</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"retValue: "</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//可能是6或1或5或0</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>如果按照正常的顺序，分别调用method01() 和 method02() 那么，最终输出就是 a = 6</p><p>但是如果在多线程环境下，因为方法1 和 方法2，他们之间不存在数据依赖的问题，因此原先正常顺序是</p><pre class=" language-java"><code class="language-java">a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"reValue:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>但是在经过编译器，指令，或者内存的重排后，可能会出现这样的情况</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 变量 a 与 flag 并没有数据依赖性，所以 a = 1; 与 flag = true; 语句无法保证谁先谁后</span>flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"reValue:"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><p>也就是先执行 flag = true后，另外一个线程马上调用方法2，满足 flag的判断，最终让a + 5，结果为5，这样同样出现了数据不一致的问题。</p><p>为什么会出现这个结果：多线程环境中线程交替执行，由于编译器优化重排的存在，两个线程中使用的变量能否保证一致性是无法确定的，结果无法预测。这样就需要通过volatile来修饰，来保证线程安全性。</p></li></ol><blockquote><p>volatile 禁止指令重排序</p></blockquote><p>Volatile实现禁止指令重排优化，从而避免了多线程环境下程序出现乱序执行的现象。</p><p>首先了解一个概念<font color='red'>，内存屏障（Memory Barrier）</font>又称内存栅栏，是一个CPU指令，它的作用有两个：</p><ul><li><font color='red'>保证特定操作的顺序</font>；</li><li><font color='red'>保证某些变量的内存可见性</font>（利用该特性实现volatile的内存可见性）</li></ul><p>由于编译器和处理器都能执行指令重排的优化，如果<font color='red'>在指令间插入一条Memory Barrier</font>则会告诉编译器和CPU，<font color='red'>不管什么指令都不能和这条Memory Barrier指令重排序</font>，也就是说<font color='red'>通过插入内存屏障禁止在内存屏障前后的指令执行重排序优化</font>。 </p><p>内存屏障另外一个作用是刷新出各种CPU的缓存数，因此任何CPU上的线程都能读取到这些数据的最新版本。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614150546.png" alt=""></p><p>也就是说在Volatile的写 和 读的时候，加入屏障，防止出现指令重排的。</p><h3 id="15-5-线程安全保障"><a href="#15-5-线程安全保障" class="headerlink" title="15.5 线程安全保障"></a>15.5 线程安全保障</h3><p>如何使线程安全性获得保证？</p><ul><li><font color='blue'>工作内存与主内存</font>同步延迟现象导致的可见性问题<ul><li>可通过<code>synchronized</code>或<code>volatile</code>关键字解决，他们都可以使一个线程修改后的变量立即对其它线程可见</li></ul></li><li>对于<font color='blue'>指令重排</font>导致的可见性问题和有序性问题<ul><li>可以使用<code>volatile</code>关键字解决，因为volatile关键字的另一个作用就是禁止重排序优化</li></ul></li></ul><h3 id="15-6-volatile应用—单例模式"><a href="#15-6-volatile应用—单例模式" class="headerlink" title="15.6 volatile应用—单例模式"></a>15.6 volatile应用—单例模式</h3><p><strong>DCL模式：Double Check Lock，即双端检索机制：在加锁前后都进行判断</strong></p><blockquote><p>DCL模式</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态私有变量保存单例对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 对外提供获取对象的静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//DCL模式 Double Check Lock 双端检索机制：在加锁前后都进行判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 对类加锁</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这种写法在多线程条件下可能正确率为 99.999999%，但可能由于指令重排而导致出错。</p><blockquote><p>懒汉单例DCL</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 静态私有变量保存单例对象</span>    <span class="token comment" spellcheck="true">// 加上volatile禁止指令重排</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 对外提供获取对象的静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//DCL模式 Double Check Lock 双端检索机制：在加锁前后都进行判断</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 对类加锁</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>静态内部类</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 在内部类里使用私有变量保存该对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Inner</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 对外提供的静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> Inner<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>枚举单例</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>ymy<span class="token punctuation">.</span>single<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Constructor<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">enum</span> EnumSingle <span class="token punctuation">{</span>    INSTANCE<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> EnumSingle <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 测试反射！</span><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        EnumSingle instance1 <span class="token operator">=</span> EnumSingle<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Constructor<span class="token operator">&lt;</span>EnumSingle<span class="token operator">></span> declaredConstructor <span class="token operator">=</span> EnumSingle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        declaredConstructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// java.lang.IllegalArgumentException: Cannot reflectively create enum objects</span>        EnumSingle instance2 <span class="token operator">=</span> declaredConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>instance1 <span class="token operator">==</span> instance2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="16-CAS"><a href="#16-CAS" class="headerlink" title="16 CAS"></a>16 CAS</h2><h3 id="16-1-谈谈CAS"><a href="#16-1-谈谈CAS" class="headerlink" title="16.1 谈谈CAS"></a>16.1 谈谈CAS</h3><p><font color='red'>CAS的全称为Compare-And-Swap</font>，它是一条CPU并发原语。</p><p>它的功能是判断内存某个位置的值是否为预期值，如果是则更改为新的值，这个过程是原子的。</p><p>CAS并发原语体现在Java语言中就是<font color='red'>sun.misc.Unsafe类的各个方法</font>。调用UnSafe类中的CAS方法，JVM会帮我们实现出CAS汇编指令，这是一种<font color='red'>完全依赖于硬件的功能，通过它实现了原子操作</font>。</p><p>再次强调，由于<font color='red'>CAS是一种系统原语，原语属于操作系统用语范畴</font>，是<font color='blue'>由若干条指令组成，用于完成某个功能的一个过程，并且原语的执行必须是连续的，在执行过程中不允许被中断</font>，也就是说CAS是一条CPU的原子指令，不会造成所谓的数据不一致的问题，也就是说CAS是线程安全的。</p><blockquote><p><code>compareAndSet()</code> 方法</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CASDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建一个原子类，初始值为5</span>        AtomicInteger atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 一个是期望值，一个是更新值，但期望值和原来的值相同时，才能够更改</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2019</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">" current data:"</span><span class="token operator">+</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">" current data:"</span><span class="token operator">+</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614154300.png" style="zoom:80%;" /><p>结果分析：</p><p>1、这是因为我们执行第一个的时候，期望值5和原本值5是相等的，因此修改成功，但是第二次后，主内存的值已经修改成了2019，不满足期望值5，因此返回了false，本次写入失败。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614154540.png" alt="" style="zoom:80%;" /><h3 id="16-2-CAS底层原理"><a href="#16-2-CAS底层原理" class="headerlink" title="16.2 CAS底层原理"></a>16.2 CAS底层原理</h3><p>一句话总结：<strong><font color='red'>自旋锁 + Unsafe类</font></strong></p><p>Unsafe是CAS的核心类，由于Java方法无法直接访问底层系统，需要通过<font color='red'>本地（Native）方法</font>来访问，Unsafe相当于一个后门，<font color='red'>基于Unsafe类可以直接操作特定的内存数据</font>。</p><p><font color='red'>Unsafe类存在<code>sun.misc</code>包</font>中，其内部方法操作可以像C的指针一样<font color='red'>直接操作内存</font>，因为Java中的CAS操作的执行依赖于Unsafe类的方法。</p><p><strong><font color='red'>注意Unsafe类的所有方法都是native修饰的，也就是说unsafe类中的方法都直接调用操作系统底层资源执行相应的任务</font></strong>。</p><p>为什么Atomic修饰的包装类，能够保证原子性，依靠的就是底层的unsafe类。</p><blockquote><p><strong>AtomicInteger 类 CAS 算法分析</strong></p></blockquote><ul><li><code>AtomicInteger</code> 类调用 <code>getAndIncrement()</code>方法；</li><li><code>atomicInteger.getAndIncrement()</code> 方法调用 <code>unsafe.getAndAddInt()</code> 方法；<ul><li><code>this.getIntVolatile(var1,var2)</code> 方法获取var1这个对象在var2地址上的<font color='red'>主内存值</font>；</li><li><code>this.compareAndSwapInt(var1, var2, var5, var5 + var4)</code> 方法<font color='red'>判断现在主内存值与上一次主内存值var5是否相等</font>：<ul><li>如果相同，证明没有其他线程改过，则执行 +var4 操作；</li><li>如果不同，证明有其他线程改过主内存值，然后再重新获取主内存值，重复 compare and set 操作。</li></ul></li></ul></li></ul><blockquote><p><strong><code>atomicInteger.getAndIncrement()</code>方法源码</strong></p></blockquote><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614154953.png" style="zoom:80%;" /><p>从这里能够看到，底层又调用了一个<code>unsafe</code>类的<code>getAndAddInt</code>方法。</p><p><font color='blue'>AtomicInteger 类中维护了一个 Unsafe 实例，和一个 volatile 修饰的 value 值</font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicInteger</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span> <span class="token keyword">implements</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 6214790243416807050L<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Unsafe类中有大量的native方法,java是无法操作的,要调用底层的C++接口来直接操作内存</span>    <span class="token comment" spellcheck="true">// Unsafe类相当于Java的后门,可以通过C++来操作内存</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Unsafe unsafe <span class="token operator">=</span> Unsafe<span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// valueOffset获取内存地址的偏移值。通过valueOffset，直接通过内存地址，获取到值，然后进行加1的操作</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// AtomicInteger类保存的具体值,使用volatile保证线程间的可见性，禁止指令重排</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><blockquote><p><strong><code>unsafe.getAndAddInt()</code>源码</strong></p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * unsafe.getAndAddInt() * @param var1  Atomiclnteger对象本身 * @param var2  该对象的偏移量 * @param var4  需要增加的值 * @return  返回主内存的值 */</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span>Object var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token keyword">int</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> var5<span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// var5：通过当前对象var1和地址偏移量var2获得主内存中值</span>        <span class="token comment" spellcheck="true">// 如果当前线程获取主内存值var5后，被挂起，其他线程将主内存值修改后，</span>        <span class="token comment" spellcheck="true">// 当前线程在下面的while处，通过var1、var2 再次获得主内存值就不等于var5了，需要再次循环获取判断</span>        var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/** 如果被挂起后，再通过当前对象var1和地址偏移量var2拿到的主内存值等于var5,那么就将(var5 + var4)的值写回内存中    *     并且返回true，直接退出循环，否则就返回false，一直循环。    */</span>    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var5<span class="token punctuation">,</span> var5 <span class="token operator">+</span> var4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> var5<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 获取对象var1在偏移量var2处的值，即主内存中的值</span><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">getIntVolatile</span><span class="token punctuation">(</span>Object var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// compareAndSwap 比较前后两次主内存中的值，如果两个值相等，那么就执行操作！否则就一直自旋。</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>Object var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token keyword">int</span> var4<span class="token punctuation">,</span> <span class="token keyword">int</span> var5<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614163255.png" alt=""></p><p>分析：</p><p>1、var5：就是我们从主内存中拷贝到工作内存中的值（每次都要从主内存拿到最新的值到自己的本地内存，然后执行compareAndSwapInt()再和主内存的值进行比较。因为线程不可以直接越过高速缓存，直接操作主内存，所以执行上述方法需要比较一次，在执行加1操作)</p><p>2、操作的时候，需要比较工作内存中的值，和主内存中的值。如果执行 compareAndSwapInt返回false，那么就一直执行 while方法，直到期望的值和真实值一样。</p><p>这里没有用synchronized，而用CAS，这样提高了并发性，也能够实现一致性，是因为每个线程进来后，进入的do while循环，然后不断的获取内存中的值，判断是否为最新，然后在进行更新操作。</p><p>假设<strong>线程A</strong>和<strong>线程B</strong>同时执行<code>getAndInt</code>操作（分别跑在不同的CPU上）</p><ol><li><code>AtomicInteger</code>里面的<code>value</code>原始值为3，即<font color='red'>主内存中<code>AtomicInteger的 value</code> 为3</font>，根据JMM模型，线程A和线程B各自持有一份价值为3的副本，分别存储在各自的工作内存；</li><li>线程A通过<code>getIntVolatile(var1 , var2)</code> 拿到<code>value</code>值3，这是线程A被挂起（该线程失去CPU执行权）</li><li>线程B也通过<code>getIntVolatile(var1, var2)</code>方法获取到<code>value</code>值也是3，此时刚好线程B没有被挂起，并执行了compareAndSwapInt方法，比较主内存的值也是3，成功修改主内存值为4，线程B打完收工，一切OK</li><li>这时线程A恢复，执行CAS方法，<font color='red'>比较发现自己手里上次获得的主内存值3和现在主内存中的值4不一致</font>，说明主内存值已被其它线程抢先一步修改过了，那么A线程本次修改失败，只能够重新读取主内存值后再来一遍了，也就是在执行do while</li><li>线程A重新获取主内存值，因为主内存变量value被volatile修饰，所以其它线程对它的修改，线程A总能够看到，线程A继续执行compareAndSwapInt进行比较替换，直到成功。</li></ol><blockquote><p><strong><code>compareAndSwapInt()</code>方法</strong></p></blockquote><p>Unsafe类中的<code>compareAndSwapInt</code>是一个<font color='red'>本地方法</font>(是底层汇编指令)，该方法的实现位于unsafe.cpp中</p><ul><li>先想办法拿到变量value在内存中的地址</li><li>通过Atomic::cmpxchg实现比较替换，其中参数X是即将更新的值，参数e是原内存的值</li></ul><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614171104.png" style="zoom:67%;" /><h3 id="16-3-CAS缺点"><a href="#16-3-CAS缺点" class="headerlink" title="16.3 CAS缺点"></a>16.3 CAS缺点</h3><p>CAS不加锁，保证一次性，但是需要多次比较</p><ol><li><p><strong>循环时间长开销很大</strong></p><p>我们可以看到getAndAddInt方法执行时，有个do while</p><p>如果CAS失败，会一直进行尝试。如果CAS长时间<font color='red'>一直不成功，可能会给CPU带来很大的开销</font>。</p></li><li><p>只能保证一个共享变量的原子操作</p><ul><li><p>当对一个共享变量执行操作时，我们可以使用循环CAS的方式来保证原子操作，</p></li><li><p>当对多个共享变量操作时，循环CAS就无法保证操作的原子性，这个时候就可以<font color='red'>用锁来保证原子性</font>。</p></li></ul></li><li><p>引出来ABA问题？</p></li></ol><h3 id="16-4-面试题—AtomicInteger为什么用-CAS-而不用synchronized？"><a href="#16-4-面试题—AtomicInteger为什么用-CAS-而不用synchronized？" class="headerlink" title="16.4 面试题—AtomicInteger为什么用 CAS 而不用synchronized？"></a>16.4 面试题—AtomicInteger为什么用 CAS 而不用synchronized？</h3><ol><li>synchronized采用的是悲观锁，是一种独占锁，独占锁就意味着 其他线程只能依靠阻塞来等待线程释放锁。，Synchronized是只允许一个线程运行，虽然一致性保证了，但是降低并发性；</li><li>如果使用 synchronized 没有抢到同步锁，那么线程将处于阻塞状态，等待 CPU 的下一次调度</li><li>CAS采用的是一种乐观锁的机制。CAS 使用 Unsafe 类 + 自旋锁实现操作的原子性，Unsafe 类中使用 do while 循环实现 compare and set ，多个线程可以同时操作，大大提高了程序的并发性，并且不存在让线程等待的问题</li></ol><p><strong><em>tips：</em></strong></p><ul><li><strong>悲观锁</strong>是将资源锁住，等一个之前获得锁的线程释放锁之后，下一个线程才可以访问（比如synchronized）。</li><li><strong>乐观锁</strong>采取了一种宽泛的态度，通过某种方式不加锁来处理资源，比如通过给记录<strong>加version来获取数据</strong>，性能较悲观锁有很大的提高。</li></ul><h2 id="17-原子类的ABA问题"><a href="#17-原子类的ABA问题" class="headerlink" title="17 原子类的ABA问题"></a>17 原子类的ABA问题</h2><p>面试题：<strong>原子类AtomicInteger的ABA问题？原子更新引用知道吗？</strong></p><h3 id="17-1-ABA问题的产生"><a href="#17-1-ABA问题的产生" class="headerlink" title="17.1 ABA问题的产生"></a>17.1 ABA问题的产生</h3><p>面试坑爹套路：</p><p>JMM  —&gt; volatile —&gt; AtomicInteger —&gt; CAS —&gt; Unsafe —&gt; CAS底层原理 —&gt; ABA —&gt; 原子引用更新 —&gt; 如果规避ABA问题</p><blockquote><p>ABA问题是什么</p></blockquote><p><strong>一句话：<font color='red'><code>ABA</code>问题就是狸猫换太子</font>。</strong></p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614194705.png" style="zoom:67%;" /><p>假设主内存中有一条记录<code>Record1</code>，<code>Thread-A</code>去修改了这条记录，把<code>Record1</code>修改成了<code>Record2</code>，过了一会儿<code>Thread-A</code>又把<code>Record2</code>修改了<code>Record1</code>，然后<code>Thread-A</code>就执行结束了。接着<code>Thread-B</code>来修改记录，<code>Thread-B</code>期望内存中存储的记录是<code>Record1</code>，这时候内存中存储的记录也确实是<code>Record1</code>，于是<code>Thread-B</code>就将<code>Record1</code>修改成了<code>Record3</code>，实际上这种操作是有问题的！这就是原子引用的<code>ABA</code>问题！</p><p>所以ABA问题就是，<font color='red'>在进行获取主内存值的时候，该内存值在我们写入主内存的时候，已经被修改了N次，但是最终又改成原来的值了</font></p><blockquote><p>CAS会导致ABA问题</p></blockquote><p>CAS算法实现的一个重要前提，<font color='red'>需要取出主内存中某时刻的数据，并在当下时刻比较并替换，那么这个时间差就会导致数据的变化</font>。</p><p>比如说一个线程one从主内存位置V中取出A，这时候另外一个线程two也从内存中取出A，并且线程two进行了一些操作将值变成了B，然后线程two又将V位置的数据变成A，这时候线程one进行CAS操作发现内存中仍然是A，然后线程one操作成功。</p><p><font color='red'>尽管线程one的CAS操作成功，但是不代表这个过程就是没有问题的</font>。</p><p><strong>总结：</strong><font color='blue'>CAS只管开头和结尾，也就是头和尾是一样，那就修改成功，中间的这个过程，可能会被人修改过</font></p><h3 id="17-2-原子引用"><a href="#17-2-原子引用" class="headerlink" title="17.2 原子引用"></a>17.2 原子引用</h3><p>原子引用其实和原子包装类是差不多的概念，就是将一个java类，用原子引用类进行包装起来，那么这个类就具备了原子性</p><p>代码：使用 <code>AtomicReference</code> 原子引用类封装我们自定义的 User 类</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 自定义类</span><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{</span>    String userName<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>String userName<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"User{"</span> <span class="token operator">+</span>                <span class="token string">"userName='"</span> <span class="token operator">+</span> userName <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>                <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span>                <span class="token string">'}'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 使用 AtomicReference 原子引用类封装我们自定义的User类 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建原子引用包装类</span>        AtomicReference<span class="token operator">&lt;</span>User<span class="token operator">></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User z3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User l4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User w5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 现在主物理内存的共享变量，为z3</span>        atomicReference<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>z3<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 比较并交换，如果现在主物理内存的值为z3，那么交换成l4</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>z3<span class="token punctuation">,</span> l4<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token operator">+</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 比较并交换，现在主物理内存的值是l4了，但是预期为z3，因此交换失败</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>z3<span class="token punctuation">,</span> w5<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token operator">+</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614201147.png" style="zoom:80%;" /><blockquote><p>普通原子引用包装类引起的ABA问题</p></blockquote><p>我们首先创建了两个线程，然后T1线程，执行一次ABA的操作，T2线程在一秒后修改主内存的值</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 普通的原子引用包装类     */</span>    <span class="token keyword">static</span> AtomicReference<span class="token operator">&lt;</span>Integer<span class="token operator">></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// t1线程，执行一次ABA的操作</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 把100 改成 101 然后在改成100，也就是ABA</span>            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// t2线程在一秒后修改主内存的值</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 睡眠一秒，保证t1线程，完成了ABA操作</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span><span class="token operator">+</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614202433.png" alt=""></p><p>结果分析：</p><p>1、它能够成功的修改，这就是ABA问题</p><h3 id="17-3-解决ABA问题"><a href="#17-3-解决ABA问题" class="headerlink" title="17.3 解决ABA问题"></a>17.3 解决ABA问题</h3><p>新增一种机制，也就是修改版本号，类似于时间戳的概念</p><p>T1： 100 1     2019 2</p><p>T2： 100 1     101 2     100 3</p><p>如果T1修改的时候，版本号为2，落后于现在的版本号3，所以要重新获取最新值，这里就提出了一个<font color='red'>使用时间戳版本号</font>，来解决ABA问题的思路</p><p><font color='red'><code>AtomicStampedReference</code> 时间戳原子引用</font>，在这里应用于版本号的更新，也就是每次更新的时候，<font color='red'>需要比较期望值和当前值，以及期望版本号和当前版本号</font></p><p><strong><font color='red'>使用<code>AtomicStampedReference</code>来添加时间戳（版本号）来解决ABA问题</font>。</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>jie<span class="token punctuation">.</span>juc<span class="token punctuation">;</span><span class="token keyword">import</span> sun<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>NewThreadAction<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>RecursiveTask<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span>AtomicReference<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span>AtomicStampedReference<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 使用AtomicStampedReference来添加时间戳（版本号）来解决ABA问题 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicStampedReferenceDemo</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 普通的原子引用包装类     */</span>    <span class="token keyword">static</span> AtomicReference<span class="token operator">&lt;</span>Integer<span class="token operator">></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 时间戳原子引用：传递两个值，一个是初始值，一个是初始版本号     */</span>    <span class="token keyword">static</span> AtomicStampedReference<span class="token operator">&lt;</span>Integer<span class="token operator">></span> atomicStampedReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicStampedReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===========以下是ABA问题的产生=================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 把100 改成 101 然后再改成100，也就是ABA</span>            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 暂停1秒钟t2线程，保证上面t1线程完成一次ABA操作</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t"</span><span class="token operator">+</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 保证上面的操作执行完成</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=============以下是ABA问题的解决======================"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 获取版本号</span>            <span class="token keyword">int</span> stamp <span class="token operator">=</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 第一次版本号："</span><span class="token operator">+</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程等待一段时间</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 传入4个值，期望值，更新值，期望版本号，更新版本号</span>            <span class="token comment" spellcheck="true">// 把100 改成 101 然后再改成100</span>            atomicStampedReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> stamp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 第二次版本号："</span><span class="token operator">+</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            atomicStampedReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 第三次版本号："</span><span class="token operator">+</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 获取版本号</span>            <span class="token keyword">int</span> stamp <span class="token operator">=</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 第一次版本号"</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 暂停3秒，保证t3线程进行一次ABA问题</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token keyword">boolean</span> result <span class="token operator">=</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> stamp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 修改成功与否："</span><span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">"\t当前最新的实际版本号："</span><span class="token operator">+</span>atomicStampedReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t 当前实际最新值："</span><span class="token operator">+</span> atomicStampedReference<span class="token punctuation">.</span><span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t4"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210614210416.png" style="zoom:80%;" /><p>结果分析：</p><p>1、线程t3，在进行ABA操作后，版本号变更成了3，而线程t4在进行操作的时候，就出现操作失败了，因为版本号和当初拿到的不一样</p><h2 id="18-各种锁的理解"><a href="#18-各种锁的理解" class="headerlink" title="18 各种锁的理解"></a>18 各种锁的理解</h2><h3 id="18-1-公平锁和非公平锁"><a href="#18-1-公平锁和非公平锁" class="headerlink" title="18.1 公平锁和非公平锁"></a>18.1 公平锁和非公平锁</h3><ul><li>公平锁：是指<font color='red'>多个线程按照申请锁的顺序来获取锁</font>。非常公平，不能够插队，来了就排队，必须先来后到。</li><li>非公共锁：是指多个线程获取锁的顺序，并不是按照申请锁的顺序，有可能申请的线程比先申请的线程优先获取锁。非常不公平，<font color='red'>上来就直接尝试占有锁</font>，如果尝试失败，就再采用类似公平锁那种方式。<strong><font color='red'>（默认都是非公平锁）</font></strong>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ReentrantLock 默认就是非公平锁</span><span class="token keyword">public</span> <span class="token function">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 可以将ReentrantLock 默认的非公平锁修改为公平锁</span><span class="token keyword">public</span> <span class="token function">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong><em>tips：</em></strong></p><ul><li>Java ReentrantLock而言，通过构造函数指定该锁是否是公平锁，默认是非公平锁。</li><li>非公平锁的优点在于吞吐量比公平锁大。</li><li>对于Synchronized而言，也是一种非公平锁</li></ul><h3 id="18-2-可重入锁"><a href="#18-2-可重入锁" class="headerlink" title="18.2 可重入锁"></a>18.2 可重入锁</h3><p><strong>可重入锁（递归锁）：</strong>指的是同一线程外层函数获得锁之后，内层递归函数仍然能获取到该锁的代码，<font color='red'>在同一线程在外层方法获取锁的时候，在进入内层方法会自动获取锁。</font></p><p>也就是说<font color='red'>某个线程已经获得某个锁，可以再次获取相同的锁而不会出现死锁。</font></p><p><code>ReentrantLock</code> 和<code>Synchronized</code> 就是典型的可重入锁</p><p>可重入锁的最大作用就是避免死锁</p><blockquote><p>Synchronized版本</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Phone</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 发送短信</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEMS()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 在同一个方法中，调用另一个同步方法</span>        <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 发送邮件</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEmail()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 可重入锁（递归锁）:可重入就是说某个线程已经获得某个锁，可以再次获取相同的锁而不会出现死锁。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReenterLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        Phone phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 两个线程操作资源类</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            phone<span class="token punctuation">.</span><span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            phone<span class="token punctuation">.</span><span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615164353.png" style="zoom:80%;" /><p>结果分析：</p><p>1、当AAA线程调用<code>sendEMS();</code>方法时，获取<code>Phone</code>对象锁，同时由于<code>sendEMS();</code>方法中又调用同被<code>synchronized</code>修饰的同步方法<code>sendEmail();</code>，所以AAA线程就不用了再去获取锁了，可以直接进入 <code>sendEmail();</code>方法中！</p><blockquote><p>ReentrantLock版本</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 资源类</span><span class="token keyword">class</span> <span class="token class-name">Phone</span><span class="token punctuation">{</span>    Lock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 发送短信</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 加锁</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEMS()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 在同一个方法中，调用另一个同步方法</span>            <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 发送邮件</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 加锁</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEmail()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 可重入锁（递归锁）:可重入就是说某个线程已经获得某个锁，可以再次获取相同的锁而不会出现死锁。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReenterLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        Phone phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 两个线程操作资源类</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            phone<span class="token punctuation">.</span><span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"AAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            phone<span class="token punctuation">.</span><span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"BBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615164353.png" style="zoom:80%;" /><blockquote><p>如果我们在一个方法中添加两把锁，同时释放两把锁，会怎么样？</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 发送短信</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 加锁</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEMS()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 在同一个方法中，调用另一个同步方法</span>        <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 释放锁</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：最后得到的结果也是一样的，<font color='red'>因为方法里不管有几把锁，其它他们都是同一把锁，也就是说用同一个钥匙都能够打开</font></p><blockquote><p>如果我们在一个方法中添加两把锁，但只释放一把锁，会怎么样？</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 发送短信</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 加锁</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEMS()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 在同一个方法中，调用另一个同步方法</span>        <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 释放锁</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//      lock.unlock();</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615170054.png" style="zoom:80%;" /><p>结果分析：</p><p>1、程序直接卡死，线程不能出来，也就说明<font color='red'>我们申请几把锁，最后需要解除几把锁</font></p><blockquote><p>如果我们在一个方法中只加一把锁，但是用两把锁来解锁的时候，又会出现什么情况呢？</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 发送短信</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 加锁</span>    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//  lock.lock();</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\t invoked sendEMS()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 在同一个方法中，调用另一个同步方法</span>        <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 释放锁</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615171309.png" style="zoom:80%;" /><h3 id="18-3-自旋锁"><a href="#18-3-自旋锁" class="headerlink" title="18.3 自旋锁"></a>18.3 自旋锁</h3><p><strong>自旋锁</strong>：是指尝试获取锁的线程不会立即阻塞，而是采<font color='red'>用循环的方式去尝试获取锁</font>，这样的<font color='blue'>好处是减少线程上下文切换的消耗，缺点是循环会消耗CPU</font>。</p><p>原来提到的比较并交换，底层使用的就是自旋，自旋就是多次尝试，多次访问，不会阻塞的状态就是自旋。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615171939.png" style="zoom:67%;" /><p><strong>优缺点：</strong></p><ul><li>优点：循环比较获取直到成功为止，没有类似于wait的阻塞</li><li>缺点：当不断自旋的线程越来越多的时候，会因为执行while循环不断的消耗CPU资源</li></ul><blockquote><p>手写自旋锁</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>jie<span class="token punctuation">.</span>juc<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span>AtomicReference<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * 自定义自旋锁 */</span><span class="token keyword">class</span> <span class="token class-name">MySpinLock</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 自定义原子包装类     * 原子引用线程，泛型装的是Thread，这样主内存中共享变量是一个线程     */</span>    AtomicReference<span class="token operator">&lt;</span>Thread<span class="token operator">></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 获取锁     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取当前进来的线程</span>        Thread curThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t come in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 开启自旋，期望值是null，更新值是当前线程，如果是null，则更新为当前线程，否则自旋</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> curThread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 释放锁     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">myUnLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 获取当前进来的线程</span>        Thread curThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 自己用完之后，将atomicReference中的线程置为null</span>        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>curThread<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t invoked myUnLock()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 手写一个自旋锁 * * 比较获取直到成功为止，没有的话就循环，类似于wait的阻塞 * * 通过CAS操作完成自选操作，A线程先进来调用myLock方法自己持有锁5秒， * B线程随后进来发现已经有线程持有了该锁，不是null，所以只能通过自旋等待，直到A线程释放锁，B线程随后抢到锁 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 自定义自旋锁</span>        MySpinLock mySpinLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// t1线程</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 开始持有锁</span>            mySpinLock<span class="token punctuation">.</span><span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 持锁5秒</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            mySpinLock<span class="token punctuation">.</span><span class="token function">myUnLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 线程等待1秒，使得t1线程，先运行</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 1秒后，启动t2线程，开始占用这个锁</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 开始站有锁</span>            mySpinLock<span class="token punctuation">.</span><span class="token function">myLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 开始释放锁</span>            mySpinLock<span class="token punctuation">.</span><span class="token function">myUnLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><pre class=" language-shell"><code class="language-shell">t1     come in.....一秒后.....t2     come in.....五秒后.....t1     invoked myUnLock()t2     invoked myUnLock()</code></pre><p>结果分析：</p><p>1、首先是t1线程开始持有锁，输出 t1     come in，并且将主内存中的共享变量由null改为t1线程，然后跳出<code>myLock()</code>方法，持锁5秒；</p><p>2、然后main线程等待1秒钟；</p><p>3、t2线程开始持有锁，输出 t2     come in，但是此时主内存中的共享变量不为null，所以一直在循环自旋等待，直到锁被t1释放后，t2成功获取到锁，然后释放。</p><h3 id="18-4-独占锁（写锁）-共享锁（读锁）-互斥锁"><a href="#18-4-独占锁（写锁）-共享锁（读锁）-互斥锁" class="headerlink" title="18.4 独占锁（写锁） / 共享锁（读锁） / 互斥锁"></a>18.4 独占锁（写锁） / 共享锁（读锁） / 互斥锁</h3><ul><li><strong>独占锁</strong>：指该锁一次只能被一个线程所持有。对<code>ReentrantLock</code>和<code>Synchronized</code>而言都是独占锁</li><li><strong>共享锁</strong>：指该锁可以被多个线程持有</li></ul><p>对<code>ReentrantReadWriteLock</code><font color='red'>其读锁是共享，其写锁是独占</font>，写的时候只能一个人写，但是读的时候，可以多个人同时读</p><blockquote><p>为什么会有写锁和读锁？</p></blockquote><p>原来我们使用ReentrantLock创建锁的时候，是独占锁，也就是说一次只能一个线程访问，但是有一个读写分离场景，读的时候想同时进行，因此原来独占锁的并发性就没这么好了，因为读锁并不会造成数据不一致的问题，因此可以多个人共享读</p><hr><p><font color='red'>多个线程 同时读一个资源类没有任何问题</font>，所以为了满足并发量，<font color='red'>读取共享资源应该可以同时进行</font>，但是<font color='red'>如果一个线程想去写共享资源，就不应该再有其它线程可以对该资源进行读或写</font></p><hr><ul><li>读——读：可以共存</li><li>读——写：不能共存</li><li>写——写：不能共存</li></ul><blockquote><p>实现一个读写缓存的操作，假设开始没有加锁的时候，会出现什么情况</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 资源类 * 模拟缓存 */</span><span class="token keyword">class</span> <span class="token class-name">MyCache</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 使用volatile修饰的map存储数据：凡缓存，一定要用 volatile 修饰，保证内存可见性</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 定义写操作     * 需要满足：原子性 + 独占     * @param key     * @param value     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 正在写入："</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 模拟网络拥堵，延迟0.3秒</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 添加</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 写入完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 正在读取"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 模拟网络拥堵，延迟0.3秒</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 获取</span>        Object result <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 读取完成："</span><span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 读写锁 * 多个线程同时读一个资源类没有任何问题，所以为了满足并发量，读取共享资源应该可以同时进行 * 但是，如果一个线程想去写共享资源，就不应该再有其它线程可以对该资源进行读或写 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyCache myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 线程操作资源类，5个线程写</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// lambda表达式内部必须是final</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span> tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 线程操作资源类， 5个线程读</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// lambda表达式内部必须是final</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615202409.png" style="zoom: 67%;" /><p>结果分析：</p><p>1、写操作被分割开了，未保证写操作的原子性和独占性。</p><p>2、在写入的时候，写操作都没其它线程打断了，这就造成了，还没写完，其它线程又开始写，这样就造成数据不一致</p><blockquote><p>使用读写锁解决问题</p></blockquote><p><font color='red'>读锁和写锁的区别在于，写锁一次只能一个线程进入，执行写操作，而读锁是多个线程能够同时进入，进行读取的操作</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 资源类 * 模拟缓存，最少也就需要添加put、读取get、清空clear这三个方法 */</span><span class="token keyword">class</span> <span class="token class-name">MyCache</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 使用volatile修饰的map存储数据：凡缓存，一定要用 volatile 修饰，保证内存可见性</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 创建一个读写锁     * 它是一个读写融为一体的锁，在使用的时候，需要转换     */</span>    <span class="token keyword">private</span> ReadWriteLock rwLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 定义写操作     * 需要满足：原子性 + 独占     * @param key     * @param value     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 加锁</span>        <span class="token comment" spellcheck="true">// 写操作的时候，就需要转换成写锁</span>        rwLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 正在写入："</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 模拟网络拥堵，延迟0.3秒</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 添加</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 写入完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            rwLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 加锁</span>        <span class="token comment" spellcheck="true">// 读操作的时候，在转换成读锁</span>        rwLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 正在读取"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 模拟网络拥堵，延迟0.3秒</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 获取</span>            Object result <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 读取完成："</span><span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 释放锁</span>            rwLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 清空缓存     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 读写锁 * 多个线程同时读一个资源类没有任何问题，所以为了满足并发量，读取共享资源应该可以同时进行 * 但是，如果一个线程想去写共享资源，就不应该再有其它线程可以对该资源进行读或写 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 资源类</span>        MyCache myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 线程操作资源类，5个线程写</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// lambda表达式内部必须是final</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span> tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 线程操作资源类， 5个线程读</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// lambda表达式内部必须是final</span>            <span class="token keyword">final</span> <span class="token keyword">int</span> tempInt <span class="token operator">=</span> i<span class="token punctuation">;</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                myCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tempInt<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210615203226.png" style="zoom:67%;" /><p>结果分析：</p><p>1、写入操作是一个一个线程进行执行的，并且中间不会被打断，满足原子性 + 独占性</p><p>2、读操作的时候，是同时5个线程进入，然后并发读取操作</p><h2 id="19-死锁排查"><a href="#19-死锁排查" class="headerlink" title="19 死锁排查"></a>19 死锁排查</h2><blockquote><p>什么是死锁？</p></blockquote><p>死锁是指两个或多个以上的进程在执行过程中，因争夺资源而造成一种互相等待的现象，若无外力干涉那他们都将无法推进下去。如果资源充足，进程的资源请求都能够得到满足，死锁出现的可能性就很低，否则就会因争夺有限的资源而陷入死锁。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617110510.png" alt="死锁" style="zoom:80%;" /><blockquote><p>死锁代码测试</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 资源类 */</span><span class="token keyword">class</span> <span class="token class-name">HoldLockThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String lockA<span class="token punctuation">;</span>    <span class="token keyword">private</span> String lockB<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">HoldLockThread</span><span class="token punctuation">(</span>String lockA<span class="token punctuation">,</span> String lockB<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lockA <span class="token operator">=</span> lockA<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lockB <span class="token operator">=</span> lockB<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 持有自己的锁</span>        <span class="token comment" spellcheck="true">// 锁非this对象（锁String对象）</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lockA<span class="token punctuation">)</span><span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 自己持有："</span> <span class="token operator">+</span> lockA <span class="token operator">+</span> <span class="token string">"\t 尝试获取："</span> <span class="token operator">+</span> lockB<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 线程等待一段时间，保证另一个线程获取自己的锁</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 希望获取别人的锁</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lockB<span class="token punctuation">)</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 自己持有："</span> <span class="token operator">+</span> lockB <span class="token operator">+</span> <span class="token string">"\t 尝试获取："</span> <span class="token operator">+</span> lockA<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 死锁 小demo * 我们创建了一个资源类，然后让两个线程分别持有自己的锁，同时在尝试获取别人的，就会出现死锁现象 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 用字符串作为线程同步锁</span>        String lockA <span class="token operator">=</span> <span class="token string">"locakA"</span><span class="token punctuation">;</span>        String lockB <span class="token operator">=</span> <span class="token string">"locakB"</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HoldLockThread</span><span class="token punctuation">(</span>lockA<span class="token punctuation">,</span> lockB<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"AAAA"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HoldLockThread</span><span class="token punctuation">(</span>lockB<span class="token punctuation">,</span> lockA<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"BBBB"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// =====================================以下是另一种写法==============================================</span><span class="token comment" spellcheck="true">// 资源类Resource1</span><span class="token keyword">class</span> <span class="token class-name">Resource1</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 持有自己的锁</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Resource1<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> <span class="token string">"获取到Resource1的锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 设置延迟3S保证Thread-B获得Resource2锁</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 还希望得到别人的锁</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Resource2<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> <span class="token string">"获取到Resource2的锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 资源类Resource2</span><span class="token keyword">class</span> <span class="token class-name">Resource2</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">getRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 持有自己的锁</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Resource2<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> <span class="token string">"获取到Resource2的锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 还希望得到别人的锁</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Resource1<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t"</span> <span class="token operator">+</span> <span class="token string">"获取到Resource1的锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/** * 死锁 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadLockDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 双资源类</span>        Resource1 resource1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Resource2 resource2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Resource2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            resource1<span class="token punctuation">.</span><span class="token function">getRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            resource2<span class="token punctuation">.</span><span class="token function">getRes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617112216.png" style="zoom:80%;" /><blockquote><p>用字符串对象作为线程同步锁</p></blockquote><p><code>synchronized</code>可以锁方法、锁类、锁this对象、锁非this对象。这里以锁String对象为例。</p><ul><li><p>如果我们是以<code>String str1 = “a”;</code>的方式来声明字符串时，<code>String str1 = “a”;</code>和<code>String str2 = “a”;</code>这两个对象时同一个对象。因为<font color='red'>两者的值都是字符串常量池中”a”的地址</font>。这也就导致了在锁字符串对象的时候，可以会取得意料之外的结果（<font color='red'>字符串一样会取得相同锁</font>）。</p><p>内容相同，那么在String常量池中的位置也就相同，那两个字符串对象就是同一个。这就是<font color='red'>String常量池会带来的问题</font>。所以在大多数情况下，<font color='red'>同步代码块synchronized代码块不使用String作为锁对象</font>，而采用其他。</p></li><li><p>如果是以<code>String str1 = new String(&quot;a&quot;);</code>的方式来声明字符串对象时，<font color='red'>这样就可以保证不是同一个对象</font>。<font color='red'>字符串不一样取得的锁也不一样</font>。</p></li><li><p><font color='red'>用string产量池对象作为锁就是为了不同线程的同步，这是一个实用的功能。</font>使用String作为同步锁必须注意产生不同对象的问题，必须保证线程拿到的是同一个String对象。</p><ul><li>最简单的就是使用<code>String str1 = “a”;</code>方式直接获取String常量池中的相同对象</li><li>new String()方式都是在堆上创建字符串对象。<font color='red'>当调用<code>intern()</code>方法时，编译器会将字符串添加到常量池中，并返回指向该常量的引用</font>，这样两个内容一样的对象，返回的都是String常量池中的地址，便是同一个对象。</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">myRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> String lock1<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">myRunnable</span><span class="token punctuation">(</span>String lock1<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lock1 <span class="token operator">=</span> lock1<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock1<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\t 获得锁："</span> <span class="token operator">+</span> lock1<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 线程等待一段时间</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String str2 <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">;</span>        String str1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 使用了intern()方法后，就会指向常量池中的 a</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">myRunnable</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">myRunnable</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>运行结果：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617160753.png" style="zoom:80%;" /><blockquote><p>死锁的排查</p></blockquote><p>1、当我们出现死锁的时候，首先需要使用jps命令查看运行的程序。</p><p>​    使用<code>jps -l</code>定位进程号。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617155245.png" style="zoom:80%;" /><p>2、使用<code>jstack + 进程号</code> 打印堆栈信息</p><pre class=" language-shell"><code class="language-shell">jstack  上面定位到的进程号  </code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210617155619.png" style="zoom:80%;" /><h2 id="20-高级面试题"><a href="#20-高级面试题" class="headerlink" title="20 高级面试题"></a>20 高级面试题</h2><h3 id="20-1-为什么Synchronized无法禁止指令重排，却能保证有序性"><a href="#20-1-为什么Synchronized无法禁止指令重排，却能保证有序性" class="headerlink" title="20.1 为什么Synchronized无法禁止指令重排，却能保证有序性"></a>20.1 为什么Synchronized无法禁止指令重排，却能保证有序性</h3><p>首先我们要分析下这道题，这简单的一个问题，其实里面还是包含了很多信息的，要想回答好这个问题，面试者至少要知道一下概念：</p><ul><li>JMM</li><li>并发编程有序性问题</li><li>指令重排</li><li>synchronized锁</li><li>可重入锁</li><li>排它锁</li><li>as-if-serial语义</li><li>单线程&amp;多线程</li></ul><p><strong>正经回答</strong></p><p>一句话：synchronized是排它锁，通过排它锁的方式，synchronized修饰的代码块，会在单线程环境下运行，这符合了as-if-serial语义，而as-if-serial语义天然满足有序性。</p><blockquote><p>先解释什么是有序性问题，也知道是什么原因导致的有序性问题</p></blockquote><p>为了进一步提升计算机各方面能力，在硬件层面做了很多优化，如<font color='red'>处理器优化和指令重排等</font>，但是这些技术的引入就会<font color='red'>导致有序性问题</font>。</p><blockquote><p>表明你知道啥是指令重排，也知道他的实现原理</p></blockquote><p>我们也知道，最好的<font color='red'>解决有序性问题的办法，就是禁止处理器优化和指令重排</font>，就像volatile中使用内存屏障一样。</p><blockquote><p>重点！解释下什么是as-if-serial语义，因为这是这道题的第一个关键词，答上来就对了一半了</p></blockquote><p>但是，虽然很多硬件都会为了优化做一些重排，但是在Java中，<font color='red'>不管怎么排序，都不能影响单线程程序的执行结果。这就是as-if-serial语义</font>，<font color='red'>所有硬件优化的前提都是必须遵守as-if-serial语义</font>。</p><p>as-if-serial语义把<strong>单线程</strong>程序保护了起来，遵守as-if-serial语义的编译器，runtime 和处理器共同为编写单线程程序的程序员创建了一个幻觉：单线程程序是按程序的顺序来执行的。<font color='red'>as-if-serial语义使单线程程序员无需担心重排序会 干扰他们，也无需担心内存可见性问题。</font></p><blockquote><p>介绍synchronized的原理，这是本题的第二个关键点，到这里基本就可以拿满分了。</p></blockquote><p>再说下synchronized，他是Java提供的锁，可以通过他对Java中的对象加锁，并且他是一种排他的、可重入的锁。</p><p>所以，当某个线程执行到一段被synchronized修饰的代码之前，<font color='red'>会先进行加锁，执行完之后再进行解锁</font>。在加锁之后，解锁之前，<font color='red'>其他线程是无法再次获得锁的</font>，只有这条加锁线程可以重复获得该锁。</p><p><font color='red'>synchronized通过排他锁的方式就保证了同一时间内，被synchronized修饰的代码是单线程执行的</font>。所以呢，这就满足了as-if-serial语义的一个关键前提，那就是<strong>单线程</strong>，因为<font color='red'>有as-if-serial语义保证，单线程的有序性就天然存在了</font>。</p><h3 id="20-2-synchronized-和-lock-有什么区别？用新的lock有什么好处？举例说明"><a href="#20-2-synchronized-和-lock-有什么区别？用新的lock有什么好处？举例说明" class="headerlink" title="20.2  synchronized 和 lock 有什么区别？用新的lock有什么好处？举例说明"></a>20.2  synchronized 和 lock 有什么区别？用新的lock有什么好处？举例说明</h3><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210616210908.png" style="zoom:80%;" /><p>1、<font color='red'>synchronized属于JVM层面，属于java的关键字</font></p><ul><li>monitorenter（底层是通过monitor对象来完成，其实wait/notify等方法也依赖于monitor对象 只能在同步块或者方法中才能调用 wait/ notify等方法）</li><li>Lock是具体类（java.util.concurrent.locks.Lock）是api层面的锁</li></ul><p>2、<font color='red'>使用方法</font></p><ul><li>synchronized：不需要用户去手动释放锁，当synchronized代码执行后，系统会自动让线程释放对锁的占用</li><li>ReentrantLock：则需要用户去手动释放锁，若没有主动释放锁，就有可能出现死锁的现象，需要lock() 和 unlock() 配置try catch语句来完成</li></ul><p>3、<font color='red'>等待是否中断</font></p><ul><li>synchronized：不可中断，除非抛出异常或者正常运行完成</li><li>ReentrantLock：可中断，可以设置超时方法<ul><li>设置超时方法，trylock(long timeout, TimeUnit unit)</li><li>lockInterrupible() 放代码块中，调用interrupt() 方法可以中断</li></ul></li></ul><p>4、<font color='red'>加锁是否公平</font></p><ul><li>synchronized：非公平锁</li><li>ReentrantLock：默认非公平锁，构造函数可以传递boolean值，true为公平锁，false为非公平锁</li></ul><p>5、<font color='red'>锁绑定多个条件Condition</font></p><ul><li>synchronized：没有，要么随机，要么全部唤醒</li><li>ReentrantLock：用来实现分组唤醒需要唤醒的线程，可以精确唤醒，而不是像synchronized那样，要么随机，要么全部唤醒</li></ul><p><font color='red'>Lock的好处是：可以精确唤醒</font>。参考前面的3.4小节。</p>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 面试 </tag>
            
            <tag> 多线程JUC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【JVM】字节码指令表</title>
      <link href="/2021/06/10/jvm-zi-jie-ma-zhi-ling-biao/"/>
      <url>/2021/06/10/jvm-zi-jie-ma-zhi-ling-biao/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">字节码</th><th align="center">助记符</th><th align="center">指令含义</th></tr></thead><tbody><tr><td align="center">0x00</td><td align="center">nop</td><td align="center">None</td></tr><tr><td align="center">0x01</td><td align="center">aconst_null</td><td align="center">将null推送至栈顶</td></tr><tr><td align="center">0x02</td><td align="center">iconst_m1</td><td align="center">将int型-1推送至栈顶</td></tr><tr><td align="center">0x03</td><td align="center">iconst_0</td><td align="center">将int型0推送至栈顶</td></tr><tr><td align="center">0x04</td><td align="center">iconst_1</td><td align="center">将int型1推送至栈顶</td></tr><tr><td align="center">0x05</td><td align="center">iconst_2</td><td align="center">将int型2推送至栈顶</td></tr><tr><td align="center">0x06</td><td align="center">iconst_3</td><td align="center">将int型3推送至栈顶</td></tr><tr><td align="center">0x07</td><td align="center">iconst_4</td><td align="center">将int型4推送至栈顶</td></tr><tr><td align="center">0x08</td><td align="center">iconst_5</td><td align="center">将int型5推送至栈顶</td></tr><tr><td align="center">0x09</td><td align="center">lconst_0</td><td align="center">将long型0推送至栈顶</td></tr><tr><td align="center">0x0a</td><td align="center">lconst_1</td><td align="center">将long型1推送至栈顶</td></tr><tr><td align="center">0x0b</td><td align="center">fconst_0</td><td align="center">将float型0推送至栈顶</td></tr><tr><td align="center">0x0c</td><td align="center">fconst_1</td><td align="center">将float型1推送至栈顶</td></tr><tr><td align="center">0x0d</td><td align="center">fconst_2</td><td align="center">将float型2推送至栈顶</td></tr><tr><td align="center">0x0e</td><td align="center">dconst_0</td><td align="center">将double型0推送至栈顶</td></tr><tr><td align="center">0x0f</td><td align="center">dconst_1</td><td align="center">将double型1推送至栈顶</td></tr><tr><td align="center">0x10</td><td align="center">bipush</td><td align="center">将单字节的常量值(-128~127)推送至栈顶</td></tr><tr><td align="center">0x11</td><td align="center">sipush</td><td align="center">将一个短整型常量(-32768~32767)推送至栈顶</td></tr><tr><td align="center">0x12</td><td align="center">ldc</td><td align="center">将int,float或String型常量值从常量池中推送至栈顶</td></tr><tr><td align="center">0x13</td><td align="center">ldc_w</td><td align="center">将int,float或String型常量值从常量池中推送至栈顶(宽索引)</td></tr><tr><td align="center">0x14</td><td align="center">ldc2_w</td><td align="center">将long或double型常量值从常量池中推送至栈顶(宽索引)</td></tr><tr><td align="center">0x15</td><td align="center">iload</td><td align="center">将指定的int型本地变量推送至栈顶</td></tr><tr><td align="center">0x16</td><td align="center">lload</td><td align="center">将指定的long型本地变量推送至栈顶</td></tr><tr><td align="center">0x17</td><td align="center">fload</td><td align="center">将指定的float型本地变量推送至栈顶</td></tr><tr><td align="center">0x18</td><td align="center">dload</td><td align="center">将指定的double型本地变量推送至栈顶</td></tr><tr><td align="center">0x19</td><td align="center">aload</td><td align="center">将指定的引用类型本地变量推送至栈顶</td></tr><tr><td align="center">0x1a</td><td align="center">iload_0</td><td align="center">将第一个int型本地变量推送至栈顶</td></tr><tr><td align="center">0x1b</td><td align="center">iload_1</td><td align="center">将第二个int型本地变量推送至栈顶</td></tr><tr><td align="center">0x1c</td><td align="center">iload_2</td><td align="center">将第三个int型本地变量推送至栈顶</td></tr><tr><td align="center">0x1d</td><td align="center">iload_3</td><td align="center">将第四个int型本地变量推送至栈顶</td></tr><tr><td align="center">0x1e</td><td align="center">lload_0</td><td align="center">将第一个long型本地变量推送至栈顶</td></tr><tr><td align="center">0x1f</td><td align="center">lload_1</td><td align="center">将第二个long型本地变量推送至栈顶</td></tr><tr><td align="center">0x20</td><td align="center">lload_2</td><td align="center">将第三个long型本地变量推送至栈顶</td></tr><tr><td align="center">0x21</td><td align="center">lload_3</td><td align="center">将第四个long型本地变量推送至栈顶</td></tr><tr><td align="center">0x22</td><td align="center">fload_0</td><td align="center">将第一个float型本地变量推送至栈顶</td></tr><tr><td align="center">0x23</td><td align="center">fload_1</td><td align="center">将第二个float型本地变量推送至栈顶</td></tr><tr><td align="center">0x24</td><td align="center">fload_2</td><td align="center">将第三个float型本地变量推送至栈顶</td></tr><tr><td align="center">0x25</td><td align="center">fload_3</td><td align="center">将第四个float型本地变量推送至栈顶</td></tr><tr><td align="center">0x26</td><td align="center">dload_0</td><td align="center">将第一个double型本地变量推送至栈顶</td></tr><tr><td align="center">0x27</td><td align="center">dload_1</td><td align="center">将第二个double型本地变量推送至栈顶</td></tr><tr><td align="center">0x28</td><td align="center">dload_2</td><td align="center">将第三个double型本地变量推送至栈顶</td></tr><tr><td align="center">0x29</td><td align="center">dload_3</td><td align="center">将第四个double型本地变量推送至栈顶</td></tr><tr><td align="center">0x2a</td><td align="center">aload_0</td><td align="center">将第一个引用类型本地变量推送至栈顶</td></tr><tr><td align="center">0x2b</td><td align="center">aload_1</td><td align="center">将第二个引用类型本地变量推送至栈顶</td></tr><tr><td align="center">0x2c</td><td align="center">aload_2</td><td align="center">将第三个引用类型本地变量推送至栈顶</td></tr><tr><td align="center">0x2d</td><td align="center">aload_3</td><td align="center">将第四个引用类型本地变量推送至栈顶</td></tr><tr><td align="center">0x2e</td><td align="center">iaload</td><td align="center">将int型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x2f</td><td align="center">laload</td><td align="center">将long型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x30</td><td align="center">faload</td><td align="center">将float型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x31</td><td align="center">daload</td><td align="center">将double型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x32</td><td align="center">aaload</td><td align="center">将引用类型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x33</td><td align="center">baload</td><td align="center">将boolean或byte型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x34</td><td align="center">caload</td><td align="center">将char型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x35</td><td align="center">saload</td><td align="center">将short型数组指定索引的值推送至栈顶</td></tr><tr><td align="center">0x36</td><td align="center">istore</td><td align="center">将栈顶int型数值存入指定本地变量</td></tr><tr><td align="center">0x37</td><td align="center">lstore</td><td align="center">将栈顶long型数值存入指定本地变量</td></tr><tr><td align="center">0x38</td><td align="center">fstore</td><td align="center">将栈顶float型数值存入指定本地变量</td></tr><tr><td align="center">0x39</td><td align="center">dstore</td><td align="center">将栈顶double型数值存入指定本地变量</td></tr><tr><td align="center">0x3a</td><td align="center">astore</td><td align="center">将栈顶引用类型数值存入指定本地变量</td></tr><tr><td align="center">0x3b</td><td align="center">istore_0</td><td align="center">将栈顶int型数值存入第一个本地变量</td></tr><tr><td align="center">0x3c</td><td align="center">istore_1</td><td align="center">将栈顶int型数值存入第二个本地变量</td></tr><tr><td align="center">0x3d</td><td align="center">istore_2</td><td align="center">将栈顶int型数值存入第三个本地变量</td></tr><tr><td align="center">0x3e</td><td align="center">istore_3</td><td align="center">将栈顶int型数值存入第四个本地变量</td></tr><tr><td align="center">0x3f</td><td align="center">lstore_0</td><td align="center">将栈顶long型数值存入第一个本地变量</td></tr><tr><td align="center">0x40</td><td align="center">lstore_1</td><td align="center">将栈顶long型数值存入第二个本地变量</td></tr><tr><td align="center">0x41</td><td align="center">lstore_2</td><td align="center">将栈顶long型数值存入第三个本地变量</td></tr><tr><td align="center">0x42</td><td align="center">lstore_3</td><td align="center">将栈顶long型数值存入第四个本地变量</td></tr><tr><td align="center">0x43</td><td align="center">fstore_0</td><td align="center">将栈顶float型数值存入第一个本地变量</td></tr><tr><td align="center">0x44</td><td align="center">fstore_1</td><td align="center">将栈顶float型数值存入第二个本地变量</td></tr><tr><td align="center">0x45</td><td align="center">fstore_2</td><td align="center">将栈顶float型数值存入第三个本地变量</td></tr><tr><td align="center">0x46</td><td align="center">fstore_3</td><td align="center">将栈顶float型数值存入第四个本地变量</td></tr><tr><td align="center">0x47</td><td align="center">dstore_0</td><td align="center">将栈顶double型数值存入第一个本地变量</td></tr><tr><td align="center">0x48</td><td align="center">dstore_1</td><td align="center">将栈顶double型数值存入第二个本地变量</td></tr><tr><td align="center">0x49</td><td align="center">dstore_2</td><td align="center">将栈顶double型数值存入第三个本地变量</td></tr><tr><td align="center">0x4a</td><td align="center">dstore_3</td><td align="center">将栈顶double型数值存入第四个本地变量</td></tr><tr><td align="center">0x4b</td><td align="center">astore_0</td><td align="center">将栈顶引用型数值存入第一个本地变量</td></tr><tr><td align="center">0x4c</td><td align="center">astore_1</td><td align="center">将栈顶引用型数值存入第二个本地变量</td></tr><tr><td align="center">0x4d</td><td align="center">astore_2</td><td align="center">将栈顶引用型数值存入第三个本地变量</td></tr><tr><td align="center">0x4e</td><td align="center">astore_3</td><td align="center">将栈顶引用型数值存入第四个本地变量</td></tr><tr><td align="center">0x4f</td><td align="center">iastore</td><td align="center">将栈顶int型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x50</td><td align="center">lastore</td><td align="center">将栈顶long型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x51</td><td align="center">fastore</td><td align="center">将栈顶float型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x52</td><td align="center">dastore</td><td align="center">将栈顶double型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x53</td><td align="center">aastore</td><td align="center">将栈顶引用型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x54</td><td align="center">bastore</td><td align="center">将栈顶boolean或byte型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x55</td><td align="center">castore</td><td align="center">将栈顶char型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x56</td><td align="center">sastore</td><td align="center">将栈顶short型数值存入指定数组的指定索引位置</td></tr><tr><td align="center">0x57</td><td align="center">pop</td><td align="center">将栈顶数值弹出(数值不能是long或double类型的)</td></tr><tr><td align="center">0x58</td><td align="center">pop2</td><td align="center">将栈顶的一个(对于非long或double类型)或两个数值(对于非long或double的其他类型)弹出</td></tr><tr><td align="center">0x59</td><td align="center">dup</td><td align="center">复制栈顶数值并将复制值压入栈顶</td></tr><tr><td align="center">0x5a</td><td align="center">dup_x1</td><td align="center">复制栈顶数值并将两个复制值压入栈顶</td></tr><tr><td align="center">0x5b</td><td align="center">dup_x2</td><td align="center">复制栈顶数值并将三个(或两个)复制值压入栈顶</td></tr><tr><td align="center">0x5c</td><td align="center">dup2</td><td align="center">复制栈顶一个(对于long或double类型)或两个(对于非long或double的其他类型)数值并将复制值压入栈顶</td></tr><tr><td align="center">0x5d</td><td align="center">dup2_x1</td><td align="center">dup_x1指令的双倍版本</td></tr><tr><td align="center">0x5e</td><td align="center">dup2_x2</td><td align="center">dup_x2指令的双倍版本</td></tr><tr><td align="center">0x5f</td><td align="center">swap</td><td align="center">将栈顶最顶端的两个数值互换(数值不能是long或double类型)</td></tr><tr><td align="center">0x60</td><td align="center">iadd</td><td align="center">将栈顶两int型数值相加并将结果压入栈顶</td></tr><tr><td align="center">0x61</td><td align="center">ladd</td><td align="center">将栈顶两long型数值相加并将结果压入栈顶</td></tr><tr><td align="center">0x62</td><td align="center">fadd</td><td align="center">将栈顶两float型数值相加并将结果压入栈顶</td></tr><tr><td align="center">0x63</td><td align="center">dadd</td><td align="center">将栈顶两double型数值相加并将结果压入栈顶</td></tr><tr><td align="center">0x64</td><td align="center">isub</td><td align="center">将栈顶两int型数值相减并将结果压入栈顶</td></tr><tr><td align="center">0x65</td><td align="center">lsub</td><td align="center">将栈顶两long型数值相减并将结果压入栈顶</td></tr><tr><td align="center">0x66</td><td align="center">fsub</td><td align="center">将栈顶两float型数值相减并将结果压入栈顶</td></tr><tr><td align="center">0x67</td><td align="center">dsub</td><td align="center">将栈顶两double型数值相减并将结果压入栈顶</td></tr><tr><td align="center">0x68</td><td align="center">imul</td><td align="center">将栈顶两int型数值相乘并将结果压入栈顶</td></tr><tr><td align="center">0x69</td><td align="center">lmul</td><td align="center">将栈顶两long型数值相乘并将结果压入栈顶</td></tr><tr><td align="center">0x6a</td><td align="center">fmul</td><td align="center">将栈顶两float型数值相乘并将结果压入栈顶</td></tr><tr><td align="center">0x6b</td><td align="center">dmul</td><td align="center">将栈顶两double型数值相乘并将结果压入栈顶</td></tr><tr><td align="center">0x6c</td><td align="center">idiv</td><td align="center">将栈顶两int型数值相除并将结果压入栈顶</td></tr><tr><td align="center">0x6d</td><td align="center">ldiv</td><td align="center">将栈顶两long型数值相除并将结果压入栈顶</td></tr><tr><td align="center">0x6e</td><td align="center">fdiv</td><td align="center">将栈顶两float型数值相除并将结果压入栈顶</td></tr><tr><td align="center">0x6f</td><td align="center">ddiv</td><td align="center">将栈顶两double型数值相除并将结果压入栈顶</td></tr><tr><td align="center">0x70</td><td align="center">irem</td><td align="center">将栈顶两int型数值作取模运算并将结果压入栈顶</td></tr><tr><td align="center">0x71</td><td align="center">lrem</td><td align="center">将栈顶两long型数值作取模运算并将结果压入栈顶</td></tr><tr><td align="center">0x72</td><td align="center">frem</td><td align="center">将栈顶两float型数值作取模运算并将结果压入栈顶</td></tr><tr><td align="center">0x73</td><td align="center">drem</td><td align="center">将栈顶两double型数值作取模运算并将结果压入栈顶</td></tr><tr><td align="center">0x74</td><td align="center">ineg</td><td align="center">将栈顶int型数值取负并将结果压入栈顶</td></tr><tr><td align="center">0x75</td><td align="center">lneg</td><td align="center">将栈顶long型数值取负并将结果压入栈顶</td></tr><tr><td align="center">0x76</td><td align="center">fneg</td><td align="center">将栈顶float型数值取负并将结果压入栈顶</td></tr><tr><td align="center">0x77</td><td align="center">dneg</td><td align="center">将栈顶double型数值取负并将结果压入栈顶</td></tr><tr><td align="center">0x78</td><td align="center">ishl</td><td align="center">将int型数值左移指定位数并将结果压入栈顶</td></tr><tr><td align="center">0x79</td><td align="center">lshl</td><td align="center">将long型数值左移指定位数并将结果压入栈顶</td></tr><tr><td align="center">0x7a</td><td align="center">ishr</td><td align="center">将int型数值右(带符号)移指定位数并将结果压入栈顶</td></tr><tr><td align="center">0x7b</td><td align="center">lshr</td><td align="center">将long型数值右(带符号)移指定位数并将结果压入栈顶</td></tr><tr><td align="center">0x7c</td><td align="center">iushr</td><td align="center">将int型数值右(无符号)移指定位数并将结果压入栈顶</td></tr><tr><td align="center">0x7d</td><td align="center">lushr</td><td align="center">将long型数值右(无符号)移指定位数并将结果压入栈顶</td></tr><tr><td align="center">0x7e</td><td align="center">iand</td><td align="center">将栈顶两int型数值”按位与”并将结果压入栈顶</td></tr><tr><td align="center">0x7f</td><td align="center">land</td><td align="center">将栈顶两long型数值”按位与”并将结果压入栈顶</td></tr><tr><td align="center">0x80</td><td align="center">ior</td><td align="center">将栈顶两int型数值”按位或”并将结果压入栈顶</td></tr><tr><td align="center">0x81</td><td align="center">lor</td><td align="center">将栈顶两long型数值”按位或”并将结果压入栈顶</td></tr><tr><td align="center">0x82</td><td align="center">ixor</td><td align="center">将栈顶两int型数值”按位异或”并将结果压入栈顶</td></tr><tr><td align="center">0x83</td><td align="center">lxor</td><td align="center">将栈顶两long型数值”按位异或”并将结果压入栈顶</td></tr><tr><td align="center">0x84</td><td align="center">iinc</td><td align="center">将指定int型变量增加指定值(如i++, i–, i+=2等)</td></tr><tr><td align="center">0x85</td><td align="center">i2l</td><td align="center">将栈顶int型数值强制转换为long型数值并将结果压入栈顶</td></tr><tr><td align="center">0x86</td><td align="center">i2f</td><td align="center">将栈顶int型数值强制转换为float型数值并将结果压入栈顶</td></tr><tr><td align="center">0x87</td><td align="center">i2d</td><td align="center">将栈顶int型数值强制转换为double型数值并将结果压入栈顶</td></tr><tr><td align="center">0x88</td><td align="center">l2i</td><td align="center">将栈顶long型数值强制转换为int型数值并将结果压入栈顶</td></tr><tr><td align="center">0x89</td><td align="center">l2f</td><td align="center">将栈顶long型数值强制转换为float型数值并将结果压入栈顶</td></tr><tr><td align="center">0x8a</td><td align="center">l2d</td><td align="center">将栈顶long型数值强制转换为double型数值并将结果压入栈顶</td></tr><tr><td align="center">0x8b</td><td align="center">f2i</td><td align="center">将栈顶float型数值强制转换为int型数值并将结果压入栈顶</td></tr><tr><td align="center">0x8c</td><td align="center">f2l</td><td align="center">将栈顶float型数值强制转换为long型数值并将结果压入栈顶</td></tr><tr><td align="center">0x8d</td><td align="center">f2d</td><td align="center">将栈顶float型数值强制转换为double型数值并将结果压入栈顶</td></tr><tr><td align="center">0x8e</td><td align="center">d2i</td><td align="center">将栈顶double型数值强制转换为int型数值并将结果压入栈顶</td></tr><tr><td align="center">0x8f</td><td align="center">d2l</td><td align="center">将栈顶double型数值强制转换为long型数值并将结果压入栈顶</td></tr><tr><td align="center">0x90</td><td align="center">d2f</td><td align="center">将栈顶double型数值强制转换为float型数值并将结果压入栈顶</td></tr><tr><td align="center">0x91</td><td align="center">i2b</td><td align="center">将栈顶int型数值强制转换为byte型数值并将结果压入栈顶</td></tr><tr><td align="center">0x92</td><td align="center">i2c</td><td align="center">将栈顶int型数值强制转换为char型数值并将结果压入栈顶</td></tr><tr><td align="center">0x93</td><td align="center">i2s</td><td align="center">将栈顶int型数值强制转换为short型数值并将结果压入栈顶</td></tr><tr><td align="center">0x94</td><td align="center">lcmp</td><td align="center">比较栈顶两long型数值大小, 并将结果(1, 0或-1)压入栈顶</td></tr><tr><td align="center">0x95</td><td align="center">fcmpl</td><td align="center">比较栈顶两float型数值大小, 并将结果(1, 0或-1)压入栈顶; 当其中一个数值为<code>NaN</code>时, 将-1压入栈顶</td></tr><tr><td align="center">0x96</td><td align="center">fcmpg</td><td align="center">比较栈顶两float型数值大小, 并将结果(1, 0或-1)压入栈顶; 当其中一个数值为<code>NaN</code>时, 将1压入栈顶</td></tr><tr><td align="center">0x97</td><td align="center">dcmpl</td><td align="center">比较栈顶两double型数值大小, 并将结果(1, 0或-1)压入栈顶; 当其中一个数值为<code>NaN</code>时, 将-1压入栈顶</td></tr><tr><td align="center">0x98</td><td align="center">dcmpg</td><td align="center">比较栈顶两double型数值大小, 并将结果(1, 0或-1)压入栈顶; 当其中一个数值为<code>NaN</code>时, 将1压入栈顶</td></tr><tr><td align="center">0x99</td><td align="center">ifeq</td><td align="center">当栈顶int型数值等于0时跳转</td></tr><tr><td align="center">0x9a</td><td align="center">ifne</td><td align="center">当栈顶int型数值不等于0时跳转</td></tr><tr><td align="center">0x9b</td><td align="center">iflt</td><td align="center">当栈顶int型数值小于0时跳转</td></tr><tr><td align="center">0x9c</td><td align="center">ifge</td><td align="center">当栈顶int型数值大于等于0时跳转</td></tr><tr><td align="center">0x9d</td><td align="center">ifgt</td><td align="center">当栈顶int型数值大于0时跳转</td></tr><tr><td align="center">0x9e</td><td align="center">ifle</td><td align="center">当栈顶int型数值小于等于0时跳转</td></tr><tr><td align="center">0x9f</td><td align="center">if_icmpeq</td><td align="center">比较栈顶两int型数值大小, 当结果等于0时跳转</td></tr><tr><td align="center">0xa0</td><td align="center">if_icmpne</td><td align="center">比较栈顶两int型数值大小, 当结果不等于0时跳转</td></tr><tr><td align="center">0xa1</td><td align="center">if_icmplt</td><td align="center">比较栈顶两int型数值大小, 当结果小于0时跳转</td></tr><tr><td align="center">0xa2</td><td align="center">if_icmpge</td><td align="center">比较栈顶两int型数值大小, 当结果大于等于0时跳转</td></tr><tr><td align="center">0xa3</td><td align="center">if_icmpgt</td><td align="center">比较栈顶两int型数值大小, 当结果大于0时跳转</td></tr><tr><td align="center">0xa4</td><td align="center">if_icmple</td><td align="center">比较栈顶两int型数值大小, 当结果小于等于0时跳转</td></tr><tr><td align="center">0xa5</td><td align="center">if_acmpeq</td><td align="center">比较栈顶两引用型数值, 当结果相等时跳转</td></tr><tr><td align="center">0xa6</td><td align="center">if_acmpne</td><td align="center">比较栈顶两引用型数值, 当结果不相等时跳转</td></tr><tr><td align="center">0xa7</td><td align="center">goto</td><td align="center">无条件跳转</td></tr><tr><td align="center">0xa8</td><td align="center">jsr</td><td align="center">跳转至指定的16位offset位置, 并将jsr的下一条指令地址压入栈顶</td></tr><tr><td align="center">0xa9</td><td align="center">ret</td><td align="center">返回至本地变量指定的index的指令位置(一般与jsr或jsr_w联合使用)</td></tr><tr><td align="center">0xaa</td><td align="center">tableswitch</td><td align="center">用于switch条件跳转, case值连续(可变长度指令)</td></tr><tr><td align="center">0xab</td><td align="center">lookupswitch</td><td align="center">用于switch条件跳转, case值不连续(可变长度指令)</td></tr><tr><td align="center">0xac</td><td align="center">ireturn</td><td align="center">从当前方法返回int</td></tr><tr><td align="center">0xad</td><td align="center">lreturn</td><td align="center">从当前方法返回long</td></tr><tr><td align="center">0xae</td><td align="center">freturn</td><td align="center">从当前方法返回float</td></tr><tr><td align="center">0xaf</td><td align="center">dreturn</td><td align="center">从当前方法返回double</td></tr><tr><td align="center">0xb0</td><td align="center">areturn</td><td align="center">从当前方法返回对象引用</td></tr><tr><td align="center">0xb1</td><td align="center">return</td><td align="center">从当前方法返回void</td></tr><tr><td align="center">0xb2</td><td align="center">getstatic</td><td align="center">获取指定类的静态域, 并将其压入栈顶</td></tr><tr><td align="center">0xb3</td><td align="center">putstatic</td><td align="center">为指定类的静态域赋值</td></tr><tr><td align="center">0xb4</td><td align="center">getfield</td><td align="center">获取指定类的实例域, 并将其压入栈顶</td></tr><tr><td align="center">0xb5</td><td align="center">putfield</td><td align="center">为指定类的实例域赋值</td></tr><tr><td align="center">0xb6</td><td align="center">invokevirtual</td><td align="center">调用实例方法</td></tr><tr><td align="center">0xb7</td><td align="center">invokespecial</td><td align="center">调用超类构建方法, 实例初始化方法, 私有方法</td></tr><tr><td align="center">0xb8</td><td align="center">invokestatic</td><td align="center">调用静态方法</td></tr><tr><td align="center">0xb9</td><td align="center">invokeinterface</td><td align="center">调用接口方法</td></tr><tr><td align="center">0xba</td><td align="center">invokedynamic</td><td align="center">调用动态方法</td></tr><tr><td align="center">0xbb</td><td align="center">new</td><td align="center">创建一个对象, 并将其引用引用值压入栈顶</td></tr><tr><td align="center">0xbc</td><td align="center">newarray</td><td align="center">创建一个指定的原始类型(如int, float, char等)的数组, 并将其引用值压入栈顶</td></tr><tr><td align="center">0xbd</td><td align="center">anewarray</td><td align="center">创建一个引用型(如类, 接口, 数组)的数组, 并将其引用值压入栈顶</td></tr><tr><td align="center">0xbe</td><td align="center">arraylength</td><td align="center">获取数组的长度值并压入栈顶</td></tr><tr><td align="center">0xbf</td><td align="center">athrow</td><td align="center">将栈顶的异常抛出</td></tr><tr><td align="center">0xc0</td><td align="center">checkcast</td><td align="center">检验类型转换, 检验未通过将抛出 ClassCastException</td></tr><tr><td align="center">0xc1</td><td align="center">instanceof</td><td align="center">检验对象是否是指定类的实际, 如果是将1压入栈顶, 否则将0压入栈顶</td></tr><tr><td align="center">0xc2</td><td align="center">monitorenter</td><td align="center">获得对象的锁, 用于同步方法或同步块</td></tr><tr><td align="center">0xc3</td><td align="center">monitorexit</td><td align="center">释放对象的锁, 用于同步方法或同步块</td></tr><tr><td align="center">0xc4</td><td align="center">wide</td><td align="center">扩展本地变量的宽度</td></tr><tr><td align="center">0xc5</td><td align="center">multianewarray</td><td align="center">创建指定类型和指定维度的多维数组(执行该指令时, 操作栈中必须包含各维度的长度值), 并将其引用压入栈顶</td></tr><tr><td align="center">0xc6</td><td align="center">ifnull</td><td align="center">为null时跳转</td></tr><tr><td align="center">0xc7</td><td align="center">ifnonnull</td><td align="center">不为null时跳转</td></tr><tr><td align="center">0xc8</td><td align="center">goto_w</td><td align="center">无条件跳转(宽索引)</td></tr><tr><td align="center">0xc9</td><td align="center">jsr_w</td><td align="center">跳转至指定的32位offset位置, 并将jsr_w的下一条指令地址压入栈顶</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
          <category> 字节码指令表 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
            <tag> 字节码指令表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】单例设计模式</title>
      <link href="/2021/06/03/mian-shi-java-dan-li-she-ji-mo-shi/"/>
      <url>/2021/06/03/mian-shi-java-dan-li-she-ji-mo-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="1-面试试题"><a href="#1-面试试题" class="headerlink" title="1 面试试题"></a>1 面试试题</h2><p>写一个Singleton示例</p><h2 id="2-单例设计模式简介"><a href="#2-单例设计模式简介" class="headerlink" title="2 单例设计模式简介"></a>2 单例设计模式简介</h2><ul><li><font color='red'>单：唯一</font></li><li><font color='red'>例：实例</font></li><li>单例设计模式，即某个类在整个系统中只能有一个实例对象可被获取和使用的代码模式。<ul><li>例如：代表JVM运行环境的Runtime类</li></ul></li></ul><h2 id="3-单例设计模式要点"><a href="#3-单例设计模式要点" class="headerlink" title="3 单例设计模式要点"></a>3 单例设计模式要点</h2><ol><li><p>某个类只能有一个实例</p><ul><li><font color='red'>构造器私有化</font></li></ul></li><li><p>它必须自行创建这个实例</p><ul><li><font color='red'>含有一个该类的静态变量来保存这个唯一的实例</font></li></ul></li><li><p>它必须自行向整个系统提供这个实例</p><ul><li><font color='red'>对外提供获取该实例对象的方式</font>：<ul><li>直接暴露</li><li>用静态变量的get方法获取</li></ul></li></ul></li></ol><h2 id="4-几种常见形式"><a href="#4-几种常见形式" class="headerlink" title="4 几种常见形式"></a>4 几种常见形式</h2><ol><li><p>饿汉式</p><p>直接创建对象，不存在线程安全问题（直接暴露对象）</p><p>① <font color='red'>构造器私有化</font></p><p>② 自行创建对象，并且用<font color='red'>静态变量保存对象</font></p><p>③ 向外提供实例（<font color='blue'>直接暴露，将静态变量权限为public</font>）</p><p>④ 强调这是一个单例，我们可以<font color='blue'>用final修改</font></p><ul><li><p>直接实例化饿汉式</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span>   <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 静态变量保存对象，直接暴露</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p><font color='red'>枚举式（最简单）</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 枚举类型：表示该类型是有限的几个 */</span><span class="token keyword">public</span> <span class="token keyword">enum</span>  Singleton <span class="token punctuation">{</span>    INSTANCE<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p>静态代码块饿汉式（适合复杂实例化）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** *  静态代码块 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 静态变量保存对象，直接暴露</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton INTANCE<span class="token punctuation">;</span>    <span class="token keyword">private</span> String info<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 构造器中要传入的参数</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 在类初始化时，加载调用构造器</span>        INTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 对象的默认值可以在此处更改，外界获得的都是该值</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span>String info<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>INTANCE<span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span>INTANCE<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul></li><li><p>懒汉式</p><p>延迟创建对象</p><p>① <font color='red'>构造器私有化</font></p><p>② <font color='red'>一个私有静态变量保存这个唯一的实例对象</font></p><p>③ <font color='red'>对外提供一个静态方法，获取该实例对象</font></p><ul><li><p>线程不安全（适用于单线程）</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 私有静态变量保存对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 私有化构造器</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 对外提供静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token operator">==</span>null<span class="token punctuation">)</span><span class="token punctuation">{</span>            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p><font color='red'>线程安全（适用于多线程，最常写）</font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 私有静态变量保存高实例对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 私有化构造器</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 对外提供静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li><li><p><font color='red'>静态内部类（适用于多线程，最简单）</font></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 1、内部类被加载和初始化时，才创建INSTANCE实例对象 * 2、静态内部类不会自动创建,随着外部类的加载初始化而初始化，他是要单独去加载和实例化的 * 3、因为是在内部类加载和初始化时，创建的，因此线程安全 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 在内部类里使用私有变量保存该对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Inner</span><span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 对外提供的静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> Inner<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Singleton s1 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul></li></ol><h2 id="5-多线程模式"><a href="#5-多线程模式" class="headerlink" title="5 多线程模式"></a>5 多线程模式</h2><h3 id="5-1-解决方法–加入Synchronized"><a href="#5-1-解决方法–加入Synchronized" class="headerlink" title="5.1 解决方法–加入Synchronized"></a>5.1 解决方法–加入Synchronized</h3><p>通过在对外提供静态方法上引入Synchronized关键字，能够解决高并发环境下的单例模式问题。但是synchronized属于重量级的同步机制，它只允许一个线程同时访问获取实例的方法，但是为了保证数据一致性，而减低了并发性。</p><p>所以一般采用<font color='red'>DCL Double Check Lock 双端检锁机制，就是在进来和出去的时候，进行检测。</font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 我是构造方法Singleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 私有静态变量保存对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton instance<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 对外提供静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 同步代码段的时候，进行检测，两端都要添加判断</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210602152835.png" alt=""></p><p>从输出结果来看，确实能够保证单例模式的正确性，但是<font color='blue'>上面的方法还是存在问题的</font>。</p><h3 id="5-2-解决方法–加入volatile"><a href="#5-2-解决方法–加入volatile" class="headerlink" title="5.2 解决方法–加入volatile"></a>5.2 解决方法–加入volatile</h3><p>DCL（双端检锁）机制不一定是线程安全的，原因是有<font color='red'>指令重排的存在，加入volatile可以禁止指令重排</font>。</p><p>因为 <font color='blue'>instance = new Singleton()；可以分为以下三步进行完成</font>：</p><ul><li>memory = allocate();     // 1、分配对象内存空间</li><li>instance(memory);        // 2、初始化对象</li><li>instance = memory;     // 3、设置instance指向刚刚分配的内存地址，此时instance != null</li></ul><p>但是我们通过上面的三个步骤，能够发现，<font color='red'>步骤2 和 步骤3之间不存在 数据依赖关系</font>，而且无论重排前 还是重排后，程序的执行结果在单线程中并没有改变，因此<font color='red'>这种重排优化是允许的</font>。所以会出下面的情况：</p><ul><li>memory = allocate();     // 1、分配对象内存空间</li><li>instance = memory;     // 3、设置instance指向刚刚分配的内存地址，此时instance != null，<font color='blue'>但是对象还没有初始化完成</font></li><li>instance(memory);        // 2、初始化对象</li></ul><p>这样就会造成什么问题呢？</p><blockquote><p>也就是当我们执行到重排后的步骤2，试图获取instance的时候，会得到null，因为对象的初始化还没有完成，而是在重排后的步骤3才完成，因此执行单例模式的代码时候，就会重新在创建一个instance实例</p></blockquote><p><font color='blue'>指令重排只会保证串行语义的执行一致性（单线程），但并不会关系多线程间的语义一致性</font></p><p>所以当一条线程访问instance不为null时，由于instance实例未必已初始化完成，这就造成了线程安全的问题</p><p>所以<font color='red'>需要引入volatile，来保证出现指令重排的问题，从而保证单例模式的线程安全性</font></p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> Singleton instance <span class="token operator">=</span> null<span class="token punctuation">;</span></code></pre><h3 id="5-3-最终代码"><a href="#5-3-最终代码" class="headerlink" title="5.3 最终代码"></a>5.3 最终代码</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造器私有化</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" 我是构造方法Singleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 私有静态变量保存对象</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> Singleton instance <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 对外提供静态方法</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// a 双重检查加锁多线程情况下会出现某个线程虽然这里已经为空，但是另外一个线程已经执行到d处</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">//b</span>                <span class="token comment" spellcheck="true">//c不加volitale关键字的话有可能会出现尚未完全初始化就获取到的情况。原因是内存模型允许无序写入</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// d 此时才开始初始化</span>                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token punctuation">{</span>                Singleton<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> Java基础 </tag>
            
            <tag> 单例设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】方法传参机制</title>
      <link href="/2021/06/02/mian-shi-java-fang-fa-chuan-can-ji-zhi/"/>
      <url>/2021/06/02/mian-shi-java-fang-fa-chuan-can-ji-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="1-面试试题"><a href="#1-面试试题" class="headerlink" title="1 面试试题"></a>1 面试试题</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodVariables</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 栈中</span>        String str <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 栈中地址，值在常量池中</span>        Integer num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 栈中地址，值在堆中</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 栈中地址，值在堆中</span>        MyData myData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 栈中地址，值在堆中</span>        <span class="token function">change</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> str<span class="token punctuation">,</span> num<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> myData<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i = "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// 1</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"str = "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// hello （String的不可变性）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num = "</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 2    （包装类的不可变性）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"arr = "</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 2,2,3,4,5,6</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"myData.a = "</span> <span class="token operator">+</span> myData<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 11</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> String str<span class="token punctuation">,</span> Integer num<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> MyData myData<span class="token punctuation">)</span> <span class="token punctuation">{</span>        i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        str <span class="token operator">+=</span> <span class="token string">" world"</span><span class="token punctuation">;</span>        num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>        myData<span class="token punctuation">.</span>a <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyData</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="2-试题考点"><a href="#2-试题考点" class="headerlink" title="2 试题考点"></a>2 试题考点</h2><ul><li>方法的传参机制</li><li>String、包装类等对象的不可变性</li></ul><h2 id="3-方法的传参机制"><a href="#3-方法的传参机制" class="headerlink" title="3 方法的传参机制"></a>3 方法的传参机制</h2><ol><li><p>形参是基本数据类型</p><ul><li><font color='red'><strong>传递的是数据值，即值传递</strong></font></li></ul></li><li><p>实参是引用数据类型</p><ul><li><font color='red'><strong>传递的是地址，即引用传递</strong></font></li><li>特殊的类型：String、包装类等对象不可变性</li></ul></li></ol><h2 id="4-试题解析"><a href="#4-试题解析" class="headerlink" title="4 试题解析"></a>4 试题解析</h2><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210602104306.png" alt="方法的参数传递机制"></p><p><strong><em>tips：</em></strong></p><ul><li><font color='red'>基本数据类型属于值传递</font>，方法内变量的改变，<font color='red'>不影响实参的值</font>。因为<font color='blue'>方法中的形参是存在在新开辟的栈帧中的局部变量表中</font>，与原来栈帧中的局部变量无关。</li><li><font color='red'>String、包装类虽属于引用传递</font>，但是<font color='red'>两者具有不可变性</font>，<font color='blue'>一旦对象发生改变，便会产生新的对象（有新的地址</font>），原地址处的对象值不变。</li><li><font color='red'>数组、自定义类等都是引用传递</font>，改变都是原地址上进行改变，最终会体现到原变量上。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> Java基础 </tag>
            
            <tag> 方法传参机制 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】成员变量和局部变量</title>
      <link href="/2021/05/21/mian-shi-java-cheng-yuan-bian-liang-he-ju-bu-bian-liang/"/>
      <url>/2021/05/21/mian-shi-java-cheng-yuan-bian-liang-he-ju-bu-bian-liang/</url>
      
        <content type="html"><![CDATA[<h2 id="1-面试题描述"><a href="#1-面试题描述" class="headerlink" title="1 面试题描述"></a>1 面试题描述</h2><p>以下代码运行后所得结果</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 局部变量与成员变量的区别 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Variables</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> s<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 静态变量</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 实例变量</span>    <span class="token keyword">int</span> j<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 实例变量</span>    <span class="token punctuation">{</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 局部变量</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 就近原则，局部变量i</span>        j<span class="token operator">++</span><span class="token punctuation">;</span>        s<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// int j j 也是个局部变量</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>        j<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 就近原则</span>        s<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Variables variables1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Variables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Variables variables2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Variables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        variables1<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        variables1<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        variables2<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>variables1<span class="token punctuation">.</span>i <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> variables1<span class="token punctuation">.</span>j <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> variables1<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>variables2<span class="token punctuation">.</span>i <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> variables2<span class="token punctuation">.</span>j <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> variables2<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-试题考点"><a href="#2-试题考点" class="headerlink" title="2 试题考点"></a>2 试题考点</h2><ul><li><font color='red'>就近原则</font></li><li>变量的分类<ul><li>局部变量</li><li>成员变量：类变量、实例变量</li></ul></li><li><font color='red'>非静态代码块</font>的执行：<font color='red'>每次创建实例对象都会执行</font></li><li><font color='red'>静态代码块</font>是在虚拟机加载类的时候，就执行的，而且<font color='red'>只执行一次</font></li><li>方法的调用规则：调用一次执行一次</li></ul><h2 id="3-static-关键字"><a href="#3-static-关键字" class="headerlink" title="3 static 关键字"></a>3 static 关键字</h2><ol><li>static关键字的用途</li></ol><p><font color='blue'>static方法就是没有this的方法。在static方法内部不能调用非静态方法，反过来是可以的。而且可以在没有创建任何对象的前提下，仅仅通过类本身来调用static方法。这实际上正是static方法的主要用途。</font></p><p>一句话描述就是：<font color='red'>方便在没有创建对象的情况下来进行调用（方法/变量）</font></p><p>很显然，被static关键字修饰的方法或者变量不需要依赖于对象来进行访问，只要类被加载了，就可以通过类名去进行访问。因此在静态方法中不能访问类的非静态成员变量和非静态成员方法，因为非静态成员方法/变量都是必须依赖具体的对象才能够被调用。</p><p>static可以用来修饰类的成员方法、类的成员变量，另外可以编写static代码块来优化程序性能。</p><h2 id="4-变量的分类"><a href="#4-变量的分类" class="headerlink" title="4 变量的分类"></a>4 变量的分类</h2><blockquote><p>局部变量</p></blockquote><p>方法体、代码块{}中的变量，使用前必须显式赋值</p><blockquote><p>成员变量</p></blockquote><ul><li><p>类变量</p><p>也叫<font color='red'>静态变量，是由static修饰的变量</font>。<font color='red'>静态变量被所有的对象所共享</font>，在内存中只有一个副本，它当且仅当在类初次加载时会被初始化。</p></li><li><p>实例变量</p><p>未有static修饰的变量。<font color='red'>实例变量是对象所私有的</font>，在创建对象的时候被初始化，存在多个副本，各个对象拥有的副本互不影响。</p></li></ul><blockquote><p>局部变量和成员变量的区别</p></blockquote><p>① 声明的位置</p><ul><li>局部变量：方法体{}中，形参，代码块{}中</li><li>成员变量：类中方法外<ul><li>类变量：静态变量，被static修饰的</li><li>实例变量：没有被static修饰的</li></ul></li></ul><p>② 修饰符</p><ul><li>局部变量：<font color='red'>只能被<code>final</code>修饰</font></li><li>类变量：可以被<code>public</code>、<code>protected</code>、<code>private</code>、<code>final</code>、<code>static</code>、<code>volatile</code>、<code>transient</code>修饰</li></ul><p>③ 值存储的位置</p><ul><li>局部变量：栈</li><li>成员变量<ul><li>类变量：方法区</li><li>实例变量：堆</li></ul></li></ul><p>④ 作用域</p><ul><li>局部变量：从声明开始，到所属的 } 结束</li><li>成员变量<ul><li>类变量：在<font color='red'>当前类中“ 类名. ”</font>(有时类名.可以省略)，在<font color='red'>其他类中 “类名.” 或 “对象名.”</font> 访问</li><li>实例变量：在<font color='red'>当前类中 “this.” </font>(有时this.可以缺省)，在<font color='red'>其他类中 “对象名.” </font>访问</li></ul></li></ul><p>⑤ 声明周期</p><ul><li>局部变量：每一个线程，每一次调用执行都是新的生命周期</li><li>成员变量<ul><li>类变量：随着类的初始化而初始化，随着类的卸载而消亡，<font color='red'>该类的所有对象的类变量是共享的</font></li><li>实例变量：随着对象的创建而初始化，随着对象的被回收而消亡，<font color='red'>每一个对象的实例变量是独私有的</font></li></ul></li></ul><blockquote><p>局部变量与成员变量重名时，如何区分？</p></blockquote><p>① 局部变量与实例变量重名</p><ul><li>在<font color='red'>实例变量前面加 “this.”</font></li></ul><p>② 局部变量与类变量重名</p><ul><li>在<font color='red'>类变量前面加 “类名.”</font></li></ul><h2 id="5-试题解析"><a href="#5-试题解析" class="headerlink" title="5 试题解析"></a>5 试题解析</h2><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210602092410.png" alt="不同变量的内存图"></p><p><strong><em>tips：</em></strong></p><ul><li><p><font color='red'>静态变量</font>是属于类的，是要存放在<font color='red'>方法区</font>中。</p></li><li><p><font color='red'>实例变量</font>是属于对象的，是要存放在<font color='red'>堆</font>中。</p></li><li><p><font color='red'>局部变量</font>是属于方法的，是要存放在<font color='red'>局部变量表</font>中。</p></li><li><p>一个<font color='red'>方法的参数、方法内定义的变量</font>是存放在虚拟机栈中的<font color='red'>局部变量表</font>。</p></li><li><p><font color='red'>方法内的参数都遵循就近原则</font>，后序操作都是针对最近的那个参数进行的。</p></li><li><p>一个<font color='red'>方法的参数、方法内定义的变量</font>，生命周期<font color='red'>仅局限于本方法内</font>，若无return传递出去，则仅在<font color='red'>局部变量表中自生自灭</font>。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> Java基础 </tag>
            
            <tag> 成员变量与局部变量 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】类和实例的初始化过程</title>
      <link href="/2021/05/18/mian-shi-java-lei-he-shi-li-de-chu-shi-hua-guo-cheng/"/>
      <url>/2021/05/18/mian-shi-java-lei-he-shi-li-de-chu-shi-hua-guo-cheng/</url>
      
        <content type="html"><![CDATA[<h2 id="1-面试题描述"><a href="#1-面试题描述" class="headerlink" title="1 面试题描述"></a>1 面试题描述</h2><p>以下代码，运行结果</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 实例变量    </span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 静态变量</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// 静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Father</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// 父类构造函数</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(2)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// 非静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(3)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 非静态方法</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(4)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 静态方法</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(5)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 实例变量</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 静态变量</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// 静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(6)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// 子类构造函数</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(7)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// 非静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(8)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 非静态方法（重写父类方法）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(9)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 静态方法（重写父类方法）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(10)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Son s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Son s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-试题考点"><a href="#2-试题考点" class="headerlink" title="2 试题考点"></a>2 试题考点</h2><ul><li>类初始化过程</li><li>实例初始化过程</li><li>方法的重写</li></ul><h2 id="3-类加载机制"><a href="#3-类加载机制" class="headerlink" title="3 类加载机制"></a>3 类加载机制</h2><p>JVM类加载机制主要包括两个问题：<strong><font color='red'>类加载的时机与步骤</font></strong> 和 <strong><font color='red'>类加载的方式</font></strong>。</p><p>虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验，转换解析和初始化，最终形成可以被虚拟机直接使用的Java类型的过程就是虚拟机的 <strong>类加载机制</strong>。　　</p><ul><li>虚拟机什么时候才会加载Class文件并初始化类呢？（<font color='red'>类加载和初始化时机</font>）</li></ul><ul><li>虚拟机如何加载一个Class文件呢？（<font color='red'>Java类加载的方式：类加载器、双亲委派机制</font>，详见博文</li></ul><ul><li>虚拟机加载一个Class文件要经历那些具体的步骤呢？（<font color='red'>类加载过程/步骤</font>）</li></ul><h3 id="3-1-类加载和初始化时机"><a href="#3-1-类加载和初始化时机" class="headerlink" title="3.1 类加载和初始化时机"></a>3.1 类加载和初始化时机</h3><p>Java类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：<font color='blue'>加载（Loading）、验证（Verification）、准备(Preparation)、解析(Resolution)、初始化(Initialization)、使用(Using) 和 卸载(Unloading)七个阶段</font>。其中准备、验证、解析3个部分统称为链接（Linking）。<br><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210602090417.png" alt="类加载子系统" style="zoom:80%;" /></p><blockquote><p>类初始化时机</p></blockquote><p>什么情况下虚拟机需要开始初始化一个类呢？这在虚拟机规范中是有严格规定的，虚拟机规范指明 <strong><font color='red'>有且只有</font></strong> 五种情况必须立即对类进行初始化（而这一过程自然发生在加载、验证、准备之后）：</p><ol><li><p>遇到<code>new</code>、<code>getstatic</code>、<code>putstatic</code>或<code>invokestatic</code>这四条字节码指令时，如果类没有进行过初始化，则需要先对其进行初始化。生成这四条指令的最常见的Java代码场景是：</p><ul><li>使用<font color='red'><code>new</code>关键字实例化对象</font>的时候；</li><li><font color='red'>读取或设置一个类的静态字段</font>（被final修饰，已在编译器把结果放入常量池的静态字段除外）的时候；</li><li>调用一个<font color='red'>类的静态方法</font>的时候。</li></ul></li><li><p>使用java.lang.reflect包的方法<font color='red'>对类进行反射调用</font>的时候，如果类没有进行过初始化，则需要先触发其初始化。</p></li><li><p>当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要<font color='red'>先触发其父类的初始化</font>。</p></li><li><p>当虚拟机启动时，用户需要指定一个要执行的主类（包含main()方法的那个类），虚拟机会<font color='red'>先初始化这个主类</font>。</p></li><li><p>当使用jdk1.7动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果REF_getstatic,REF_putstatic,REF_invokeStatic的方法句柄，并且这个方法句柄所对应的类没有进行初始化，则需要先出触发其初始化。</p></li></ol><p><strong><em>tips：类的实例化与类的初始化是两个完全不同的概念！！</em></strong></p><ul><li>类的实例化是指<font color='red'>创建一个类的实例(对象)</font>的过程；</li><li>类的初始化是指为类中<font color='red'>各个类成员(被static修饰的成员变量)赋初始值的过程</font>，是类生命周期中的一个阶段。</li></ul><h3 id="3-2-类加载过程"><a href="#3-2-类加载过程" class="headerlink" title="3.2 类加载过程"></a>3.2 类加载过程</h3><blockquote><p>加载（Loading）</p></blockquote><p>在加载阶段（可以参考java.lang.ClassLoader的loadClass()方法），虚拟机需要完成以下三件事情：</p><ol><li><p><font color='red'>通过一个类的全限定名来获取定义此类的二进制字节流</font>（并没有指明要从一个Class文件中获取，可以从其他渠道，譬如：网络、动态生成、数据库等）；</p></li><li><p><font color='red'>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构</font>；</p></li><li><p><font color='red'>在内存中(对于HotSpot虚拟就而言就是方法区)生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口</font>；</p></li></ol><blockquote><p>验证（Verification）</p></blockquote><p>验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。 验证阶段大致会完成4个阶段的检验动作：</p><ul><li><p><font color='blue'>文件格式验证</font>：验证字节流是否符合Class文件格式的规范(例如，是否以魔术0xCAFEBABE开头、主次版本号是否在当前虚拟机的处理范围之内、常量池中的常量是否有不被支持的类型)</p></li><li><p><font color='blue'>元数据验证</font>：对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求(例如：这个类是否有父类，除了java.lang.Object之外)；</p></li><li><p><font color='blue'>字节码验证</font>：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的;</p></li><li><p><font color='blue'>符号引用验证</font>：确保解析动作能正确执行。</p></li></ul><p><font color='red'><strong>验证阶段是非常重要的，但不是必须的，它对程序运行期没有影响。</strong></font></p><blockquote><p>准备(Preparation)</p></blockquote><p><font color='red'>准备阶段是正式为类变量(static 成员变量)分配内存并设置类变量初始值（零值）的阶段</font>，这些变量所使用的内存都将在<font color='red'>方法区中进行分配</font>。这时候进行内存分配的仅包括类变量，而<font color='red'>不包括实例变量</font>，实例变量将会在对象实例化时随着对象一起<font color='red'>分配在堆中</font>。其次，这里所说的初始值“通常情况”下是<font color='red'>数据类型的零值</font>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span></code></pre><p>变量value在准备阶段过后的值为0而不是123。因为这时候尚未开始执行任何java方法，而把<font color='blue'>value赋值为123</font>的putstatic指令是程序被编译后，<font color='red'>存放于类构造器方法&lt; clinit&gt;()之中</font>，所以把value赋值为123的动作将在<font color='red'>初始化阶段才会执行</font>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span></code></pre><p><font color='red'><strong>特殊情况</strong></font>：当类字段的字段属性是ConstantValue时，会在准备阶段初始化为指定的值。即<font color='red'>被<code>final</code>修饰之后</font>，value的值在准备阶段初始化为123而非0。</p><blockquote><p>解析(Resolution)</p></blockquote><p>解析阶段是虚拟机将<font color='red'>常量池内的符号引用替换为直接引用的过程</font>。解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行。</p><blockquote><p>初始化(Initialization)</p></blockquote><p>到了初始化阶段，才真正开始执行类中定义的java程序代码(字节码)。</p><p>在准备阶段，变量已经赋过一次系统要求的初始值(零值)；而在初始化阶段，则根据程序去初始化类变量和其他资源，或者更直接地说：<strong><font color='red'>初始化阶段是执行类构造器&lt; clinit&gt;()方法的过程</font>。</strong></p><p>&lt; clinit&gt;()方法是由编译器自动收集类中的所有<font color='red'>类变量的赋值动作</font>和<font color='red'>静态语句块static{}中的语句</font>合并产生的，编译器收集的顺序是由语句在源文件中出现的顺序所决定的，静态语句块只能访问到定义在静态语句块之前的变量，<font color='red'>定义在它之后的变量，在前面的静态语句块可以赋值，但是不能访问</font>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>    <span class="token keyword">static</span><span class="token punctuation">{</span>        i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Error：Cannot reference a field before it is defined（非法向前应用）</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">{</span>    <span class="token keyword">static</span><span class="token punctuation">{</span>        i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//System.out.println(i);</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Output: 1</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong><em>tips：类构造器&lt; clinit&gt;()与实例构造器&lt; init&gt;()的不同</em></strong></p><ul><li><p>虚拟机会保证在子类类构造器&lt; clinit&gt;()执行之前，<font color='red'>父类的类构造&lt; clinit&gt;()先执行完毕</font>。</p><ul><li>父类的构造器&lt; clinit&gt;()先执行，意味着父类中定义的<font color='red'>静态语句块/静态变量的初始化要优先于子类</font>的静态语句块/静态变量的初始化执行。</li></ul></li><li><p><strong><font color='red'>在同一个类加载器下，一个类型只会被初始化一次</font>。</strong></p></li></ul><h3 id="3-3-小结"><a href="#3-3-小结" class="headerlink" title="3.3 小结"></a>3.3 小结</h3><p>1、一个类要创建实例需要先加载并初始化该类</p><ul><li>main方法所在的类需要先加载和初始化</li></ul><p>2、一个子类要初始化需要先初始化其父类</p><p>3、一个类初始化就是执行 &lt; clinit &gt;()方法</p><ul><li>&lt; clinit &gt;()方法由静态类变量显式赋值代码和静态代码块组成</li><li>类变量显式赋值代码和静态代码块从上到下顺序执行</li><li>&lt; clinit &gt;()方法只执行一次</li></ul><h2 id="4-实例初始化过程"><a href="#4-实例初始化过程" class="headerlink" title="4 实例初始化过程"></a>4 实例初始化过程</h2><p>一个Java对象的创建过程往往包括 <strong><font color='red'>类初始化</font></strong> 和 <strong><font color='red'>类实例化</font></strong> 两个阶段。</p><h3 id="4-1-对象创建时机"><a href="#4-1-对象创建时机" class="headerlink" title="4.1 对象创建时机"></a>4.1 对象创建时机</h3><p>一个对象在可以被使用之前必须要被正确地实例化。在Java代码中，有很多行为可以引起对象的创建，最为直观的一种就是使用new关键字来调用一个类的构造函数显式地创建对象，这种方式在Java规范中被称为 : <font color='red'><strong>由执行类实例创建表达式而引起的对象创建</strong></font>。除此之外，我们还可以使用反射机制(Class类的newInstance方法、使用Constructor类的newInstance方法)、使用Clone方法、使用反序列化等方式创建对象。</p><ol><li><p>使用<code>new</code>关键字创建对象</p><p>这是我们最常见的也是最简单的创建对象的方式，通过这种方式我们可以调用任意的构造函数（<font color='blue'>无参的和有参的</font>）去创建对象。</p></li><li><p>使用<code>Class</code>类的<code>newInstance</code>方法(反射机制)</p><p>我们也可以通过Java的反射机制使用Class类的<code>newInstance</code>方法来创建对象，事实上，这个<code>newInstance</code>方法调用<font color='blue'>无参</font>的构造器创建对象。</p></li><li><p>使用<code>Constructor</code>类的<code>newInstance</code>方法(反射机制)</p></li></ol><p><code>java.lang.relect.Constructor</code>类里也有一个<code>newInstance</code>方法可以创建对象，该方法和<code>Class</code>类中的<code>newInstance</code>方法很像，但是相比之下，<code>Constructor</code>类的<code>newInstance</code>方法更加强大些，我们可以通过这个<code>newInstance</code>方法调用<font color='blue'>有参数的和私有的</font>构造函数。</p><ol start="4"><li><p>使用<code>Clone</code>方法创建对象</p><p>无论何时我们调用一个对象的<code>clone</code>方法，JVM都会帮我们创建一个新的、一样的对象，特别需要说明的是，用<code>clone</code>方法创建对象的过程中并不会调用任何构造函数。简单而言，要想使用<code>clone</code>方法，我们就必须先实现<code>Cloneable</code>接口并实现其定义的<code>clone</code>方法，这也是原型模式的应用。</p></li><li><p>使用(反)序列化机制创建对象</p><p>当我们反序列化一个对象时，JVM会给我们创建一个单独的对象，在此过程中，JVM并不会调用任何构造函数。为了反序列化一个对象，我们需要让我们的类实现<code>Serializable</code>接口。</p></li></ol><h3 id="4-2-对象创建过程"><a href="#4-2-对象创建过程" class="headerlink" title="4.2 对象创建过程"></a>4.2 对象创建过程</h3><p>当一个<font color='blue'>对象被创建时</font>，虚拟机就会为其<font color='blue'>分配内存来存放对象自己的实例变量及其从父类继承过来的实例变量</font>(即使这些从超类继承过来的实例变量有可能被隐藏也会被分配空间)。在为这些实例变量分配内存的同时，这些<font color='red'>实例变量也会被赋予默认值(零值)</font>。</p><p>在内存分配完成之后，Java虚拟机就会开始对新创建的对象按照程序进行<font color='blue'>初始化</font>。在Java对象初始化过程中，主要涉及三种执行对象初始化的结构，分别是 <font color='red'><strong>实例变量初始化</strong></font>、<strong><font color='red'>实例代码块初始化</font></strong> 以及 <strong><font color='red'>构造函数初始化</font></strong>。</p><blockquote><p>实例变量初始化与实例代码块初始化</p></blockquote><p>我们在定义（声明）实例变量的同时，还可以直接对实例变量进行赋值或者使用实例代码块对其进行赋值。如果我们以这两种方式为实例变量进行初始化，那么它们将在<font color='blue'>构造函数执行之前完成这些初始化操作</font>。<strong><font color='red'>实际上，如果我们对实例变量直接赋值或者使用实例代码块赋值，那么编译器会将其中的代码放到类的构造函数中去，并且这些代码会被放在对超类构造函数的调用语句之后(还记得吗？Java要求构造函数的第一条语句必须是超类构造函数的调用语句)，构造函数本身的代码之前。</font></strong></p><pre class=" language-JAVA"><code class="language-JAVA">public class InstanceVariableInitializer {      private int i = 1;      private int j = i + 1;      public InstanceVariableInitializer(int var){        System.out.println(i);        System.out.println(j);        this.i = var;        System.out.println(i);        System.out.println(j);    }    {               // 实例代码块        j += 3;     }    public static void main(String[] args) {        new InstanceVariableInitializer(8);    }}/* Output:             1            5            8            5 *///:~</code></pre><p>特别需要注意的是，Java是按照<font color='red'>编程顺序来执行实例变量初始化器和实例初始化器中的代码的</font>，并且不允许顺序靠前的实例代码块初始化在其后面定义的实例变量。</p><blockquote><p>构造函数初始化</p></blockquote><p>在编译生成的字节码中，这些<font color='red'>构造函数会被命名成&lt; init&gt;()方法</font>，参数列表与Java语言书写的构造函数的参数列表相同。</p><p><strong><font color='red'>Java要求在实例化类之前，必须先实例化其超类，以保证所创建实例的完整性</font>。</strong>事实上，这一点是在构造函数中保证的：Java强制要求Object对象(Object是Java的顶层对象，没有超类)之外的<font color='blue'>所有对象构造函数的第一条语句必须是超类构造函数的调用语句</font>或者是类中定义的其他的构造函数，如果我们既没有调用其他的构造函数，也没有显式调用超类的构造函数，那么编译器会为我们自动生成一个对超类构造函数的调用。</p><h3 id="4-3-小结"><a href="#4-3-小结" class="headerlink" title="4.3 小结"></a>4.3 小结</h3><p>在实例化一个类的对象时，具体过程是这样的：</p><ol><li>在准备实例化一个类的对象前，<font color='red'>首先准备实例化该类的父类</font>，如果该类的父类还有父类，那么准备实例化该类的父类的父类，依次递归直到递归到Object类。</li><li>具体而言，在实例化每个类时，都遵循如下顺序：<font color='red'>先依次执行实例变量初始化</font>和<font color='red'>实例代码块初始化</font>，<font color='red'>再执行构造函数初始化</font>。也就是说，编译器会将实例变量初始化和实例代码块初始化相关代码放到类的构造函数中去，并且这些代码会被放在对超类构造函数的调用语句之后，构造函数本身的代码之前。</li></ol><blockquote><p>一个实例变量在对象初始化的过程中会被赋值几次？</p></blockquote><ul><li><p>JVM在为一个对象<font color='blue'>分配完内存</font>之后，会给每一个<font color='blue'>实例变量赋予默认值</font>，这个时候实例变量被第一次赋值，这个赋值过程是没有办法避免的。</p></li><li><p>如果在<font color='blue'>声明实例变量x的同时对其进行了赋值操作</font>，那么这个时候，这个实例变量就被第二次赋值了。</p></li><li><p>如果在<font color='blue'>实例代码块</font>中，又对变量x做了初始化操作，那么这个时候，这个实例变量就被第三次赋值了。</p></li><li><p>如果在<font color='blue'>构造函数</font>中，也对变量x做了初始化操作，那么这个时候，变量x就被第四次赋值。</p></li><li><p>也就是说，在Java的对象初始化过程中，一个实例变量<font color='blue'>最多可以被初始化4次。</font></p></li></ul><p>在Java中， 创建一个对象常常需要经历如下几个过程：<strong><font color='red'>父类的类构造器&lt; clinit&gt;() -&gt; 子类的类构造器&lt; clinit&gt;() -&gt; 父类的实例变量和非静态代码块 -&gt; 父类的构造函数 -&gt; 子类的实例变量和非静态代码块 -&gt; 子类的构造函数</font>。</strong></p><p>1、实例初始化就是执行 &lt; init &gt;() 方法</p><ul><li>&lt; init &gt;() 方法可能重载有多个，有几个构造器就有几个 &lt; init &gt;() 方法</li><li>&lt; init &gt;() 由实例变量显式赋值代码和非静态代码块、对应的构造器代码组成</li><li>实例变量显式赋值代码和非静态代码块从上到下顺序执行而对应构造器的代码最后执行</li><li>每次创建实例对象，对应的构造器，执行的就是对应的 &lt; init &gt;() 方法</li><li>&lt; init &gt;() 的首行是 super() 或 super(实参列表)，即对应父类的 &lt; init &gt;() 方法</li></ul><h2 id="5-方法的重写-Override"><a href="#5-方法的重写-Override" class="headerlink" title="5 方法的重写 Override"></a>5 方法的重写 Override</h2><p>1、哪些方法不可以被重写</p><ul><li><code>final</code>修饰的方法</li><li><code>static</code>修饰的方法</li><li><code>private</code>修饰的方法（子类不可见的方法）</li></ul><p>2、对象的多态性</p><ul><li>子类如果重写了父类的方法，通过子类对象调用的一定是子类重写过的代码</li><li>非静态方法默认的调用对象是 this</li><li>this 对象在构造器（ &lt; init &gt;() 方法）中就是正在创建的对象</li></ul><h2 id="6-Override-和-Overload"><a href="#6-Override-和-Overload" class="headerlink" title="6 Override 和 Overload"></a>6 Override 和 Overload</h2><blockquote><p>Override重写的规则</p></blockquote><ul><li>方法名：方法名必须完全相同。</li></ul><ul><li>形参列表：参数列表与被重写方法的参数列表必须完全相同。</li></ul><ul><li>返回值类型：返回类型与被重写方法的返回类型可以不相同，但是必须是父类返回值的派生类。</li></ul><ul><li>抛出的异常列表：重写的方法能够抛出任何非强制异常，无论被重写的方法是否抛出异常。但是，重写的方法不能抛出新的强制性异常，或者比被重写方法声明的更广泛的强制性异常，反之则可以。</li></ul><ul><li>修饰符：访问权限不能比父类中被重写的方法的访问权限更低。</li></ul><blockquote><p>Overload 重载规则</p></blockquote><p>重载(overloading) 是在一个类里面，<font color='red'>方法名字相同，而参数不同</font>。<font color='red'>返回类型可以相同也可以不同</font>。</p><p>每个重载的方法（或者构造函数）都必须有一个独一无二的参数类型列表。</p><p>最常用的地方就是<font color='blue'>构造器的重载</font>。</p><ul><li><p>方法名：方法名必须完全相同。</p></li><li><p>形参列表：被重载的方法<font color='blue'>必须改变参数列表</font>(参数个数或类型不一样)。</p></li><li><p>返回值类型：被重载的方法<font color='blue'>可以改变返回类型</font>。</p></li><li><p>抛出的异常列表：被重载的方法可以声明<font color='blue'>新的或更广的检查异常</font>。</p></li><li><p>修饰符：被重载的方法<font color='blue'>可以改变访问修饰符</font>。</p></li></ul><p><strong><em>tips：</em></strong></p><ul><li>方法能够在同一个类中或者在一个子类中被重载。</li><li><font color='red'>无法</font>以<font color='blue'>返回值类型作为重载函数的区分标准</font>。</li></ul><blockquote><p>Override 重写与 Overload  重载之间的区别</p></blockquote><table><thead><tr><th align="center">区别点</th><th align="center">重载 Overload</th><th align="center">重写 Override</th></tr></thead><tbody><tr><td align="center">参数列表</td><td align="center">必须修改</td><td align="center">一定不能修改</td></tr><tr><td align="center">返回值类型</td><td align="center">可以修改</td><td align="center">一定不能修改</td></tr><tr><td align="center">异常</td><td align="center">可以修改</td><td align="center">可以减少或删除，一定不能抛出新的或更广的异常</td></tr><tr><td align="center">修饰符</td><td align="center">可以修改</td><td align="center">一定不能做更严格的限制（可以降低限制）</td></tr></tbody></table><ul><li>方法重载是一个类中定义了多个方法名相同,而他们的参数的数量不同或数量相同而类型和次序不同,则称为方法的重载(Overloading)。</li><li>方法重写是在子类存在方法与父类的方法的名字相同,而且参数的个数与类型一样,返回值也一样的方法,就称为重写(Overriding)。</li><li>方法重载是一个类的多态性表现，而方法重写是<font color='blue'>子类与父类之间多态性</font>的一种表现。</li></ul><h2 id="7-典型例题分析"><a href="#7-典型例题分析" class="headerlink" title="7 典型例题分析"></a>7 典型例题分析</h2><h3 id="7-1-例题一"><a href="#7-1-例题一" class="headerlink" title="7.1 例题一"></a>7.1 例题一</h3><p>那么，我们看看下面的程序的输出结果：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">staticFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 调用静态方法之前，main所在的类开始初始化，按顺序执行&lt;clinit>，该静态方法最后执行</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> StaticTest st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 静态变量，该变量是对象，所以导致对象的实例化会在类的实例化之前。</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">//静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 实例代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 实例构造器</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a="</span> <span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">",b="</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">staticFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 静态方法</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 实例变量</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">112</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 静态变量</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:         2        3        a=110,b=0        1        4 */</span><span class="token comment" spellcheck="true">//:~</span></code></pre><p>在初始化阶段，当JVM对类StaticTest进行初始化时，首先会执行下面的语句：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> StaticTest st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>也就是实例化StaticTest对象，但这个时候类都没有初始化完毕啊，能直接进行实例化吗？事实上，这涉及到一个根本问题就是：<strong><font color='red'>实例初始化不一定要在类初始化结束之后才开始初始化</font>。</strong> 下面我们结合类的加载过程说明这个问题。</p><p>首先，在类的<font color='blue'>准备</font>阶段需要做的是为<font color='blue'>类变量（static变量）分配内存并设置默认值</font>(零值)，因此在该阶段结束后，<font color='blue'>类变量st将变为null、b变为0</font>。<font color='red'>但是特别注意，如果类变量是final的，</font>在<font color='blue'>准备阶段</font>虚拟机就会将变量设置为指定的值。如果上述程序对变量b采用如下定义方式时：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> b<span class="token operator">=</span><span class="token number">112</span></code></pre><p>那么，在准备阶段b的值就是112，而不再是0了。</p><p>其次，在类的<font color='blue'>初始化阶段</font>需要做的是<font color='blue'>执行类构造器&lt; clinit&gt;()</font>，需要指出的是，类构造器本质上是编译器收集所有<font color='blue'>静态语句块和类变量的赋值语句</font>按语句在源码中的顺序合并生成类构造器&lt; clinit&gt;()。因此，对上述程序而言，JVM将先执行第一条静态变量的赋值语句：</p><pre class=" language-java"><code class="language-java">st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticTest</span> <span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>从Java角度看，我们知道一个类初始化的基本常识，那就是：在同一个类加载器下，一个类型只会被初始化一次。所以，一旦开始初始化一个类型，无论是否完成，后续都不会再重新触发该类型的初始化阶段了(只考虑在同一个类加载器下的情形)。因此，在实例化上述程序中的st变量时，<font color='red'><strong>实际上是把实例初始化嵌入到了静态初始化流程中，并且在上面的程序中，嵌入到了静态初始化的起始位置。</strong></font>这就导致了实例初始化完全发生在静态初始化之前，当然，这也是导致a为110b为0的原因。</p><p>因此，上述程序的StaticTest类构造器&lt; clinit&gt;()的实现等价于：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticTest</span> <span class="token punctuation">{</span>    <span class="token operator">&lt;</span>clinit<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 先是实例初始化</span>        a <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 实例变量</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 实例代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 实例构造器中代码的执行</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a="</span> <span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">",b="</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 实例构造器中代码的执行，此时b还只是准备阶段的默认值0</span>        <span class="token comment" spellcheck="true">// 然后是静态初始化</span>        类变量st被初始化        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//静态代码块</span>        类变量b被初始化为<span class="token number">112</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>下面，我们对上述程序稍作改动，如下所示：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">staticFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> StaticTest st <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"a="</span> <span class="token operator">+</span> a <span class="token operator">+</span> <span class="token string">",b="</span> <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">staticFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">112</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> StaticTest st1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在程序最后的一行，增加以下代码行：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> StaticTest st1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>只有执行完上述代码行后，StaticTest类才被初始化完成，即：</p><pre class=" language-java"><code class="language-java"><span class="token number">2</span><span class="token number">3</span>a<span class="token operator">=</span><span class="token number">110</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0</span><span class="token number">1</span><span class="token number">2</span><span class="token number">3</span>a<span class="token operator">=</span><span class="token number">110</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">112</span><span class="token number">4</span></code></pre><h3 id="7-2-例题二"><a href="#7-2-例题二" class="headerlink" title="7.2 例题二"></a>7.2 例题二</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//父类</span><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  特别注意：该处为<span class="token number">0</span>？？？    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>        i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//子类</span><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token keyword">extends</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>        j <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 重写父类方法</span>        <span class="token keyword">return</span> j<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConstructorExample</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Bar bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:             2            0            2 */</span><span class="token comment" spellcheck="true">//:~</span></code></pre><p>将实例变量和实例代码块放到构造函数之前，Foo类的构造函数和Bar类的构造函数等价地分别变为如下形式：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Foo类构造函数的等价变换：</span><span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// ？？？？</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//Bar类构造函数的等价变换</span><span class="token function">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    j <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">}</span></code></pre><p>(2)处输出是0，为什么呢？因为在执行Foo的构造函数的过程中，由于<font color='red'>Bar重载了Foo中的getValue方法</font>，所以根据Java的多态特性可以知道，其调用的getValue方法是被Bar重载的那个getValue方法。但由于这时Bar的构造函数还没有被执行，因此此时<font color='red'>j的值还是默认值0</font>，因此(2)处输出是0。</p><h3 id="7-3-例题三"><a href="#7-3-例题三" class="headerlink" title="7.3 例题三"></a>7.3 例题三</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 父类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 实例变量    </span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 静态变量</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// 静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Father</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// 父类构造函数</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(2)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// 非静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(3)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 非静态方法，被子类重写，i只会调用子类的test()方法</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(4)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 静态方法</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(5)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 子类</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 实例变量</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 静态变量</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// 静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(6)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                                <span class="token comment" spellcheck="true">// 子类构造函数</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(7)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">{</span>                                    <span class="token comment" spellcheck="true">// 非静态代码块</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(8)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 非静态方法（重写父类方法）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(9)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> k<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 静态方法（无法重写父类方法）</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"(10)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Son s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// (5)  (1)  (10)  (6)  (9)  (3)  (2)  2  (9)  (8)  (7)</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Son s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// (9)  (3)  (2)  2  (9)  (8)  (7)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>创建一个对象常常需要经历如下几个过程</p></blockquote><ol><li><p><font color='red'>*<em>父类的类构造器&lt; clinit&gt;() *</em></font>。</p><ul><li>&lt; clinit&gt;主要就是静态变量和静态代码块按顺序执行。</li><li>当静态变量调用静态方法时，静态方法立即执行。</li><li>特别注意：<code>final</code>修饰的静态变量在准备阶段边被赋值了，无需等到初始化阶段。</li></ul></li><li><p><strong><font color='red'>子类的类构造器&lt; clinit&gt;() 。</font></strong></p><ul><li>父类的静态方法不会被重写，所以子类中的静态变量调用静态方法是自身的静态方法。</li><li>类初始化只会出现一次。</li></ul></li><li><p><strong><font color='red'>父类的实例变量和非静态代码块</font> 。</strong></p><ul><li>实例变量和非静态代码块按顺序执行。</li><li>当实例变量调用非静态方法时，非静态方法立即执行。</li><li><font color='red'>如果非静态方法被子类重写了，那么该实例变量调用的非静态方法便是重写后的子类非静态方法！！！</font></li></ul></li><li><p><font color='red'><strong>父类的构造函数</strong> 。</font></p><ul><li>当父类的实例对象调用的方法是子类重写的方法时，由于此时子类的构造函数还没有被执行，<font color='red'>该实例对象的值是默认值或者是父类实例化初始化的值</font>。</li></ul></li><li><p><font color='red'><strong>子类的实例变量和非静态代码块</strong> 。</font></p></li><li><p><font color='red'><strong>子类的构造函数。</strong></font></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> Java基础 </tag>
            
            <tag> 类和实例的初始化过程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-Java】i++与++i的区别</title>
      <link href="/2021/05/06/mian-shi-java-i-yu-i-de-qu-bie/"/>
      <url>/2021/05/06/mian-shi-java-i-yu-i-de-qu-bie/</url>
      
        <content type="html"><![CDATA[<h2 id="1-面试题描述"><a href="#1-面试题描述" class="headerlink" title="1 面试题描述"></a>1 面试题描述</h2><p>运行如下代码，得到的结果：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 体会 i++ 与 ++i 在内存中的运行不同 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Iaddadd</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        i <span class="token operator">=</span> i <span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> k <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token operator">++</span>i <span class="token operator">*</span> i<span class="token operator">++</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i="</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// i = 4</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"j="</span><span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// j = 1</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"k="</span><span class="token operator">+</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// k = 11</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="2-JVM中虚拟机栈"><a href="#2-JVM中虚拟机栈" class="headerlink" title="2 JVM中虚拟机栈"></a>2 JVM中虚拟机栈</h2><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210527202226.jpg" alt="虚拟机模型" style="zoom: 50%;" /><p>虚拟机栈/Java栈是由一个个<font color='blue'>栈帧</font>构成的。（<font color='red'>一个栈帧就是一个方法</font>）</p><p><font color='red'>每个栈帧是线程私有</font>的，包括四部分内容：<font color='red'>局部变量表(LVT)、操作数栈(OS)</font>、动态链接(DL)和方法返回地址(RA)。</p><h3 id="2-1-局部变量表"><a href="#2-1-局部变量表" class="headerlink" title="2.1 局部变量表"></a>2.1 局部变量表</h3><p> 局部变量表是一组变量值存储空间，用于存放方法参数和方法内部定义的局部变量。</p><ul><li><font color='red'>存储方法参数，以及在方法体内的局部变量</font>；</li><li>存储的数据类型包括：基本数据类型（8种）、引用类型和returnAddress类型。</li></ul><h3 id="2-2-操作数栈"><a href="#2-2-操作数栈" class="headerlink" title="2.2 操作数栈"></a>2.2 操作数栈</h3><p>操作数栈，主要用于保存计算过程中的中间结果，同时作为计算过程中变量临时的存储空间。</p><ul><li>往栈中写入数据或提取数据。只负责存数据和取数据，不参与计算。</li></ul><h2 id="3-内存运行展示"><a href="#3-内存运行展示" class="headerlink" title="3 内存运行展示"></a>3 内存运行展示</h2><ol><li><p>int i = 1</p><p>对应的字节码</p><pre class=" language-java"><code class="language-java"><span class="token number">0</span> iconst_1    <span class="token comment" spellcheck="true">// 将 int 型的 1 推送至栈顶</span><span class="token number">1</span> istore_1    <span class="token comment" spellcheck="true">// 把栈顶的元素弹出，并赋值给局部变量表中位置为“1”的变量，此时指变量i</span></code></pre><p>i 是main方法体中的局部变量，所以将 i 放入局部变量表中。</p></li></ol><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210527203654.png" alt=""></p><ol start="2"><li><p>i = i ++</p><p><font color='red'>= 赋值，都是将操作数栈中的值赋给左边的变量！！！！</font></p><p>对应的字节码指令</p><pre class=" language-java"><code class="language-java"> <span class="token number">2</span> iload_1            <span class="token comment" spellcheck="true">// 把局部变量表中位置为“1”的变量加载到栈顶，即把 i 的值加载到栈顶</span> <span class="token number">3</span> iinc <span class="token number">1</span> by <span class="token number">1</span>        <span class="token comment" spellcheck="true">// 将局部变量表中位置为“1”的 i 加 1，此时局部变量表中 i 的结果为 2</span><span class="token number">6</span> istore_1            <span class="token comment" spellcheck="true">// 把栈顶的元素弹出，并赋值给局部变量表中位置为“1”的变量。所以 i 的值又被改为了 1。</span></code></pre><p>所以这里分为三步：</p><p>① 先从<font color='red'>局部变量表</font>中读取到 i 的值到<font color='red'>操作数栈</font>中；</p><p>② i 直接在<font color='red'>局部变量表上自增</font>；</p><p>③ 将<font color='red'>操作数栈</font>上读取到的 i 的值<font color='red'>赋值给局部变量表</font>上的 i （局部变量表上 i 之前自增的结果会被<font color='red'>覆盖</font>）。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210527210332.png" style="zoom: 80%;" /><ol start="3"><li><p>int  j = i ++;</p><p>对应的字节码指令：</p><pre class=" language-java"><code class="language-java"> <span class="token number">7</span> iload_1            <span class="token comment" spellcheck="true">// 把局部变量表中位置为“1”的变量加载到栈顶，即把 i 的值加载到栈顶</span> <span class="token number">8</span> iinc <span class="token number">1</span> by <span class="token number">1</span>        <span class="token comment" spellcheck="true">// 将局部变量表中位置为“1”的 i 加 1，此时结果为 2，也就是局部变量表中 i 的结果为 2。</span><span class="token number">11</span> istore_2            <span class="token comment" spellcheck="true">// 把栈顶的元素弹出并赋值给局部变量表中位置为“2”的 j。所以 j 是 1，但是 i 的值已经为 2。</span></code></pre><p><font color='red'>先处理等式右边的，然后再处理赋值=</font>，所以这里分为三步：</p><p>① 先从<font color='red'>局部变量表</font>中读取 i 的值到<font color='red'>操作数栈</font>中；</p><p>② <font color='red'>局部变量表中的 i 自增</font>，变为2；</p><p>③ 将<font color='red'>操作数栈中 i 的值</font>（即栈顶元素）赋值给<font color='red'>局部变量表中的 j</font>（因为<font color='blue'>计算是直接在局部变量表上进行</font>，所以操作数栈中的i还是1）。</p></li></ol></li></ol><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210527211630.png" style="zoom:80%;" /><ol start="4"><li><p>int  k = i +  ++i  *  i++</p><p>对应的字节码指令：</p><pre class=" language-java"><code class="language-java"><span class="token number">12</span> iload_1        <span class="token comment" spellcheck="true">// 把局部变量表中位置为“1”的变量加载到栈顶，即把 i 的值加载到栈顶，注意 i 的值此时是 2。</span><span class="token number">13</span> iinc <span class="token number">1</span> by <span class="token number">1</span>    <span class="token comment" spellcheck="true">// 将局部变量表中位置为“1”的 i 加 1，然后 i 就变成 3 了</span><span class="token number">16</span> iload_1        <span class="token comment" spellcheck="true">// 把局部变量表中位置为“1”的变量加载到栈顶，即把 i 的值加载到栈顶</span><span class="token number">17</span> iload_1        <span class="token comment" spellcheck="true">// 把局部变量表中位置为“1”的变量加载到栈顶，即把 i 的值加载到栈顶，所以栈中现在是 3、3、2。</span><span class="token number">18</span> iinc <span class="token number">1</span> by <span class="token number">1</span>    <span class="token comment" spellcheck="true">// 将局部变量表中位置为“1”的 i 加 1，然后 i 就变成 4 了，注意这个 4 并未压入栈。</span><span class="token number">21</span> imul            <span class="token comment" spellcheck="true">// 进行乘法计算，栈中的前两个元素计算后是 9</span><span class="token number">22</span> iadd            <span class="token comment" spellcheck="true">// 也就是 9 + 2，结果为 11。</span><span class="token number">23</span> istore_3        <span class="token comment" spellcheck="true">// 把 11 从栈顶弹出，并赋值给 k，也就是局部变量表中位置为“3”的 k 的值是 11。</span></code></pre><p>这里分为七步：</p><p>① 先从<font color='red'>局部变量表</font>中读取 i 的值到<font color='red'>操作数栈</font>中，此时操作数栈中的结果是 2；</p><p>②  <font color='red'>局部变量表中的 i 自增</font>，变为3；</p><p>③ 再从<font color='red'>局部变量表</font>中读取 i 的值到<font color='red'>操作数栈</font>中，此时操作数栈中的结果是 2  3；</p><p>④ 再次从<font color='red'>局部变量表</font>中读取 i 的值到<font color='red'>操作数栈</font>中，此时操作数栈中的结果是 2  3  3；</p><p>⑤ <font color='red'>局部变量表中的 i 自增</font>，变为4；</p><p>⑥ 操作数栈中前两个元素弹出，进行乘法运算，然后把结果3*3=9再压入栈；</p><p>⑦ 操作数栈中的值弹出，进行加法运算，然后把结果9+2=11在压入栈，然后把栈顶元素赋值给局部变量表中的变量k。</p></li></ol><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210528093641.png" style="zoom:67%;" /><ol start="5"><li>测试不同运算符在一起时，操作数栈入栈出栈顺序</li></ol><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> d <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> e <span class="token operator">=</span> a <span class="token operator">+</span> b <span class="token operator">*</span> c <span class="token operator">-</span> d <span class="token operator">/</span> b<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>对应的字节码指令：</p><pre class=" language-java"><code class="language-java"> <span class="token number">0</span> iconst_1        <span class="token comment" spellcheck="true">// 当 int 取值 -1~5 时，JVM 采用 iconst 指令将常量压入栈中。</span> <span class="token number">1</span> istore_1        <span class="token comment" spellcheck="true">// 将操作数栈的栈顶int数值存入第1局部变量</span> <span class="token number">2</span> iconst_2 <span class="token number">3</span> istore_2 <span class="token number">4</span> iconst_3 <span class="token number">5</span> istore_3 <span class="token number">6</span> iconst_4 <span class="token number">7</span> istore <span class="token number">4</span> <span class="token number">9</span> iload_1        <span class="token comment" spellcheck="true">// 局部变量表处的第2个int型变量进操作数栈（即a=1入栈），此时操作数栈中结果为 1</span><span class="token number">10</span> iload_2        <span class="token comment" spellcheck="true">// 局部变量表处的第3个int型变量进操作数栈（即b=2入栈），此时操作数栈中结果为 1 2</span><span class="token number">11</span> iload_3        <span class="token comment" spellcheck="true">// 局部变量表处的第4个int型变量进操作数栈（即c=3入栈），此时操作数栈中结果为 1 2 3</span><span class="token number">12</span> imul            <span class="token comment" spellcheck="true">// 取出前两个元素，进行乘法运算（2*3），然后将结果6再入栈</span><span class="token number">13</span> iadd            <span class="token comment" spellcheck="true">// 取出前两个元素，进行加法运算（6+1），然后将结果7入栈</span><span class="token number">14</span> iload <span class="token number">4</span>        <span class="token comment" spellcheck="true">// 局部变量表处的第5个int型变量进操作数栈（即d=4入栈），此时操作数栈中结果为 7 4</span><span class="token number">16</span> iload_2        <span class="token comment" spellcheck="true">// 局部变量表处的第3个int型变量进操作数栈（即b=2入栈），此时操作数栈中结果为 7 4 2</span><span class="token number">17</span> idiv            <span class="token comment" spellcheck="true">// 除法</span><span class="token number">18</span> isub            <span class="token comment" spellcheck="true">// 减法</span><span class="token number">19</span> istore <span class="token number">5</span>        <span class="token comment" spellcheck="true">// 栈顶元素保存到局部变量表</span><span class="token number">21</span> getstatic #<span class="token number">2</span> <span class="token operator">&lt;</span>java<span class="token operator">/</span>lang<span class="token operator">/</span>System<span class="token punctuation">.</span>out<span class="token operator">></span><span class="token number">24</span> iload <span class="token number">5</span><span class="token number">26</span> invokevirtual #<span class="token number">3</span> <span class="token operator">&lt;</span>java<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream<span class="token punctuation">.</span>println<span class="token operator">></span><span class="token number">29</span> <span class="token keyword">return</span></code></pre><h2 id="4-小结"><a href="#4-小结" class="headerlink" title="4 小结"></a>4 小结</h2><ul><li>赋值=，最后计算</li><li><font color='red'>= 右边只要遇到变量，就会从局部变量表中将变量的值加载到操作数栈中</font></li><li>= 右边，如果遇到的都是<font color='red'>同一级的运算符</font>，那么<font color='red'>从左到右依次加载变量值，并压入操作数栈</font></li><li>= 右边，如果遇到的不是同一级运算符，那么从左到右依次加载变量值，并压入操作数栈，直到遇到优先级高的，那就先计算，计算结果入栈，然后再依次加载变量值，并压入操作数栈</li><li><font color='red'><strong>自增、自减都是直接在局部变量表中修改变量的值</strong>，不经过操作数栈</font></li><li>最后的赋值之前，临时结果也是存储在操作数栈中的</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> Java基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> Java基础 </tag>
            
            <tag> 内存分配 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【面试-MySQL】MySQL高级优化</title>
      <link href="/2021/04/25/mian-shi-mysql-mysql-gao-ji-you-hua/"/>
      <url>/2021/04/25/mian-shi-mysql-mysql-gao-ji-you-hua/</url>
      
        <content type="html"><![CDATA[<h2 id="1-MySQL环境"><a href="#1-MySQL环境" class="headerlink" title="1 MySQL环境"></a>1 MySQL环境</h2><h3 id="1-1-环境安装"><a href="#1-1-环境安装" class="headerlink" title="1.1 环境安装"></a>1.1 环境安装</h3><pre class=" language-shell"><code class="language-shell"># 查看Linux服务器上是否安装过MySQLrpm -qa | grep -i mysql # 查询出所有mysql依赖包# 1、拉取镜像docker pull mysql:5.7# 2、创建实例并启动docker run -p 3306:3306 --name mysql \-v /root/mysql/log:/var/log/mysql \-v /root/mysql/data:/var/lib/mysql \-v /root/mysql/conf:/etc/mysql \-e MYSQL_ROOT_PASSWORD=333 \-d mysql:5.7# 3、mysql配置 /root/mysql/conf/my.conf[client]#mysqlde utf8字符集默认为3位的，不支持emoji表情及部分不常见的汉字，故推荐使用utf8mb4default-character-set=utf8[mysql]default-character-set=utf8[mysqld]#设置client连接mysql时的字符集,防止乱码init_connect='SET collation_connection = utf8_general_ci'init_connect='SET NAMES utf8'#数据库默认字符集character-set-server=utf8#数据库字符集对应一些排序等规则，注意要和character-set-server对应collation-server=utf8_general_ci# 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置skip-character-set-client-handshake# 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！skip-name-resolve# 4、重启mysql容器docker restart mysql# 5、进入到mysql容器docker exec -it mysql /bin/bash# 6、查看修改的配置文件cat /etc/mysql/my.conf</code></pre><h3 id="1-2-安装位置"><a href="#1-2-安装位置" class="headerlink" title="1.2 安装位置"></a>1.2 安装位置</h3><p><code>Docker</code>容器就是一个小型的<code>Linux</code>环境，进入到<code>MySQL</code>容器中。</p><pre class=" language-shell"><code class="language-shell">docker exec -it mysql /bin/bash</code></pre><p><code>Linux</code>环境下<code>MySQL</code>的安装目录。</p><table><thead><tr><th>路径</th><th>解释</th></tr></thead><tbody><tr><td><code>/var/lib/mysql</code></td><td>MySQL数据库文件存放位置</td></tr><tr><td><code>/usr/share/mysql</code></td><td>错误消息和字符集文件配置</td></tr><tr><td><code>/usr/bin</code></td><td>客户端程序和脚本</td></tr><tr><td><code>/etc/init.d/mysql</code></td><td>启停脚本相关</td></tr></tbody></table><h3 id="1-3-修改字符集"><a href="#1-3-修改字符集" class="headerlink" title="1.3 修改字符集"></a>1.3 修改字符集</h3><pre class=" language-shell"><code class="language-shell"># 1、进入到mysql数据库并查看字符集# show variables like 'character%';# show variables like '%char%';mysql> show variables like 'character%';+--------------------------+----------------------------+| Variable_name            | Value                      |+--------------------------+----------------------------+| character_set_client     | utf8                       || character_set_connection | utf8                       || character_set_database   | utf8                       || character_set_filesystem | binary                     || character_set_results    | utf8                       || character_set_server     | utf8                       || character_set_system     | utf8                       || character_sets_dir       | /usr/share/mysql/charsets/ |+--------------------------+----------------------------+8 rows in set (0.00 sec)mysql> show variables like '%char%';+--------------------------+----------------------------+| Variable_name            | Value                      |+--------------------------+----------------------------+| character_set_client     | utf8                       || character_set_connection | utf8                       || character_set_database   | utf8                       || character_set_filesystem | binary                     || character_set_results    | utf8                       || character_set_server     | utf8                       || character_set_system     | utf8                       || character_sets_dir       | /usr/share/mysql/charsets/ |+--------------------------+----------------------------+8 rows in set (0.01 sec)</code></pre><p><code>MySQL5.7</code>配置文件位置是<code>/etc/my.cnf</code>或者<code>/etc/mysql/my.cnf</code>，如果字符集不是<code>utf-8</code>直接进入配置文件修改即可。</p><pre class=" language-shell"><code class="language-shell">[client]default-character-set=utf8[mysql]default-character-set=utf8[mysqld]# 设置client连接mysql时的字符集,防止乱码init_connect='SET NAMES utf8'init_connect='SET collation_connection = utf8_general_ci'# 数据库默认字符集character-set-server=utf8#数据库字符集对应一些排序等规则，注意要和character-set-server对应collation-server=utf8_general_ci# 跳过mysql程序起动时的字符参数设置 ，使用服务器端字符集设置skip-character-set-client-handshake# 禁止MySQL对外部连接进行DNS解析，使用这一选项可以消除MySQL进行DNS解析的时间。但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！skip-name-resolve</code></pre><p><strong>注意：安装<code>MySQL</code>完毕之后，第一件事就是修改字符集编码。</strong></p><h3 id="1-4-配置文件"><a href="#1-4-配置文件" class="headerlink" title="1.4 配置文件"></a>1.4 配置文件</h3><p><strong><code>MySQL</code>配置文件讲解：<a href="https://www.cnblogs.com/gaoyuechen/p/10273102.html" target="_blank" rel="noopener">https://www.cnblogs.com/gaoyuechen/p/10273102.html</a></strong></p><p>1、二进制日志<code>log-bin</code>：主从复制。</p><pre class=" language-shell"><code class="language-shell"># my,cnf# 开启mysql binlog功能log-bin=mysql-bin</code></pre><p>2、错误日志<code>log-error</code>：默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等。</p><pre class=" language-shell"><code class="language-shell"># my,cnf# 数据库错误日志文件log-error = error.log</code></pre><p>3、查询日志<code>log</code>：默认关闭，记录查询的<code>sql</code>语句，如果开启会降低<code>MySQL</code>整体的性能，因为记录日志需要消耗系统资源。</p><pre class=" language-shell"><code class="language-shell"># my,cnf# 慢查询sql日志设置slow_query_log = 1slow_query_log_file = slow.log</code></pre><p>4、数据文件。</p><ul><li><code>frm文件</code>：存放表结构。</li><li><code>myd</code>文件：存放表数据。</li><li><code>myi</code>文件：存放表索引。</li></ul><pre class=" language-shell"><code class="language-shell"># mysql5.7 使用.frm文件来存储表结构# 使用 .ibd文件来存储表索引和表数据-rw-r-----  1 mysql mysql   8988 Jun 25 09:31 pms_category.frm-rw-r-----  1 mysql mysql 245760 Jul 21 10:01 pms_category.ibd</code></pre><p><code>MySQL5.7</code>的<code>Innodb</code>存储引擎可将所有数据存放于<code>ibdata*</code>的共享表空间，也可将每张表存放于独立的<code>.ibd</code>文件的独立表空间。<br>共享表空间以及独立表空间都是针对数据的存储方式而言的。</p><ul><li>共享表空间: 某一个数据库的所有的表数据，索引文件全部放在一个文件中，默认这个共享表空间的文件路径在<code>data</code>目录下。 默认的文件名为<code>:ibdata1</code> 初始化为<code>10M</code>。</li><li>独立表空间: 每一个表都将会生成以独立的文件方式来进行存储，每一个表都有一个<code>.frm</code>表描述文件，还有一个<code>.ibd</code>文件。 其中这个文件包括了单独一个表的数据内容以及索引内容，默认情况下它的存储位置也是在表的位置之中。在配置文件<code>my.cnf</code>中设置： <code>innodb_file_per_table</code>。</li></ul><h2 id="2-MySQL逻辑架构"><a href="#2-MySQL逻辑架构" class="headerlink" title="2 MySQL逻辑架构"></a>2 MySQL逻辑架构</h2><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525165216.jpg" alt="MySQL逻辑架构" style="zoom:80%;" /><ul><li><p><code>Connectors</code>：指的是不同语言中与SQL的交互。</p></li><li><p><code>Connection Pool</code>：管理缓冲用户连接，线程处理等需要缓存的需求。<strong>MySQL数据库的连接层。</strong></p></li><li><p><code>Management Serveices &amp; Utilities</code>：系统管理和控制工具。备份、安全、复制、集群等等。</p></li><li><p><code>SQL Interface</code>：接受用户的SQL命令，并且返回用户需要查询的结果。</p></li><li><p><code>Parser</code>：SQL语句解析器。</p></li><li><p><code>Optimizer</code>：查询优化器，SQL语句在查询之前会使用查询优化器对查询进行优化。<strong>就是优化客户端请求query</strong>，根据客户端请求的 query 语句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，告诉后面的程序如何取得这个 query 语句的结果。<strong>For Example</strong>： <code>select uid,name from user where gender = 1;</code>这个<code>select</code>查询先根据<code>where</code>语句进行选取，而不是先将表全部查询出来以后再进行<code>gender</code>过滤；然后根据<code>uid</code>和<code>name</code>进行属性投影，而不是将属性全部取出以后再进行过滤。最后将这两个查询条件联接起来生成最终查询结果。</p></li><li><p><code>Caches &amp; Buffers</code>：查询缓存。</p></li><li><p><code>Pluggable Storage Engines</code>：<strong>存储引擎接口。MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎(注意：存储引擎是基于表的，而不是数据库)。</strong></p></li><li><p><code>File System</code>：数据落地到磁盘上，就是文件的存储。</p></li></ul><p>MySQL数据库和其他数据库相比，MySQL有点与众不同，主要体现在存储引擎的架构上，<strong>插件式的存储引擎架构将查询处理和其他的系统任务以及数据的存储提取相分离</strong>。这种架构可以根据业务的需求和实际需求选择合适的存储引擎。</p><blockquote><p>逻辑架构分层</p></blockquote><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525165317.png" alt="MySQL逻辑架构分层" style="zoom:80%;" /><ul><li>连接层：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于<code>tcp/ip</code>的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于<code>SSL</code>的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</li><li>服务层：MySQL的核心服务功能层，该层是MySQL的核心，包括查询缓存，解析器，解析树，预处理器，查询优化器。主要进行查询解析、分析、查询缓存、内置函数、存储过程、触发器、视图等，select操作会先检查是否命中查询缓存，命中则直接返回缓存数据，否则解析查询并创建对应的解析树。</li><li>引擎层：存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。</li><li>存储层：数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</li></ul><h3 id="2-1-查询流程"><a href="#2-1-查询流程" class="headerlink" title="2.1 查询流程"></a>2.1 查询流程</h3><p>mysql 的查询流程大致是：</p><ol><li>mysql 客户端通过协议与 mysql 服务器建连接，发送查询语句，先检查查询缓存，如果命中，直接返回结果，否则进行语句解析,也就是说，在解析查询之前，服务器会先访问查询缓存(query cache)——它存储 SELECT 语句以及相应的查询结果集。如果某个查询结果已经位于缓存中，服务器就不会再对查询进行解析、优化、以及执行。它仅仅将缓存中的结果返回给用户即可，这将大大提高系统的性能。</li><li>语法解析器和预处理：首先 mysql 通过关键字将 SQL 语句进行解析，并生成一颗对应的“解析树”。mysql 解析器将使用 mysql 语法规则验证和解析查询；预处理器则根据一些 mysql 规则进一步检查解析数是否合法。</li><li>查询优化器当解析树被认为是合法的了，并且由优化器将其转化成执行计划。一条查询可以有很多种执行方式，最后都返回相同的结果。优化器的作用就是找到这其中最好的执行计划。</li><li>然后，mysql 默认使用的 BTREE 索引，并且一个大致方向是:无论怎么折腾 sql，至少在目前来说，mysql 最多只用到表中的一个索引。</li></ol><h2 id="3-存储引擎"><a href="#3-存储引擎" class="headerlink" title="3 存储引擎"></a>3 存储引擎</h2><p><code>show engines;</code>命令查看MySQL5.7支持的存储引擎。</p><pre class=" language-shell"><code class="language-shell">mysql> show engines;</code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210526213816.png" alt="存储引擎" style="zoom:80%;" /><p><code>show variables like &#39;default_storage_engine%&#39;;</code>查看当前数据库正在使用的存储引擎。</p><pre class=" language-shell"><code class="language-shell">mysql> show variables like 'default_storage_engine%';+------------------------+--------+| Variable_name          | Value  |+------------------------+--------+| default_storage_engine | InnoDB |+------------------------+--------+1 row in set (0.01 sec)</code></pre><blockquote><p>InnoDB和MyISAM对比</p></blockquote><table><thead><tr><th align="left">对比项</th><th align="center">MyISAM</th><th align="center">InnoDB</th></tr></thead><tbody><tr><td align="left">主外键</td><td align="center">不支持</td><td align="center">支持</td></tr><tr><td align="left">事务</td><td align="center">不支持</td><td align="center">支持</td></tr><tr><td align="left">行表锁</td><td align="center">表锁，即使操作一条记录也会锁住整张表，<strong>不适合高并发操作</strong></td><td align="center">行锁，操作时只锁某一行，不对其他行有影响，<strong>适合高并发操作</strong></td></tr><tr><td align="left">缓存</td><td align="center">只缓存索引，不缓存真实数据</td><td align="center">不仅缓存索引还要缓存真实数据，対内存要求较高，而且内存大小対性能有决定性影响</td></tr><tr><td align="left">表空间</td><td align="center">小</td><td align="center">大</td></tr><tr><td align="left">关注点</td><td align="center">性能</td><td align="center">事务</td></tr><tr><td align="left">默认安装</td><td align="center">Y</td><td align="center">Y</td></tr></tbody></table><h2 id="4-SQL性能下降的原因"><a href="#4-SQL性能下降的原因" class="headerlink" title="4 SQL性能下降的原因"></a>4 SQL性能下降的原因</h2><ul><li>查询语句写的差。</li><li>索引失效：索引建了，但是没有用上。</li><li>关联 查询太多<code>join</code>（设计缺陷或者不得已的需求）。</li><li>服务器调优以及各个参数的设置（缓冲、线程数等）。</li></ul><h2 id="5-SQL执行顺序"><a href="#5-SQL执行顺序" class="headerlink" title="5 SQL执行顺序"></a>5 SQL执行顺序</h2><p>手写的顺序：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210508210749.png" style="zoom:80%;" /><p>真正执行的顺序：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210508210829.png" alt=""></p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210508210907.png" style="zoom:80%;" /><pre class=" language-shell"><code class="language-shell">select              # 5    ... from                # 1    ... where               # 2    .... group by            # 3    ... having              # 4    ... order by            # 6    ... limit               # 7    [offset]</code></pre><h2 id="6-七种JOIN理论"><a href="#6-七种JOIN理论" class="headerlink" title="6 七种JOIN理论"></a>6 七种JOIN理论</h2><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509201309.png" alt="INNER JOIN"></p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle 与 MySQL 写法一致 */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509202122.png" alt="LEFT JOIN"></p><p>LEFT JOIN是以左表的记录为基础的，它的结果集是A表中的全部数据，再加上A表和B表匹配后的数据。换句话说,左表(A)的记录将会全部表示出来，而右表(B)只会显示符合搜索条件的记录。B表无对应数据的地方均为NULL。</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle 与 MySQL 写法一致 */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509202645.png" alt="RIGHT JOIN"></p><p>和LEFT JOIN的结果刚好相反，是以右表(B)为基础的。它的结果集是B表所有记录，再加上A和B匹配后的数据。 A表无对应数据的地方均为NULL。</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle 与 MySQL 写法一致 */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509202934.png" alt=""></p><p>LEFT JOIN 去掉其中B表为null的部分</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle 与 MySQL 写法一致 */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token keyword">WHERE</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509203138.png" alt=""></p><p>RIGHT JOIN 去掉其中A表为null的部分</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle 与 MySQL 写法一致 */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token keyword">WHERE</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509203445.png" alt="FULL JOIN"></p><p>全外连接（FULL OUTER JOIN/FULL JOIN）：左表和右表都不做限制，所有的记录都显示，两表不足的地方均为NULL。</p><p>MySQL中UNION 操作符：用于连接两个以上的 SELECT 语句的结果组合到一个结果集合中，<font color=#FF0000 >多个 SELECT 语句会删除重复的数据。</font></p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">FULL</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token comment" spellcheck="true">/* MySQL不支持全关联，只能实现左右关联，可以根据LEFT JOIN + RIGHT JOIN 来实现FULL JOIN (2+3) */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span><span class="token keyword">UNION</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509204120.png" alt=""></p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* Oracle */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">FULL</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token keyword">WHERE</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* MySQL不支持FULL OUTER JOIN这种语法 可以改成 (4+5) */</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token keyword">WHERE</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span class="token keyword">UNION</span><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>select_list<span class="token operator">></span> <span class="token keyword">FROM</span> TableA A <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> TableB B <span class="token keyword">ON</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">=</span> B<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token keyword">WHERE</span> A<span class="token punctuation">.</span><span class="token keyword">Key</span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></code></pre><h2 id="7-索引"><a href="#7-索引" class="headerlink" title="7 索引"></a>7 索引</h2><h3 id="7-1-索引简介"><a href="#7-1-索引简介" class="headerlink" title="7.1 索引简介"></a>7.1 索引简介</h3><blockquote><p>索引是什么？</p></blockquote><p>MySQL官方对索引的定义为：<strong>索引（INDEX）是帮助MySQL高效获取数据的数据结果。</strong></p><p>从而可以获得索引的本质：<font color=#FF0000 ><strong>索引是排好序的快速查找数据结构。</strong></font></p><p>索引的目的在于提高查询效率，可以类比字典的目录。如果要查<code>mysql</code>这个这个单词，我们肯定要先定位到<code>m</code>字母，然后从上往下找<code>y</code>字母，再找剩下的<code>sql</code>。如果没有索引，那么可能需要<code>a---z</code>，这样全字典扫描，如果我想找<code>Java</code>开头的单词呢？如果我想找<code>Oracle</code>开头的单词呢？？？</p><p><strong>重点：索引会影响到MySQL<font color=#FF0000 >查找(WHERE的查询条件)</font>和<font color=#FF0000 >排序(ORDER BY)</font>两大功能！</strong></p><p><strong>除了数据本身之外，数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是索引。</strong></p><p>一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储在磁盘上。</p><pre class=" language-shell"><code class="language-shell"># Linux下查看磁盘空间命令 df -h [root@Ringo ~]# df -hFilesystem      Size  Used Avail Use% Mounted on/dev/vda1        40G   16G   23G  41% /devtmpfs        911M     0  911M   0% /devtmpfs           920M     0  920M   0% /dev/shmtmpfs           920M  480K  920M   1% /runtmpfs           920M     0  920M   0% /sys/fs/cgroupoverlay          40G   16G   23G  41% </code></pre><p>我们平时所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种数据结构的索引之外，还有哈希索引（Hash Index）等。</p><blockquote><p>索引的优势和劣势</p></blockquote><p>优势：</p><ul><li><font color=#0000FF >查找</font>：类似大学图书馆的书目索引，提高数据检索的效率，降低数据库的IO成本。</li><li><font color=#0000FF >排序</font>：通过索引対数据进行排序，降低数据排序的成本，降低了CPU的消耗。</li></ul><p>劣势：</p><ul><li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要<strong>占用空间</strong>的。</li><li>虽然索引大大提高了查询速度，但是同时<font color=#FF0000 >会降低表的更新速度</font>，例如对表频繁的进行<code>INSERT</code>、<code>UPDATE</code>和<code>DELETE</code>。因为更新表的时候，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加的索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</li><li>索引只是提高效率的一个因素，如果MySQL有大数据量的表，就需要花时间研究建立最优秀的索引。</li></ul><h3 id="7-2-MySQL索引数据结构"><a href="#7-2-MySQL索引数据结构" class="headerlink" title="7.2 MySQL索引数据结构"></a>7.2 MySQL索引数据结构</h3><p>索引数据结构：</p><ul><li><code>B-tree</code>索引。</li><li><code>Hash</code>索引。</li><li><code>Full-text</code>全文索引。</li><li><code>R-Tree</code>索引。</li></ul><p><code>B-tree</code>索引检索原理：</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525165637.png" alt="B-tree" style="zoom:80%;" /><p>一颗 b 树，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示），如磁盘块 1 包含数据项 17 和 35，包含指针 P1、P2、P3。</p><ul><li>P1 表示小于 17 的磁盘块，P2 表示在 17 和 35 之间的磁盘块，P3 表示大于 35 的磁盘块。</li><li><strong>真实的数据存在于叶子节点</strong>即 3、5、9、10、13、15、28、29、36、60、75、79、90、99。</li><li><strong>非叶子节点只不存储真实的数据</strong>，<strong>只存储指引搜索方向的数据项</strong>，如 17、35 并不真实存在于数据表中。</li></ul><p><code>B+tree</code>索引检索原理：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210509210725.png" alt="B+tree"></p><p>B+Tree 与 B-Tree 的区别：</p><ol><li>B-树的关键字和记录是放在一起的，叶子节点可以看作外部节点，不包含任何信息；B+树的非叶子节点中只有关键字和指向下一个节点的索引，记录只放在叶子节点中。</li><li>在 B-树中，越靠近根节点的记录查找时间越快，只要找到关键字即可确定记录的存在；而 B+树中每个记录的查找时间基本是一样的，都需要从根节点走到叶子节点，而且在叶子节点中还要再比较关键字。从这个角度看 B-树的性能好像要比 B+树好，而在实际应用中却是 B+树的性能要好些。因为 <font color=#0000FF >B+树的非叶子节点不存放实际的数据，这样每个节点可容纳的元素个数比 B-树多，树高比 B-树小，这样带来的好处是减少磁盘访问次数。</font>尽管 B+树找到一个记录所需的比较次数要比 B-树多，但是一次磁盘访问的时间相当于成百上千次内存比较的时间，因此实际中B+树的性能可能还会好些，而且 B+树的叶子节点使用指针连接在一起，方便顺序遍历（例如查看一个目录下的所有文件，一个表中的所有记录等），这也是很多数据库和文件系统使用 B+树的缘故。</li></ol><blockquote><p>思考：为什么说 B+树比 B-树更适合实际应用中操作系统的文件索引和数据库索引？</p></blockquote><ul><li><p><strong>B+树的磁盘读写代价更低</strong></p><p>B+树的内部结点并没有指向关键字具体信息的指针。因此其内部结点相对 B 树更小。如果把所有同一内部结点的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就越多。相对来说 IO 读写次数也就降低了。</p></li><li><p><strong>B+树的查询效率更加稳定</strong></p><p>由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。</p></li></ul><h3 id="7-3-MySQL索引分类"><a href="#7-3-MySQL索引分类" class="headerlink" title="7.3 MySQL索引分类"></a>7.3 MySQL索引分类</h3><p>索引分类：</p><ul><li>单值索引：一个索引只包含单个列，一个表可以有多个单列索引。</li><li>唯一索引：索引列的值必须唯一，但是允许空值。</li><li>复合索引：一个索引包含多个字段。</li></ul><p><strong>建议：一张表建的索引最好不要超过5个！</strong></p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 基本语法 */</span><span class="token comment" spellcheck="true">/* 1、创建索引 [UNIQUE]可以省略*/</span><span class="token comment" spellcheck="true">/* 如果只写一个字段就是单值索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_表名_列名 <span class="token keyword">ON</span> 表名<span class="token punctuation">(</span>列名<span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 唯一索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_表名_列名 <span class="token keyword">ON</span> 表名<span class="token punctuation">(</span>列名<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 多个字段就是复合索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_列名1_列名<span class="token number">2</span> <span class="token keyword">ON</span> 表名<span class="token punctuation">(</span>列名<span class="token number">1</span><span class="token punctuation">,</span>列名<span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 2、删除索引 */</span><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> <span class="token punctuation">[</span>indexName<span class="token punctuation">]</span> <span class="token keyword">ON</span> tabName<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 3、查看索引 */</span><span class="token comment" spellcheck="true">/* 加上\G就可以以列的形式查看了 不加\G就是以表的形式查看 */</span><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> tabName \G<span class="token punctuation">;</span></code></pre><p>使用<code>ALTER</code>命令来为数据表添加索引</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 1、该语句添加一个主键，这意味着索引值必须是唯一的，并且不能为NULL */</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tabName <span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 2、该语句创建索引的键值必须是唯一的(除了NULL之外，NULL可能会出现多次) */</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tabName <span class="token keyword">ADD</span> <span class="token keyword">UNIQUE</span> indexName<span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 3、该语句创建普通索引，索引值可以出现多次 */</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tabName <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> indexName<span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 4、该语句指定了索引为FULLTEXT，用于全文检索 */</span><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tabName <span class="token keyword">ADD</span> FULLTEXT indexName<span class="token punctuation">(</span>column_list<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="7-4-哪些情况需要建索引"><a href="#7-4-哪些情况需要建索引" class="headerlink" title="7.4 哪些情况需要建索引"></a>7.4 哪些情况需要建索引</h3><ul><li>主键自动建立主键索引（唯一 + 非空）。</li><li><font color=#FF0000 >频繁作为查询条件的字段</font>应该创建索引。</li><li>查询中与其他表关联的字段，<font color=#FF0000 >外键关系建立索引</font>。</li><li><font color=#FF0000 >查询中排序的字段</font>，排序字段若通过索引去访问将大大提高排序速度。</li><li>查询中<font color=#FF0000 >统计或者分组字段</font>（group by也和索引有关）。</li></ul><h3 id="7-5-那些情况不要建索引"><a href="#7-5-那些情况不要建索引" class="headerlink" title="7.5 那些情况不要建索引"></a>7.5 那些情况不要建索引</h3><ul><li><p>记录太少的表。</p></li><li><p>经常增删改的表。</p></li><li><p>频繁更新的字段不适合创建索引。</p></li><li><p>Where条件里用不到的字段不创建索引。</p></li><li><p>过滤性不好的不适合建索引。</p><p>假如一个表有10万行记录，有一个字段A只有true和false两种值，并且每个值的分布概率大约为50%，那么对A字段建索引一般不会提高数据库的查询速度。<font color=#0000FF >索引的选择性是指索引列中不同值的数目与表中记录数的比。</font>如果一个表中有2000条记录，表索引列有1980个不同的值，那么这个索引的选择性就是1980/2000=0.99。<font color=#FF0000 >一个索引的选择性越接近于1，这个索引的效率就越高。</font></p></li></ul><h2 id="8-性能分析"><a href="#8-性能分析" class="headerlink" title="8 性能分析"></a>8 性能分析</h2><h3 id="8-1-EXPLAIN简介"><a href="#8-1-EXPLAIN简介" class="headerlink" title="8.1 EXPLAIN简介"></a>8.1 EXPLAIN简介</h3><blockquote><p>EXPLAIN是什么？</p></blockquote><p>EXPLAIN：SQL的执行计划，使用EXPLAIN关键字可以<strong>模拟优化器执行SQL查询语句</strong>，从而知道MySQL是如何处理SQL语句的。</p><blockquote><p>EXPLAIN怎么使用？</p></blockquote><p>语法：<code>explain</code> + <code>SQL</code>。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510110706.png" alt="EXPLAIN执行后返回的信息"></p><pre class=" language-shell"><code class="language-shell">mysql> explain select * from pms_category \G;*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: pms_category   partitions: NULL         type: ALLpossible_keys: NULL          key: NULL      key_len: NULL          ref: NULL         rows: 1425     filtered: 100.00        Extra: NULL1 row in set, 1 warning (0.00 sec)</code></pre><blockquote><p>EXPLAIN能干嘛？</p></blockquote><p>可以查看以下信息：</p><ul><li><code>id</code>：select 查询的序列号，表示查询中执行 select 子句或操作表的顺序。</li><li><code>select_type</code>：数据读取操作的操作类型。</li><li><code>possible_keys</code>：哪些索引可以使用。</li><li><code>key</code>：哪些索引被实际使用。</li><li><code>ref</code>：表之间的引用。</li><li><code>rows</code>：每张表有多少行被优化器查询。</li></ul><h3 id="8-2-EXPLAIN字段"><a href="#8-2-EXPLAIN字段" class="headerlink" title="8.2 EXPLAIN字段"></a>8.2 EXPLAIN字段</h3><blockquote><p><font color=#FF0000 ><code>id</code></font></p></blockquote><p><code>id</code>：查询中执行 select 子句或操作表的顺序。</p><p>值有以下三种情况：</p><ul><li><code>id</code>相同，执行顺序由上至下。</li><li><code>id</code>不同，如果是子查询，id的序号会递增，<strong>id值越大优先级越高，越先被执行。</strong></li><li><code>id</code>相同不同情况同时存在。<strong>永远是id大的优先级最高，id相等的时候顺序执行。</strong></li></ul><p><strong><em>Tips：</em></strong><font color=#FF0000 >id 号每个号码，表示一趟独立的查询。一个 sql 的查询趟数越少越好。</font></p><blockquote><p>select_type</p></blockquote><p><code>select_type</code>：数据查询的类型，主要是用于区别，普通查询、联合查询、子查询等的复杂查询。</p><table><thead><tr><th align="center"><code>select_type</code>属性</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center"><code>SIMPLE</code></td><td align="center">简单的<code>SELECT</code>查询，查询中不包含子查询或者<code>UNION</code>。(<font color=#0000FF >单表查询</font>)</td></tr><tr><td align="center"><code>PRIMARY</code></td><td align="center">查询中如果包含任何复杂的子部分，<font color=#0000FF >最外层查询</font>则被标记为<code>PRIMARY</code>。</td></tr><tr><td align="center"><code>DERIVED</code></td><td align="center">在<font color=#0000FF ><code>FROM</code>子句中包含的子查询</font>被标记为<code>DERIVED(衍生)</code>，MySQL会递归执行这些子查询，把结果放在临时表中。</td></tr><tr><td align="center"><code>SUBQUERY</code></td><td align="center">在<font color=#0000FF ><code>SELECT</code>或者<code>WHERE</code>子句</font>中包含了子查询。<font color=#0000FF >where子句后面是单个值</font></td></tr><tr><td align="center"><code>DEPEDENT SUBQUERY</code></td><td align="center">在<font color=#0000FF ><code>SELECT</code>或<code>WHERE</code>列表中</font>包含了子查询,子查询基于外层。<font color=#0000FF >where子句后面是一组值</font></td></tr><tr><td align="center"><code>UNCACHEABLE SUBQUERY</code></td><td align="center">无法使用缓存的子查询，<font color=#0000FF >当使用了@@来引用系统变量的时候，不会使用缓存。</font></td></tr><tr><td align="center"><code>UNION</code></td><td align="center">如果第二个<code>SELECT</code>出现在<code>UNION</code>之后，则被标记为<code>UNION</code>；若<code>UNION</code>包含在<code>FROM</code>子句的子查询中，外层<code>SELECT</code>将被标记为<code>DERIVED</code>。</td></tr><tr><td align="center"><code>UNION RESULT</code></td><td align="center"><code>从</code>UNION<code>表获取结果的</code>SELECT`。</td></tr></tbody></table><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510112306.png" alt="PRIMARY DERIVED"></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510144954.png" alt="SUBQUERY"></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510145227.png" alt=" DEPENDENT SUBQUERY"></p><p><strong><em>Tips：</em></strong><font color=#FF0000 ><code>SUBQUERY</code>与<code>DEPEDENT SUBQUERY</code>的区别：都是 where 后面的条件，subquery 是单个值，dependent subquery 是一组值。</font></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510150457.png" alt="UNION"></p><blockquote><p><font color='red'><code>type</code></font></p></blockquote><p><code>type</code>：访问类型排列。是较为重要的一个指标。</p><p><strong>从最好到最差依次是：</strong><font color=#FF0000 ><code>system</code>&gt;<code>const</code>&gt;<code>eq_ref</code>&gt;<code>ref</code>&gt;<code>range</code>&gt;<code>index</code>&gt;<code>ALL</code>。</font>除了<code>ALL</code>没有用到索引，其他级别都用到索引了。</p><p>一般来说，得保证<font color=#0000FF >查询至少达到<code>range</code>级别，最好达到<code>ref</code>。</font></p><ul><li><code>system</code>：表只有一行记录（等于系统表），这是<code>const</code>类型的特例，平时不会出现，这个也可以忽略不计。</li><li><code>const</code>：表示通过索引一次就找到了，<code>const</code>用于比较<font color=#0000FF ><code>primary key</code>或者<code>unique</code>索引</font>。因为只匹配一行数据，所以很快。如将主键置于<code>where</code>列表中，MySQL就能将该查询转化为一个常量。</li><li><code>eq_ref</code>：<font color=#0000FF >唯一性索引扫描</font>，读取本表中和关联表表中的每行组合成的一行，查出来只有一条记录。除 了 <code>system</code> 和<code>const</code> 类型之外, 这是最好的联接类型。</li><li><code>ref</code>：<font color=#0000FF >非唯一性索引扫描</font>，返回本表和关联表<font color=#0000FF >某个值匹配的所有行</font>，查出来有多条记录。</li><li><code>range</code>：只检索给定范围的行，一般就是<font color=#0000FF >在<code>WHERE</code>语句中出现了<code>BETWEEN</code>、<code>&lt; &gt;</code>、<code>in</code>等的查询</font>。这种范围扫描索引比全表扫描要好，因为它只需要开始于索引树的某一点，而结束于另一点，不用扫描全部索引。</li><li><code>index</code>：<code>Full Index Scan</code>，全索引扫描。出现index是sql使用了索引但是<font color=#FF0000 >没有通过索引进行过滤</font>，一般是使用了<font color=#FF0000 >覆盖索引</font>或者是<font color=#FF0000 >利用索引进行了排序分组。</font>            </li><li><code>ALL</code>：<code>Full Table Scan</code>，没有用到索引，全表扫描。</li></ul><p><strong><em>Tips：</em></strong><code>index</code>和<code>ALL</code>的区别：<code>index</code>类型只遍历索引树。<strong>也就是说虽然<code>ALL</code>和<code>index</code>都是读全表，但是<code>index</code>是从索引中读的，<code>ALL</code>是从磁盘中读取的。</strong></p><blockquote><p><font color='red'>possible_keys 和 key</font></p></blockquote><p><code>possible_keys</code>：显示可能应用在这张表中的索引，一个或者多个。查询涉及到的字段上若存在索引，则该索引将被列出，<strong>但不一定被查询实际使用。</strong></p><p><code>key</code>：实际使用的索引。如果为<code>NULL</code>，则没有使用索引。查询中如果使用了覆盖索引，则该索引仅仅出现在<code>key</code>列表中。</p><blockquote><p>key_len</p></blockquote><p><code>key_len</code>：表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。<code>key_len</code>显示的值为索引字段的最大可能长度，并非实际使用长度，即<code>key_len</code>是根据表定义计算而得，不是通过表内检索出的。在不损失精度的情况下，长度越短越好。</p><p><code>key_len</code>计算规则：<strong><a href="https://blog.csdn.net/qq_34930488/article/details/102931490" target="_blank" rel="noopener">https://blog.csdn.net/qq_34930488/article/details/102931490</a></strong></p><pre class=" language-shell"><code class="language-shell">mysql> desc pms_category;+---------------+------------+------+-----+---------+----------------+| Field         | Type       | Null | Key | Default | Extra          |+---------------+------------+------+-----+---------+----------------+| cat_id        | bigint(20) | NO   | PRI | NULL    | auto_increment || name          | char(50)   | YES  |     | NULL    |                || parent_cid    | bigint(20) | YES  |     | NULL    |                || cat_level     | int(11)    | YES  |     | NULL    |                || show_status   | tinyint(4) | YES  |     | NULL    |                || sort          | int(11)    | YES  |     | NULL    |                || icon          | char(255)  | YES  |     | NULL    |                || product_unit  | char(50)   | YES  |     | NULL    |                || product_count | int(11)    | YES  |     | NULL    |                |+---------------+------------+------+-----+---------+----------------+9 rows in set (0.00 sec)mysql> explain select cat_id from pms_category where cat_id between 10 and 20 \G;*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: pms_category   partitions: NULL         type: rangepossible_keys: PRIMARY          key: PRIMARY  # 用到了主键索引，通过查看表结构知道，cat_id是bigint类型，占用8个字节      key_len: 8        # 这里只用到了cat_id主键索引，所以长度就是8！          ref: NULL         rows: 11     filtered: 100.00        Extra: Using where; Using index1 row in set, 1 warning (0.00 sec)</code></pre><blockquote><p><font color='red'><code>ref</code></font></p></blockquote><p><code>ref</code>：显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值。</p><blockquote><p>rows</p></blockquote><p><code>rows</code>：根据表统计信息及索引选用情况，大致估算出找到所需的记录需要读取的行数。<strong>越少越好！</strong></p><blockquote><p>Extra</p></blockquote><p><code>Extra</code>：包含不适合在其他列中显示但十分重要的额外信息。</p><ul><li><font color='red'><code>Using filesort</code></font>：说明MySQL会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。<strong>MySQL中无法利用索引完成的排序操作成为”文件内排序”。</strong></li><li><strong>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度。</strong></li></ul><pre class=" language-shell"><code class="language-shell"># 排序没有使用索引mysql> explain select name from pms_category where name='Tangs' order by cat_level \G*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: pms_category   partitions: NULL         type: refpossible_keys: idx_name_parentCid_catLevel          key: idx_name_parentCid_catLevel      key_len: 201          ref: const         rows: 1     filtered: 100.00        Extra: Using where; Using index; Using filesort1 row in set, 1 warning (0.00 sec)#~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~# 排序使用到了索引mysql> explain select name from pms_category where name='Tangs' order by parent_cid,cat_level\G*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: pms_category   partitions: NULL         type: refpossible_keys: idx_name_parentCid_catLevel          key: idx_name_parentCid_catLevel      key_len: 201          ref: const         rows: 1     filtered: 100.00        Extra: Using where; Using index1 row in set, 1 warning (0.00 sec)</code></pre><ul><li><p><font color='red'><code>Using temporary</code></font>：使用了临时表保存中间结果，MySQL在対查询结果排序时使用了临时表。常见于<font color=#FF0000 >排序<code>order by</code>和分组查询<code>group by</code>。</font><strong>临时表対系统性能损耗很大。</strong></p></li><li><p><font color='red'><code>Using index</code></font>：表示<font color='red'>相应的<code>SELECT</code>操作中使用了覆盖索引，避免访问了表的数据行</font>，效率不错！如果同时出现<code>Using where</code>，表示索引被用来执行索引键值的查找；如果没有同时出现<code>Using where</code>，表明索引用来读取数据而非执行查找动作。</p></li></ul><pre class=" language-shell"><code class="language-shell"># 覆盖索引# 就是select的数据列只用从索引中就能够取得，不必从数据表中读取，换句话说查询列要被所使用的索引覆盖。# 注意：如果要使用覆盖索引，一定不能写SELECT *，要写出具体的字段。mysql> explain select cat_id from pms_category \G;*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: pms_category   partitions: NULL         type: indexpossible_keys: NULL                 key: PRIMARY      key_len: 8          ref: NULL         rows: 1425     filtered: 100.00        Extra: Using index   # select的数据列只用从索引中就能够取得，不必从数据表中读取   1 row in set, 1 warning (0.00 sec)</code></pre><ul><li><code>Using where</code>：表明使用了<code>WHERE</code>过滤。</li><li><code>Using join buffer</code>：使用了连接缓存。</li><li><code>impossible where</code>：<code>WHERE</code>子句的值总是false，不能用来获取任何元组。</li></ul><pre class=" language-shell"><code class="language-shell">mysql> explain select name from pms_category where name = 'zs' and name = 'ls'\G*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: NULL   partitions: NULL         type: NULLpossible_keys: NULL          key: NULL      key_len: NULL          ref: NULL         rows: NULL     filtered: NULL        Extra: Impossible WHERE   # 不可能字段同时查到两个名字1 row in set, 1 warning (0.00 sec)</code></pre><h2 id="9-索引分析"><a href="#9-索引分析" class="headerlink" title="9 索引分析"></a>9 索引分析</h2><h3 id="9-1-单表索引分析"><a href="#9-1-单表索引分析" class="headerlink" title="9.1 单表索引分析"></a>9.1 单表索引分析</h3><blockquote><p>数据准备</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'作者id'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>category_id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'分类id'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>views<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'被查看的次数'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>comments<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'回帖的备注'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'标题'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'正文内容'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'文章'</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>content<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>content<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>content<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>content<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>author_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>category_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>views<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>content<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>案例：查询<code>category_id</code>为1且<code>comments</code>大于1的情况下，<code>views</code>最多的<code>article_id</code>。</p></blockquote><p>1、编写SQL语句并查看SQL执行计划。</p><pre class=" language-shell"><code class="language-shell"># 1、sql语句SELECT id,author_id FROM article WHERE category_id = 1 AND comments > 1 ORDER BY views DESC LIMIT 1;# 2、sql执行计划mysql> EXPLAIN SELECT id,author_id FROM article WHERE category_id = 1 AND comments > 1 ORDER BY views DESC LIMIT 1\G*************************** 1. row ***************************           id: 1  select_type: SIMPLE        table: article   partitions: NULL         type: ALLpossible_keys: NULL          key: NULL      key_len: NULL          ref: NULL         rows: 5     filtered: 20.00        Extra: Using where; Using filesort  # 产生了文件内排序，需要优化SQL1 row in set, 1 warning (0.00 sec)</code></pre><p>2、创建索引<code>idx_article_ccv</code>。</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_article_ccv <span class="token keyword">ON</span> article<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span>comments<span class="token punctuation">,</span>views<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>3、查看当前索引。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525165812.png" alt="show index" /><p>4、查看现在SQL语句的执行计划。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525165918.png" alt="explain" style="zoom:80%;" /><p>我们发现，创建符合索引<code>idx_article_ccv</code>之后，虽然解决了全表扫描的问题，但是在<code>order by</code>排序的时候没有用到索引，MySQL居然还是用的<code>Using filesort</code>，为什么？</p><p>5、我们试试把SQL修改为<code>SELECT id,author_id FROM article WHERE category_id = 1 AND comments = 1 ORDER BY views DESC LIMIT 1;</code>看看SQL的执行计划。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170012.png" alt="explain" /><p>推论：当<code>comments &gt; 1</code>的时候<code>order by</code>排序<code>views</code>字段索引就用不上，但是当<code>comments = 1</code>的时候<code>order by</code>排序<code>views</code>字段索引就可以用上！！！<strong>所以，<font color='blue'>范围之后的索引会失效</font>。</strong></p><p>6、我们现在知道<strong>范围之后的索引会失效</strong>，原来的索引<code>idx_article_ccv</code>最后一个字段<code>views</code>会失效，那么我们如果删除这个索引，创建<code>idx_article_cv</code>索引呢？？？？</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 创建索引 idx_article_cv */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_article_cv <span class="token keyword">ON</span> article<span class="token punctuation">(</span>category_id<span class="token punctuation">,</span>views<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>查看当前的索引</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170114.png" alt="Show Index"></p><p>7、当前索引是<code>idx_article_cv</code>，来看一下SQL执行计划。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170209.png" alt="explain"></p><h3 id="9-2-两表索引分析"><a href="#9-2-两表索引分析" class="headerlink" title="9.2 两表索引分析"></a>9.2 两表索引分析</h3><blockquote><p>数据准备</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>class<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>book<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>class<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>card<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'分类'</span> <span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品类别'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>book<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>card<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'分类'</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'书籍'</span><span class="token punctuation">;</span></code></pre><blockquote><p>两表连接查询的SQL执行计划</p></blockquote><p>1、不创建索引的情况下，SQL的执行计划。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170306.png" alt="explain"></p><p><code>book</code>和<code>class</code>两张表都是没有使用索引，全表扫描，那么如果进行优化，索引是创建在<code>book</code>表还是创建在<code>class</code>表呢？下面进行大胆的尝试！</p><p>2、左表(<code>book</code>表)创建索引。</p><p>创建索引<code>idx_book_card</code></p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 在book表创建索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_book_card <span class="token keyword">ON</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在<code>book</code>表中有<code>idx_book_card</code>索引的情况下，查看SQL执行计划</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170353.png" alt="explain"></p><p>3、删除<code>book</code>表的索引，右表(<code>class</code>表)创建索引。</p><p>创建索引<code>idx_class_card</code></p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 在class表创建索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_class_card <span class="token keyword">ON</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在<code>class</code>表中有<code>idx_class_card</code>索引的情况下，查看SQL执行计划</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170423.png" alt="explain"></p><p><strong>由此可见，<font color='red'>左连接将索引创建在右表上更合适，右连接将索引创建在左表上更合适</font>。</strong></p><p><strong><em>tips：</em></strong></p><ul><li>在优化关联查询时，只有在<font color='blue'>被驱动表上建立索引才有效</font>！</li><li><font color='red'><code>left join</code> 时，左侧的为驱动表，右侧为被驱动表！</font></li><li><code>inner join</code> 时，mysql 会自己帮你把<font color='red'>小结果集的表选为驱动表</font>。</li></ul><blockquote><p>案例</p></blockquote><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511205227.png" alt=""></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511205242.png" alt=""></p><p>上述两个案例，第一个查询效率较高，且有优化的余地。第二个案例中，子查询作为被驱动表，由于子查询是虚表，无法建立索引，因此不能优化。</p><p><strong><em>tips：</em></strong></p><ul><li><font color='red'>子查询尽量不要放在被驱动表</font>，有可能使用不到索引；</li><li><code>left join</code>时，尽量让<font color='blue'>实体表作为被驱动表</font>。</li><li>能够<font color='blue'>直接多表关联的尽量直接关联</font>，不用子查询！</li></ul><h3 id="9-3-三张表索引分析"><a href="#9-3-三张表索引分析" class="headerlink" title="9.3 三张表索引分析"></a>9.3 三张表索引分析</h3><blockquote><p>数据准备</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>phone<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>phone<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>phone_id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>card<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> UNSIGNED <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'分类'</span> <span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'手机'</span><span class="token punctuation">;</span></code></pre><blockquote><p>三表连接查询SQL优化</p></blockquote><p>1、不加任何索引，查看SQL执行计划。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170522.png" alt="explain"></p><p>2、根据两表查询优化的经验，左连接需要在右表上添加索引，所以尝试在<code>book</code>表和<code>phone</code>表上添加索引。</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 在book表创建索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_book_card <span class="token keyword">ON</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 在phone表上创建索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_phone_card <span class="token keyword">ON</span> phone<span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>再次执行SQL的执行计划</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170555.png" alt="explain"></p><h3 id="9-4-结论"><a href="#9-4-结论" class="headerlink" title="9.4 结论"></a>9.4 结论</h3><p><code>JOIN</code>语句的优化：</p><ul><li><p><strong><font color='red'>左连接将索引创建在右表上更合适，右连接将索引创建在左表上更合适</font>。</strong></p></li><li><p>尽可能减少<code>JOIN</code>语句中的<code>NestedLoop</code>（嵌套循环）的总次数：<font color='red'><strong>永远都是小的结果集驱动大的结果集</strong>。</font></p></li><li><p>优先优化<code>NestedLoop</code>的内层循环。</p></li><li><p>保证<code>JOIN</code>语句中被驱动表上<code>JOIN</code>条件字段已经被索引。</p></li><li><p>当无法保证被驱动表的<code>JOIN</code>条件字段被索引且内存资源充足的前提下，不要太吝惜<code>Join Buffer</code> 的设置。</p></li></ul><h2 id="10-单表使用索引常见的索引失效"><a href="#10-单表使用索引常见的索引失效" class="headerlink" title="10 单表使用索引常见的索引失效"></a>10 单表使用索引常见的索引失效</h2><blockquote><p>数据准备</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'姓名'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'年龄'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'职位'</span><span class="token punctuation">,</span><span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'入职时间'</span><span class="token punctuation">)</span><span class="token keyword">COMMENT</span> <span class="token string">'员工记录表'</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'Ringo'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">'manager'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 创建索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_staffs_name_age_pos <span class="token keyword">ON</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><font color='red'>索引失效的情况</font></p></blockquote><ul><li>全值匹配我最爱。</li><li>最佳左前缀法则。</li><li>不在索引列上做任何操作（计算、函数、(自动or手动)类型转换），会导致索引失效而转向全表扫描。</li><li>索引中范围条件右边的字段会全部失效。</li><li>尽量使用覆盖索引（只访问索引的查询，索引列和查询列一致），减少<code>SELECT *</code>。</li><li>MySQL在使用<code>!=</code>或者<code>&lt;&gt;</code>的时候无法使用索引会导致全表扫描。</li><li><code>is null</code>、<code>is not null</code>也无法使用索引。</li><li><code>like</code>以通配符开头<code>%abc</code>索引失效会变成全表扫描。</li><li>字符串不加单引号索引失效。</li><li>少用<code>or</code>，用它来连接时会索引失效。</li></ul><h3 id="10-1-全值匹配我最爱"><a href="#10-1-全值匹配我最爱" class="headerlink" title="10.1 全值匹配我最爱"></a>10.1 全值匹配我最爱</h3><pre class=" language-mysql"><code class="language-mysql"># 创建的索引如下所示CREATE INDEX idx_age_deptid_name ON emp(age,deptid,NAME);</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510165417.png" alt="全值匹配我最爱"></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510165800.png" alt=""></p><p><strong><em>Tips：</em></strong></p><ul><li>全值匹配我最爱指的是，<font color='red'>查询的字段按照顺序在索引中都可以匹配到！</font></li><li>当<font color='red'>查询字段的数量与索引中字段的数量一致</font>时，SQL中查询字段的顺序，跟使用索引中字段的顺序，没有关系。优化器会在不影响 SQL执行结果的前提下，给你自动地优化。</li></ul><h3 id="10-2-最佳左前缀法则"><a href="#10-2-最佳左前缀法则" class="headerlink" title="10.2 最佳左前缀法则"></a>10.2 最佳左前缀法则</h3><pre class=" language-mysql"><code class="language-mysql"># 创建的索引如下所示CREATE INDEX idx_age_deptid_name ON emp(age,deptid,NAME);</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510170510.png" alt="最佳作前缀法则"></p><p><strong><em>Tips：</em></strong></p><ul><li><font color='blue'>查询字段与索引字段顺序的不同</font>会导致，<font color='purple'>索引无法充分使用，甚至索引失效</font>！</li><li>使用复合索引，需要遵循最佳左前缀法则。查询<font color='red'>从索引的最左前列开始并且不跳过索引中的列</font>。</li><li><strong>过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用。</strong></li></ul><p><strong>口诀：</strong></p><ul><li><strong><font color='red'>带头大哥不能死，中间兄弟不能断</font></strong></li></ul><blockquote><p>案例</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 用到了idx_staffs_name_age_pos索引中的name字段 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 用到了idx_staffs_name_age_pos索引中的name, age字段 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 索引没用上，ALL全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 索引没用上，ALL全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 用到了idx_staffs_name_age_pos索引中的name字段，pos字段索引失效 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span></code></pre><h3 id="10-3-索引列上不计算"><a href="#10-3-索引列上不计算" class="headerlink" title="10.3 索引列上不计算"></a>10.3 索引列上不计算</h3><p>不在索引列上做任何操作<font color='green'>（计算、函数、(自动 or 手动)类型转换）</font>，会导致索引失效而转向全表扫描。</p><blockquote><p>案例一：在查询列上使用了函数</p></blockquote><pre class=" language-shell"><code class="language-shell"># 现在要查询`name` = 'Ringo'的记录下面有两种方式来查询！# 1、直接使用 字段 = 值的方式来计算mysql> SELECT * FROM `staffs` WHERE `name` = 'Ringo';+----+-------+-----+---------+---------------------+| id | name  | age | pos     | add_time            |+----+-------+-----+---------+---------------------+|  1 | Ringo |  18 | manager | 2020-08-03 08:30:39 |+----+-------+-----+---------+---------------------+1 row in set (0.00 sec)# 2、使用MySQL内置的函数mysql> SELECT * FROM `staffs` WHERE LEFT(`name`, 5) = 'Ringo';+----+-------+-----+---------+---------------------+| id | name  | age | pos     | add_time            |+----+-------+-----+---------+---------------------+|  1 | Ringo |  18 | manager | 2020-08-03 08:30:39 |+----+-------+-----+---------+---------------------+1 row in set (0.00 sec)</code></pre><p>我们发现以上两条SQL的执行结果都是一样的，但是执行效率有没有差距呢？？？</p><p>通过分析两条SQL的执行计划来分析性能。</p><p><img src="https://img-blog.csdnimg.cn/20200803171857325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JyaW5nb18=,size_16,color_FFFFFF,t_70" alt="explain"></p><p><strong>由此可见，在索引列上进行计算，会使索引失效。</strong></p><blockquote><p>案例二：在查询列上使用了转换</p></blockquote><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510171504.png" alt="查询列上使用转换"></p><p><strong>由此可见，在索引列上进行转换，会使索引失效。</strong></p><p><strong><em>Tips：</em></strong></p><ul><li><font color='red'>等号左边无计算！</font></li><li><font color='red'>等号右边无转换！</font></li><li><font color='red'>字符串必须加单引号</font>，字符串不加单引号，则会在 name 列上做一次转换！</li></ul><p><strong>口诀：</strong></p><ul><li><strong><font color='red'>索引列上不计算</font></strong></li></ul><h3 id="10-4-范围之后全失效"><a href="#10-4-范围之后全失效" class="headerlink" title="10.4 范围之后全失效"></a>10.4 范围之后全失效</h3><blockquote><p>案例</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 用到了idx_staffs_name_age_pos索引中的name，age，pos字段 这是属于全值匹配的情况！！！*/</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 用到了idx_staffs_name_age_pos索引中的name，age字段，pos字段索引失效 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'张三'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">></span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'dev'</span><span class="token punctuation">;</span></code></pre><p>查看上述SQL的执行计划</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170642.png" alt="explain"></p><p><strong>由此可知，查询范围的字段使用到了索引，但是范围之后的索引字段会失效。</strong></p><p><strong><em>Tips：</em></strong></p><ul><li><font color='red'>将可能做范围查询的字段的索引顺序放在最后</font></li></ul><p><strong>口诀：</strong></p><ul><li><strong><font color='red'>范围之后全失效</font></strong></li></ul><h3 id="10-5-覆盖索引尽量用"><a href="#10-5-覆盖索引尽量用" class="headerlink" title="10.5 覆盖索引尽量用"></a>10.5 覆盖索引尽量用</h3><p>在写SQL的<font color='blue'>不要使用<code>SELECT *</code></font>，用什么字段就查询什么字段。</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 没有用到覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">AND</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'manager'</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170747.png" alt="使用覆盖索引"></p><p><strong>口诀：</strong></p><ul><li><strong><font color='red'>查询一定不用<code>*</code></font></strong></li></ul><h3 id="10-6-不等有时会失效"><a href="#10-6-不等有时会失效" class="headerlink" title="10.6 不等有时会失效"></a>10.6 不等有时会失效</h3><p>mysql 在使用<font color='blue'>不等于(!= 或者&lt;&gt;)</font>时，有时会无法使用索引会导致全表扫描。</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 会使用到覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">!=</span> <span class="token string">'Ringo'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 索引失效 全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">!=</span> <span class="token string">'Ringo'</span><span class="token punctuation">;</span></code></pre><h3 id="10-7-like百分加右边"><a href="#10-7-like百分加右边" class="headerlink" title="10.7 like百分加右边"></a>10.7 like百分加右边</h3><p>前后模糊匹配：like</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 索引失效 全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%ing%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 索引失效 全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%ing'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用索引范围查询 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'Rin%'</span><span class="token punctuation">;</span></code></pre><p><strong><em>Tips：</em></strong></p><ul><li><font color='red'>前缀不能出现模糊匹配！</font></li></ul><p><strong>口诀：</strong></p><ul><li><strong><font color='red'><code>like</code>百分加右边</font></strong></li></ul><p>如果一定要使用<code>%like</code>，而且还要保证索引不失效，那么使用<font color='blue'>覆盖索引</font>来编写SQL。</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in%'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%na'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 索引失效 全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>pos<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">LIKE</span> <span class="token string">'%in'</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525170826.png" alt="模糊查询百分号一定加前边"></p><p><strong>口诀：</strong></p><ul><li><strong><font color='red'>覆盖索引保两边</font></strong></li></ul><h3 id="10-8-字符要加单引号"><a href="#10-8-字符要加单引号" class="headerlink" title="10.8 字符要加单引号"></a>10.8 字符要加单引号</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'Ringo'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 使用到了覆盖索引 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 索引失效 全表扫描 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>staffs<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span></code></pre><p>这里name = 2000在MySQL中会发生强制类型转换，将数字转成字符串。</p><p><strong>口诀：</strong></p><ul><li><strong><font color='red'>字符要加单引号</font></strong></li></ul><h3 id="10-9-null用-not-null不用"><a href="#10-9-null用-not-null不用" class="headerlink" title="10.9 null用 not null不用"></a>10.9 null用 not null不用</h3><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510203707.png" alt=""></p><p>当字段允许为 Null 的条件下：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510203746.png" alt=""></p><p><strong><em>Tips：</em></strong></p><ul><li><font color='green'>is not null 用不到索引，is null 可以用到索引。</font></li></ul><p><strong>口诀：</strong></p><ul><li><font color='red'>null用 not null不用</font></li></ul><h3 id="10-10-使用union替换or"><a href="#10-10-使用union替换or" class="headerlink" title="10.10 使用union替换or"></a>10.10 使用union替换or</h3><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510204016.png" alt=""></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510204111.png" alt=""></p><p><strong><em>Tips：</em></strong></p><ul><li><font color='green'>使用 union all 或者 union 来替代。</font></li></ul><p><strong>口诀：</strong></p><ul><li><font color='red'>使用union替换or</font></li></ul><h3 id="10-11-索引相关题目"><a href="#10-11-索引相关题目" class="headerlink" title="10.11 索引相关题目"></a>10.11 索引相关题目</h3><p><strong>假设index(a,b,c)</strong></p><table><thead><tr><th>Where语句</th><th>索引是否被使用</th></tr></thead><tbody><tr><td>where a = 3</td><td>Y，使用到a</td></tr><tr><td>where a = 3 and b = 5</td><td>Y，使用到a，b</td></tr><tr><td>where a = 3 and b = 5 and c = 4</td><td>Y，使用到a，b，c</td></tr><tr><td>where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</td><td>N，没有用到a字段</td></tr><tr><td>where a = 3 and c = 5</td><td>使用到a，但是没有用到c，因为b断了</td></tr><tr><td>where a = 3 and b &gt; 4 and c = 5</td><td>使用到a，b，但是没有用到c，因为c在范围之后</td></tr><tr><td>where a = 3 and b like ‘kk%’ and c = 4</td><td>Y，a，b，c都用到</td></tr><tr><td>where a = 3 and b like ‘%kk’ and c = 4</td><td>只用到a</td></tr><tr><td>where a = 3 and b like ‘%kk%’ and c = 4</td><td>只用到a</td></tr><tr><td>where a = 3 and b like ‘k%kk%’ and c = 4</td><td>Y，a，b，c都用到</td></tr></tbody></table><p><strong><em>Tips：</em></strong></p><ul><li><font color='blue'>like后面的%前面只要有一个常量，就可以使用到索引！</font></li></ul><h3 id="10-12-面试题分析"><a href="#10-12-面试题分析" class="headerlink" title="10.12 面试题分析"></a>10.12 面试题分析</h3><blockquote><p>数据准备</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 创建表 */</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> CHAR<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> CHAR<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span> CHAR<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span> CHAR<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span> CHAR<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 插入数据 */</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'a1'</span><span class="token punctuation">,</span><span class="token string">'a2'</span><span class="token punctuation">,</span><span class="token string">'a3'</span><span class="token punctuation">,</span><span class="token string">'a4'</span><span class="token punctuation">,</span><span class="token string">'a5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'b1'</span><span class="token punctuation">,</span><span class="token string">'b22'</span><span class="token punctuation">,</span><span class="token string">'b3'</span><span class="token punctuation">,</span><span class="token string">'b4'</span><span class="token punctuation">,</span><span class="token string">'b5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'c1'</span><span class="token punctuation">,</span><span class="token string">'c2'</span><span class="token punctuation">,</span><span class="token string">'c3'</span><span class="token punctuation">,</span><span class="token string">'c4'</span><span class="token punctuation">,</span><span class="token string">'c5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'d1'</span><span class="token punctuation">,</span><span class="token string">'d2'</span><span class="token punctuation">,</span><span class="token string">'d3'</span><span class="token punctuation">,</span><span class="token string">'d4'</span><span class="token punctuation">,</span><span class="token string">'d5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'e1'</span><span class="token punctuation">,</span><span class="token string">'e2'</span><span class="token punctuation">,</span><span class="token string">'e3'</span><span class="token punctuation">,</span><span class="token string">'e4'</span><span class="token punctuation">,</span><span class="token string">'e5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 创建复合索引 */</span><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_test03_c1234 <span class="token keyword">ON</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>题目</p></blockquote><p><font color='blue'>最好索引怎么创建的，就怎么用，按照顺序使用，避免让MySQL再自己去翻译一次</font></p><ol><li>全值匹配</li></ol><pre class=" language-mysql"><code class="language-mysql">/* 1.全值匹配 用到索引c1 c2 c3 c4全字段 */EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c2` = 'a2' AND `c3` = 'a3' AND `c4` = 'a4';/* 2.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c2` = 'a2' AND `c4` = 'a4' AND `c3` = 'a3';/* 3.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序*/EXPLAIN SELECT * FROM `test03` WHERE `c4` = 'a4' AND `c3` = 'a3' AND `c2` = 'a2' AND `c1` = 'a1';</code></pre><ol start="2"><li>范围后失效，与顺序无关</li></ol><pre class=" language-mysql"><code class="language-mysql">/* 4.用到索引c1 c2 c3字段，c4字段失效，范围之后全失效 */EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c2` = 'a2' AND `c3` > 'a3' AND `c4` = 'a4';/* 5.用到索引c1 c2 c3 c4全字段 MySQL的查询优化器会优化SQL语句的顺序 */EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c2` = 'a2' AND `c4` > 'a4' AND `c3` = 'a3';</code></pre><ol start="3"><li><code>ORDER BY</code> 排序</li></ol><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 6.用到了索引c1 c2 c3三个字段, c1和c2两个字段用于查找,  c3字段用于排序了但是没有统计到key_len中，c4字段失效 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a4'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 7.用到了索引c1 c2 c3三个字段，c1和c2两个字段用于查找, c3字段用于排序了但是没有统计到key_len中*/</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*    8.用到了索引c1 c2两个字段，c4失效，c1和c2两个字段用于查找，c4字段排序产生了Using filesort说明排序没有用到c4字段 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token number">c4</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 9.用到了索引c1 c2 c3三个字段，c1用于查找，c2和c3用于排序 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 10.用到了c1一个字段，c1用于查找，c3和c2两个字段索引失效，产生了Using filesort */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">`</span><span class="token number">c3</span><span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 11.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span>  <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* 12.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 */</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span>  <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">c2</span><span class="token punctuation">,</span> <span class="token number">c3</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*    13.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 没有产生Using filesort       因为之前c2这个字段已经确定了是'a2'了，这是一个常量，再去ORDER BY c3,c2 这时候c2已经不用排序了！      所以没有产生Using filesort 和(10)进行对比学习！*/</span><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>test03<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token number">c1</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a1'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c2</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a2'</span> <span class="token operator">AND</span> <span class="token punctuation">`</span><span class="token number">c5</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'a5'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token number">c3</span><span class="token punctuation">,</span> <span class="token number">c2</span><span class="token punctuation">;</span></code></pre><ol start="4"><li><p><code>GROUP BY</code>分组</p><p><code>GROUP BY</code> 表面上是叫做分组，但是<font color='blue'>分组之前必定排序</font>。索引优化几乎和<code>ORDER BY</code>一致，但是<code>GROUP BY</code>会有临时表的产生。</p></li></ol><pre class=" language-mysql"><code class="language-mysql">/* 14.用到c1 c2 c3三个字段，c1用于查找，c2 c3用于排序，c4失效 */EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c4` = 'a4' GROUP BY `c2`,`c3`;/* 15.用到c1这一个字段，c4失效，c2和c3排序失效产生了Using filesort */EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c4` = 'a4' GROUP BY `c3`,`c2`;</code></pre><p><strong><em>tip：</em></strong></p><pre class=" language-mysql"><code class="language-mysql">/* 10.用到了c1一个字段，c1用于查找，c3和c2两个字段索引失效，产生了Using filesort */EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c5` = 'a5' ORDER BY `c3`, `c2`;</code></pre><ul><li><font color='red'>ORDER BY 中字段的顺序，必须和索引中一致</font>，MySQL的查询优化器只会优化查询的SQL语句的顺序，不会优化排序的SQL语句顺序！</li></ul><pre class=" language-mysql"><code class="language-mysql">/*    13.用到了c1 c2 c3三个字段，c1 c2用于查找，c2 c3用于排序 没有产生Using filesort       因为之前c2这个字段已经确定了是'a2'了，这是一个常量，再去ORDER BY c3,c2 这时候c2已经不用排序了！      所以没有产生Using filesort 和(10)进行对比学习！*/EXPLAIN SELECT * FROM `test03` WHERE `c1` = 'a1' AND `c2` = 'a2' AND `c5` = 'a5' ORDER BY c3, c2;</code></pre><ul><li><font color='blue'>这是一种特例！</font>与10类似，但是本SQL没有产生Using filesort ，<font color='red'>因为c2这个字段已经确定了是’a2’了，这是一个常量，再去ORDER BY c3,c2 这时候c2已经不用排序了！</font></li></ul><h3 id="10-13-索引优化总结"><a href="#10-13-索引优化总结" class="headerlink" title="10.13 索引优化总结"></a>10.13 索引优化总结</h3><p>索引优化的一般性建议：</p><ul><li>对于单值索引，尽量选择针对当前<code>query</code>过滤性更好的索引。</li><li>在选择复合索引的时候，当前<code>query</code>中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li><li>在选择复合索引的时候，尽量选择可以能够包含当前<code>query</code>中的<code>where</code>子句中更多字段的索引。</li><li>尽可能通过分析统计信息和调整<code>query</code>的写法来达到选择合适索引的目的。</li></ul><p>口诀：</p><p>全值匹配我最爱，最左前缀要遵守；</p><p>带头大哥必须在，中间兄弟不能断；</p><p>索引列上不计算，范围之后全失效；</p><p>LIKE百分写最右，覆盖索引不写<code>*</code>；</p><p>不等非空还有OR，索引失效要少用；</p><p>字符要加单引号，SQL优化有诀窍。</p><h2 id="11-排序分组优化"><a href="#11-排序分组优化" class="headerlink" title="11 排序分组优化"></a>11 排序分组优化</h2><h3 id="11-1-无过滤-不索引"><a href="#11-1-无过滤-不索引" class="headerlink" title="11.1 无过滤 不索引"></a>11.1 无过滤 不索引</h3><p><font color='blue'>where 条件和 on 的判断</font>这些过滤条件，作为优先优化的部门，<font color='blue'>是要被先考虑的</font>！其次，如果有分组和排序，那么也要考虑 grouo by 和 order by。</p><blockquote><p>数据准备</p></blockquote><pre class=" language-mysql"><code class="language-mysql">create index idx_age_deptid_name on emp (age,deptid,name);</code></pre><blockquote><p>案例</p></blockquote><pre class=" language-mysql"><code class="language-mysql">/* 1.where作为过滤条件 使用索引进行排序了 不会产生Using filesort */explain select * from emp where age=40 order by deptid;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511210218.png" alt=""></p><pre class=" language-mysql"><code class="language-mysql">/* 2.未出现where过滤条件 未使用索引进行排序 产生Using filesort */explain select * from emp order by age,deptid;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511210258.png" alt=""></p><p><code>using filesort</code> 说明进行了手工排序！<font color='red'>原因在于没有 where 作为过滤条件！</font></p><pre class=" language-mysql"><code class="language-mysql">/* 3.limit作为过滤条件 使用索引进行排序了 不会产生Using filesort */explain select * from emp order by age,deptid limit 10;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511210431.png" alt=""></p><p><strong><em>tips：</em></strong></p><ul><li>无过滤，不索引。<font color='red'><code>where</code>，<code>limt</code> 都相当于一种过滤条件，所以才能使用上索引！</font></li></ul><h3 id="11-2-顺序错-必排序"><a href="#11-2-顺序错-必排序" class="headerlink" title="11.2 顺序错 必排序"></a>11.2 顺序错 必排序</h3><blockquote><p>案例</p></blockquote><pre class=" language-mysql"><code class="language-mysql">/* 1.where作为过滤条件 使用索引进行排序了 不会产生Using filesort */explain select * from emp where age=45 order by deptid,name;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511210719.png" alt=""></p><pre class=" language-mysql"><code class="language-mysql">/* 2.未使用索引进行排序 产生Using filesort */explain select * from emp where age=45 order by deptid,empno;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511211128.png" alt=""></p><p><font color='blue'>empno 字段并没有建立索引</font>，因此也无法用到索引，此字段需要排序！</p><pre class=" language-mysql"><code class="language-mysql">/* 3.未使用索引进行排序 产生Using filesort */explain select * from emp where age=45 order by name,deptid;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511211349.png" alt=""></p><p><font color='blue'><code>where</code> 两侧列的顺序可以变换</font>，效果相同，但是<font color='red'> <code>order by</code> 列的顺序不能随便变换！</font></p><pre class=" language-mysql"><code class="language-mysql">/* 4.未使用索引进行排序 产生Using filesort */explain select * from emp where deptid=45 order by age;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511211540.png" alt=""></p><p>deptid 作为过滤条件的字段，无法使用索引，<font color='red'>未满足最佳作前缀法则！</font></p><h3 id="11-3-方向反-必排序"><a href="#11-3-方向反-必排序" class="headerlink" title="11.3 方向反 必排序"></a>11.3 方向反 必排序</h3><pre class=" language-mysql"><code class="language-mysql">/* 1.使用索引进行排序了 不会产生Using filesort */explain select * from emp where age=45 order by deptid desc, name desc ;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511211826.png" alt=""></p><p>如果可以用上索引的字段<font color='red'>都使用正序或者逆序</font>，实际上是没有任何影响的，无非将结果集调换顺序。</p><pre class=" language-mysql"><code class="language-mysql">/* 2.未使用索引进行排序 产生Using filesort */explain select * from emp where age=45 order by deptid asc, name desc ;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511211926.png" alt=""></p><p>如果<font color='red'>排序的字段，顺序有差异</font>，就需要将差异的部分，进行一次倒置顺序，因此还是需要<font color='red'>手动排序</font>的！</p><h3 id="11-4-范围和排序的抉择"><a href="#11-4-范围和排序的抉择" class="headerlink" title="11.4 范围和排序的抉择"></a>11.4 范围和排序的抉择</h3><pre class=" language-mysql"><code class="language-mysql">create index idx_age_empno_name on emp(age,empno,name);</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511212402.png" alt=""></p><p>原因： <font color='red'>empno 是范围查询，因此导致了索引失效，所以 name 字段无法使用索引排序。</font><br>所以，三个字段的符合索引，没有意义，因为 <font color='red'>empno 和 name 字段只能选择其一！</font></p><pre class=" language-mysql"><code class="language-mysql">/* 鱼与熊掌不可兼得，因此，要么选择 empno,要么选择 name */drop index idx_age_empno_name on emp;create index idx_age_name on emp(age,name);create index idx_age_empno on emp(age,empno);</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210511212659.png" alt=""></p><p>原因：所有的排序都是在条件过滤之后才执行的，所以<font color='blue'>如果条件过滤了大部分数据的话，几百几千条数据进行排序其实并不是很消耗性能</font>，即使索引优化了排序但实际提升性能很有限。 相对的 empno&lt;101000 这个条件如果没有用到索引的话，要对几万条的数据进行扫描，这是非常消耗性能的，使用 empno 字段的范围查询，过滤性更好（empno 从 100000 开始）！</p><p><strong><em>tips：</em></strong></p><ul><li>当范围条件和 group by 或者 order by 的字段出现二选一时 ，<font color='red'>优先观察条件字段的过滤数量</font>，<font color='red'>如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上</font>。反之，亦然。</li></ul><h3 id="11-5-using-filesort"><a href="#11-5-using-filesort" class="headerlink" title="11.5 using filesort"></a>11.5 using filesort</h3><p><code>ORDER BY</code>子句，尽量使用索引排序，避免使用<code>Using filesort</code>排序。</p><p>MySQL支持两种方式的排序，<code>FileSort</code>和<code>Index</code>，<code>Index</code>的效率高，它指MySQL扫描索引本身完成排序。<code>FileSort</code>方式效率较低。</p><p><code>ORDER BY</code>满足两情况，会使用<code>Index</code>方式排序：</p><ul><li><font color='red'><code>ORDER BY</code>语句使用索引最左前列。</font></li><li><font color='red'>使用<code>WHERE</code>子句或是<code>limint</code>与<code>ORDER BY</code>子句条件列组合满足索引最左前列。</font></li></ul><p><strong>结论：尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀原则。</strong></p><blockquote><p>如果不在索引列上，File Sort有两种算法：MySQL就要启动双路排序算法和单路排序算法</p></blockquote><p>1、<font color='blue'>双路排序算法</font>：MySQL4.1之前使用双路排序，字面意思就是两次扫描磁盘，最终得到数据，读取行指针和<code>ORDER BY</code>列，対他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。<strong>一句话，从磁盘取排序字段，在<code>buffer</code>中进行排序，再从磁盘取其他字段。</strong></p><p>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在MySQL4.1之后，出现了改进的算法，就是单路排序算法。</p><p>2、<font color='blue'>单路排序算法</font>：从磁盘读取查询需要的所有列，按照<code>ORDER BY</code>列在<code>buffer</code>対它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。</p><p>由于单路排序算法是后出的，总体而言效率好过双路排序算法。</p><p>但是<font color='blue'>单路排序算法有问题</font>：如果<code>SortBuffer</code>缓冲区太小，导致从磁盘中读取所有的列不能完全保存在<code>SortBuffer</code>缓冲区中，这时候单路复用算法就会出现问题，反而性能不如双路复用算法。</p><p><strong>单路复用算法的优化策略：</strong></p><ul><li><font color='red'>增大<code>sort_buffer_size</code>参数的设置。</font><ul><li>不管使用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的。</li></ul></li><li><font color='red'>增大<code>max_length_for_sort_data</code>参数的设置。</font><ul><li>提高这个参数，会增加用单路排序算法的概率。但是如果设置的太高，数据总容量<code>sort_buffer_size</code>的概率就增大，明显症状是高的磁盘IO活动和低的处理器使用率。</li></ul></li><li><font color='red'>减少 select 后面的查询的字段，查什么字段就写什么字段</font>。<ul><li>当查询的字段大小总和小于<code>max_length_for_sort_data</code>而且排序字段不是<code>TEXT|BLOB</code>类型时，会使用单路排序算法，否则使用多路排序算法。</li><li>两种排序算法的数据都有可能超出<code>sort_buffer</code>缓冲区的容量，超出之后，会创建<code>tmp</code>临时文件进行合并排序，导致多次IO，但是单路排序算法的风险会更大一些，所以要增大<code>sort_buffer_size</code>参数的设置。</li></ul></li></ul><h3 id="11-6-使用覆盖索引"><a href="#11-6-使用覆盖索引" class="headerlink" title="11.6 使用覆盖索引"></a>11.6 使用覆盖索引</h3><p><font color='red'>覆盖索引</font>：<font color='blue'>SQL 只需要通过索引就可以返回查询所需要的数据，而不必通过二级索引查到主键之后再去查询数据。</font></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512202844.png" alt=""></p><h3 id="11-7-group-by"><a href="#11-7-group-by" class="headerlink" title="11.7 group by"></a>11.7 group by</h3><p>group by 使用索引的原则<font color='blue'>几乎跟 order by 一致</font> ，<font color='red'>唯一区别是 groupby 即使没有过滤条件用到索引，也可以直接使用索引。</font></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512203048.png" alt=""></p><p><strong><em>tips：</em></strong></p><ul><li><p><code>GROUP BY</code>实质是先排序后进行分组，<strong>遵照索引建的最佳左前缀</strong>。</p></li><li><p>当无法使用索引列时，会使用<code>Using filesort</code>进行排序，增大<code>max_length_for_sort_data</code>参数的设置和增大<code>sort_buffer_size</code>参数的设置，会提高性能。</p></li><li><p><font color='red'><code>WHERE</code>执行顺序高于<code>HAVING</code>，能写在<code>WHERE</code>限定条件里的就不要写在<code>HAVING</code>中了</font>。</p></li></ul><h2 id="12-查询优化"><a href="#12-查询优化" class="headerlink" title="12 查询优化"></a>12 查询优化</h2><h3 id="12-1-小表驱动大表"><a href="#12-1-小表驱动大表" class="headerlink" title="12.1 小表驱动大表"></a>12.1 小表驱动大表</h3><blockquote><p>优化原则：对于MySQL数据库而言，<font color='red'>永远都是小表驱动大表</font>。</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 举个例子：可以使用嵌套的for循环来理解小表驱动大表。* 以下两个循环结果都是一样的，但是对于MySQL来说不一样，* 第一种可以理解为，和MySQL建立5次连接每次查询1000次。* 第一种可以理解为，和MySQL建立1000次连接每次查询5次。*/</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p>IN和EXISTS</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* 优化原则：小表驱动大表，即小的数据集驱动大的数据集 */</span><span class="token comment" spellcheck="true">/* IN适合B表比A表数据小的情况*/</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>A<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>B<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/* EXISTS适合B表比A表数据大的情况 */</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>A<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>B<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span>B<span class="token punctuation">`</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">`</span>A<span class="token punctuation">`</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>EXISTS：</strong></p><ul><li>语法：<code>SELECT....FROM tab WHERE EXISTS(subquery);</code>该语法可以理解为：</li><li>该语法可以理解为：将主查询的数据，放到子查询中做条件验证，根据验证结果（<code>true</code>或是<code>false</code>）来决定主查询的数据结果是否得以保留。</li></ul><p><strong>提示：</strong></p><ul><li><code>EXISTS(subquery)</code>子查询只返回<code>true</code>或者<code>false</code>，因此子查询中的<code>SELECT *</code>可以是<code>SELECT 1</code>或是<code>SELECT X</code>，它们并没有区别。</li><li><code>EXISTS(subquery)</code>子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担心效率问题，可进行实际检验以确定是否有效率问题。</li><li><code>EXISTS(subquery)</code>子查询往往也可以用条件表达式，其他子查询或者<code>JOIN</code>替代，何种最优需要具体问题具体分析。</li></ul><h3 id="12-2-练习"><a href="#12-2-练习" class="headerlink" title="12.2 练习"></a>12.2 练习</h3><blockquote><p>案例一</p></blockquote><h2 id="13-分析慢SQL的步骤"><a href="#13-分析慢SQL的步骤" class="headerlink" title="13 分析慢SQL的步骤"></a>13 分析慢SQL的步骤</h2><p>分析：</p><p>1、观察，至少跑1天，看看生产的慢SQL情况。</p><p>2、开启慢查询日志，设置阈值，比如超过5秒钟的就是慢SQL，并将它抓取出来。</p><p>3、explain + 慢SQL分析。</p><p>4、show Profile。</p><p>5、运维经理 OR DBA，进行MySQL数据库服务器的参数调优。</p><p>总结（大纲）：</p><p>1、慢查询的开启并捕获。</p><p>2、explain + 慢SQL分析。</p><p>3、show Profile查询SQL在MySQL数据库中的执行细节和生命周期情况。</p><p>4、MySQL数据库服务器的参数调优。</p><h2 id="14-慢查询日志"><a href="#14-慢查询日志" class="headerlink" title="14 慢查询日志"></a>14 慢查询日志</h2><h3 id="14-1-基本介绍"><a href="#14-1-基本介绍" class="headerlink" title="14.1 基本介绍"></a>14.1 基本介绍</h3><blockquote><p>慢查询日志是什么？</p></blockquote><ul><li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阈值的语句，具体指运行时间超过<code>long_query_time</code>值的SQL，则会被记录到慢查询日志中。</li><li><code>long_query_time</code>的默认值为10，意思是运行10秒以上的语句。</li><li>由慢查询日志来查看哪些SQL超出了我们的最大忍耐时间值，比如一条SQL执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒钟的SQL，结合之前<code>explain</code>进行全面分析。</li></ul><blockquote><p>特别说明</p></blockquote><p><font color='red'>默认情况下，MySQL数据库没有开启慢查询日志</font>，<font color='blue'>需要我们手动来设置这个参数</font>。</p><p><font color='red'>当然，如果不是调优需要的话，一般不建议启动该参数</font>，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p><blockquote><p>查看慢查询日志是否开以及如何开启</p></blockquote><ol><li>本次MySQL中开启</li></ol><table><thead><tr><th align="center">SQL语句</th><th>描述</th><th>备注</th></tr></thead><tbody><tr><td align="center"><code>SHOW VARIABLES LIKE &#39;%slow_query_log%&#39;;</code></td><td>查看慢查询日志是否开启</td><td>默认情况下 slow_query_log 的值为 OFF，<br>表示慢查询日志是禁用的</td></tr><tr><td align="center"><code>SET GLOBAL slow_query_log = 1;</code></td><td>开启慢查询日志</td><td></td></tr><tr><td align="center"><code>SHOW VARIABLES LIKE&#39; long_query_time%&#39;;</code></td><td>查看慢查询设定阈值</td><td>单位秒</td></tr><tr><td align="center"><code>set long_query_time=1</code></td><td>设定慢查询阈值</td><td>单位秒</td></tr></tbody></table><pre class=" language-shell"><code class="language-shell"># 1、查看慢查询日志是否开启mysql> SHOW VARIABLES LIKE '%slow_query_log%';+---------------------+--------------------------------------+| Variable_name       | Value                                |+---------------------+--------------------------------------+| slow_query_log      | OFF                                  || slow_query_log_file | /var/lib/mysql/1dcb5644392c-slow.log |+---------------------+--------------------------------------+2 rows in set (0.01 sec)# 2、开启慢查询日志mysql> SET GLOBAL slow_query_log = 1;Query OK, 0 rows affected (0.00 sec)# 查看long_query_time 默认是10秒# 只有SQL的执行时间>10才会被记录mysql> SHOW VARIABLES LIKE 'long_query_time%';+-----------------+-----------+| Variable_name   | Value     |+-----------------+-----------+| long_query_time | 10.000000 |+-----------------+-----------+1 row in set (0.00 sec)</code></pre><ol start="2"><li>如果要使慢查询日志永久开启，需要修改<code>my.cnf</code>文件，在<code>[mysqld]</code>下增加修改参数。</li></ol><pre class=" language-shell"><code class="language-shell"># my.cnf[mysqld]# 1.这个是开启慢查询。slow_query_log=1# 2.这个是存储慢查询的日志文件。这个文件不存在的话，需要自己创建slow_query_log_file=/var/lib/mysql/slow.log# 3.慢查询阈值设定long_query_time=3log_output=FILE</code></pre><ol start="3"><li>查新慢查询日志的总记录条数：<code>SHOW GLOBAL STATUS LIKE &#39;%Slow_queries%&#39;;</code>。</li></ol><pre class=" language-shell"><code class="language-shell">mysql> SHOW GLOBAL STATUS LIKE '%Slow_queries%';+---------------+-------+| Variable_name | Value |+---------------+-------+| Slow_queries  | 3     |+---------------+-------+1 row in set (0.00 sec)</code></pre><h3 id="14-2-日志分析工具"><a href="#14-2-日志分析工具" class="headerlink" title="14.2 日志分析工具"></a>14.2 日志分析工具</h3><p>日志分析工具<code>mysqldumpslow</code>：在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具<code>mysqldumpslow</code>。</p><pre class=" language-shell"><code class="language-shell"># 1、mysqldumpslow --help 来查看mysqldumpslow的帮助信息root@1dcb5644392c:/usr/bin# mysqldumpslow --helpUsage: mysqldumpslow [ OPTS... ] [ LOGS... ]Parse and summarize the MySQL slow query log. Options are  --verbose    verbose  --debug      debug  --help       write this text to standard output  -v           verbose  -d           debug  -s ORDER     what to sort by (al, at, ar, c, l, r, t), 'at' is default  # 按照何种方式排序                al: average lock time # 平均锁定时间                ar: average rows sent # 平均返回记录数                at: average query time # 平均查询时间                 c: count  # 访问次数                 l: lock time  # 锁定时间                 r: rows sent  # 返回记录                 t: query time  # 查询时间   -r           reverse the sort order (largest last instead of first)  -t NUM       just show the top n queries  # 返回前面多少条记录  -a           don't abstract all numbers to N and strings to 'S'  -n NUM       abstract numbers with at least n digits within names  -g PATTERN   grep: only consider stmts that include this string    -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),               default is '*', i.e. match all  -i NAME      name of server instance (if using mysql.server startup script)  -l           don't subtract lock time from total time# 2、 案例# 2.1、得到返回记录集最多的10个SQLmysqldumpslow -s r -t 10 /var/lib/mysql/slow.log# 2.2、得到访问次数最多的10个SQLmysqldumpslow -s c -t 10 /var/lib/mysql/slow.log# 2.3、得到按照时间排序的前10条里面含有左连接的查询语句mysqldumpslow -s t -t 10 -g "left join" /var/lib/mysql/slow.log# 2.4、另外建议使用这些命令时结合|和more使用，否则出现爆屏的情况mysqldumpslow -s r -t 10 /var/lib/mysql/slow.log | more</code></pre><h3 id="14-3-Show-Profile"><a href="#14-3-Show-Profile" class="headerlink" title="14.3 Show Profile"></a>14.3 Show Profile</h3><blockquote><p>Show Profile是什么？</p></blockquote><p><code>Show Profile</code>：MySQL提供可以用来分析当前会话中语句执行的资源消耗情况。可以用于SQL的调优的测量。<strong>默认情况下，参数处于关闭状态，并保存最近15次的运行结果。</strong></p><blockquote><p>分析步骤</p></blockquote><p>1、是否支持，看看当前的MySQL版本是否支持。</p><pre class=" language-shell"><code class="language-shell"># 查看Show Profile功能是否开启mysql> SHOW VARIABLES LIKE 'profiling';+---------------+-------+| Variable_name | Value |+---------------+-------+| profiling     | OFF   |+---------------+-------+1 row in set (0.00 sec)</code></pre><p>2、<font color='red'>开启<code>Show Profile</code>功能，默认是关闭的，使用前需要开启</font>。</p><pre class=" language-shell"><code class="language-shell"># 开启Show Profile功能mysql> SET profiling=ON;Query OK, 0 rows affected, 1 warning (0.00 sec)</code></pre><p>3、运行SQL</p><pre class=" language-mysql"><code class="language-mysql">SELECT * FROM `emp` GROUP BY `id`%10 LIMIT 150000;SELECT * FROM `emp` GROUP BY `id`%20 ORDER BY 5;</code></pre><p>4、查看结果，执行<code>SHOW PROFILES;</code></p><p><code>Duration</code>：持续时间。</p><pre class=" language-shell"><code class="language-shell">mysql> SHOW PROFILES;+----------+------------+---------------------------------------------------+| Query_ID | Duration   | Query                                             |+----------+------------+---------------------------------------------------+|        1 | 0.00156100 | SHOW VARIABLES LIKE 'profiling'                   ||        2 | 0.56296725 | SELECT * FROM `emp` GROUP BY `id`%10 LIMIT 150000 ||        3 | 0.52105825 | SELECT * FROM `emp` GROUP BY `id`%10 LIMIT 150000 ||        4 | 0.51279775 | SELECT * FROM `emp` GROUP BY `id`%20 ORDER BY 5   |+----------+------------+---------------------------------------------------+4 rows in set, 1 warning (0.00 sec)</code></pre><p>5、诊断SQL，<code>SHOW PROFILE cpu,block io FOR QUERY Query_ID;</code></p><pre class=" language-shell"><code class="language-shell"># 这里的3是第四步中的Query_ID。# 可以在SHOW PROFILE中看到一条SQL中完整的生命周期。mysql> SHOW PROFILE cpu,block io FOR QUERY 3;+----------------------+----------+----------+------------+--------------+---------------+| Status               | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |+----------------------+----------+----------+------------+--------------+---------------+| starting             | 0.000097 | 0.000090 |   0.000002 |            0 |             0 || checking permissions | 0.000010 | 0.000009 |   0.000000 |            0 |             0 || Opening tables       | 0.000039 | 0.000058 |   0.000000 |            0 |             0 || init                 | 0.000046 | 0.000046 |   0.000000 |            0 |             0 || System lock          | 0.000011 | 0.000000 |   0.000000 |            0 |             0 || optimizing           | 0.000005 | 0.000000 |   0.000000 |            0 |             0 || statistics           | 0.000023 | 0.000037 |   0.000000 |            0 |             0 || preparing            | 0.000014 | 0.000000 |   0.000000 |            0 |             0 || Creating tmp table   | 0.000041 | 0.000053 |   0.000000 |            0 |             0 || Sorting result       | 0.000005 | 0.000000 |   0.000000 |            0 |             0 || executing            | 0.000003 | 0.000000 |   0.000000 |            0 |             0 || Sending data         | 0.520620 | 0.516267 |   0.000000 |            0 |             0 || Creating sort index  | 0.000060 | 0.000051 |   0.000000 |            0 |             0 || end                  | 0.000006 | 0.000000 |   0.000000 |            0 |             0 || query end            | 0.000011 | 0.000000 |   0.000000 |            0 |             0 || removing tmp table   | 0.000006 | 0.000000 |   0.000000 |            0 |             0 || query end            | 0.000004 | 0.000000 |   0.000000 |            0 |             0 || closing tables       | 0.000009 | 0.000000 |   0.000000 |            0 |             0 || freeing items        | 0.000032 | 0.000064 |   0.000000 |            0 |             0 || cleaning up          | 0.000019 | 0.000000 |   0.000000 |            0 |             0 |+----------------------+----------+----------+------------+--------------+---------------+20 rows in set, 1 warning (0.00 sec)</code></pre><p><code>Show Profile</code>查询参数备注：</p><ul><li><code>ALL</code>：显示所有的开销信息。</li><li><code>BLOCK IO</code>：显示块IO相关开销（通用）。</li><li><code>CONTEXT SWITCHES</code>：上下文切换相关开销。</li><li><code>CPU</code>：显示CPU相关开销信息（通用）。</li><li><code>IPC</code>：显示发送和接收相关开销信息。</li><li><code>MEMORY</code>：显示内存相关开销信息。</li><li><code>PAGE FAULTS</code>：显示页面错误相关开销信息。</li><li><code>SOURCE</code>：显示和Source_function。</li><li><code>SWAPS</code>：显示交换次数相关开销的信息。</li></ul><p>6、<code>Show Profile</code>查询列表，日常开发需要注意的结论：</p><ul><li><code>converting HEAP to MyISAM</code>：查询结果太大，内存都不够用了，往磁盘上搬了。</li><li><code>Creating tmp table</code>：创建临时表（拷贝数据到临时表，用完再删除），非常耗费数据库性能。</li><li><code>Copying to tmp table on disk</code>：把内存中的临时表复制到磁盘，危险！！！</li><li><code>locked</code>：死锁。</li></ul><h2 id="15-批量插入数据脚本"><a href="#15-批量插入数据脚本" class="headerlink" title="15 批量插入数据脚本"></a>15 批量插入数据脚本</h2><h3 id="15-1-环境准备"><a href="#15-1-环境准备" class="headerlink" title="15.1 环境准备"></a>15.1 环境准备</h3><blockquote><p>1 建表SQL</p></blockquote><pre class=" language-mysql"><code class="language-mysql">/* 1.dept表 */CREATE TABLE `dept` (  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',  `deptno` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '部门id',  `dname` varchar(20) NOT NULL DEFAULT '' COMMENT '部门名字',  `loc` varchar(13) NOT NULL DEFAULT '' COMMENT '部门地址',  PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='部门表'/* 2.emp表 */CREATE TABLE `emp` (  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',  `empno` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '员工编号',  `ename` varchar(20) NOT NULL DEFAULT '' COMMENT '员工名字',  `job` varchar(9) NOT NULL DEFAULT '' COMMENT '职位',  `mgr` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '上级编号',  `hiredata` date NOT NULL COMMENT '入职时间',  `sal` decimal(7,2) NOT NULL COMMENT '薪水',  `comm` decimal(7,2) NOT NULL COMMENT '分红',  `deptno` int(10) unsigned NOT NULL DEFAULT '0' COMMENT '部门id',  PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='员工表'</code></pre><blockquote><p>2 设置参数</p></blockquote><p>在执行创建函数之前，首先请保证<font color='red'> <code>log_bin_trust_function_creators</code> 参数为 1</font>，即 on 开启状态。否则会报错：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210510161631.png" alt=""></p><p>查询：<font color='red'>show variables like ‘log_bin_trust_function_creators’;</font><br>设置：<font color='red'>set global log_bin_trust_function_creators=1;</font></p><pre class=" language-shell"><code class="language-shell"># 在mysql中设置 # log_bin_trust_function_creators 默认是关闭的 需要手动开启mysql> SHOW VARIABLES LIKE 'log_bin_trust_function_creators';+---------------------------------+-------+| Variable_name                   | Value |+---------------------------------+-------+| log_bin_trust_function_creators | OFF   |+---------------------------------+-------+1 row in set (0.00 sec)mysql> SET GLOBAL log_bin_trust_function_creators=1;Query OK, 0 rows affected (0.00 sec)</code></pre><p>上述修改方式MySQL重启后会失败，在<code>my.cnf</code>配置文件下修改永久有效。</p><pre class=" language-shell"><code class="language-shell"># 在[mysqld]中加上 log_bin_trust_function_creators=1[mysqld]log_bin_trust_function_creators=1</code></pre><h3 id="15-2-编写随机函数"><a href="#15-2-编写随机函数" class="headerlink" title="15.2 编写随机函数"></a>15.2 编写随机函数</h3><p>创建函数，保证每条数据都不同。</p><p>如果要删除函数，则执行：<font color='red'>drop function 函数名;</font></p><pre class=" language-mysql"><code class="language-mysql"># 1、函数：随机产生字符串DELIMITER $$CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)BEGIN    DECLARE chars_str VARCHAR(100) DEFAULT 'abcdefghijklmnopqrstuvwsyzABCDEFGHIJKLMNOPQRSTUVWXYZ';    DECLARE return_str VARCHAR(255) DEFAULT '';    DECLARE i INT DEFAULT 0;    WHILE i < n DO    SET return_str = CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));    SET i = i + 1;    END WHILE;    RETURN return_str;END $$# 2、函数：随机产生部门编号DELIMITER $$CREATE FUNCTION rand_num() RETURNS INT(5)BEGIN    DECLARE i INT DEFAULT 0;    SET i = FLOOR(100 + RAND() * 10);    RETURN i;END $$</code></pre><h3 id="15-3-创建存储过程"><a href="#15-3-创建存储过程" class="headerlink" title="15.3 创建存储过程"></a>15.3 创建存储过程</h3><p>删除存储过程：</p><p><font color='red'>DELIMITER ;</font></p><p><font color='red'>drop PROCEDURE 存储过程名;</font></p><pre class=" language-mysql"><code class="language-mysql"># 1、存储过程：向dept表批量插入DELIMITER $$CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))BEGINDECLARE i INT DEFAULT 0;    SET autocommit = 0;    REPEAT    SET i = i + 1;    INSERT INTO dept(deptno,dname,loc) VALUES((START + i),rand_string(10),rand_string(8));    UNTIL i = max_num    END REPEAT;    COMMIT;END $$# 2、存储过程：向emp表批量插入DELIMITER $$CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))BEGINDECLARE i INT DEFAULT 0;    SET autocommit = 0;    REPEAT    SET i = i + 1;    INSERT INTO emp(empno,ename,job,mgr,hiredata,sal,comm,deptno) VALUES((START + i),rand_string(6),'SALESMAN',0001,CURDATE(),2000,400,rand_num());    UNTIL i = max_num    END REPEAT;    COMMIT;END $$</code></pre><h3 id="15-4-调用存储过程"><a href="#15-4-调用存储过程" class="headerlink" title="15.4 调用存储过程"></a>15.4 调用存储过程</h3><pre class=" language-mysql"><code class="language-mysql"># 1、调用存储过程向dept表插入10个部门。DELIMITER ;CALL insert_dept(100,10);# 2、调用存储过程向emp表插入50万条数据。DELIMITER ;CALL insert_emp(100001,500000);</code></pre><h3 id="15-5-批量删除某个表上的所有索引"><a href="#15-5-批量删除某个表上的所有索引" class="headerlink" title="15.5 批量删除某个表上的所有索引"></a>15.5 批量删除某个表上的所有索引</h3><pre class=" language-mysql"><code class="language-mysql"># 1、存储过程：删除索引(dbname-数据库名；tablename-表名)DELIMITER $$CREATE PROCEDURE `proc_drop_index`(dbname VARCHAR(200),tablename VARCHAR(200))BEGIN    DECLARE done INT DEFAULT 0;    DECLARE ct INT DEFAULT 0;    DECLARE _index VARCHAR(200) DEFAULT '';    DECLARE _cur CURSOR FOR SELECT index_name FROM information_schema.STATISTICS WHERE table_schema=dbname AND table_name=tablename AND seq_in_index=1 AND index_name <>'PRIMARY' ;    DECLARE CONTINUE HANDLER FOR NOT FOUND set done=2 ;    OPEN _cur;    FETCH _cur INTO _index;    WHILE _index<>'' DO        SET @str = CONCAT("drop index ",_index," on ",tablename );        PREPARE sql_str FROM @str ;        EXECUTE sql_str;        DEALLOCATE PREPARE sql_str;        SET _index='';        FETCH _cur INTO _index;    END WHILE;CLOSE _cur;END$$# 2、执行存储过程CALL proc_drop_index("dbname","tablename");</code></pre><h2 id="16-表锁-偏读"><a href="#16-表锁-偏读" class="headerlink" title="16 表锁(偏读)"></a>16 表锁(偏读)</h2><p>锁的分类</p><ul><li>对数据操作的类型分（读/写）<ul><li><font color='blue'>读锁（共享锁）</font>：针对同一份数据，<font color='red'>多个读操作可以同时</font>进行而不会相互影响</li><li><font color='blue'>写锁（排他锁）</font>：当前写操作没有完成之前，它会<font color='red'>阻隔其他写锁和读锁</font></li></ul></li><li>对数据操作的粒度来分<ul><li>表锁</li><li>行锁</li></ul></li></ul><p><strong>表锁特点：</strong></p><ul><li>表锁偏向<code>MyISAM</code>存储引擎，开销小，加锁快，无死锁，锁定粒度大，发生锁冲突的概率最高，并发度最低。</li></ul><h3 id="16-1-环境准备"><a href="#16-1-环境准备" class="headerlink" title="16.1 环境准备"></a>16.1 环境准备</h3><pre class=" language-mysql"><code class="language-mysql"># 1、创建表CREATE TABLE `mylock`(`id` INT NOT NULL PRIMARY KEY AUTO_INCREMENT,`name` VARCHAR(20))ENGINE=MYISAM DEFAULT CHARSET=utf8 COMMENT='测试表锁';# 2、插入数据INSERT INTO `mylock`(`name`) VALUES('ZhangSan');INSERT INTO `mylock`(`name`) VALUES('LiSi');INSERT INTO `mylock`(`name`) VALUES('WangWu');INSERT INTO `mylock`(`name`) VALUES('ZhaoLiu');</code></pre><h3 id="16-2-锁表的命令"><a href="#16-2-锁表的命令" class="headerlink" title="16.2 锁表的命令"></a>16.2 锁表的命令</h3><blockquote><p>1、查看数据库表锁的命令。</p></blockquote><pre class=" language-mysql"><code class="language-mysql"># 查看数据库表锁的命令SHOW OPEN TABLES;</code></pre><blockquote><p>2、给<code>mylock</code>表上读锁，给<code>book</code>表上写锁。</p></blockquote><pre class=" language-mysql"><code class="language-mysql"># 给mylock表上读锁，给book表上写锁LOCK TABLE `mylock` READ, `book` WRITE;# 查看当前表的状态mysql> SHOW OPEN TABLES;+--------------------+------------------------------------------------------+--------+-------------+| Database           | Table                                                | In_use | Name_locked |+--------------------+------------------------------------------------------+--------+-------------+| sql_analysis       | book                                                 |      1 |           0 || sql_analysis       | mylock                                               |      1 |           0 |+--------------------+------------------------------------------------------+--------+-------------+</code></pre><blockquote><p>3、释放表锁。</p></blockquote><pre class=" language-mysql"><code class="language-mysql"># 释放给表添加的锁UNLOCK TABLES;# 查看当前表的状态mysql> SHOW OPEN TABLES;+--------------------+------------------------------------------------------+--------+-------------+| Database           | Table                                                | In_use | Name_locked |+--------------------+------------------------------------------------------+--------+-------------+| sql_analysis       | book                                                 |      0 |           0 || sql_analysis       | mylock                                               |      0 |           0 |+--------------------+------------------------------------------------------+--------+-------------+</code></pre><h3 id="16-3-读锁案例"><a href="#16-3-读锁案例" class="headerlink" title="16.3 读锁案例"></a>16.3 读锁案例</h3><blockquote><p>1、打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加读锁。</p></blockquote><pre class=" language-mysql"><code class="language-mysql"># 为mylock表添加读锁LOCK TABLE `mylock` READ;</code></pre><blockquote><p>2、打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p></blockquote><pre class=" language-shell"><code class="language-shell"># SESSION1# 问题1：SESSION1为mylock表加了读锁，可以读mylock表！mysql> SELECT * FROM `mylock`;+----+----------+| id | name     |+----+----------+|  1 | ZhangSan ||  2 | LiSi     ||  3 | WangWu   ||  4 | ZhaoLiu  |+----+----------+4 rows in set (0.00 sec)# 问题2：SESSION1为mylock表加了读锁，不可以修改mylock表！mysql> UPDATE `mylock` SET `name` = 'abc' WHERE `id` = 1;ERROR 1099 (HY000): Table 'mylock' was locked with a READ lock and can't be updated# 问题3：SESSION1为mylock表加了读锁，不可以读其他的表！mysql> SELECT * FROM `book`;ERROR 1100 (HY000): Table 'book' was not locked with LOCK TABLES# SESSION2# 问题1：SESSION1为mylock表加了读锁，SESSION2可以读mylock表！mysql> SELECT * FROM `mylock`;+----+----------+| id | name     |+----+----------+|  1 | ZhangSan ||  2 | LiSi     ||  3 | WangWu   ||  4 | ZhaoLiu  |+----+----------+4 rows in set (0.00 sec)# 问题2：SESSION1为mylock表加了读锁，SESSION2修改mylock表会被阻塞，需要等待SESSION1释放mylock表！mysql> UPDATE `mylock` SET `name` = 'abc' WHERE `id` = 1;^C^C -- query abortedERROR 1317 (70100): Query execution was interrupted# 问题3：SESSION1为mylock表加了读锁，SESSION2可以读其他表！mysql> SELECT * FROM `book`;+--------+------+| bookid | card |+--------+------+|      1 |    1 ||      7 |    4 ||      8 |    4 ||      9 |    5 ||      5 |    6 ||     17 |    6 ||     15 |    8 |+--------+------+24 rows in set (0.00 sec)</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210514213404.png" alt="读锁"></p><h3 id="16-4-写锁案例"><a href="#16-4-写锁案例" class="headerlink" title="16.4 写锁案例"></a>16.4 写锁案例</h3><blockquote><p>1、打开两个会话，<code>SESSION1</code>为<code>mylock</code>表添加写锁。</p></blockquote><pre class=" language-mysql"><code class="language-mysql"># 为mylock表添加写锁LOCK TABLE `mylock` WRITE;</code></pre><blockquote><p>2、打开两个会话，<code>SESSION1</code>是否可以读自己锁的表？是否可以修改自己锁的表？是否可以读其他的表？那么<code>SESSION2</code>呢？</p></blockquote><pre class=" language-shell"><code class="language-shell"># SESSION1# 问题1：SESSION1为mylock表加了写锁，可以读mylock的表！mysql> SELECT * FROM `mylock`;+----+----------+| id | name     |+----+----------+|  1 | ZhangSan ||  2 | LiSi     ||  3 | WangWu   ||  4 | ZhaoLiu  |+----+----------+4 rows in set (0.00 sec)# 问题2：SESSION1为mylock表加了写锁，可以修改mylock表!mysql> UPDATE `mylock` SET `name` = 'abc' WHERE `id` = 1;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0# 问题3：SESSION1为mylock表加了写锁，不能读其他表!mysql> SELECT * FROM `book`;ERROR 1100 (HY000): Table 'book' was not locked with LOCK TABLES# SESSION2# 问题1：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！mysql> SELECT * FROM `mylock`;^C^C -- query abortedERROR 1317 (70100): Query execution was interrupted# 问题2：SESSION1为mylock表加了写锁，SESSION2读mylock表会阻塞，等待SESSION1释放！mysql> UPDATE `mylock` SET `name` = 'abc' WHERE `id` = 1;^C^C -- query abortedERROR 1317 (70100): Query execution was interrupted# 问题3：SESSION1为mylock表加了写锁，SESSION2可以读其他表！mysql> SELECT * FROM `book`;+--------+------+| bookid | card |+--------+------+|      1 |    1 ||      7 |    4 ||      8 |    4 ||      9 |    5 ||      5 |    6 ||     17 |    6 ||     15 |    8 |+--------+------+24 rows in set (0.00 sec)</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210514214018.png" alt="写锁"></p><h3 id="16-5-案例结论"><a href="#16-5-案例结论" class="headerlink" title="16.5 案例结论"></a>16.5 案例结论</h3><p><strong><code>MyISAM</code>引擎在执行查询语句<code>SELECT</code>之前，会自动给涉及到的所有表加读锁，在执行增删改之前，会自动给涉及的表加写锁。</strong></p><p>MySQL的表级锁有两种模式：</p><ul><li><font color='blue'>表共享读锁</font>（Table Read Lock）。</li><li><font color='blue'>表独占写锁</font>（Table Write Lock）。</li></ul><table><thead><tr><th align="center">锁类型</th><th align="center">可否兼容</th><th align="center">读</th><th align="center">写</th></tr></thead><tbody><tr><td align="center">读锁</td><td align="center">是</td><td align="center">是</td><td align="center">否</td></tr><tr><td align="center">写锁</td><td align="center">是</td><td align="center">否</td><td align="center">否</td></tr></tbody></table><p>対<code>MyISAM</code>表进行操作，会有以下情况：</p><ul><li>対<code>MyISAM</code>表的<font color='red'>读操作（加读锁），不会阻塞其他线程対同一表的读操作，但是会阻塞其他线程対同一表的写操作</font>。只有当读锁释放之后，才会执行其他线程的写操作。</li><li>対<code>MyISAM</code>表的<font color='red'>写操作（加写锁），会阻塞其他线程対同一表的读和写操作</font>，只有当写锁释放之后，才会执行其他线程的读写操作。</li><li><font color='red'><strong>简而言之，读锁会阻塞写，但不会阻塞读；写锁会把读和写都阻塞。</strong></font></li></ul><h3 id="16-6-表锁分析"><a href="#16-6-表锁分析" class="headerlink" title="16.6 表锁分析"></a>16.6 表锁分析</h3><pre class=" language-shell"><code class="language-shell">mysql> SHOW STATUS LIKE 'table%';+----------------------------+-------+| Variable_name              | Value |+----------------------------+-------+| Table_locks_immediate      | 173   || Table_locks_waited         | 0     || Table_open_cache_hits      | 5     || Table_open_cache_misses    | 8     || Table_open_cache_overflows | 0     |+----------------------------+-------+5 rows in set (0.00 sec)</code></pre><p>可以通过<code>Table_locks_immediate</code>和<code>Table_locks_waited</code>状态变量来分析系统上的表锁定。具体说明如下：</p><p><code>Table_locks_immediate</code>：<font color='red'>产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1。</font></p><p><code>Table_locks_waited</code>：<font color='blue'>出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在较严重的表级锁争用情况。</font></p><p><strong>此外，<font color='red'><code>MyISAM</code>的读写锁调度是写优先</font>，这也是<code>MyISAM</code>不适合作为主表的引擎。因为写锁后，其他线程不能进行任何操作，大量的写操作会使查询很难得到锁，从而造成永远阻塞。</strong></p><h2 id="17-行锁-偏写"><a href="#17-行锁-偏写" class="headerlink" title="17 行锁(偏写)"></a>17 行锁(偏写)</h2><p><strong>行锁特点：</strong></p><ul><li>偏向<code>InnoDB</code>存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度最高。</li></ul><p><strong><code>InnoDB</code>存储引擎和<code>MyISAM</code>存储引擎最大不同有两点：一是支持事务，二是采用行锁。</strong></p><h3 id="17-1-事务"><a href="#17-1-事务" class="headerlink" title="17.1 事务"></a>17.1 事务</h3><blockquote><p>事务的ACID属性</p></blockquote><ul><li>原子性：<code>Atomicity</code>。要么一起成功，要么一起失败。</li><li>一致性：<code>Consistency</code>。数据保持一致。</li><li>隔离性：<code>Isolation</code>。不受外界影响。</li><li>持久性：<code>Durability</code>。修改后永久有效。</li></ul><blockquote><p>并发事务处理带来的问题</p></blockquote><ul><li>更新丢失：另一个事务的更新覆盖了有其他事务所做的更新。</li><li>脏读：事务A读取到了事务B<font color='red'>未提交的修改</font>数据，还在这个数据上做了操作。此时，如果事务B回滚，事务A读取的数据无效，<font color='blue'>不符合一致性要求</font>。</li><li>不可重复读：事务A读取到了事务B<font color='red'>已提交的修改数据</font>，前后两次数据不一样。<font color='blue'>不符合隔离性</font>。</li><li>幻读：事务A读取到了事务B<font color='red'>提交的新增删除数据</font>，后面读到的数据比前一次多了或少了内容，<font color='blue'>不符合隔离性</font>。<ul><li>脏读是事务B里<font color='red'>修改</font>了数据。</li><li>幻读是事务B里<font color='red'>新增</font>了数据。</li></ul></li></ul><blockquote><p>事务的隔离级别</p></blockquote><table><thead><tr><th align="center">隔离级别</th><th align="center">读数据一致性</th><th align="center">脏读</th><th align="center">不可重复读</th><th align="center">幻读</th></tr></thead><tbody><tr><td align="center">未提交读</td><td align="center">最低级别，只能保证不读物理上损坏的数据</td><td align="center">是</td><td align="center">是</td><td align="center">是</td></tr><tr><td align="center">已提交读</td><td align="center">语句级</td><td align="center">否</td><td align="center">是</td><td align="center">是</td></tr><tr><td align="center">可重复读</td><td align="center">事务级</td><td align="center">否</td><td align="center">否</td><td align="center">是</td></tr><tr><td align="center">可序列化</td><td align="center">最高级别，事务级</td><td align="center">否</td><td align="center">否</td><td align="center">否</td></tr></tbody></table><h3 id="17-2-行锁案例"><a href="#17-2-行锁案例" class="headerlink" title="17.2 行锁案例"></a>17.2 行锁案例</h3><blockquote><p>0、环境准备</p></blockquote><pre class=" language-mysql"><code class="language-mysql"># 建表语句CREATE TABLE `test_innodb_lock`(`a` INT,`b` VARCHAR(16))ENGINE=INNODB DEFAULT CHARSET=utf8 COMMENT='测试行锁'; # 插入数据INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(1, 'b2');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(2, '3');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(3, '4000');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(4, '5000');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(5, '6000');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(6, '7000');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(7, '8000');INSERT INTO `test_innodb_lock`(`a`, `b`) VALUES(8, '9000');# 创建索引CREATE INDEX idx_test_a ON `test_innodb_lock`(a);CREATE INDEX idx_test_b ON `test_innodb_lock`(b);</code></pre><blockquote><p>1、开启手动提交</p></blockquote><p>打开<code>SESSION1</code>和<code>SESSION2</code>两个会话，都开启手动提交。</p><pre class=" language-shell"><code class="language-shell"># 开启MySQL数据库的手动提交mysql> SET autocommit=0;Query OK, 0 rows affected (0.00 sec)</code></pre><blockquote><p>2、读己知所写</p></blockquote><pre class=" language-shell"><code class="language-shell"># SESSION1 # SESSION1対test_innodb_lock表做写操作，但是没有commit。# 执行修改SQL之后，查询一下test_innodb_lock表，发现数据被修改了。mysql> UPDATE `test_innodb_lock` SET `b` = '88' WHERE `a` = 1;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0mysql> SELECT * FROM `test_innodb_lock`;+------+------+| a    | b    |+------+------+|    1 | 88   ||    2 | 3    ||    3 | 4000 ||    4 | 5000 ||    5 | 6000 ||    6 | 7000 ||    7 | 8000 ||    8 | 9000 |+------+------+8 rows in set (0.00 sec)# SESSION2 # SESSION2这时候来查询test_innodb_lock表。# 发现SESSION2是读不到SESSION1未提交的数据的。（没有出现脏读）mysql> SELECT * FROM `test_innodb_lock`;+------+------+| a    | b    |+------+------+|    1 | b2   ||    2 | 3    ||    3 | 4000 ||    4 | 5000 ||    5 | 6000 ||    6 | 7000 ||    7 | 8000 ||    8 | 9000 |+------+------+8 rows in set (0.00 se</code></pre><blockquote><p>3、行锁两个SESSION同时対一条记录进行写操作</p></blockquote><p>等SESSION1执行commit语句之后，SESSION2的SQL才会执行</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210516223348.png" alt=""></p><pre class=" language-shell"><code class="language-shell"># SESSION1 対test_innodb_lock表的`a`=1这一行进行写操作，但是没有commitmysql> UPDATE `test_innodb_lock` SET `b` = '99' WHERE `a` = 1;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0# SESSION2 也对test_innodb_lock表的`a`=1这一行进行写操作，但是发现阻塞了！！！mysql> UPDATE `test_innodb_lock` SET `b` = 'asdasd' WHERE `a` = 1;ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</code></pre><blockquote><p>4、行锁两个SESSION同时对不同记录进行写操作</p></blockquote><p>SESSION1和SESSION2同时对不同的行进行写操作互不影响</p><pre class=" language-shell"><code class="language-shell"># SESSION1 対test_innodb_lock表的`a`=6这一行进行写操作，但是没有commitmysql> UPDATE `test_innodb_lock` SET `b` = '8976' WHERE `a` = 6;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0# SESSION2 対test_innodb_lock表的`a`=4这一行进行写操作，没有阻塞！！！mysql> UPDATE `test_innodb_lock` SET `b` = 'Ringo' WHERE `a` = 4;Query OK, 1 row affected (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 0</code></pre><h3 id="17-3-索引失效行锁变表锁"><a href="#17-3-索引失效行锁变表锁" class="headerlink" title="17.3 索引失效行锁变表锁"></a>17.3 索引失效行锁变表锁</h3><pre class=" language-shell"><code class="language-shell"># SESSION1 执行SQL语句，没有执行commit。# 由于`b`字段是字符串，但是没有加单引号导致索引失效mysql> UPDATE `test_innodb_lock` SET `a` = 888 WHERE `b` = 8000;Query OK, 1 row affected, 1 warning (0.00 sec)Rows matched: 1  Changed: 1  Warnings: 1# SESSION2 和SESSION1操作的并不是同一行，但是也被阻塞了？？？# 由于SESSION1执行的SQL索引失效，导致行锁升级为表锁，SESSION2不能修改了。mysql> UPDATE `test_innodb_lock` SET `b` = '1314' WHERE `a` = 1;ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</code></pre><h3 id="17-4-间隙锁的危害"><a href="#17-4-间隙锁的危害" class="headerlink" title="17.4 间隙锁的危害"></a>17.4 间隙锁的危害</h3><blockquote><p>什么是间隙锁？</p></blockquote><p>当我们用范围条件而不是相等条件检索数据，并请求共享或者排他锁时，<code>InnoDB</code>会给符合条件的已有数据记录的索引项加锁，对于键值<font color='red'>在条件范围内但并不存在的记录，叫做”间隙(GAP)”</font>。</p><p><code>InnoDB</code>也会对这个”间隙”加锁，这种锁的机制就是所谓的”间隙锁”。</p><blockquote><p>间隙锁的危害</p></blockquote><p>因为<code>Query</code>执行过程中通过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值不存在。</p><p>间隙锁有一个比较致命的缺点，就是<strong>当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。</strong>在某些场景下这可能会対性能造成很大的危害。</p><h3 id="17-5-面试题：如何锁定一行"><a href="#17-5-面试题：如何锁定一行" class="headerlink" title="17.5 面试题：如何锁定一行"></a>17.5 面试题：如何锁定一行</h3><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210525171052.png" alt="锁定一行"></p><p><font color='red'><code>SELECT .....FOR UPDATE</code></font>在锁定某一行后，其他写操作会被阻塞，直到锁定的行被<code>COMMIT</code>。</p><h3 id="17-6-案例结论"><a href="#17-6-案例结论" class="headerlink" title="17.6 案例结论"></a>17.6 案例结论</h3><p><code>InnoDB</code>存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于<code>MyISAM</code>的表级锁定的。<font color='blue'>当系统并发量较高的时候，<code>InnoDB</code>的整体性能和<code>MyISAM</code>相比就会有比较明显的优势了</font>。</p><p>但是，<code>InnoDB</code>的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让<code>InnoDB</code>的整体性能表现不仅不能比<code>MyISAM</code>高，甚至可能会更差。</p><h3 id="17-7-行锁分析"><a href="#17-7-行锁分析" class="headerlink" title="17.7 行锁分析"></a>17.7 行锁分析</h3><pre class=" language-shell"><code class="language-shell">mysql> SHOW STATUS LIKE 'innodb_row_lock%';+-------------------------------+--------+| Variable_name                 | Value  |+-------------------------------+--------+| Innodb_row_lock_current_waits | 0      || Innodb_row_lock_time          | 124150 || Innodb_row_lock_time_avg      | 31037  || Innodb_row_lock_time_max      | 51004  || Innodb_row_lock_waits         | 4      |+-------------------------------+--------+5 rows in set (0.00 sec)</code></pre><p>対各个状态量的说明如下：</p><ul><li><code>Innodb_row_lock_current_waits</code>：当前正在等待锁定的数量。</li><li><code>Innodb_row_lock_time</code>：从系统启动到现在锁定总时间长度（重要）。</li><li><code>Innodb_row_lock_time_avg</code>：每次等待所花的平均时间（重要）。</li><li><code>Innodb_row_lock_time_max</code>：从系统启动到现在等待最长的一次所花的时间。</li><li><code>Innodb_row_lock_waits</code>：系统启动后到现在总共等待的次数（重要）。</li></ul><p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化策略。</p><h2 id="18-主从复制"><a href="#18-主从复制" class="headerlink" title="18 主从复制"></a>18 主从复制</h2><h3 id="18-1-复制基本原理"><a href="#18-1-复制基本原理" class="headerlink" title="18.1 复制基本原理"></a>18.1 复制基本原理</h3><p><font color='red'>slave 会从 master 读取 binlog 来进行数据同步。</font></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512210231.png" alt="主从复制"></p><p>MySQL复制过程分为三步：</p><ul><li>Master将改变记录到<font color='blue'>二进制日志(Binary Log)</font>。这些记录过程叫做二进制日志事件，<code>Binary Log Events</code>；</li><li>Slave将Master的<code>Binary Log Events</code>拷贝到它的<font color='blue'>中继日志(Replay  Log)</font>;</li><li>Slave重做中继日志中的事件，将改变应用到自己的数据库中。<font color='blue'>MySQL复制是异步且串行化的</font>。</li></ul><h3 id="18-2-复制基本原则"><a href="#18-2-复制基本原则" class="headerlink" title="18.2 复制基本原则"></a>18.2 复制基本原则</h3><ul><li>每个Slave只有一个Master。</li><li>每个Slave只能有一个唯一的服务器ID。</li><li>每个Master可以有多个Salve。</li></ul><blockquote><p>存在的问题</p></blockquote><ul><li>因为发生多次 IO，存在延时问题</li></ul><h3 id="18-3-一主一从常见配置"><a href="#18-3-一主一从常见配置" class="headerlink" title="18.3 一主一从常见配置"></a>18.3 一主一从常见配置</h3><blockquote><p>1、<font color='red'>Master和Slave的MySQL服务器版本一致</font>且后台以服务运行。</p></blockquote><pre class=" language-shell"><code class="language-shell"># 创建mysql-slave1实例docker run -p 3307:3306 --name mysql-slave1 \-v /root/mysql-slave1/log:/var/log/mysql \-v /root/mysql-slave1/data:/var/lib/mysql \-v /root/mysql-slave1/conf:/etc/mysql \-e MYSQL_ROOT_PASSWORD=333 \-d mysql:5.7</code></pre><blockquote><p>2、主从配置都是配在[mysqld]节点下，都是小写</p></blockquote><pre class=" language-shell"><code class="language-shell"># Master修改 my.ini 配置文件[mysqld]# 主服务器唯一 ID（必须）server-id=1# 启用二进制日志（必须）log-bin=自己本地的路径/data/mysqlbin# 设置不要复制的数据库binlog-ignore-db=mysql# 设置需要复制的数据库binlog-do-db=需要复制的主数据库名字# 设置 logbin 格式，默认是STATEMENTbinlog_format=STATEMENTread-only=0</code></pre><pre class=" language-shell"><code class="language-shell"># Slave修改 my.cnf 的[mysqld]栏位下[mysqld]# 从机服务 id（必须）server-id=2# 注意 my.cnf 中有 server-id = 1# 设置中继日志relay-log=mysql-relay</code></pre><blockquote><p>3、因修改过配置文件，请主机+从机都重启后台 mysql 服务</p></blockquote><blockquote><p>4、主机从机都关闭防火墙、安全工具（腾讯管家等）</p></blockquote><blockquote><p>5、在 Windows 主机上建立帐户并授权 slave</p></blockquote><pre class=" language-shell"><code class="language-shell">#创建用户，并授权# 1、GRANT REPLICATION SLAVE ON *.* TO '备份账号名称'@'从机IP地址' IDENTIFIED BY 'password';mysql> GRANT REPLICATION SLAVE ON *.* TO 'zhangsan'@'172.18.0.3' IDENTIFIED BY '123456';Query OK, 0 rows affected, 1 warning (0.01 sec)</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512211450.png" alt=""></p><blockquote><p>6、查询 master 的状态，并记录下 File 和 Position 的值(后面要用)</p></blockquote><pre class=" language-shell"><code class="language-shell">#查询 master 的状态# 每次配从机的时候都要SHOW MASTER STATUS;查看最新的File和Positionshow master status;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512211720.png" alt=""></p><p>执行完此步骤后不要再操作主服务器 MYSQL，防止主服务器状态值变化。</p><blockquote><p>7、在 Linux 从机上配置需要复制的主机</p></blockquote><pre class=" language-shell"><code class="language-shell">#查询 master 的状态CHANGE MASTER TO MASTER_HOST='主机 IP',                MASTER_USER='创建用户名',                MASTER_PASSWORD='创建的密码',                MASTER_LOG_FILE='mysql-bin.File的编号',                MASTER_LOG_POS=Position的最新值;</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512211947.png" alt=""></p><blockquote><p>8、启动从服务器复制功能</p></blockquote><pre class=" language-shell"><code class="language-shell"># 开启Slave从机的复制START SLAVE;# 查看Slave状态# Slave_IO_Running 和 Slave_SQL_Running 必须同时为Yes 说明主从复制配置成功！SHOW SLAVE STATUS\G</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210512212247.png" alt=""></p><blockquote><p>9、主机新建库、新建表、insert 记录，从机复制</p></blockquote><pre class=" language-shell"><code class="language-shell"># Master创建数据库mysql> create database test_replication;Query OK, 1 row affected (0.01 sec)# Slave查询数据库mysql> show databases;+--------------------+| Database           |+--------------------+| information_schema || mysql              || performance_schema || sys                || test_replication   |+--------------------+5 rows in set (0.00 sec)</code></pre><blockquote><p>10、停止从服务复制功能</p></blockquote><pre class=" language-shell"><code class="language-shell"># 1、停止Slavemysql> STOP SLAVE;Query OK, 0 rows affected (0.00 sec)# 2、重新配置主从# MASTER_LOG_FILE 和 MASTER_LOG_POS一定要根据最新的数据来配mysql> CHANGE MASTER TO MASTER_HOST='172.18.0.4',    -> MASTER_USER='zhangsan',    -> MASTER_PASSWORD='123456',    -> MASTER_LOG_FILE='mysql-bin.000001',    -> MASTER_LOG_POS=797;Query OK, 0 rows affected, 2 warnings (0.01 sec)mysql> START SLAVE;Query OK, 0 rows affected (0.00 sec)mysql> SHOW SLAVE STATUS\G*************************** 1. row ***************************               Slave_IO_State: Waiting for master to send event                  Master_Host: 172.18.0.4                  Master_User: zhangsan                  Master_Port: 3306                Connect_Retry: 60              Master_Log_File: mysql-bin.000001          Read_Master_Log_Pos: 797               Relay_Log_File: b030ad25d5fe-relay-bin.000002                Relay_Log_Pos: 320        Relay_Master_Log_File: mysql-bin.000001             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:           Replicate_Ignore_DB:            Replicate_Do_Table:        Replicate_Ignore_Table:       Replicate_Wild_Do_Table:   Replicate_Wild_Ignore_Table:                    Last_Errno: 0                   Last_Error:                  Skip_Counter: 0          Exec_Master_Log_Pos: 797              Relay_Log_Space: 534              Until_Condition: None               Until_Log_File:                 Until_Log_Pos: 0           Master_SSL_Allowed: No           Master_SSL_CA_File:            Master_SSL_CA_Path:               Master_SSL_Cert:             Master_SSL_Cipher:                Master_SSL_Key:         Seconds_Behind_Master: 0Master_SSL_Verify_Server_Cert: No                Last_IO_Errno: 0                Last_IO_Error:                Last_SQL_Errno: 0               Last_SQL_Error:   Replicate_Ignore_Server_Ids:              Master_Server_Id: 1                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002             Master_Info_File: /var/lib/mysql/master.info                    SQL_Delay: 0          SQL_Remaining_Delay: NULL      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates           Master_Retry_Count: 86400                  Master_Bind:       Last_IO_Error_Timestamp:      Last_SQL_Error_Timestamp:                Master_SSL_Crl:            Master_SSL_Crlpath:            Retrieved_Gtid_Set:             Executed_Gtid_Set:                 Auto_Position: 0         Replicate_Rewrite_DB:                  Channel_Name:            Master_TLS_Version: 1 row in set (0.00 sec)</code></pre>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
          <category> MySQL优化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面试 </tag>
            
            <tag> MySQL </tag>
            
            <tag> SQL优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-二叉树】遍历的应用</title>
      <link href="/2021/04/14/shu-ju-jie-gou-er-cha-shu-bian-li-de-ying-yong/"/>
      <url>/2021/04/14/shu-ju-jie-gou-er-cha-shu-bian-li-de-ying-yong/</url>
      
        <content type="html"><![CDATA[<h2 id="一、考点"><a href="#一、考点" class="headerlink" title="一、考点"></a>一、考点</h2><ul><li>考察应聘者对二叉树中序遍历的理解程度。</li><li>考察应聘者分析复杂问题的能力。把构建二叉树的问题大问题分解成构建左、右子树的两个小问题，然后递归解决。</li><li>考察应聘者分析复杂问题的能力。应聘者只有画出二叉树的结构图、通过具体的例子找出中序遍历下一个节点的规律，才有可能设计出可行的算法。(感觉上找规律很重要)</li></ul><h2 id="二、前、中、后序遍历及层次遍历"><a href="#二、前、中、后序遍历及层次遍历" class="headerlink" title="二、前、中、后序遍历及层次遍历"></a>二、前、中、后序遍历及层次遍历</h2><h3 id="2-1-前序遍历"><a href="#2-1-前序遍历" class="headerlink" title="2.1 前序遍历"></a>2.1 前序遍历</h3><p>根——左——右</p><ul><li>递归写法</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//前序遍历（递归）方法</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preOrderWithRecursion</span><span class="token punctuation">(</span>HeroNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    HeroNode p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 定义一个移动指针</span>    <span class="token comment" spellcheck="true">// 递归结束条件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"二叉树为空，无法遍历~~~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 递归体</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 根节点</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>left <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 左子树</span>        <span class="token function">preOrderWithRecursion</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>right <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 右子树</span>        <span class="token function">preOrderWithRecursion</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>非递归写法</li></ul><p>&emsp;&emsp;利用栈，一直向左遍历，非空即入栈，同时加入列表；弹出栈顶，同样方法，遍历右子树</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//前序遍历（非递归）方法</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preOrderWithStack</span><span class="token punctuation">(</span>HeroNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Stack<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>HeroNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    HeroNode p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 定义一个移动指针</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token operator">!=</span>null <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 外循环条件</span>        <span class="token comment" spellcheck="true">// 一直向左遍历，非空即入栈，同时加入列表</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 内循环条件</span>            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 弹出栈顶，遍历右子树</span>        HeroNode temp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p <span class="token operator">=</span> temp<span class="token punctuation">.</span>right<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 输出前序遍历结果</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>HeroNode heroNode <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>heroNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-2-中序遍历"><a href="#2-2-中序遍历" class="headerlink" title="2.2 中序遍历"></a>2.2 中序遍历</h3><p>左——根——右</p><ul><li>非递归</li></ul><p>&emsp;&emsp;利用栈，一直向左遍历，非空即入栈；弹出栈顶，加入列表，同样方法，遍历右子树</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//中序遍历（非递归）方法</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">infixOrderWithStack</span><span class="token punctuation">(</span>HeroNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Stack<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>HeroNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    HeroNode p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 定义一个移动指针</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token operator">!=</span>null <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 一直向左遍历，非空即入栈</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 弹出栈顶，加入列表，遍历右子树</span>        HeroNode temp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>        p <span class="token operator">=</span> temp<span class="token punctuation">.</span>right<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 输出中序遍历结果</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>HeroNode heroNode <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>heroNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><font color=#0000FF ><strong>注意：</strong></font></p><p>&emsp;&emsp;<font color=#FF0000 >前序遍历和中序遍历代码几乎一样，不同仅仅是元素添加到列表的时机。</font></p><h3 id="2-3-后序遍历"><a href="#2-3-后序遍历" class="headerlink" title="2.3 后序遍历"></a>2.3 后序遍历</h3><p>左——右——根</p><ul><li>非递归写法</li></ul><p>&emsp;&emsp;借助前序遍历，前序遍历是 根 左 右，先将前序遍历代码改成 根 右 左，然后反转即是后序遍历 左 右 根</p><p>&emsp;&emsp;利用栈，一直向右遍历，非空即入栈，同时加入列表；弹出栈顶，同样方法，遍历左子树，最后列表倒叙输出。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 后序遍历（非递归）方法</span><span class="token comment" spellcheck="true">// 前序遍历是 根 左 右，先将前序遍历代码改成 根 右 左，然后反转即是后序遍历 左 右 根 </span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">postOrderWithStack</span><span class="token punctuation">(</span>HeroNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Stack<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>HeroNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    HeroNode p <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 定义一个移动指针</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token operator">!=</span>null <span class="token operator">||</span> <span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 一直向右遍历，非空即入栈，同时加入列表</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 弹出栈顶，遍历左子树</span>        HeroNode temp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p <span class="token operator">=</span> temp<span class="token punctuation">.</span>left<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 输出后序遍历结果：倒叙输出列表即可</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-4-层次遍历"><a href="#2-4-层次遍历" class="headerlink" title="2.4 层次遍历"></a>2.4 层次遍历</h3><p>借助队列实现</p><ul><li>先将二叉树的头结点入队列，然后出队列。出队列时，访问该节点。</li><li>如果有左子树，则将左子树的根结点入队，然后出队列。出队列时，访问该节点。</li><li>如果有右子树，则将右子树的根结点入队。然后出队列。出队列时，访问该节点。 </li><li>如此反复，直到队列为空为止。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 完全二叉树层次遍历，结果即是顺序存储结果</span><span class="token comment" spellcheck="true">/**     * 借助队列实现      *     1.先将二叉树的头结点入队列，然后出队列。出队列时，访问该节点。     *     2.如果有左子树，则将左子树的根结点入队，然后出队列。出队列时，访问该节点。     *     3.如果有右子树，则将右子树的根结点入队。然后出队列。出队列时，访问该节点。      *     4.如此反复，直到队列为空为止。     * @param root     * @return     */</span><span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> <span class="token function">levelOrder</span><span class="token punctuation">(</span>HeroNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    HeroNode p <span class="token operator">=</span> root<span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>HeroNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Deque<span class="token operator">&lt;</span>HeroNode<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"空树~~~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 1.先将二叉树的头结点入队列</span>    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 不能使用queue！=null来判断空值</span>        <span class="token comment" spellcheck="true">// 2.出队列，加入列表</span>        HeroNode tmp <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3.判断左子树</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>left <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 4.判断右子树</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>right <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> list<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="三、重建二叉树"><a href="#三、重建二叉树" class="headerlink" title="三、重建二叉树"></a>三、重建二叉树</h2><h3 id="3-1-题目描述"><a href="#3-1-题目描述" class="headerlink" title="3.1 题目描述"></a>3.1 题目描述</h3><p>输入某二叉树的前序遍历和中序遍历的结果，请重建该二叉树。假设输入的前序遍历和中序遍历的结果中都不含重复的数字。</p><p><strong>举例：</strong></p><pre class=" language-java"><code class="language-java">前序遍历 preorder <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>中序遍历 inorder <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span></code></pre><p>返回如下的二叉树：</p><pre class=" language-java"><code class="language-java">    <span class="token number">3</span>   <span class="token operator">/</span> \  <span class="token number">9</span>  <span class="token number">20</span>    <span class="token operator">/</span>  \   <span class="token number">15</span>   <span class="token number">7</span></code></pre><p><strong>限制：</strong></p><pre class=" language-java"><code class="language-java"><span class="token number">0</span> <span class="token operator">&lt;=</span> 节点个数 <span class="token operator">&lt;=</span> <span class="token number">5000</span></code></pre><h3 id="3-2-题目解析"><a href="#3-2-题目解析" class="headerlink" title="3.2 题目解析"></a>3.2 题目解析</h3><p>对于任意一颗树而言，前序遍历的形式总是</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span> 根节点<span class="token punctuation">,</span> <span class="token punctuation">[</span>左子树的前序遍历结果<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>右子树的前序遍历结果<span class="token punctuation">]</span> <span class="token punctuation">]</span></code></pre><p>即<font color=#FF0000 >根节点总是前序遍历中的第一个节点。</font></p><p>中序遍历的形式总是</p><pre><code>[ [左子树的中序遍历结果], 根节点, [右子树的中序遍历结果] ]</code></pre><ul><li>先根据前序序列的第一个数字创建根节点</li><li>接下来在中序序列中找到根节点的位置</li><li>确定左、右子树节点的数量</li><li>在前序遍历和中序遍历序列中划分了左、右子树节点的之后，便可以递归的调用去分别构建它的左、右子树</li></ul><p><strong>优化：</strong></p><p>可以考虑使用哈希表来帮助我们快速地定位根节点。对于<font color=#FF0000 >哈希映射中的每个键值对，键表示一个元素（节点的值），值表示其在中序遍历中的出现位置。</font>在构造二叉树的过程之前，我们可以对中序遍历的列表进行一遍扫描，就可以构造出这个哈希映射。在此后构造二叉树的过程中，我们就只需要 O(1)<em>O</em>(1) 的时间对根节点进行定位了。</p><h3 id="3-3-代码实现"><a href="#3-3-代码实现" class="headerlink" title="3.3 代码实现"></a>3.3 代码实现</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 二叉树节点* public class TreeNode {*     int val;*     TreeNode left;*     TreeNode right;*     TreeNode(int x) { val = x; }* }*/</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>Integer<span class="token operator">></span> indexMap<span class="token punctuation">;</span>    <span class="token keyword">public</span> TreeNode <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> n <span class="token operator">=</span> preorder<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 构造一个哈希映射，帮助快速定位根节点在中序序列中的位置</span>        indexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            indexMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>inorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// key：中序遍历的结果，value：结果对应的下标</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment" spellcheck="true">/**    * @param preorder            前序序列    * @param inorder            中序序列    * @param preorder_left        前序序列中开始的位置    * @param preorder_right    前序序列中结束的位置    * @param inorder_left        中序序列中开始的位置    * @param inorder_right        中序序列中结束的位置    * @return    */</span>    <span class="token keyword">public</span> TreeNode <span class="token function">myBuildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">,</span> <span class="token keyword">int</span> preorder_left<span class="token punctuation">,</span> <span class="token keyword">int</span> preorder_right<span class="token punctuation">,</span> <span class="token keyword">int</span> inorder_left<span class="token punctuation">,</span> <span class="token keyword">int</span> inorder_right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 递归结束条件</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>preorder_left <span class="token operator">></span> preorder_right<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 前序遍历中的第一个节点就是根节点，获取其索引</span>    <span class="token keyword">int</span> preorder_root <span class="token operator">=</span> preorder_left<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 在中序遍历中定位根节点，保存的都是下标值</span>    <span class="token keyword">int</span> inorder_root <span class="token operator">=</span> indexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span>preorder_root<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 获取前序序列中左子树中节点的数目</span>    <span class="token keyword">int</span> size_left_subtree <span class="token operator">=</span> inorder_root <span class="token operator">-</span> inorder_left<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 创建根节点</span>    TreeNode root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span>preorder_root<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 递归地构造左子树，并连接到根节点</span>    <span class="token comment" spellcheck="true">// 先序遍历中「从 左边界+1 开始的 size_left_subtree」个元素就对应了中序遍历中「从 左边界 开始到 根节点定位-1」的元素</span>    root<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> preorder_left<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> preorder_left<span class="token operator">+</span>size_left_subtree<span class="token punctuation">,</span> inorder_left<span class="token punctuation">,</span> inorder_root<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 递归地构造右子树，并连接到根节点</span>    <span class="token comment" spellcheck="true">// 先序遍历中「从 左边界+1+左子树节点数目 开始到 右边界」的元素就对应了中序遍历中「从 根节点定位+1 到 右边界」的元素</span>    root<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token function">myBuildTree</span><span class="token punctuation">(</span>preorder<span class="token punctuation">,</span> inorder<span class="token punctuation">,</span> preorder_left<span class="token operator">+</span>size_left_subtree<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> preorder_right <span class="token punctuation">,</span> inorder_root<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> inorder_right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="3-4-利用迭代方法实现"><a href="#3-4-利用迭代方法实现" class="headerlink" title="3.4 利用迭代方法实现"></a>3.4 利用迭代方法实现</h3><p>分析：。。。。。（待写）</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 二叉树节点* public class TreeNode {*     int val;*     TreeNode left;*     TreeNode right;*     TreeNode(int x) { val = x; }* }*/</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> TreeNode <span class="token function">buildTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preorder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inorder<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>preorder <span class="token operator">==</span> null <span class="token operator">||</span> preorder<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TreeNode root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorder<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Deque<span class="token operator">&lt;</span>TreeNode<span class="token operator">></span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>TreeNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> inorderIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> preorder<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> preorderVal <span class="token operator">=</span> preorder<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            TreeNode node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>val <span class="token operator">!=</span> inorder<span class="token punctuation">[</span>inorderIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                node<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorderVal<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val <span class="token operator">==</span> inorder<span class="token punctuation">[</span>inorderIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    node <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    inorderIndex<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                node<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preorderVal<span class="token punctuation">)</span><span class="token punctuation">;</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="四、二叉树的下一个节点"><a href="#四、二叉树的下一个节点" class="headerlink" title="四、二叉树的下一个节点"></a>四、二叉树的下一个节点</h2><h3 id="4-1-题目描述"><a href="#4-1-题目描述" class="headerlink" title="4.1 题目描述"></a>4.1 题目描述</h3><p>给定一颗二叉树和其中的一个节点，如何找出中序遍历序列的下一个节点？</p><p>注意，树中的节点不仅包含左右子节点，同时包含指向父节点的指针。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 二叉树节点 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TreeLinkNode</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    TreeLinkNode left <span class="token operator">=</span> null<span class="token punctuation">;</span>    TreeLinkNode right <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 父节点</span>    TreeLinkNode parent <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token function">TreeLinkNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="4-2-题目解析"><a href="#4-2-题目解析" class="headerlink" title="4.2 题目解析"></a>4.2 题目解析</h3><p>画出二叉树的结构图、通过具体的例子找出中序遍历下一个节点的规律，才有可能设计出可行的算法。</p><p>通过对下一个节点的情况分析，主要有以下两种情况：</p><ul><li>如果一个节点的右子树不为空，那么该节点的下一个节点是右子树的最左节点。也就是说，从右子节点出发一直沿着指向左子节点的指针就能找到它的下一个节点。 如下图：</li></ul><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210414172449.png" alt=""></p><p>比如，当前节点是b，先到其右子节点e，再到左子节点g</p><ul><li>如果一个节点的右子树为空<ul><li>当前节点是其父节点的左子节点，则其下一个节点就是其父节点</li><li>当前节点是其父节点的右子节点，那么需要沿着父节点的指针一直向上遍历，直到找到一个节点（该节点是其父节点的左子节点），那么该节点的父节点便是要找的下一个节点。</li></ul></li></ul><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210414180950.png" alt=""></p><p>比如，当前节点是h，沿着父节点的指针向上遍历，先到达节点e，由于节点e是它父节点b的右子节点，继续向上遍历达到节点b。由于节点b是它父节点a的左子节点，因此节点b的父节点a就是节点h的下一个节点。</p><h3 id="4-3-代码实现"><a href="#4-3-代码实现" class="headerlink" title="4.3 代码实现"></a>4.3 代码实现</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 二叉树节点 */</span><span class="token keyword">class</span> <span class="token class-name">TreeLinkNode</span> <span class="token punctuation">{</span>    String val<span class="token punctuation">;</span>    TreeLinkNode left <span class="token operator">=</span> null<span class="token punctuation">;</span>    TreeLinkNode right <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 父节点</span>    TreeLinkNode parent <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token function">TreeLinkNode</span><span class="token punctuation">(</span>String val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/**     * 寻找二叉树当前节点在中序序列中的下一个节点     * @param pNode     * @return     */</span><span class="token keyword">public</span> <span class="token keyword">static</span> TreeLinkNode <span class="token function">getNext</span><span class="token punctuation">(</span>TreeLinkNode pNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pNode <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 中间指针</span>    TreeLinkNode pNext <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 1.当前节点有右子树的情况</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 从右子节点出发，一路向左</span>        TreeLinkNode pRight <span class="token operator">=</span> pNode<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>pRight<span class="token punctuation">.</span>left <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            pRight <span class="token operator">=</span> pRight<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        pNext <span class="token operator">=</span> pRight<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pNode<span class="token punctuation">.</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 2.当前节点没有右子树情况</span>        TreeLinkNode pParent <span class="token operator">=</span> pNode<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 当前节点的父节点</span>        TreeLinkNode pCurrent <span class="token operator">=</span> pNode<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 当前节点赋给一个中间变量</span>        <span class="token comment" spellcheck="true">// 2.1 当前节点是其父节点的左子节点</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pParent<span class="token punctuation">.</span>left <span class="token operator">==</span> pNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            pNext <span class="token operator">=</span> pParent<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 2.2 当前节点是其父节点的右子节点</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>pParent<span class="token operator">!=</span>null <span class="token operator">&amp;&amp;</span> pParent<span class="token punctuation">.</span>right <span class="token operator">==</span> pCurrent<span class="token punctuation">)</span> <span class="token punctuation">{</span>            pCurrent <span class="token operator">=</span> pParent<span class="token punctuation">;</span>            pParent <span class="token operator">=</span> pCurrent<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        pNext <span class="token operator">=</span> pParent<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> pNext<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 二叉树 </category>
          
          <category> 遍历 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 二叉树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-数组】二维数组中的查找</title>
      <link href="/2021/04/13/shu-ju-jie-gou-shu-zu-er-wei-shu-zu-zhong-de-cha-zhao/"/>
      <url>/2021/04/13/shu-ju-jie-gou-shu-zu-er-wei-shu-zu-zhong-de-cha-zhao/</url>
      
        <content type="html"><![CDATA[<h2 id="一、考察点"><a href="#一、考察点" class="headerlink" title="一、考察点"></a>一、考察点</h2><p>考查应聘者分析问题的能力。<font color=#FF0000 >当应聘者发现问题比较复杂时，能不能通过具体的例子找出其中的规律，</font>是能否解决这个问题的关键所在。这个题目只要从一个具体的二维数组的右上角开始分析，就能找到查找的规律，从而找到解决问题的突破口。</p><p><font color=#0000FF >当我们需要解决一个复杂的问题时，一个很有效的办法就是从一个具体的问题入手，通过分析简单具体的例子，试图寻找普遍的规律。</font></p><h2 id="二、二维数组中的查找"><a href="#二、二维数组中的查找" class="headerlink" title="二、二维数组中的查找"></a>二、二维数组中的查找</h2><h3 id="2-1-题目描述"><a href="#2-1-题目描述" class="headerlink" title="2.1 题目描述"></a>2.1 题目描述</h3><p>在一个 n * m 的二维数组中，每一行都按照从左到右递增的顺序排序，每一列都按照从上到下递增的顺序排序。请完成一个高效的函数，输入这样的一个二维数组和一个整数，判断数组中是否含有该整数。</p><p><strong>示例 ：</strong></p><p>现有矩阵 matrix 如下：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span>   <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span>   <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><p>给定 target = <code>5</code>，返回 <code>true</code>。</p><p>给定 target = <code>20</code>，返回 <code>false</code>。</p><p><strong>限制：</strong></p><pre class=" language-java"><code class="language-java"><span class="token number">0</span> <span class="token operator">&lt;=</span> n <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token number">0</span> <span class="token operator">&lt;=</span> m <span class="token operator">&lt;=</span> <span class="token number">1000</span></code></pre><h3 id="2-2-题目分析"><a href="#2-2-题目分析" class="headerlink" title="2.2 题目分析"></a>2.2 题目分析</h3><p><font color=#FF0000 >从右上角看，这个矩阵类似于二叉排序树。</font></p><ul><li>从二维数组的右上角开始查找。<ul><li>如果当前元素等于目标值，则返回 <code>true</code>，查找结束。</li><li>如果当前元素大于目标值，则剔除当前元素所在的列，即移到左边一列。</li><li>如果当前元素小于目标值，则剔除当前元素所在的行，即移到下边一行。</li></ul></li></ul><p>如果要查找的数字不在数组的右上角，则每一次都在数组的查找范围中剔除一行或者一列，这样每一步都可以缩小查找的范围，直到找到要查找的数字，或者查找范围为空。</p><h3 id="2-3-代码实现"><a href="#2-3-代码实现" class="headerlink" title="2.3 代码实现"></a>2.3 代码实现</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">findNumberIn2DArray</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> found <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 当matrix为null时，求matrix[0].length会报错</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>matrix<span class="token operator">==</span>null <span class="token operator">||</span> matrix<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">||</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> found<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> rows <span class="token operator">=</span> matrix<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 行数</span>        <span class="token keyword">int</span> columns <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 列数</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>rows<span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> columns<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// 当前行数</span>            <span class="token keyword">int</span> column <span class="token operator">=</span> columns <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// 当前列数</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>row<span class="token operator">&lt;</span>rows <span class="token operator">&amp;&amp;</span> column<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 右上角值等于target，直接返回</span>                    found <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">></span> target<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 右上角值大于target，剔除该列，当前列数减一</span>                    column<span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// // 右上角值小于target，剔除改行，当前行数加一</span>                    row<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> found<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数组 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-数组】数组中寻找重复数问题</title>
      <link href="/2021/04/12/shu-ju-jie-gou-shu-zu-shu-zu-zhong-xun-zhao-chong-fu-shu-wen-ti/"/>
      <url>/2021/04/12/shu-ju-jie-gou-shu-zu-shu-zu-zhong-xun-zhao-chong-fu-shu-wen-ti/</url>
      
        <content type="html"><![CDATA[<h2 id="一、考察点"><a href="#一、考察点" class="headerlink" title="一、考察点"></a>一、考察点</h2><p>&emsp;&emsp;这类题考察的是程序员的沟通能力。如果面试官提出不同的功能要求（找出任意一个重复数字、找出所有重复的数组）或者性能要求（时间效率优先、空间效率优先），那么最终选取的算法也将不同。</p><h2 id="二、题目一：找出数组中重复的数字"><a href="#二、题目一：找出数组中重复的数字" class="headerlink" title="二、题目一：找出数组中重复的数字"></a>二、题目一：找出数组中重复的数字</h2><h3 id="2-1-题目描述"><a href="#2-1-题目描述" class="headerlink" title="2.1 题目描述"></a>2.1 题目描述</h3><p>在一个长度为 n 的数组 nums 里的所有数字都在 0～n-1 的范围内。数组中某些数字是重复的，但不知道有几个数字重复了，也不知道每个数字重复了几次。请找出数组中任意一个重复的数字。</p><p><strong>示例 1：</strong></p><pre class=" language-java"><code class="language-java">输入：<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>输出：<span class="token number">2</span> 或 <span class="token number">3</span> </code></pre><p><strong>限制：</strong></p><pre><code>2 &lt;= n &lt;= 100000</code></pre><h3 id="2-2-方法一：排序"><a href="#2-2-方法一：排序" class="headerlink" title="2.2 方法一：排序"></a>2.2 方法一：排序</h3><h4 id="2-2-1-题目解析"><a href="#2-2-1-题目解析" class="headerlink" title="2.2.1 题目解析"></a>2.2.1 题目解析</h4><p>先把输入的数组排序，然后从头到尾扫描排序后的数组即可。时间复杂度为O(nlogn)，空间复杂度为O(1)</p><h3 id="2-3-方法二：利用集合或数组"><a href="#2-3-方法二：利用集合或数组" class="headerlink" title="2.3 方法二：利用集合或数组"></a>2.3 方法二：利用集合或数组</h3><h4 id="2-3-1-题目解析"><a href="#2-3-1-题目解析" class="headerlink" title="2.3.1 题目解析"></a>2.3.1 题目解析</h4><p>集合（Hashset）有一个特性：无序不重复。使用集合存储已经遇到的数字，如果遇到的一个数字已经在集合中，则当前的数字是重复数字。也可以使用数组存储已遇到的数字。时间复杂度：O(n)，空间复杂度：O(n)。</p><h4 id="2-3-2-代码实现"><a href="#2-3-2-代码实现" class="headerlink" title="2.3.2 代码实现"></a>2.3.2 代码实现</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 使用数组存储已遇到的数字，先把数组初始化为-1</span>        <span class="token keyword">int</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>nums<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                arr<span class="token punctuation">[</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// nums[i]为多少，则存储在对应下标处</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                <span class="token keyword">return</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 使用集合存储已遇到的数字</span>        Set<span class="token operator">&lt;</span>Integer<span class="token operator">></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> repeat <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Integer e <span class="token operator">:</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// set.add(e):当添加已存在的数据时，会返回false</span>                repeat <span class="token operator">=</span> e<span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> repeat<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>两种存储方式比较：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210412161418.png" alt=""></p><p>数组存储的运行时间是1ms，内存消耗是45.6MB，集合存储的运行时间是5ms，内存消耗是48.5MB。使用数组比集合更优。</p><h3 id="2-4-方法三：利用数组下标"><a href="#2-4-方法三：利用数组下标" class="headerlink" title="2.4 方法三：利用数组下标"></a>2.4 方法三：利用数组下标</h3><h4 id="2-4-1-题目解析"><a href="#2-4-1-题目解析" class="headerlink" title="2.4.1 题目解析"></a>2.4.1 题目解析</h4><p>类似于第二种方法的思想，只不过是通过自身数组的移动来实现的。</p><p>我们注意到数组中的数字都在0~n-l的范围内。如果这个数组中没有重复的数字，那么当数组排序之后数字i将出现在下标为i的位置。由于数组中有重复的数字，有些位置可能存在多个数字，同时有些位置可能没有数字。</p><p>从头到尾依次扫描这个数组中的每个数字。</p><ul><li>当扫描到下标为i的数字时，首先比较这个数字nums[i]是不是等于i。<ul><li>如果是，则接着扫描下一个数字；</li><li>如果不是，则再拿它和第nums[i]个数字进行比较。<ul><li>如果它和第nums[i]个数字相等，就找到了一个重复的数字（该数字在下标为i和nums[i]的位置都出现了）</li><li>如果它和第nums[i]个数字不相等，就把第i个数字和第nums[i]个数字交换，把nums[i]放到属于它的位置。</li></ul></li></ul></li><li>接下来再重复这个比较、交换的过程，直到我们发现一个重复的数字。</li></ul><p>时间复杂度：O(n)，空间复杂度：O(1)。</p><h4 id="2-4-2-代码实现"><a href="#2-4-2-代码实现" class="headerlink" title="2.4.2 代码实现"></a>2.4.2 代码实现</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> m <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 存储i处的数组值</span>            <span class="token comment" spellcheck="true">// 1.先比较索引i处的值m是否等于i</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token operator">!=</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 索引i处的值m不等于i</span>                <span class="token comment" spellcheck="true">// 2.将m作为索引，比较索引m处的值nums[m]是否等于索引m</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> nums<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 找到重复数字，该数字在下标为i和nums[i]的位置都出现了</span>                    <span class="token keyword">return</span> m<span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 把第i个数字和第nums[i]个数字交换，把nums[i]放到对应索引处</span>                    <span class="token keyword">int</span> temp <span class="token operator">=</span> nums<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">;</span>                    nums<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> m<span class="token punctuation">;</span>                    m <span class="token operator">=</span> temp<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 索引i处的值m等于i的话，遍历下一个</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="三、题目二：不修改数组找出重复的数字"><a href="#三、题目二：不修改数组找出重复的数字" class="headerlink" title="三、题目二：不修改数组找出重复的数字"></a>三、题目二：不修改数组找出重复的数字</h2><h3 id="3-1-技巧"><a href="#3-1-技巧" class="headerlink" title="3.1 技巧"></a>3.1 技巧</h3><p>&emsp;&emsp;二分法的使用 <strong>并不一定</strong> 需要在排序好的数组上面进行，<strong>不要让常见的例题限制了你的思路</strong>，二分法还有一个比较高级的用法叫做 <font color=#FF0000 ><strong>按值二分</strong></font>。</p><h3 id="3-2-题目1描述"><a href="#3-2-题目1描述" class="headerlink" title="3.2 题目1描述"></a>3.2 题目1描述</h3><p>在一个长度为n + 1 的数组里的所有数字都在1～n 的范围内，所以数组中至少有一个数字是重复的。请找出数组中任意一个重复的数字，但不能修改输入的数组。</p><p><strong>示例 1：</strong></p><pre class=" language-java"><code class="language-java">输入：<span class="token punctuation">[</span><span class="token number">2</span>，<span class="token number">3</span>，<span class="token number">5</span>，<span class="token number">4</span>，<span class="token number">3</span>，<span class="token number">2</span>，<span class="token number">6</span>，<span class="token number">7</span><span class="token punctuation">]</span>输出：<span class="token number">2</span> 或 <span class="token number">3</span> </code></pre><h3 id="3-3-题目1解析"><a href="#3-3-题目1解析" class="headerlink" title="3.3 题目1解析"></a>3.3 题目1解析</h3><p>我们可以创建一个长度为n+1的辅助数组，然后逐一把原数组的每个数字复制到辅助数组。如果原数组中被复制的数字是m，则把它复制到辅助数组中下标为m的位置。这样很容易就能发现哪个数字是重复的。由于需要创建一个数组，该方案需要O（n）的辅助空间。</p><p>接下来我们尝试避免使用O（n）的辅助空间。为什么数组中会有重复的数字？假如没有重复的数字，那么在从1～n的范围里只有n个数字。由于数组里包含超过n个数字，所以一定包含了重复的数字。<font color=#FF0000 >看起来在某范围里数字的个数对解决这个问题很重要。</font></p><p>我们把从1～n的数字从中间的数字m分为两部分，前面一半为1～m，后面一半为m+1～n。如果1～m的数字的数目超过m，那么这一半的区间里一定包含重复的数字；否则，另一半m+1～n的区间里一定包含重复的数字。我们可以继续把包含重复数字的区间一分为二，直到找到一个重复的数字。<font color=#FF0000 >这个过程和二分查找算法很类似，只是多了一步统计区间里数字的数目。</font></p><h3 id="3-4-题目1代码实现"><a href="#3-4-题目1代码实现" class="headerlink" title="3.4 题目1代码实现"></a>3.4 题目1代码实现</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">findRepeatNumber</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 按值二分查找</span>        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> end <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>start<span class="token operator">&lt;=</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> mid <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 统计start 到 mid 之间数据的个数</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">countRange</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> start<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token operator">==</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// [1,1] start=1,end=1</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> start<span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// start~mid区间的数字数目count 大于区间值，证明在该区间内存在重复数字</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token punctuation">(</span>mid<span class="token operator">-</span>start<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                end <span class="token operator">=</span> mid<span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                start <span class="token operator">=</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">countRange</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nums <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 统计整个数组中在该区间内数据的个数</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">>=</span>start <span class="token operator">&amp;&amp;</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;=</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>                count<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> count<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="3-5-题目2描述"><a href="#3-5-题目2描述" class="headerlink" title="3.5 题目2描述"></a>3.5 题目2描述</h3><p>&emsp;&emsp;给定一个包含 <em>n + 1</em> 个整数的数组 <em>nums</em>，其数字都在 1 到 n 之间（包括 1 和 n），可知至少存在一个重复的整数。假设只有一个重复的整数，找出这个重复的数。</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210412153324.png" style="zoom:80%;" /><h3 id="3-6-题目2解析"><a href="#3-6-题目2解析" class="headerlink" title="3.6 题目2解析"></a>3.6 题目2解析</h3><p>&emsp;&emsp;由于限制条件太多了，很多方法都不能用！</p><p>&emsp;&emsp;假如没有这些限制，可以采取的方法有：</p><ul><li><font color=#FF0000 >不能更改原数组</font>导致无法排序，也无法用<font color=#FF0000 >index 和元素建立关系</font> index 和元素建立关系；</li><li><font color=#FF0000 >只能使用 O(1) 的空间</font>意味着使用<font color=#FF0000 >哈希表去计数</font>这条路也走不通；</li><li><font color=#FF0000 >时间复杂度必须小于 O(n^2)</font>意味着不能用<font color=#FF0000 >暴力解法</font>；</li><li><font color=#FF0000 >重复数字可以重复出现</font>通过<font color=#FF0000 >累加求和然后做差 <code>sum(array) - sum(1,2,...,n)</code> 的方式</font>也变得不可行。</li></ul><p>&emsp;&emsp;<font color=#FF0000 ><strong>什么样的算法可以不使用额外的空间解决数组上面的搜索问题？</strong></font></p><p>&emsp;&emsp;<font color=#FF0000 ><strong>二分查找！！</strong></font></p><p>&emsp;&emsp;这道题目交代的信息很少，<strong>我们只需要关注两个东西 - 数组，数组里的元素</strong>，利用二分我们需要去思考的是，我们要找符合条件的元素作为答案，那么 <font color=#FF0000 ><strong>比答案小的元素具有什么样的特质，比答案大的元素又具有什么样的特质？</strong></font>结合题目给我们的例子来看看：</p><p>&emsp;&emsp;例1：</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>                      元素个数<span class="token operator">&lt;=</span> <span class="token number">1</span> 的元素：<span class="token number">1</span>                       <span class="token number">1</span><span class="token operator">&lt;=</span> <span class="token number">2</span> 的元素：<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span>                 <span class="token number">3</span><span class="token operator">&lt;=</span> <span class="token number">3</span> 的元素：<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>              <span class="token number">4</span><span class="token operator">&lt;=</span> <span class="token number">4</span> 的元素：<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span>           <span class="token number">5</span></code></pre><p>&emsp;&emsp;例2:</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span> <span class="token number">1</span> 的元素：<span class="token number">1</span>                        <span class="token number">1</span><span class="token operator">&lt;=</span> <span class="token number">2</span> 的元素：<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>                     <span class="token number">2</span><span class="token operator">&lt;=</span> <span class="token number">3</span> 的元素：<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span>               <span class="token number">4</span><span class="token operator">&lt;=</span> <span class="token number">4</span> 的元素：<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span>            <span class="token number">5</span></code></pre><p>&emsp;&emsp;极端一点的例子 (必须保证数组的长度是 n + 1, 并且元素都在区间[1,n] 上, 有且只有一个重复)</p><pre class=" language-java"><code class="language-java"><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span> <span class="token number">1</span> 的元素：                        <span class="token number">0</span><span class="token operator">&lt;=</span> <span class="token number">2</span> 的元素：                        <span class="token number">0</span><span class="token operator">&lt;=</span> <span class="token number">3</span> 的元素：<span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span>              <span class="token number">4</span><span class="token operator">&lt;=</span> <span class="token number">4</span> 的元素：<span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span>           <span class="token number">5</span></code></pre><p>&emsp;&emsp;看完上面几个例子，相信你明白了一个事实:</p><ul><li>如果选中的数<font color=#FF0000 > <strong>小于</strong></font> 我们要找的答案，那么整个数组中小于或等于该数的元素个数必然小于或等于该元素的值;</li><li>如果选中的数<font color=#FF0000 > <strong>大于或等于</strong></font> 我们要找的答案，那么整个数组中小于或等于该数的元素个数必然<font color=#FF0000 >大于</font>该元素的值</li></ul><p>&emsp;&emsp;而且你可以看到，我们要找的答案其实就处于一个分界点的位置，寻找边界值，这又是二分的一个应用，而且题目已经告诉我们数组里面的值只可能在 [1, n] 之间，这么一来，思路就是在 [1, n] 区间上做二分，然后按我们之前提到的逻辑去做分割。整个解法的时间复杂度是 <strong>O(nlogn)</strong>，也是满足题目要求的。</p><p>&emsp;&emsp;动画描述参考：<a href="https://mp.weixin.qq.com/s?__biz=MzUyNjQxNjYyMg==&amp;mid=2247486581&amp;idx=1&amp;sn=0ed7d74ba7ebf427c58ade56bc4f8f68" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzUyNjQxNjYyMg==&amp;mid=2247486581&amp;idx=1&amp;sn=0ed7d74ba7ebf427c58ade56bc4f8f68</a></p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210412153339.png" style="zoom:80%;" /><h3 id="3-7-题目2代码实现"><a href="#3-7-题目2代码实现" class="headerlink" title="3.7 题目2代码实现"></a>3.7 题目2代码实现</h3><p>&emsp;&emsp;java代码：</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findDuplicate</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arrays<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> len <span class="token operator">=</span> arrays<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> end <span class="token operator">=</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> mid <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> array <span class="token operator">:</span> arrays<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 统计数组中小于等于mid的元素个数counter</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>array <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    counter <span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">></span> mid<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment" spellcheck="true">// 如果个数counter大于mid，则下次应该在[start，mid]之间找寻</span>                end <span class="token operator">=</span> mid<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">else</span> <span class="token punctuation">{</span>                start <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 否则，在[mid+1，end]之间找寻</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> start<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="3-8-另一种解题思路"><a href="#3-8-另一种解题思路" class="headerlink" title="3.8 另一种解题思路"></a>3.8 另一种解题思路</h3><p>&emsp;&emsp;另外一种 O(n) 的解法借鉴快慢指针找交点的思想，算法非常的巧妙，也非常的有趣，但不太容易想到，这里把代码放上。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//快慢指针</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findDuplicate</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> fast <span class="token operator">=</span> nums<span class="token punctuation">[</span>nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> slow <span class="token operator">=</span> nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>fast <span class="token operator">!=</span> slow<span class="token punctuation">)</span> <span class="token punctuation">{</span>        fast <span class="token operator">=</span> nums<span class="token punctuation">[</span>nums<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        slow <span class="token operator">=</span> nums<span class="token punctuation">[</span>slow<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    slow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>fast <span class="token operator">!=</span> slow<span class="token punctuation">)</span> <span class="token punctuation">{</span>        fast <span class="token operator">=</span> nums<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">;</span>        slow <span class="token operator">=</span> nums<span class="token punctuation">[</span>slow<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> slow<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数组 </category>
          
          <category> 二分法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【SpringBoot】05-SpringBoot-单元测试</title>
      <link href="/2021/03/17/springboot-05-springboot-dan-yuan-ce-shi/"/>
      <url>/2021/03/17/springboot-05-springboot-dan-yuan-ce-shi/</url>
      
        <content type="html"><![CDATA[<h2 id="一、JUnit5-的变化"><a href="#一、JUnit5-的变化" class="headerlink" title="一、JUnit5 的变化"></a>一、JUnit5 的变化</h2><p><font color=#FF0000 ><strong>Spring Boot 2.2.0 版本开始引入 JUnit 5 作为单元测试默认库</strong></font></p><p>作为最新版本的JUnit框架，JUnit5与之前版本的Junit框架有很大的不同。由三个不同子项目的几个不同模块组成。</p><blockquote><p><strong>JUnit 5 = JUnit Platform + JUnit Jupiter + JUnit Vintage</strong></p></blockquote><p><strong>JUnit Platform</strong>: Junit Platform是在JVM上启动测试框架的基础，不仅支持Junit自制的测试引擎，其他测试引擎也都可以接入。</p><p><strong>JUnit Jupiter</strong>: JUnit Jupiter提供了JUnit5的新的编程模型，是JUnit5新特性的核心。内部 包含了一个<strong>测试引擎</strong>，用于在Junit Platform上运行。</p><p><strong>JUnit Vintage</strong>: 由于JUint已经发展多年，为了照顾老的项目，JUnit Vintage提供了兼容JUnit4.x,Junit3.x的测试引擎。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210317195753.png" alt=""></p><p><strong>注意</strong>：</p><p><strong>SpringBoot 2.4 以上版本移除了默认对 Vintage 的依赖。如果需要兼容junit4需要自行引入（不能使用junit4的功能 @Test）</strong></p><p><strong>JUnit 5’s Vintage Engine Removed from</strong> <strong><code>spring-boot-starter-test,如果需要继续兼容junit4需要自行引入vintage</code></strong></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.junit.vintage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit-vintage-engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.hamcrest<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hamcrest-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>引入SpringBoot的test测试类</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>测试程序：</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span><span class="token keyword">class</span> <span class="token class-name">Boot05WebAdminApplicationTests</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>SpringBoot整合Junit以后。</p><ul><li>编写测试方法：@Test标注（注意需要使用junit5版本的注解）</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span>Test<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// junit5版本的注解</span></code></pre><ul><li>Junit类具有Spring的功能，@Autowired、比如 @Transactional 标注测试方法，测试完成后自动回滚</li></ul><h2 id="二、JUnit5常用注解"><a href="#二、JUnit5常用注解" class="headerlink" title="二、JUnit5常用注解"></a>二、JUnit5常用注解</h2><p>JUnit5的注解与JUnit4的注解有所变化</p><p><a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations" target="_blank" rel="noopener">https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations</a></p><ul><li><strong>@Test :</strong>表示方法是测试方法。但是与JUnit4的@Test不同，他的职责非常单一不能声明任何属性，拓展的测试将会由Jupiter提供额外测试</li><li><strong>@ParameterizedTest :</strong>表示方法是参数化测试，下方会有详细介绍</li><li><strong>@RepeatedTest :</strong>表示方法可重复执行，下方会有详细介绍</li><li><strong>@DisplayName :</strong>为测试类或者测试方法设置展示名称</li><li><strong>@BeforeEach :</strong>表示在每个单元测试之前执行</li><li><strong>@AfterEach :</strong>表示在每个单元测试之后执行</li><li><strong>@BeforeAll :</strong>表示在所有单元测试之前执行</li><li><strong>@AfterAll :</strong>表示在所有单元测试之后执行</li><li><strong>@Tag :</strong>表示单元测试类别，类似于JUnit4中的@Categories</li><li><strong>@Disabled :</strong>表示测试类或测试方法不执行，类似于JUnit4中的@Ignore</li><li><strong>@Timeout :</strong>表示测试方法运行如果超过了指定时间将会返回错误</li><li><strong>@ExtendWith :</strong>为测试类或测试方法提供扩展类引用</li></ul><h2 id="三、断言（assertions）"><a href="#三、断言（assertions）" class="headerlink" title="三、断言（assertions）"></a>三、断言（assertions）</h2><p>断言（assertions）是测试方法中的核心部分，用来对测试需要满足的条件进行验证。<strong>这些断言方法都是 <font color=#FF0000 >org.junit.jupiter.api.Assertions</font> 的静态方法</strong>。JUnit 5 内置的断言可以分成如下几个类别：</p><ul><li><p><strong>检查业务逻辑返回的数据是否合理。</strong></p></li><li><p><strong>所有的测试运行结束以后，会有一个详细的测试报告；</strong></p></li></ul><h3 id="3-1-简单断言"><a href="#3-1-简单断言" class="headerlink" title="3.1 简单断言"></a>3.1 简单断言</h3><p>用来对单个值进行简单的验证。如：</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>assertEquals</td><td>判断两个对象或两个原始类型是否相等</td></tr><tr><td>assertNotEquals</td><td>判断两个对象或两个原始类型是否不相等</td></tr><tr><td>assertSame</td><td>判断两个对象引用是否指向同一个对象</td></tr><tr><td>assertNotSame</td><td>判断两个对象引用是否指向不同的对象</td></tr><tr><td>assertTrue</td><td>判断给定的布尔值是否为 true</td></tr><tr><td>assertFalse</td><td>判断给定的布尔值是否为 false</td></tr><tr><td>assertNull</td><td>判断给定的对象引用是否为 null</td></tr><tr><td>assertNotNull</td><td>判断给定的对象引用是否不为 null</td></tr></tbody></table><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"simple assertion"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"simple math"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertNotEquals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertNotSame</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertSame</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertFalse</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertNull</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">assertNotNull</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="3-2-数组断言"><a href="#3-2-数组断言" class="headerlink" title="3.2 数组断言"></a>3.2 数组断言</h3><p>通过 assertArrayEquals 方法来判断两个对象或原始类型的数组是否相等</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"array assertion"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">assertArrayEquals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="3-3-组合断言"><a href="#3-3-组合断言" class="headerlink" title="3.3 组合断言"></a>3.3 组合断言</h3><p>assertAll 方法接受多个 org.junit.jupiter.api.Executable 函数式接口的实例作为要验证的断言，可以通过 lambda 表达式很容易的提供这些断言</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"assert all"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">assertAll</span><span class="token punctuation">(</span><span class="token string">"Math"</span><span class="token punctuation">,</span>              <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>             <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="3-4-异常断言"><a href="#3-4-异常断言" class="headerlink" title="3.4 异常断言"></a>3.4 异常断言</h3><p>在JUnit4时期，想要测试方法的异常情况时，需要用<strong>@Rule</strong>注解的ExpectedException变量还是比较麻烦的。而JUnit5提供了一种新的断言方式<strong>Assertions.assertThrows()</strong> ，配合函数式编程就可以进行使用。</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"异常测试"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ArithmeticException exception <span class="token operator">=</span> Assertions<span class="token punctuation">.</span><span class="token function">assertThrows</span><span class="token punctuation">(</span>        <span class="token comment" spellcheck="true">//扔出断言异常</span>        ArithmeticException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">%</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="3-5-超时断言"><a href="#3-5-超时断言" class="headerlink" title="3.5 超时断言"></a>3.5 超时断言</h3><p>Junit5还提供了<strong>Assertions.assertTimeout()</strong> 为测试方法设置了超时时间</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"超时测试"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">timeoutTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//如果测试方法时间超过1s将会异常</span>    Assertions<span class="token punctuation">.</span><span class="token function">assertTimeout</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="3-6-快速失败"><a href="#3-6-快速失败" class="headerlink" title="3.6 快速失败"></a>3.6 快速失败</h3><p>通过 fail 方法直接使得测试失败</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shouldFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"This should fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="四、前置条件（assumptions）"><a href="#四、前置条件（assumptions）" class="headerlink" title="四、前置条件（assumptions）"></a>四、前置条件（assumptions）</h2><p>JUnit 5 中的前置条件（<strong>assumptions【假设】</strong>）类似于断言，不同之处在于<strong>不满足的断言会使得测试方法失败</strong>，而不满足的<strong>前置条件只会使得测试方法的执行终止</strong>。前置条件可以看成是测试方法执行的前提，当该前提不满足时，就没有继续执行的必要。</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"前置条件"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AssumptionsTest</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> String environment <span class="token operator">=</span> <span class="token string">"DEV"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"simple"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">simpleAssume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">assumeTrue</span><span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token string">"DEV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assumeFalse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token string">"PROD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Test</span>    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"assume then do"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">assumeThenDo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">assumingThat</span><span class="token punctuation">(</span>            Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token string">"DEV"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"In DEV"</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>assumeTrue 和 assumFalse 确保给定的条件为 true 或 false，不满足条件会使得测试执行终止。</p><p>assumingThat 的参数是表示条件的布尔值和对应的 Executable 接口的实现对象。只有条件满足时，Executable 对象才会被执行；当条件不满足时，测试执行并不会终止.</p><h2 id="五、嵌套测试"><a href="#五、嵌套测试" class="headerlink" title="五、嵌套测试"></a>五、嵌套测试</h2><p>JUnit 5 可以通过<font color=#FF0000 > Java 中的内部类和@<strong>Nested</strong> 注解</font>实现嵌套测试，从而可以更好的把相关的测试方法组织在一起。在内部类中可以使用@BeforeEach 和@AfterEach 注解，而且嵌套的层次没有限制。</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"A stack"</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">TestingAStackDemo</span> <span class="token punctuation">{</span>    Stack<span class="token operator">&lt;</span>Object<span class="token operator">></span> stack<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"is instantiated with new Stack()"</span><span class="token punctuation">)</span>    <span class="token keyword">void</span> <span class="token function">isInstantiatedWithNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Nested</span>    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"when new"</span><span class="token punctuation">)</span>    <span class="token keyword">class</span> <span class="token class-name">WhenNew</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@BeforeEach</span>        <span class="token keyword">void</span> <span class="token function">createNewStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Test</span>        <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"is empty"</span><span class="token punctuation">)</span>        <span class="token keyword">void</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">assertTrue</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Test</span>        <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"throws EmptyStackException when popped"</span><span class="token punctuation">)</span>        <span class="token keyword">void</span> <span class="token function">throwsExceptionWhenPopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">assertThrows</span><span class="token punctuation">(</span>EmptyStackException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> stack<span class="token operator">:</span><span class="token operator">:</span>pop<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Test</span>        <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"throws EmptyStackException when peeked"</span><span class="token punctuation">)</span>        <span class="token keyword">void</span> <span class="token function">throwsExceptionWhenPeeked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">assertThrows</span><span class="token punctuation">(</span>EmptyStackException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> stack<span class="token operator">:</span><span class="token operator">:</span>peek<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Nested</span>        <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"after pushing an element"</span><span class="token punctuation">)</span>        <span class="token keyword">class</span> <span class="token class-name">AfterPushing</span> <span class="token punctuation">{</span>            String anElement <span class="token operator">=</span> <span class="token string">"an element"</span><span class="token punctuation">;</span>            <span class="token annotation punctuation">@BeforeEach</span>            <span class="token keyword">void</span> <span class="token function">pushAnElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>anElement<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Test</span>            <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"it is no longer empty"</span><span class="token punctuation">)</span>            <span class="token keyword">void</span> <span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">assertFalse</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Test</span>            <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"returns the element when popped and is empty"</span><span class="token punctuation">)</span>            <span class="token keyword">void</span> <span class="token function">returnElementWhenPopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">assertEquals</span><span class="token punctuation">(</span>anElement<span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">assertTrue</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Test</span>            <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"returns the element when peeked but remains not empty"</span><span class="token punctuation">)</span>            <span class="token keyword">void</span> <span class="token function">returnElementWhenPeeked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">assertEquals</span><span class="token punctuation">(</span>anElement<span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">assertFalse</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="六、参数化测试"><a href="#六、参数化测试" class="headerlink" title="六、参数化测试"></a>六、参数化测试</h2><p>参数化测试是JUnit5很重要的一个新特性，它使得用不同的参数多次运行测试成为了可能，也为我们的单元测试带来许多便利。</p><p>利用<strong>@ValueSource</strong>等注解，指定入参，我们将可以使用不同的参数进行多次单元测试，而不需要每新增一个参数就新增一个单元测试，省去了很多冗余代码。</p><ul><li><p><strong>@ValueSource</strong>: 为参数化测试指定入参来源，支持八大基础类以及String类型,Class类型</p></li><li><p><strong>@NullSource</strong>: 表示为参数化测试提供一个null的入参</p></li><li><p><strong>@EnumSource</strong>: 表示为参数化测试提供一个枚举入参</p></li><li><p><strong>@CsvFileSource</strong>：表示读取指定CSV文件内容作为参数化测试入参</p></li><li><p><strong>@MethodSource</strong>：表示读取指定方法的返回值作为参数化测试入参(注意方法返回需要是一个流)</p></li></ul><blockquote><p>当然如果参数化测试仅仅只能做到指定普通的入参还达不到让我觉得惊艳的地步。让我真正感到他的强大之处的地方在于他可以支持外部的各类入参。如:CSV,YML,JSON 文件甚至方法的返回值也可以作为入参。只需要去实现<strong>ArgumentsProvider</strong>接口，任何外部文件都可以作为它的入参。</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ParameterizedTest</span><span class="token annotation punctuation">@ValueSource</span><span class="token punctuation">(</span>strings <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"one"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"参数化测试1"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parameterizedTest1</span><span class="token punctuation">(</span>String string<span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>    Assertions<span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@ParameterizedTest</span><span class="token annotation punctuation">@MethodSource</span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//指定方法名</span><span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"方法来源参数"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWithExplicitLocalMethodSource</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    Assertions<span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">static</span> Stream<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"apple"</span><span class="token punctuation">,</span> <span class="token string">"banana"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="七、迁移指南"><a href="#七、迁移指南" class="headerlink" title="七、迁移指南"></a>七、迁移指南</h2><p>在进行迁移的时候需要注意如下的变化：</p><ul><li>注解在 org.junit.jupiter.api 包中，断言在 org.junit.jupiter.api.Assertions 类中，前置条件在 org.junit.jupiter.api.Assumptions 类中。</li><li>把@Before 和@After 替换成@BeforeEach 和@AfterEach。</li><li>把@BeforeClass 和@AfterClass 替换成@BeforeAll 和@AfterAll。</li><li>把@Ignore 替换成@Disabled。</li><li>把@Category 替换成@Tag。</li><li>把@RunWith、@Rule 和@ClassRule 替换成@ExtendWith。</li></ul>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
            <tag> Java框架 </tag>
            
            <tag> JUnit5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【SpringBoot】04-SpringBoot-数据访问</title>
      <link href="/2021/03/17/springboot-04-springboot-shu-ju-fang-wen/"/>
      <url>/2021/03/17/springboot-04-springboot-shu-ju-fang-wen/</url>
      
        <content type="html"><![CDATA[<h2 id="一、SQL"><a href="#一、SQL" class="headerlink" title="一、SQL"></a>一、SQL</h2><h3 id="1-1-数据源的自动配置—HikariDataSource"><a href="#1-1-数据源的自动配置—HikariDataSource" class="headerlink" title="1.1 数据源的自动配置—HikariDataSource"></a>1.1 数据源的自动配置—<strong>HikariDataSource</strong></h3><h4 id="1-1-1-导入JDBC场景"><a href="#1-1-1-导入JDBC场景" class="headerlink" title="1.1.1 导入JDBC场景"></a>1.1.1 导入JDBC场景</h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210317164711.png" alt=""></p><p>数据库驱动？</p><p>为什么导入JDBC场景，官方不导入驱动？官方不知道我们接下要操作什么数据库。</p><p><font color=#FF0000 >数据库版本要和导入的驱动版本对应</font></p><pre class=" language-xml"><code class="language-xml">默认版本：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">></span></span>8.0.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;version>5.1.49&lt;/version> --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>想要修改版本1、直接依赖引入具体版本（maven的就近依赖原则）2、重新声明版本（maven的属性的就近优先原则）<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">></span></span>5.1.49<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></code></pre><h4 id="1-1-2-分析自动配置"><a href="#1-1-2-分析自动配置" class="headerlink" title="1.1.2 分析自动配置"></a>1.1.2 分析自动配置</h4><p>1、自动配置的类</p><ul><li>DataSourceAutoConfiguration ： 数据源的自动配置<ul><li>修改数据源相关的配置：<font color=#FF0000 ><strong>spring.datasource</strong></font></li><li><strong>数据库连接池的配置，是自己容器中没有DataSource才自动配置的</strong></li><li>底层配置好的连接池是：<strong>HikariDataSource</strong></li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span>PooledDataSourceCondition<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token punctuation">{</span> DataSource<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> XADataSource<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span> DataSourceConfiguration<span class="token punctuation">.</span>Hikari<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> DataSourceConfiguration<span class="token punctuation">.</span>Tomcat<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>         DataSourceConfiguration<span class="token punctuation">.</span>Dbcp2<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> DataSourceConfiguration<span class="token punctuation">.</span>OracleUcp<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>         DataSourceConfiguration<span class="token punctuation">.</span>Generic<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> DataSourceJmxConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PooledDataSourceConfiguration</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><ul><li><p>DataSourceTransactionManagerAutoConfiguration： 事务管理器的自动配置</p></li><li><p>JdbcTemplateAutoConfiguration： <strong>JdbcTemplate的自动配置，可以来对数据库进行crud</strong></p><ul><li><font color=#0000FF >可以修改这个配置项@ConfigurationProperties(prefix = <strong>“spring.jdbc”</strong>)</font> 来修改JdbcTemplate</li><li>@Bean@Primary   JdbcTemplate；容器中有这个组件</li></ul></li><li><p>JndiDataSourceAutoConfiguration： jndi的自动配置</p></li><li><p>XADataSourceAutoConfiguration： 分布式事务相关的</p></li></ul><h4 id="1-1-3-修改配置项"><a href="#1-1-3-修改配置项" class="headerlink" title="1.1.3 修改配置项"></a>1.1.3 修改配置项</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/db_account    <span class="token key atrule">username</span><span class="token punctuation">:</span> root    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver</code></pre><h4 id="1-1-4-测试"><a href="#1-1-4-测试" class="headerlink" title="1.1.4 测试"></a>1.1.4 测试</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token keyword">class</span> <span class="token class-name">Boot05WebAdminApplicationTests</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    JdbcTemplate jdbcTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//      jdbcTemplate.queryForObject("select * from account_tbl")</span><span class="token comment" spellcheck="true">//      jdbcTemplate.queryForList("select * from account_tbl",)</span>        Long aLong <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">queryForObject</span><span class="token punctuation">(</span><span class="token string">"select count(*) from account_tbl"</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"记录总数：{}"</span><span class="token punctuation">,</span>aLong<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="1-2-使用Druid数据源"><a href="#1-2-使用Druid数据源" class="headerlink" title="1.2 使用Druid数据源"></a>1.2 使用Druid数据源</h3><h4 id="1-2-1-druid官方github地址"><a href="#1-2-1-druid官方github地址" class="headerlink" title="1.2.1 druid官方github地址"></a>1.2.1 druid官方github地址</h4><p><a href="https://github.com/alibaba/druid" target="_blank" rel="noopener">https://github.com/alibaba/druid</a></p><p>整合第三方技术的两种方式</p><ul><li>自定义</li><li>找starter</li></ul><h4 id="1-2-2-自定义方式"><a href="#1-2-2-自定义方式" class="headerlink" title="1.2.2 自定义方式"></a>1.2.2 自定义方式</h4><p>1、创建数据源</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">"</span></span>      <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${jdbc.url}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${jdbc.username}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${jdbc.password}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxActive<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>initialSize<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxWait<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>minIdle<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>timeBetweenEvictionRunsMillis<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>60000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>minEvictableIdleTimeMillis<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>testWhileIdle<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>testOnBorrow<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>testOnReturn<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>poolPreparedStatements<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxOpenPreparedStatements<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span></code></pre><p>2、StatViewServlet</p><p>StatViewServlet的用途包括：</p><ul><li>提供监控信息展示的html页面</li><li>提供监控信息的JSON API</li></ul><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>DruidStatView<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>com.alibaba.druid.support.http.StatViewServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>DruidStatView<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/druid/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span></code></pre><p>3、StatFilter</p><p>用于统计监控信息；如SQL监控、URI监控</p><pre class=" language-xml"><code class="language-xml">需要给数据源中配置如下属性；可以允许多个filter，多个用，分割；如：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>filters<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stat,slf4j<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><p>系统中所有filter：</p><table><thead><tr><th>别名</th><th>Filter类名</th></tr></thead><tbody><tr><td>default</td><td>com.alibaba.druid.filter.stat.StatFilter</td></tr><tr><td>stat</td><td>com.alibaba.druid.filter.stat.StatFilter</td></tr><tr><td>mergeStat</td><td>com.alibaba.druid.filter.stat.MergeStatFilter</td></tr><tr><td>encoding</td><td>com.alibaba.druid.filter.encoding.EncodingConvertFilter</td></tr><tr><td>log4j</td><td>com.alibaba.druid.filter.logging.Log4jFilter</td></tr><tr><td>log4j2</td><td>com.alibaba.druid.filter.logging.Log4j2Filter</td></tr><tr><td>slf4j</td><td>com.alibaba.druid.filter.logging.Slf4jLogFilter</td></tr><tr><td>commonlogging</td><td>com.alibaba.druid.filter.logging.CommonsLogFilter</td></tr></tbody></table><p><strong>慢SQL记录配置</strong></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stat-filter<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.alibaba.druid.filter.stat.StatFilter<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>slowSqlMillis<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>logSlowSql<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>使用 slowSqlMillis 定义慢SQL的时长</code></pre><h4 id="1-2-3-使用官方starter方式"><a href="#1-2-3-使用官方starter方式" class="headerlink" title="1.2.3 使用官方starter方式"></a>1.2.3 使用官方starter方式</h4><p>1、引入druid-starter</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.1.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>2、分析自动配置</p><ul><li>扩展配置项 <strong>spring.datasource.druid</strong></li><li>DruidSpringAopConfiguration.<strong>class</strong>,  监控SpringBean的；配置项：<strong>spring.datasource.druid.aop-patterns</strong></li><li>DruidStatViewServletConfiguration.<strong>class</strong>, 监控页的配置：<strong>spring.datasource.druid.stat-view-servlet；默认开启</strong></li><li>DruidWebStatFilterConfiguration.<strong>class</strong>, web监控配置；<strong>spring.datasource.druid.web-stat-filter；默认开启</strong></li><li>DruidFilterConfiguration.<strong>class</strong>}) 所有Druid自己filter的配置</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_STAT_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.stat"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_CONFIG_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.config"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_ENCODING_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.encoding"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_SLF4J_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.slf4j"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_LOG4J_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.log4j"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_LOG4J2_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.log4j2"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_COMMONS_LOG_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.commons-log"</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String FILTER_WALL_PREFIX <span class="token operator">=</span> <span class="token string">"spring.datasource.druid.filter.wall"</span><span class="token punctuation">;</span></code></pre><p>3、配置示例</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/db_account    <span class="token key atrule">username</span><span class="token punctuation">:</span> root    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver    <span class="token key atrule">druid</span><span class="token punctuation">:</span>      <span class="token key atrule">aop-patterns</span><span class="token punctuation">:</span> com.atguigu.admin.*  <span class="token comment" spellcheck="true">#监控SpringBean</span>      <span class="token key atrule">filters</span><span class="token punctuation">:</span> stat<span class="token punctuation">,</span>wall     <span class="token comment" spellcheck="true"># 底层开启功能，stat（sql监控），wall（防火墙）</span>      <span class="token key atrule">stat-view-servlet</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true"># 配置监控页功能</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">login-username</span><span class="token punctuation">:</span> admin        <span class="token key atrule">login-password</span><span class="token punctuation">:</span> admin        <span class="token key atrule">resetEnable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">web-stat-filter</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 监控web</span>        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">urlPattern</span><span class="token punctuation">:</span> /*        <span class="token key atrule">exclusions</span><span class="token punctuation">:</span> <span class="token string">'*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*'</span>      <span class="token key atrule">filter</span><span class="token punctuation">:</span>        <span class="token key atrule">stat</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 对上面filters里面的stat的详细配置</span>          <span class="token key atrule">slow-sql-millis</span><span class="token punctuation">:</span> <span class="token number">1000</span>          <span class="token key atrule">logSlowSql</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">wall</span><span class="token punctuation">:</span>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">config</span><span class="token punctuation">:</span>            <span class="token key atrule">drop-table-allow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre><p>SpringBoot配置示例：<a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter" target="_blank" rel="noopener">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></p><p>配置项列表：<a href="https://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8" target="_blank" rel="noopener">https://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8</a></p><h3 id="1-3-整合MyBatis操作"><a href="#1-3-整合MyBatis操作" class="headerlink" title="1.3 整合MyBatis操作"></a>1.3 整合MyBatis操作</h3><p>mybatis-spring-boot-starter：<a href="https://github.com/mybatis/spring-boot-starter/tree/mybatis-spring-boot-2.1.4" target="_blank" rel="noopener">https://github.com/mybatis/spring-boot-starter/tree/mybatis-spring-boot-2.1.4</a></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h4 id="1-3-1-配置模式"><a href="#1-3-1-配置模式" class="headerlink" title="1.3.1 配置模式"></a>1.3.1 配置模式</h4><ul><li>全局配置文件</li><li>SqlSessionFactory: 自动配置好了</li><li>SqlSession：自动配置了 <strong>SqlSessionTemplate 组合了SqlSession</strong></li><li>@Import(<strong>AutoConfiguredMapperScannerRegistrar</strong>.<strong>class</strong>）；</li><li>Mapper： 只要我们写的操作MyBatis的接口标准了 <strong>@Mapper 就会被自动扫描进来</strong></li></ul><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>MybatisProperties<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> ： MyBatis配置项绑定类。<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> DataSourceAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> MybatisLanguageDriverAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisAutoConfiguration</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"mybatis"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisProperties</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>可以修改配置文件中 mybatis 开始的所有；</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># 配置mybatis规则</span><span class="token key atrule">mybatis</span><span class="token punctuation">:</span>  <span class="token key atrule">config-location</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mybatis/mybatis<span class="token punctuation">-</span>config.xml  <span class="token comment" spellcheck="true">#全局配置文件位置</span>  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mybatis/mapper/*.xml  <span class="token comment" spellcheck="true">#sql映射文件位置</span></code></pre><pre class=" language-java"><code class="language-java">Mapper接口<span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span>绑定Xml<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE mapper        PUBLIC <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>        <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token operator">></span><span class="token operator">&lt;</span>mapper namespace<span class="token operator">=</span><span class="token string">"com.atguigu.admin.mapper.AccountMapper"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>    <span class="token keyword">public</span> Account <span class="token function">getAcct</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"getAcct"</span> resultType<span class="token operator">=</span><span class="token string">"com.atguigu.admin.bean.Account"</span><span class="token operator">></span>        select <span class="token operator">*</span> from  account_tbl where  id<span class="token operator">=</span>#<span class="token punctuation">{</span>id<span class="token punctuation">}</span>    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>mapper<span class="token operator">></span></code></pre><p>配置 <strong>private</strong> Configuration <strong>configuration</strong>; mybatis.<strong>configuration下面的所有，就是相当于改mybatis全局配置文件中的值</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># 配置mybatis规则</span><span class="token key atrule">mybatis</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#  config-location: classpath:mybatis/mybatis-config.xml</span>  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mybatis/mapper/*.xml  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>    <span class="token key atrule">map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 可以不写全局；配置文件，所有全局配置文件的配置都放在configuration配置项中即可</code></pre><ul><li>导入mybatis官方starter</li><li>编写mapper接口。标准@Mapper注解</li><li>编写sql映射文件并绑定mapper接口</li><li>在application.yaml中指定Mapper配置文件的位置，以及指定全局配置文件的信息 （建议；<strong>配置在mybatis.configuration</strong>）</li></ul><h4 id="1-3-2-注解模式"><a href="#1-3-2-注解模式" class="headerlink" title="1.3.2 注解模式"></a>1.3.2 注解模式</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Mapper</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CityMapper</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from city where id=#{id}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> City <span class="token function">getById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>City city<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="1-3-3-混合模式"><a href="#1-3-3-混合模式" class="headerlink" title="1.3.3 混合模式"></a>1.3.3 混合模式</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Mapper</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CityMapper</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from city where id=#{id}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> City <span class="token function">getById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>City city<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>最佳实战：</strong></p><ul><li>引入mybatis-starter</li><li><strong>配置application.yaml中，指定mapper-location位置即可</strong></li><li>编写Mapper接口并标注@Mapper注解</li><li>简单方法直接注解方式</li><li>复杂方法编写mapper.xml进行绑定映射</li><li><font color=#FF0000 >@MapperScan(“com.atguigu.admin.mapper”) 简化，</font>其他的接口就可以不用标注@Mapper注解</li></ul><h3 id="1-4-整合MyBatis-Plus完成CRUD"><a href="#1-4-整合MyBatis-Plus完成CRUD" class="headerlink" title="1.4 整合MyBatis-Plus完成CRUD"></a>1.4 整合MyBatis-Plus完成CRUD</h3><h4 id="1-4-1-什么是MyBatis-Plus"><a href="#1-4-1-什么是MyBatis-Plus" class="headerlink" title="1.4.1 什么是MyBatis-Plus"></a>1.4.1 什么是MyBatis-Plus</h4><p><a href="https://github.com/baomidou/mybatis-plus" target="_blank" rel="noopener">MyBatis-Plus</a>（简称 MP）是一个 <a href="http://www.mybatis.org/mybatis-3/" target="_blank" rel="noopener">MyBatis</a> 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p><p><a href="https://baomidou.com/" target="_blank" rel="noopener">mybatis plus 官网</a></p><p>建议安装 <strong>MybatisX</strong> 插件 </p><h4 id="1-4-2-整合MyBatis-Plus"><a href="#1-4-2-整合MyBatis-Plus" class="headerlink" title="1.4.2 整合MyBatis-Plus"></a>1.4.2 整合MyBatis-Plus</h4><p>MyBatis-Plus中已引入 数据库启动项和mybatis启动项，所以这两个不需要再次导入</p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- MyBatis-Plus启动项 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${mybatis-plus-starter.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>自动配置</p><ul><li>MybatisPlusAutoConfiguration 配置类，MybatisPlusProperties 配置项绑定。<strong>mybatis-plus：xxx 就是对mybatis-plus的定制</strong></li><li><strong>SqlSessionFactory 自动配置好。底层是容器中默认的数据源</strong></li><li><strong>mapperLocations 自动配置好的。有默认值</strong>。<strong>classpath:/mapper/ * */.xml</strong>；任意包的类路径下的所有mapper文件夹下任意路径下的所有xml都是sql映射文件。  <font color=#FF0000 >建议以后sql映射文件，放在 mapper下</font></li><li><strong>容器中也自动配置好了</strong> <strong>SqlSessionTemplate</strong></li><li><strong>@Mapper 标注的接口也会被自动扫描；建议直接</strong> @MapperScan(<strong>“com.atguigu.admin.mapper”</strong>) 批量扫描就行</li></ul><h4 id="1-4-3-CRUD功能"><a href="#1-4-3-CRUD功能" class="headerlink" title="1.4.3 CRUD功能"></a>1.4.3 CRUD功能</h4><p>1、mapper接口</p><p>只需要我们的Mapper继承 <strong>BaseMapper</strong> 就可以拥有crud能力</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 使用MyBatisPlus时，mapper接口只要继承BaseMapper即可，不需要再写接口方法 * BaseMapper 中的泛型是要操作的实体类 */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>2、service接口及其实现类</p><p>只需要我们的Service继承 <strong>IService</strong> 就可以拥有CRUD能力，不需要我们再写接口<br>只需要我们的ServiceImpl继承 <strong>ServiceImpl</strong>,并实现Service接口，就可以拥有CRUD能力，不需要写方法</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 使用MyBatisPlus时，service接口只要继承IService即可，不需要再写接口方法 * IService 中的泛型是要操作的实体类 */</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 使用MyBatisPlus时，serviceImpl实现类只要继承ServiceImpl即可，不需要再写方法 * ServiceImpl 中的泛型，第一个是自定义的mapper接口，第二个是要操作的实体类 */</span><span class="token annotation punctuation">@Service</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token operator">&lt;</span>UserMapper<span class="token punctuation">,</span>User<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>3、controller控制器</p><ul><li><font color=#FF0000 >RedirectAttributes</font>：设置重定向携带的参数</li><li>删除请求中携带当前页码，删除后重定向到当前页</li></ul><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{/delete/{id}(id<span class="token punctuation">=</span>${user.id},pn<span class="token punctuation">=</span>${users.current}) }<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>对应的URL：/delete/1?pn=3</code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * 删除操作     * 删除请求中携带当前页码，删除后重定向到当前页     * RedirectAttributes   设置重定向携带的参数     * @param id     * @return     */</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/delete/{id}"</span><span class="token punctuation">)</span><span class="token keyword">public</span> String <span class="token function">deleteUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"id"</span><span class="token punctuation">)</span> Long id<span class="token punctuation">,</span>                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pn"</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> Integer pn<span class="token punctuation">,</span>                         RedirectAttributes redirectAttributes<span class="token punctuation">)</span><span class="token punctuation">{</span>    userServiceImpl<span class="token punctuation">.</span><span class="token function">removeById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 设置重定向携带参数，自动以URI方式添加进去</span>    redirectAttributes<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"pn"</span><span class="token punctuation">,</span>pn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">"redirect:/dynamic_table"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"dynamic_table"</span><span class="token punctuation">)</span><span class="token keyword">public</span> String <span class="token function">dynamic_table</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pn"</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> Integer pn<span class="token punctuation">,</span> Model model<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 构造分页参数</span>    <span class="token keyword">int</span> pageStart <span class="token operator">=</span> pn<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 分页开始页从请求中获取</span>    <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// 分页大小默认值为2</span>    Page<span class="token operator">&lt;</span>User<span class="token operator">></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>pageStart<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 调用page分页</span>    Page<span class="token operator">&lt;</span>User<span class="token operator">></span> userPage <span class="token operator">=</span> userServiceImpl<span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//        userPage.getPages();    // 当前分页的总数</span>    <span class="token comment" spellcheck="true">//        userPage.getCurrent();  // 获取当前页数</span>    <span class="token comment" spellcheck="true">//        userPage.getTotal();    // 获取数据库中的总记录数</span>    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">,</span>userPage<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">"table/dynamic_table"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="二、NoSQL"><a href="#二、NoSQL" class="headerlink" title="二、NoSQL"></a>二、NoSQL</h2><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、<strong>缓存</strong>和消息中间件。 它支持多种类型的数据结构，如 <a href="http://www.redis.cn/topics/data-types-intro.html#strings" target="_blank" rel="noopener">字符串（strings）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#hashes" target="_blank" rel="noopener">散列（hashes）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#lists" target="_blank" rel="noopener">列表（lists）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#sets" target="_blank" rel="noopener">集合（sets）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets" target="_blank" rel="noopener">有序集合（sorted sets）</a> 与范围查询， <a href="http://www.redis.cn/topics/data-types-intro.html#bitmaps" target="_blank" rel="noopener">bitmaps</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#hyperloglogs" target="_blank" rel="noopener">hyperloglogs</a> 和 <a href="http://www.redis.cn/commands/geoadd.html" target="_blank" rel="noopener">地理空间（geospatial）</a> 索引半径查询。 Redis 内置了 <a href="http://www.redis.cn/topics/replication.html" target="_blank" rel="noopener">复制（replication）</a>，<a href="http://www.redis.cn/commands/eval.html" target="_blank" rel="noopener">LUA脚本（Lua scripting）</a>， <a href="http://www.redis.cn/topics/lru-cache.html" target="_blank" rel="noopener">LRU驱动事件（LRU eviction）</a>，<a href="http://www.redis.cn/topics/transactions.html" target="_blank" rel="noopener">事务（transactions）</a> 和不同级别的 <a href="http://www.redis.cn/topics/persistence.html" target="_blank" rel="noopener">磁盘持久化（persistence）</a>， 并通过 <a href="http://www.redis.cn/topics/sentinel.html" target="_blank" rel="noopener">Redis哨兵（Sentinel）</a>和自动 <a href="http://www.redis.cn/topics/cluster-tutorial.html" target="_blank" rel="noopener">分区（Cluster）</a>提供高可用性（high availability）。</p><h3 id="2-1-Redis自动配置"><a href="#2-1-Redis自动配置" class="headerlink" title="2.1 Redis自动配置"></a>2.1 Redis自动配置</h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>自动配置：</p><ul><li>RedisAutoConfiguration 自动配置类。RedisProperties 属性类 –&gt; <strong>spring.redis.xxx是对redis的配置</strong></li><li>连接工厂是准备好的。<strong>Lettuce</strong>ConnectionConfiguration、<strong>Jedis</strong>ConnectionConfiguration</li><li><strong>自动注入了RedisTemplate</strong>&lt;<strong>Object</strong>, <strong>Object</strong>&gt; ： xxxTemplate；</li><li><strong>自动注入了StringRedisTemplate；k：v都是String</strong></li><li><strong>key：value</strong></li><li><strong>底层只要我们使用</strong> <strong>StringRedisTemplate、RedisTemplate就可以操作redis</strong></li></ul><h3 id="2-4-redis集群环境搭建"><a href="#2-4-redis集群环境搭建" class="headerlink" title="2.4 redis集群环境搭建"></a>2.4 redis集群环境搭建</h3><p>在CentOS中搭建Redis集群</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 配置Redis集群</span>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>      <span class="token key atrule">nodes</span><span class="token punctuation">:</span> 192.168.195.130<span class="token punctuation">:</span><span class="token number">7001</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7002</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7003</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7004</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7005</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7006</span>      <span class="token key atrule">max-redirects</span><span class="token punctuation">:</span> <span class="token number">2</span></code></pre><h3 id="2-3-RedisTemplate与Lettuce"><a href="#2-3-RedisTemplate与Lettuce" class="headerlink" title="2.3 RedisTemplate与Lettuce"></a>2.3 RedisTemplate与Lettuce</h3><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@SpringBootTest</span><span class="token keyword">class</span> <span class="token class-name">Boot05WebAdminApplicationTests</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    StringRedisTemplate redisTemplate<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">testRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        ValueOperations<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        operations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String a <span class="token operator">=</span> operations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-4-切换至jedis"><a href="#2-4-切换至jedis" class="headerlink" title="2.4 切换至jedis"></a>2.4 切换至jedis</h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!--导入jedis--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 配置Redis集群</span>  <span class="token key atrule">redis</span><span class="token punctuation">:</span>    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>      <span class="token key atrule">nodes</span><span class="token punctuation">:</span> 192.168.195.130<span class="token punctuation">:</span><span class="token number">7001</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7002</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7003</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7004</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7005</span><span class="token punctuation">,</span>192.168.195.130<span class="token punctuation">:</span><span class="token number">7006</span>      <span class="token key atrule">max-redirects</span><span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token key atrule">client-type</span><span class="token punctuation">:</span> jedis    <span class="token key atrule">jedis</span><span class="token punctuation">:</span>      <span class="token key atrule">pool</span><span class="token punctuation">:</span>        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">10</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
            <tag> Java框架 </tag>
            
            <tag> 数据访问 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搜索技巧</title>
      <link href="/2021/03/15/sou-suo-ji-qiao/"/>
      <url>/2021/03/15/sou-suo-ji-qiao/</url>
      
        <content type="html"><![CDATA[<h2 id="1-谷歌搜索"><a href="#1-谷歌搜索" class="headerlink" title="1 谷歌搜索"></a>1 谷歌搜索</h2><ol><li><p><font color=#FF0000 >双引号</font>：精确匹配</p></li><li><p>OR：或者。包含一个关键字即可</p></li><li><p>AND：必须同时包含两个关键字</p></li><li><p><font color=#FF0000 >减号 —</font>：不包含减号后面的关键字</p></li><li><p>通配符 *：代替任何字</p></li><li><p>括号 ()：同时使用多个命令符号时会用到</p></li><li><p>define：查询词汇的定义</p></li><li><p><font color=#FF0000 >减号 —</font>：找特定类型的文件</p><pre class=" language-xml"><code class="language-xml">谷歌搜索 filetype:ppt</code></pre></li><li><p><font color=#FF0000 >site</font>：指定网站搜索</p><pre class=" language-xml"><code class="language-xml">bilibili site:xinhuanet.com</code></pre></li><li><p><font color=#FF0000 >intitle</font>：网页标题搜索</p></li><li><p>allintitle：网页标题包含以下所有关键词</p><pre class=" language-xml"><code class="language-xml">allintitle 诸葛亮 王司徒</code></pre></li><li><p><font color=#FF0000 >inurl</font>：网址中包含特定词</p></li><li><p>allinurl：网址中包含以下所有词</p><pre class=" language-xml"><code class="language-xml">allinurl:apple iphone</code></pre></li><li><p><font color=#FF0000 >intext</font>：只找网页里的文字（不搜索标题、网址等其他部分）</p></li><li><p>allintext：只找网页里的文字</p></li><li><p>AROUND(X)：两个词距离在X之内</p><pre class=" language-xml"><code class="language-xml">apple around(4) iphone搜到的是apple和iphone两个词距离不超过4的结果</code></pre></li><li><p>weather：查天气</p><p>stocks：查估计</p><p>map：查地图</p><p>movie：查电影</p><p>in：算汇率</p></li></ol><h2 id="2-GitHub搜索"><a href="#2-GitHub搜索" class="headerlink" title="2 GitHub搜索"></a>2 GitHub搜索</h2><h3 id="2-1-常用词含义"><a href="#2-1-常用词含义" class="headerlink" title="2.1 常用词含义"></a>2.1 常用词含义</h3><ul><li><code>watch</code>：会持续收到该项目的动态</li><li><code>fork</code>：复制某个仓库到自己的GitHub仓库中</li><li><code>star</code>：可以理解为点赞</li><li><code>clone</code>：将项目下载到本地</li><li><code>follow</code>：关注你感兴趣的作者，会受到他们的动态</li></ul><h3 id="2-2-in-关键字限制搜索范围"><a href="#2-2-in-关键字限制搜索范围" class="headerlink" title="2.2 in 关键字限制搜索范围"></a>2.2 in 关键字限制搜索范围</h3><ul><li><p><font color='red'>公式：XXX（关键字）<code>in:name</code> 或 <code>in:description</code> 或 <code>in:readme</code></font></p></li><li><p>xxx in:name            仓库标题中包含xxx关键字的</p></li><li><p>xxx in:description  仓库描述中包含xxx关键字的</p></li><li><p>xxx in:readme        项目的readme文件中包含xxx关键字的</p></li><li><p>组合使用，中间用 , 隔开</p><ul><li>xxx  in:name,readme    </li></ul><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618104701.png" style="zoom:80%;" /></li></ul><h3 id="2-3-stars或forks数量关键字查找"><a href="#2-3-stars或forks数量关键字查找" class="headerlink" title="2.3  stars或forks数量关键字查找"></a>2.3  stars或forks数量关键字查找</h3><ul><li><p>公式：</p><ul><li><font color='red'>xxx（关键字） <code>stars:&gt;数字</code>（或是<code>stars:&gt;=数字</code>）</font></li><li><font color='red'>区间范围关键字：<code>stars:数字1..数字2</code></font></li></ul></li><li><p>组合使用，用空格隔开</p></li><li><p>案例</p><ul><li><p>查找stars数大于等于5000的Springboot项目</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618105405.png" style="zoom:67%;" /></li><li><p>查找forks数在1000~2000之间的springboot项目</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618105528.png" style="zoom:67%;" /></li><li><p>查找star大于1000，fork数在500到1000的springboot项目</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618105704.png" style="zoom:67%;" /></li></ul></li></ul><h3 id="2-4-awesome加强搜索"><a href="#2-4-awesome加强搜索" class="headerlink" title="2.4  awesome加强搜索"></a>2.4  awesome加强搜索</h3><ul><li><p><font color='red'>公式：<code>awesome  关键字</code> ：awesome系列，一般用来收集学习、工具、书籍类相关的项目</font></p></li><li><p>案例</p><ul><li><p>搜索优秀的redis相关的项目，包括框架，教程等 </p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618110011.png" style="zoom:67%;" /></li></ul></li></ul><h3 id="2-5-高亮显示某行代码"><a href="#2-5-高亮显示某行代码" class="headerlink" title="2.5 高亮显示某行代码"></a>2.5 高亮显示某行代码</h3><ul><li><p><font color='red'>高亮显示一行：地址后面紧跟 #L行号</font></p><ul><li><p>比如高亮显示下面找到的代码的第 17 行</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618110649.png" style="zoom:67%;" /></li><li><p>需要复制上方的网址，然后再网址后面加上#L17</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618110838.png" alt="" style="zoom:80%;" /></li></ul></li><li><p><font color='red'>高亮显示多行：地址后面紧跟#L行号1-L行号2</font></p><ul><li><p>比如高亮显示上面找到的代码的第 17 行到第 30 行</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618111218.png" style="zoom:80%;" /></li></ul></li></ul><h3 id="2-6-项目内搜索"><a href="#2-6-项目内搜索" class="headerlink" title="2.6 项目内搜索"></a>2.6 项目内搜索</h3><ul><li><p>在仓库首页，按下英文字母 <code>t</code> ,开启项目内搜索</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618111353.png" style="zoom:67%;" /></li><li><p>浏览器安装Octotree插件</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618111451.png" style="zoom:67%;" /></li></ul><h3 id="2-7-搜索某个地区内的大佬"><a href="#2-7-搜索某个地区内的大佬" class="headerlink" title="2.7  搜索某个地区内的大佬"></a>2.7  搜索某个地区内的大佬</h3><ul><li>location：地区</li><li>language：语言</li><li>例如：<code>location:wuhan language:java</code></li></ul><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210618111719.png" style="zoom:67%;" /><h3 id="2-8-其他"><a href="#2-8-其他" class="headerlink" title="2.8 其他"></a>2.8 其他</h3><h4 id="2-8-1-明确搜索仓库大小的"><a href="#2-8-1-明确搜索仓库大小的" class="headerlink" title="2.8.1 明确搜索仓库大小的"></a>2.8.1 明确搜索仓库大小的</h4><ul><li>公式：<font color='red'>关键字 size:&gt;=5000(单位是k)</font></li></ul><h4 id="2-8-2-明确仓库是否还在更新维护"><a href="#2-8-2-明确仓库是否还在更新维护" class="headerlink" title="2.8.2 明确仓库是否还在更新维护"></a>2.8.2 明确仓库是否还在更新维护</h4><ul><li>直接指定<strong>更新时间</strong>在哪个时间前或后的：<font color='red'>关键字 pushed:&gt;2021-01-03 </font></li></ul><h4 id="2-8-3-明确搜索仓库的-LICENSE"><a href="#2-8-3-明确搜索仓库的-LICENSE" class="headerlink" title="2.8.3 明确搜索仓库的 LICENSE"></a>2.8.3 明确搜索仓库的 LICENSE</h4><ul><li>要找协议是最为宽松的 Apache License 2 的代码，可以这样：<font color='red'>关键字 license:apache-2.0</font></li></ul><h4 id="2-8-4-明确搜索某个人或组织的仓库"><a href="#2-8-4-明确搜索某个人或组织的仓库" class="headerlink" title="2.8.4 明确搜索某个人或组织的仓库"></a>2.8.4 明确搜索某个人或组织的仓库</h4><ul><li><p><font color='red'>找某个人的代码：<strong>user</strong>:joshlong</font></p></li><li><p><font color='red'>多个查询之间「空格」分隔：<strong>user</strong>:joshlong <strong>language</strong>:java</font></p></li><li><p>找某个组织的代码：<strong>org</strong>:spring-cloud</p></li></ul><h3 id="2-9-注意事项"><a href="#2-9-注意事项" class="headerlink" title="2.9 注意事项"></a>2.9 注意事项</h3><p>(1) <strong>冒号两侧不能有空格</strong>；</p><p>(2) <strong>多个查询之间「空格」分隔</strong></p><p>(3) <strong>不区分大小写</strong>；</p><p>(4) <strong>不能将以下通配符用作搜索查询的一部分</strong>，<strong>搜索将忽略这些符号</strong>：. , : ; / \ ` ‘ “ = * ! ? # $ &amp; + ^ | ~ &lt; &gt; ( ) { } [ ]；</p><p>(5) <strong>搜索默认为master分支。</strong></p>]]></content>
      
      
      <categories>
          
          <category> 搜索技巧 </category>
          
          <category> GitHub </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搜索技巧 </tag>
            
            <tag> 谷歌 </tag>
            
            <tag> GitHub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【SpringBoot】03-SpringBoot-Web开发</title>
      <link href="/2021/03/13/springboot-03-springboot-web-kai-fa/"/>
      <url>/2021/03/13/springboot-03-springboot-web-kai-fa/</url>
      
        <content type="html"><![CDATA[<h2 id="一、配置文件"><a href="#一、配置文件" class="headerlink" title="一、配置文件"></a>一、配置文件</h2><h3 id="1-1-文件类型"><a href="#1-1-文件类型" class="headerlink" title="1.1 文件类型"></a>1.1 文件类型</h3><h4 id="1-1-1-properties类型"><a href="#1-1-1-properties类型" class="headerlink" title="1.1.1 properties类型"></a>1.1.1 properties类型</h4><h4 id="1-1-2-yaml类型"><a href="#1-1-2-yaml类型" class="headerlink" title="1.1.2 yaml类型"></a>1.1.2 yaml类型</h4><p>1、yaml简介</p><p>&emsp;&emsp;YAML非常适合用来做以数据为中心的配置文件。</p><p>2、基本语法</p><ul><li>key: value；<font color=#FF0000 >kv之间有空格(：后面都有一个空格)</font></li><li>大小写敏感</li><li>使用缩进表示层级关系，缩进不允许使用tab，<font color=#FF0000 >只允许空格</font></li><li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li><li>‘#’表示注释</li><li>字符串无需加引号，如果要加，<font color=#FF0000 >‘’和””表示字符串内容 会被 转义/不转义</font></li></ul><p>3、数据类型</p><ul><li>字面量：单个的、不可再分的值。data、Boolean、string、number、null</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">k</span><span class="token punctuation">:</span> v</code></pre><ul><li>对象：键值对的集合。map、hash、set、object </li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># 第一种写法：行内写法</span><span class="token key atrule">k</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">k1</span><span class="token punctuation">:</span> v1<span class="token punctuation">,</span><span class="token key atrule">k2</span><span class="token punctuation">:</span> v2<span class="token punctuation">,</span><span class="token key atrule">k3</span><span class="token punctuation">:</span> v3<span class="token punctuation">}</span><span class="token comment" spellcheck="true"># 第二种写法</span><span class="token key atrule">k</span><span class="token punctuation">:</span>   <span class="token key atrule">k1</span><span class="token punctuation">:</span> v1  <span class="token key atrule">k2</span><span class="token punctuation">:</span> v2  <span class="token key atrule">k3</span><span class="token punctuation">:</span> v3</code></pre><ul><li>数组：一组按次序排列的值。array、list、queue</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># 第一种写法：行内写法</span><span class="token key atrule">k</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>v1<span class="token punctuation">,</span>v2<span class="token punctuation">,</span>v3<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># 第二种写法</span><span class="token key atrule">k</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> v1 <span class="token punctuation">-</span> v2 <span class="token punctuation">-</span> v3</code></pre><p>4、代码示例</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@ToString</span><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"person"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 配置yaml中的前缀</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> Boolean boss<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date birth<span class="token punctuation">;</span>    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>    <span class="token keyword">private</span> Pet pet<span class="token punctuation">;</span>    <span class="token keyword">private</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> interests<span class="token punctuation">;</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> animal<span class="token punctuation">;</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> score<span class="token punctuation">;</span>    <span class="token keyword">private</span> Set<span class="token operator">&lt;</span>Double<span class="token operator">></span> salarys<span class="token punctuation">;</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Pet<span class="token operator">>></span> allPets<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@ToString</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pet</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> Double weight<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># yaml表示以上对象</span><span class="token comment" spellcheck="true">#  单引号会将 \n作为字符串输出   双引号会将\n 作为换行输出</span><span class="token comment" spellcheck="true">#  双引号不会转义，单引号会转义</span><span class="token key atrule">person</span><span class="token punctuation">:</span>  <span class="token key atrule">userName</span><span class="token punctuation">:</span> 张三  <span class="token key atrule">boss</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">birth</span><span class="token punctuation">:</span> 2019/12/12 20<span class="token punctuation">:</span><span class="token datetime number">12:33</span>  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">18</span>  <span class="token comment" spellcheck="true"># 数组有两种表示方式</span>  <span class="token key atrule">interests</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>篮球<span class="token punctuation">,</span>足球<span class="token punctuation">]</span>  <span class="token key atrule">animal</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> jerry    <span class="token punctuation">-</span> mario  <span class="token comment" spellcheck="true"># 键值型的也有两种表示方式</span>  <span class="token key atrule">score</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">English</span><span class="token punctuation">:</span> <span class="token number">99</span><span class="token punctuation">,</span><span class="token key atrule">Math</span><span class="token punctuation">:</span> <span class="token number">88</span><span class="token punctuation">}</span>  <span class="token key atrule">salarys</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3999</span><span class="token punctuation">,</span><span class="token number">4999.98</span><span class="token punctuation">,</span><span class="token number">5999.99</span><span class="token punctuation">]</span>  <span class="token key atrule">pet</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat    <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">23.4</span>  <span class="token key atrule">allPets</span><span class="token punctuation">:</span>    <span class="token key atrule">sick</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">,</span><span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">47</span><span class="token punctuation">}</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jerry        <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">46</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 阿狗        <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">66</span>    <span class="token key atrule">health</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token key atrule">name</span><span class="token punctuation">:</span> mario<span class="token punctuation">,</span><span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">47</span><span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><h3 id="1-2-配置提示"><a href="#1-2-配置提示" class="headerlink" title="1.2 配置提示"></a>1.2 配置提示</h3><p>&emsp;&emsp;自定义的类和配置文件绑定一般没有提示。</p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 自定义的类和配置文件绑定 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- 简化部署：项目打成jar包 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token comment" spellcheck="true">&lt;!-- 打包的时候去除掉自定义类，减小文件大小 --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></code></pre><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210315094501.jpg" style="zoom: 50%;" /><h2 id="二、Web开发—SpringMVC自动配置概览"><a href="#二、Web开发—SpringMVC自动配置概览" class="headerlink" title="二、Web开发—SpringMVC自动配置概览"></a>二、Web开发—SpringMVC自动配置概览</h2><p>SpringBoot已经帮我们自动配置好了SpringMVC的大多场景。自动配置项包括以下内容：</p><ul><li><p>内容协商视图解析器和BeanName视图解析器</p></li><li><p>静态资源（包括webjars），详见</p></li></ul><ul><li><p>自动注册 <code>Converter，GenericConverter，Formatter</code></p></li><li><p>支持 <code>HttpMessageConverters</code> （配合内容协商理解原理），官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-message-converters" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-message-converters</a></p></li><li><p>自动注册 <code>MessageCodesResolver</code> （国际化用）</p></li><li><p>静态index.html 页支持</p></li><li><p>自定义 <code>Favicon</code>  ，官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-favicon" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-favicon</a></p></li><li><p>自动使用 <code>ConfigurableWebBindingInitializer</code> ，（DataBinder负责将请求数据绑定到JavaBean上），官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-web-binding-initializer" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-web-binding-initializer</a></p></li></ul><hr><blockquote><p>If you want to keep those Spring Boot MVC customizations and make more <a href="https://docs.spring.io/spring/docs/5.2.9.RELEASE/spring-framework-reference/web.html#mvc" target="_blank" rel="noopener">MVC customizations</a> (interceptors, formatters, view controllers, and other features), you can add your own <code>@Configuration</code> class of type <code>WebMvcConfigurer</code> but <strong>without</strong> <code>@EnableWebMvc</code>.</p><p><strong>不用@EnableWebMvc注解。使用</strong> <strong><code>@Configuration</code></strong> <strong>+</strong> <strong><code>WebMvcConfigurer</code></strong> <strong>自定义规则</strong></p></blockquote><blockquote><p>If you want to provide custom instances of <code>RequestMappingHandlerMapping</code>, <code>RequestMappingHandlerAdapter</code>, or <code>ExceptionHandlerExceptionResolver</code>, and still keep the Spring Boot MVC customizations, you can declare a bean of type <code>WebMvcRegistrations</code> and use it to provide custom instances of those components.</p><p><strong>声明</strong> <strong><code>WebMvcRegistrations</code></strong> <strong>改变默认底层组件</strong></p></blockquote><blockquote><p>If you want to take complete control of Spring MVC, you can add your own <code>@Configuration</code> annotated with <code>@EnableWebMvc</code>, or alternatively add your own <code>@Configuration</code>-annotated <code>DelegatingWebMvcConfiguration</code> as described in the Javadoc of <code>@EnableWebMvc</code>.</p><p><strong>使用</strong> <strong><code>@EnableWebMvc+@Configuration+DelegatingWebMvcConfiguration 全面接管SpringMVC</code></strong></p></blockquote><h2 id="三、Web开发—简单功能分析"><a href="#三、Web开发—简单功能分析" class="headerlink" title="三、Web开发—简单功能分析"></a>三、Web开发—简单功能分析</h2><h3 id="3-1-静态资源访问"><a href="#3-1-静态资源访问" class="headerlink" title="3.1 静态资源访问"></a>3.1 静态资源访问</h3><h4 id="3-1-1-静态资源目录"><a href="#3-1-1-静态资源目录" class="headerlink" title="3.1.1  静态资源目录"></a>3.1.1  静态资源目录</h4><p>只要静态资源放在类路径(main/resources)下：  <code>/static</code> (or <code>/public</code> or <code>/resources</code> or <code>/META-INF/resources</code></p><p>访问方式： 当前项目根路径/ + 静态资源名 </p><p>原理： 默认静态资源映射为/**。<font color=#FF0000 >请求进来，先去找Controller看能不能处理。不能处理的所有请求又都交给静态资源处理器。</font>静态资源也找不到则响应404页面。</p><p>可以改变默认的静态资源路径，目的在于以后配置的拦截器，放行固定前缀的静态资源，只拦截动态资源</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">mvc</span><span class="token punctuation">:</span>      <span class="token key atrule">static-locations</span><span class="token punctuation">:</span> /res/**        <span class="token comment" spellcheck="true"># 以后静态资源访问都要加上/res/，才能正常访问</span>  <span class="token comment" spellcheck="true"># 修改静态资源的默认路径，默认是在static文件夹下，一般不推荐使用</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">static-locations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>classpath<span class="token punctuation">:</span>/haha/<span class="token punctuation">]</span>    <span class="token comment" spellcheck="true"># 将这些静态资源都放在指定文件夹下面，方便后面拦截器的操作</span></code></pre><h4 id="3-1-2-静态资源访问前缀"><a href="#3-1-2-静态资源访问前缀" class="headerlink" title="3.1.2 静态资源访问前缀"></a>3.1.2 静态资源访问前缀</h4><p>默认访问是没有前缀的，访问路径为：当前项目 + 静态资源名 </p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">mvc</span><span class="token punctuation">:</span>      <span class="token key atrule">static-locations</span><span class="token punctuation">:</span> /res/**        <span class="token comment" spellcheck="true"># 以后静态资源访问都要加上/res/，才能正常访问</span></code></pre><p>加上前缀后，访问路径：当前项目 + static-path-pattern + 静态资源名 = 静态资源文件夹下找</p><h4 id="3-1-3-webjar"><a href="#3-1-3-webjar" class="headerlink" title="3.1. 3 webjar"></a>3.1. 3 webjar</h4><p>webjar就是将前端的静态资源：比如说jquery、bootstarp等资源以jar包的方式导入。</p><p>自动映射为：/<a href="http://localhost:8080/webjars/jquery/3.5.1/jquery.js" target="_blank" rel="noopener">webjars</a>/**</p><p>详细了解：<a href="https://www.webjars.org/" target="_blank" rel="noopener">https://www.webjars.org/</a></p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.webjars<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jquery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>访问地址：<a href="http://localhost:8080/webjars/jquery/3.5.1/jquery.js" target="_blank" rel="noopener">http://localhost:8080/webjars/<strong>jquery/3.5.1/jquery.js</strong></a>  后面地址要按照依赖里面的包路径</p><h3 id="3-2-欢迎页支持"><a href="#3-2-欢迎页支持" class="headerlink" title="3.2 欢迎页支持"></a>3.2 欢迎页支持</h3><ul><li>第一种方法：静态资源路径下的index.html<ul><li>可以配置静态资源路径</li><li><font color=#FF0000 >但不可以配置静态资源的访问前缀。否则会导致index.html不能被默认访问。</font></li></ul></li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">mvc</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 配置静态资源的访问前缀static</span>    <span class="token comment" spellcheck="true"># 一旦配置了这个，就会使 welcome page 功能失效（即欢迎页不能展示）</span><span class="token comment" spellcheck="true">#    static-path-pattern: /static/**</span>  <span class="token comment" spellcheck="true"># 修改静态资源的默认路径，默认是在static文件夹下，一般不推荐使用</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">static-locations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>classpath<span class="token punctuation">:</span>/haha/<span class="token punctuation">]</span></code></pre><ul><li>第二种方法：controller能处理/index，然后跳转到index.html页面</li></ul><h3 id="3-3-自定义Favicon"><a href="#3-3-自定义Favicon" class="headerlink" title="3.3 自定义Favicon"></a>3.3 自定义Favicon</h3><p>网站左上角的小图标。只需要将favicon.ico 放在静态资源目录下。同样不可以配置静态资源的访问前缀。</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#  mvc:</span><span class="token comment" spellcheck="true">#    static-path-pattern: /res/**   这个会导致 Favicon 功能失效</span></code></pre><h3 id="3-4-静态资源配置原理"><a href="#3-4-静态资源配置原理" class="headerlink" title="3.4 静态资源配置原理"></a>3.4 静态资源配置原理</h3><h2 id="四、Web开发—请求参数处理"><a href="#四、Web开发—请求参数处理" class="headerlink" title="四、Web开发—请求参数处理"></a>四、Web开发—请求参数处理</h2><h3 id="4-1-请求映射"><a href="#4-1-请求映射" class="headerlink" title="4.1 请求映射"></a>4.1 请求映射</h3><h4 id="4-1-1-rest使用与原理"><a href="#4-1-1-rest使用与原理" class="headerlink" title="4.1.1 rest使用与原理"></a>4.1.1 rest使用与原理</h4><ul><li>@xxxMapping；</li><li>Rest风格支持（<strong>使用HTTP请求方式动词</strong>来表示对资源的操作）<ul><li><em>以前：**/getUser</em>  <em>获取用户</em>   <em>/deleteUser</em> <em>删除用户</em>   <em>/editUser</em>  <em>修改用户</em>    <em>/saveUser</em> <em>保存用户</em></li><li>现在： /user   <strong>GET</strong>-获取用户  <strong>DELETE</strong>-删除用户   <strong>PUT</strong>-修改用户    <strong>POST</strong>-保存用户</li><li>核心Filter：HiddenHttpMethodFilter<ul><li>用法： <font color=#FF0000 >表单method=post，隐藏域 _method=put</font></li><li>SpringBoot中<font color=#FF0000 >手动开启</font></li></ul></li><li>也可以把_method 这个名字换成我们自己喜欢的。</li></ul></li></ul><p>1、controller代码</p><pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/user"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"GET-张三"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/user"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"POST-张三"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/user"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>PUT<span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">putUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"PUT-张三"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/user"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>DELETE<span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">deleteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"DELETE-张三"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>2、配置类WebConfig代码</p><p>所有修改SpringBoot默认配置的代码，全部写在Config类中。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//自定义filter</span><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * HiddenHttpMethodFilter 中默认的MethodParam是_method     * 可以通过自定义hiddenHttpMethodFilter，将其设置为_m     * @return     */</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> HiddenHttpMethodFilter <span class="token function">hiddenHttpMethodFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        HiddenHttpMethodFilter methodFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiddenHttpMethodFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        methodFilter<span class="token punctuation">.</span><span class="token function">setMethodParam</span><span class="token punctuation">(</span><span class="token string">"_m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> methodFilter<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>3、配置文件中开启rest功能</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">mvc</span><span class="token punctuation">:</span>    <span class="token key atrule">hiddenmethod</span><span class="token punctuation">:</span>      <span class="token key atrule">filter</span><span class="token punctuation">:</span>      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true   </span><span class="token comment" spellcheck="true"># 开启页面表单的 Rest功能</span></code></pre><p>4、Rest原理（<strong>表单提交要使用REST的时候</strong>）</p><ul><li>表单提交会带上<strong>_method=PUT</strong><ul><li><strong>需要在表单提交按钮前加上下面这一句话</strong></li></ul></li></ul><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_method<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>delete<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></code></pre><ul><li><strong>请求过来</strong>被<strong>HiddenHttpMethodFilter</strong>拦截<ul><li>请求正常，并且是POST<ul><li>获取到<strong>_method</strong>的值，或是通过自定义hiddenHttpMethodFilter设置的_m的值。</li><li>兼容以下请求：<strong>PUT</strong>.<strong>DELETE</strong>.<strong>PATCH</strong></li><li><strong>原生request（post），包装模式requestWrapper重写了getMethod方法，返回的是传入的值。</strong></li><li><strong>过滤器链放行的时候用wrapper。以后的方法调用getMethod是调用requesWrapper的。</strong></li></ul></li></ul></li></ul><p><font color=#0000FF >Rest使用客户端工具，如PostMan直接发送Put、delete等方式请求，无需Filter。</font></p><h4 id="4-1-2-请求映射原理"><a href="#4-1-2-请求映射原理" class="headerlink" title="4.1.2 请求映射原理"></a>4.1.2 请求映射原理</h4><p>xxx</p><h3 id="4-2-普通参数与基本注解"><a href="#4-2-普通参数与基本注解" class="headerlink" title="4.2 普通参数与基本注解"></a>4.2 普通参数与基本注解</h3><h4 id="4-2-1-注解"><a href="#4-2-1-注解" class="headerlink" title="4.2.1 注解"></a>4.2.1 注解</h4><ul><li>@pathVariable：获取路径变量</li><li>@RequestHeader：获取请求头</li><li>@RequestParam：获取请求参数（一个属性有多个值可以使用？inters=bask&amp;inters=game）</li><li>@RequestBody：获取表单提交内容</li></ul><p><strong>注意：</strong></p><p>&emsp;&emsp;以上注解都可以使用<font color=#FF0000 >Map&lt;String, String&gt; </font>接收全部参数。</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParameterTestController</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * @PathVariable、@RequestHeader、@RequestParam、@MatrixVariable、@RequestBody、@CookieValue     * @ModelAttribute     * http://localhost:8080/car/3/owner/lisi?age=18&amp;inters=basketball&amp;inters=game     * @param id     * @param username     * @param pv     * @return     */</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/car/{id}/owner/{username}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> <span class="token function">getCar</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Integer id<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> String username<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@PathVariable</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> pv<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span> String userAgent<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@RequestHeader</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> header<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> Integer age<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"inters"</span><span class="token punctuation">)</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> inters<span class="token punctuation">,</span>                                      <span class="token annotation punctuation">@RequestParam</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> params<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">//                                      @CookieValue("_ga") String _ga,</span><span class="token comment" spellcheck="true">//                                      @CookieValue("_ga") Cookie cookie</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// @PathVariable</span><span class="token comment" spellcheck="true">//        map.put("id", id);</span><span class="token comment" spellcheck="true">//        map.put("username", username);</span><span class="token comment" spellcheck="true">//        map.put("pv", pv);      // {"pv":{"id":"3","username":"lisi"}}</span>        <span class="token comment" spellcheck="true">// @RequestHeader</span><span class="token comment" spellcheck="true">//        map.put("userAgent", userAgent);</span><span class="token comment" spellcheck="true">//        map.put("header", header);</span>        <span class="token comment" spellcheck="true">// @RequestParam</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"inters"</span><span class="token punctuation">,</span> inters<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// {"params":{"age":"18","inters":"basketball"}} 同名参数只能获取到第一个值</span>        <span class="token comment" spellcheck="true">// @CookieValue</span><span class="token comment" spellcheck="true">//        map.put("_ga", _ga);</span><span class="token comment" spellcheck="true">//        map.put("cookie", cookie);</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/save"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> <span class="token function">postMethod</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> String content<span class="token punctuation">)</span><span class="token punctuation">{</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// {"content":"userName=sys&amp;email=1049272251%40qq.com"}</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>@MatrixVariable：矩阵变量<ul><li>Matrix Variable中，多个变量可以使用“;”（分号）分隔；</li><li>如果是一个变量的多个值那么可以使用“,”（逗号）分隔，或者可以使用重复的变量名</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ParameterTestController</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 1、语法：请求路径：/cars/sell;low=34;brand=byd,audi,yd     * 2、SpringBoot默认是禁用了矩阵变量的功能     *      手动开启：原理----对于路径的处理，UrlPathHelper进行判断     *          removeSemicolonContent（移除分好内容）支持矩阵变量的     * 3、矩阵变量必须有url路径变量才能被解析（即url中的sell在控制器中要变成{path}）     * @return     */</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/cars/{path}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> <span class="token function">carsSell</span><span class="token punctuation">(</span><span class="token annotation punctuation">@MatrixVariable</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">)</span> Integer low<span class="token punctuation">,</span>                                        <span class="token annotation punctuation">@MatrixVariable</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> brand<span class="token punctuation">,</span>                                        <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span> String path<span class="token punctuation">)</span><span class="token punctuation">{</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"low"</span><span class="token punctuation">,</span> low<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">,</span> brand<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// {"path":"sell","low":34,"brand":["byd","audi","yd"]}</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// /boss/1;age=20/2;age=10</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/boss/{bossId}/{empId}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> <span class="token function">boss</span><span class="token punctuation">(</span><span class="token annotation punctuation">@MatrixVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"age"</span><span class="token punctuation">,</span>pathVar <span class="token operator">=</span> <span class="token string">"bossId"</span><span class="token punctuation">)</span> Integer bossAge<span class="token punctuation">,</span>                                   <span class="token annotation punctuation">@MatrixVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"age"</span><span class="token punctuation">,</span>pathVar <span class="token operator">=</span> <span class="token string">"empId"</span><span class="token punctuation">)</span> Integer empAge<span class="token punctuation">)</span><span class="token punctuation">{</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bossAge"</span><span class="token punctuation">,</span> bossAge<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"empAge"</span><span class="token punctuation">,</span> empAge<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// {"bossAge":20,"empAge":10}</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>配置文件中开启矩阵变量功能</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token key atrule">mvc</span><span class="token punctuation">:</span>    <span class="token key atrule">contentnegotiation</span><span class="token punctuation">:</span>      <span class="token key atrule">favor-parameter</span><span class="token punctuation">:</span> <span class="token boolean important">true   </span><span class="token comment" spellcheck="true"># 开启矩阵变量的功能，开启请求参数内容协商模式</span></code></pre><ul><li>@RequestAttribute获取request域属性(HttpServetRequest在request域中添加属性)<ul><li>required默认为true，即作用域中必须有该参数的值，否则会报错</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Controller</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestController</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * @RequestAttribute(value = "msg",required = false)     *  required默认为true，即作用域中必须有该参数的值，否则会报错     *  当required为false时，作用域中没有该参数的值时，不会报错，结果中直接不显示，也不显示null     * @param request     * @param msg     * @param code     * @return     */</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"sucess"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> <span class="token function">testParam</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span>                                         <span class="token annotation punctuation">@RequestAttribute</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"msg"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String msg<span class="token punctuation">,</span>                                         <span class="token annotation punctuation">@RequestAttribute</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"code"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> Integer code<span class="token punctuation">)</span><span class="token punctuation">{</span>        Object msg1 <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object hello <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object world <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object message <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"reqMethod_msg"</span><span class="token punctuation">,</span> msg1<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"annotation_msg"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">,</span> world<span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="4-2-2-Servlet-API"><a href="#4-2-2-Servlet-API" class="headerlink" title="4.2.2 Servlet API"></a>4.2.2 Servlet API</h4><p>WebRequest、ServletRequest、MultipartRequest、 HttpSession、javax.servlet.http.PushBuilder、Principal、InputStream、Reader、HttpMethod、Locale、TimeZone、ZoneId</p><h4 id="4-2-3-复杂参数"><a href="#4-2-3-复杂参数" class="headerlink" title="4.2.3 复杂参数"></a>4.2.3 复杂参数</h4><ul><li><strong>Map</strong>、<strong>Model（map、model里面的数据会被放在request的请求域  request.setAttribute）</strong></li><li><strong>RedirectAttributes（ 重定向携带数据）**</strong>、ServletResponse（response）**</li><li>Errors/BindingResult、SessionStatus、UriComponentsBuilder、ServletUriComponentsBuilder</li></ul><p><strong>Map、Model类型的参数</strong>，会返回 mavContainer.getModel（）；—&gt; BindingAwareModelMap 是Model 也是Map</p><p><strong>mavContainer</strong>.getModel(); 获取到值的</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210315141904.png" style="zoom: 67%;" /><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210315141953.png" style="zoom: 80%;" /><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210315142040.png" style="zoom:67%;" /><h4 id="4-2-4-自定义对象参数"><a href="#4-2-4-自定义对象参数" class="headerlink" title="4.2.4 自定义对象参数"></a>4.2.4 自定义对象参数</h4><p>可以自动类型转换与格式化，可以级联封装。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** *     姓名： &lt;input name="userName"/> &lt;br/> *     年龄： &lt;input name="age"/> &lt;br/> *     生日： &lt;input name="birth"/> &lt;br/> *     宠物姓名：&lt;input name="pet.name"/>&lt;br/> *     宠物年龄：&lt;input name="pet.age"/> */</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>    <span class="token keyword">private</span> Date birth<span class="token punctuation">;</span>    <span class="token keyword">private</span> Pet pet<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Pet</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> String age<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="4-3-POJO封装过程"><a href="#4-3-POJO封装过程" class="headerlink" title="4.3 POJO封装过程"></a>4.3 POJO封装过程</h3><ul><li><strong>ServletModelAttributeMethodProcessor</strong></li></ul><h3 id="4-4-参数处理过程"><a href="#4-4-参数处理过程" class="headerlink" title="4.4 参数处理过程"></a>4.4 参数处理过程</h3><ul><li>HandlerMapping中找到能处理请求的Handler（Controller.method()）</li><li>为当前Handler 找一个适配器 HandlerAdapter； <strong>RequestMappingHandlerAdapter</strong></li><li>适配器执行目标方法并确定方法参数的每一个值</li></ul><p>xxx</p><h2 id="五、Web开发—数据响应和内容协商"><a href="#五、Web开发—数据响应和内容协商" class="headerlink" title="五、Web开发—数据响应和内容协商"></a>五、Web开发—数据响应和内容协商</h2><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316155944.jpg" style="zoom: 67%;" /><h3 id="5-1-响应JSON"><a href="#5-1-响应JSON" class="headerlink" title="5.1 响应JSON"></a>5.1 响应JSON</h3><h4 id="5-1-1-jackson-jar-ResponseBody"><a href="#5-1-1-jackson-jar-ResponseBody" class="headerlink" title="5.1.1  jackson.jar+@ResponseBody"></a>5.1.1  jackson.jar+@ResponseBody</h4><p>给前端自动返回json数据；</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>web场景已经自动引入了json场景<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>1、返回值解析器</p><p>XXX</p><p>2、返回值解析器原理</p><p>XXX</p><h4 id="5-1-2-SpringMVC到底支持哪些返回值"><a href="#5-1-2-SpringMVC到底支持哪些返回值" class="headerlink" title="5.1.2 SpringMVC到底支持哪些返回值"></a>5.1.2 SpringMVC到底支持哪些返回值</h4><pre class=" language-java"><code class="language-java">ModelAndViewModelViewResponseEntity ResponseBodyEmitterStreamingResponseBodyHttpEntityHttpHeadersCallableDeferredResultListenableFutureCompletionStageWebAsyncTask有 <span class="token annotation punctuation">@ModelAttribute</span> 且为对象类型的<span class="token annotation punctuation">@ResponseBody</span> 注解 <span class="token operator">--</span><span class="token operator">-</span><span class="token operator">></span> RequestResponseBodyMethodProcessor；</code></pre><h4 id="5-1-3-HTTPMessageConverter原理"><a href="#5-1-3-HTTPMessageConverter原理" class="headerlink" title="5.1.3 HTTPMessageConverter原理"></a>5.1.3 HTTPMessageConverter原理</h4><p>HttpMessageConverter接口主要提供以下几个方法：</p><p>（1）canRead 是否可以读</p><p>（2）canWrite 是否可以写</p><p>（3）read() 读数据</p><p>（4）write() 写数据</p><p>1、MessageConverter规范</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316161112.png" style="zoom:80%;" /><p>HttpMessageConverter: 看是否支持将 此 Class类型的对象，转为MediaType类型的数据。</p><p>例如：Person对象转为JSON。或者 JSON转为Person</p><p>2、默认的MessageConverter</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316161304.png" style="zoom: 80%;" /><p>0 - 只支持Byte类型的</p><p>1 - String</p><p>2 - String</p><p>3 - Resource</p><p>4 - ResourceRegion</p><p>5 - DOMSource.<strong>class \</strong> SAXSource.<strong>class</strong>) \ StAXSource.<strong>class \</strong>StreamSource.<strong>class \</strong>Source.<strong>class</strong></p><p><strong>6 -</strong> MultiValueMap</p><p>7 - <strong>可支持所有类型（一直返回true）</strong></p><p><strong>8 - true</strong></p><p><strong>9 - 支持注解方式xml处理的</strong></p><p>最终 MappingJackson2HttpMessageConverter  把对象转为JSON（利用底层的jackson的objectMapper转换的）</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316161457.png" style="zoom:80%;" /><h3 id="5-2-内容协商"><a href="#5-2-内容协商" class="headerlink" title="5.2 内容协商"></a>5.2 内容协商</h3><p>根据客户端接收能力不同，返回不同媒体类型的数据。</p><h4 id="5-2-1-引入xml依赖"><a href="#5-2-1-引入xml依赖" class="headerlink" title="5.2.1 引入xml依赖"></a>5.2.1 引入xml依赖</h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.dataformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-dataformat-xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h4 id="5-2-2-postman分别测试返回json和xml"><a href="#5-2-2-postman分别测试返回json和xml" class="headerlink" title="5.2.2 postman分别测试返回json和xml"></a>5.2.2 postman分别测试返回json和xml</h4><p>只需要改变<font color=#FF0000 >请求头中Accept字段。</font>Http协议中规定的，告诉服务器本客户端可以接收的数据类型。</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/1111.png" alt=""></p><h4 id="5-2-3-开启浏览器参数方式内容协商功能"><a href="#5-2-3-开启浏览器参数方式内容协商功能" class="headerlink" title="5.2.3 开启浏览器参数方式内容协商功能"></a>5.2.3 开启浏览器参数方式内容协商功能</h4><p>为了方便内容协商，可以在SpringBoot的yaml配置文件中开启基于请求参数的内容协商功能。</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>    <span class="token key atrule">contentnegotiation</span><span class="token punctuation">:</span>      <span class="token key atrule">favor-parameter</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span><span class="token comment" spellcheck="true">#开启请求参数内容协商模式</span></code></pre><p>配置开启内容协商模式后，通过在<font color=#FF0000 >发送的请求后面加上format参数</font>来选择返回的数据类型</p><p>浏览器端发送请求：</p><p><a href="http://localhost:8080/test/person?format=json" target="_blank" rel="noopener">http://localhost:8080/test/person?format=json</a><br><a href="http://localhost:8080/test/person?format=xml" target="_blank" rel="noopener">http://localhost:8080/test/person?format=xml</a></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316163017.png" alt=""></p><p>确定客户端接收什么样的内容类型；</p><ol><li>Parameter策略优先确定是要返回json数据（获取请求头中的format的值）<ol><li>浏览器端不传参数或者是没匹配到，就是 “*/ *” 都能匹配，然后按权重匹配，最高权重直接匹配到第一个，而第一个就是json</li></ol></li><li>最终进行内容协商返回给客户端json即可。</li></ol><h4 id="5-2-4-内容协商原理"><a href="#5-2-4-内容协商原理" class="headerlink" title="5.2.4 内容协商原理"></a>5.2.4 内容协商原理</h4><p> XXX</p><h4 id="5-2-5-自定义-MessageConverter"><a href="#5-2-5-自定义-MessageConverter" class="headerlink" title="5.2.5 自定义 MessageConverter"></a>5.2.5 自定义 MessageConverter</h4><p>XXX</p><h2 id="六、Web开发—视图解析与模板引擎"><a href="#六、Web开发—视图解析与模板引擎" class="headerlink" title="六、Web开发—视图解析与模板引擎"></a>六、Web开发—视图解析与模板引擎</h2><p>视图解析：<strong>SpringBoot默认不支持 JSP，需要引入第三方模板引擎技术实现页面渲染。</strong></p><h3 id="6-1-视图解析"><a href="#6-1-视图解析" class="headerlink" title="6.1 视图解析"></a>6.1 视图解析</h3><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316163713.jpg" style="zoom:67%;" /><h4 id="6-1-1-视图解析原理流程"><a href="#6-1-1-视图解析原理流程" class="headerlink" title="6.1.1 视图解析原理流程"></a>6.1.1 视图解析原理流程</h4><p>XXXX</p><h3 id="6-2-模板引擎-Thymeleaf"><a href="#6-2-模板引擎-Thymeleaf" class="headerlink" title="6.2 模板引擎-Thymeleaf"></a>6.2 模板引擎-Thymeleaf</h3><h4 id="6-2-1-thymeleaf简介"><a href="#6-2-1-thymeleaf简介" class="headerlink" title="6.2.1 thymeleaf简介"></a>6.2.1 thymeleaf简介</h4><p>现代化、服务端Java模板引擎</p><h4 id="6-2-2-基本语法"><a href="#6-2-2-基本语法" class="headerlink" title="6.2.2 基本语法"></a>6.2.2 基本语法</h4><p>1、表达式</p><table><thead><tr><th>表达式名字</th><th>语法</th><th>用途</th></tr></thead><tbody><tr><td><font color=#FF0000 >变量取值</font></td><td>${…}</td><td>获取请求域、session域、对象等值</td></tr><tr><td>选择变量</td><td>*{…}</td><td>获取上下文对象值</td></tr><tr><td>消息</td><td>#{…}</td><td>获取国际化等值</td></tr><tr><td><font color=#FF0000 >链接</font></td><td>@{…}</td><td>生成链接</td></tr><tr><td>片段表达式</td><td>~{…}</td><td>jsp:include 作用，引入公共页面片段</td></tr></tbody></table><p>2、字面量</p><ul><li>文本值: <strong>‘one text’</strong> <strong>,</strong> <strong>‘Another one!’</strong> <strong>,…</strong></li><li>数字: <strong>0</strong> <strong>,</strong> <strong>34</strong> <strong>,</strong> <strong>3.0</strong> <strong>,</strong> <strong>12.3</strong> <strong>,…</strong></li><li>布尔值: <strong>true</strong> <strong>,</strong> <strong>false</strong></li><li>空值: <strong>null</strong></li><li>变量： one，two，…. 变量不能有空格</li></ul><p>3、文本操作</p><ul><li><font color=#FF0000 >字符串拼接</font>: <strong>+</strong></li><li><font color=#FF0000 >变量替换</font>: <strong>|The name is ${name}|</strong> </li></ul><p>4、数学运算</p><p>运算符: + , - , * , / , %</p><p>5、布尔运算</p><ul><li>运算符:  <strong>and</strong> <strong>,</strong> <strong>or</strong></li><li>一元运算: <strong>!</strong> <strong>,</strong> <strong>not</strong> </li></ul><p>6、比较运算</p><ul><li>比较: <strong>&gt;</strong> <strong>,</strong> <strong>&lt;</strong> <strong>,</strong> <strong>&gt;=</strong> <strong>,</strong> <strong>&lt;=</strong> <strong>(</strong> <strong>gt</strong> <strong>,</strong> <strong>lt</strong> <strong>,</strong> <strong>ge</strong> <strong>,</strong> <strong>le</strong> <strong>)</strong></li><li>等式: <strong>==</strong> <strong>,</strong> <strong>!=</strong> <strong>(</strong> <strong>eq</strong> <strong>,</strong> <strong>ne</strong> <strong>)</strong> </li></ul><p>7、条件运算</p><ul><li>If-then: <strong>(if) ? (then)</strong></li><li>If-then-else: <strong>(if) ? (then) : (else)</strong></li><li>Default: (value) <strong>?: (defaultvalue)</strong> </li></ul><p>8、特殊操作</p><p>无操作： _</p><h4 id="6-2-3-设置属性值"><a href="#6-2-3-设置属性值" class="headerlink" title="6.2.3 设置属性值"></a>6.2.3 设置属性值</h4><ul><li>设置单个值</li></ul><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>subscribe.html<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{/subscribe}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fieldset</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Subscribe!<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#{subscribe.submit}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fieldset</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre><ul><li>设置多个值</li></ul><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>../../images/gtvglogo.png<span class="token punctuation">"</span></span>  <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{/images/gtvglogo.png},title<span class="token punctuation">=</span>#{logo},alt<span class="token punctuation">=</span>#{logo}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span></code></pre><p>所有h5兼容的标签写法：<a href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#setting-value-to-specific-attributes" target="_blank" rel="noopener">https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#setting-value-to-specific-attributes</a></p><h4 id="6-2-4-迭代"><a href="#6-2-4-迭代" class="headerlink" title="6.2.4 迭代"></a>6.2.4 迭代</h4><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>prod : ${prods}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${prod.name}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Onions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${prod.price}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>2.41<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${prod.inStock}? #{true} : #{false}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span></code></pre><pre class=" language-html"><code class="language-html"><span class="token comment" spellcheck="true">&lt;!-- user表示循环变量，stat：可以用来设置索引 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gradeX<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user,stat:${users.records}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${stat.count}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Trident<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${user.id}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Trident<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${user.name}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Trident<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${user.age}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Trident<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${user.email}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Trident<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- /delete/1?pn=3 --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{/delete/{id}(id<span class="token punctuation">=</span>${user.id},pn<span class="token punctuation">=</span>${users.current}) }<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-danger btn-sm<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span></code></pre><h4 id="6-4-5-条件运算"><a href="#6-4-5-条件运算" class="headerlink" title="6.4.5  条件运算"></a>6.4.5  条件运算</h4><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>comments.html<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{/product/comments(prodId<span class="token punctuation">=</span>${prod.id})}<span class="token punctuation">"</span></span>   <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${not #lists.isEmpty(prod.comments)}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>view<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre><h3 id="6-3-thymeleaf使用"><a href="#6-3-thymeleaf使用" class="headerlink" title="6.3 thymeleaf使用"></a>6.3 thymeleaf使用</h3><h4 id="6-3-1-引入Starter"><a href="#6-3-1-引入Starter" class="headerlink" title="6.3.1 引入Starter"></a>6.3.1 引入Starter</h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><h4 id="6-3-2-自动配置好了thymeleaf"><a href="#6-3-2-自动配置好了thymeleaf" class="headerlink" title="6.3.2 自动配置好了thymeleaf"></a>6.3.2 自动配置好了thymeleaf</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>ThymeleafProperties<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> TemplateMode<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> SpringTemplateEngine<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> WebMvcAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> WebFluxAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThymeleafAutoConfiguration</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></code></pre><p>自动配好的策略：</p><ol><li>所有thymeleaf的配置值都在 ThymeleafProperties</li><li>配置好了 <strong>SpringTemplateEngine</strong> </li><li><strong>配好了</strong> <strong>ThymeleafViewResolver</strong> </li><li>我们只需要直接开发页面</li><li>配置了默认文件路径在 /templates/ 下，默认后缀是 .html</li></ol><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DEFAULT_PREFIX <span class="token operator">=</span> <span class="token string">"classpath:/templates/"</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DEFAULT_SUFFIX <span class="token operator">=</span> <span class="token string">".html"</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//xxx.html</span></code></pre><h4 id="6-3-3-页面开发"><a href="#6-3-3-页面开发" class="headerlink" title="6.3.3 页面开发"></a>6.3.3 页面开发</h4><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${msg}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>哈哈<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- ${link}:是将link中的值取出，作为URL         @{link}：是直接将link作为URL    --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>www.atguigu.com<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${link}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>去百度<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>www.atguigu.com<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{link}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>去百度2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h3 id="6-4-构建后台管理系统"><a href="#6-4-构建后台管理系统" class="headerlink" title="6.4 构建后台管理系统"></a>6.4 构建后台管理系统</h3><h4 id="6-4-1-项目创建"><a href="#6-4-1-项目创建" class="headerlink" title="6.4.1 项目创建"></a>6.4.1 项目创建</h4><p>自动创建时，选取以下内容：thymeleaf、web-starter、devtools、lombok</p><h4 id="6-4-2-静态资源处理"><a href="#6-4-2-静态资源处理" class="headerlink" title="6.4.2 静态资源处理"></a>6.4.2 静态资源处理</h4><p>自动配置好，我们只需要把所有静态资源放到 static 文件夹下</p><h4 id="6-4-3-路径构建"><a href="#6-4-3-路径构建" class="headerlink" title="6.4.3 路径构建"></a>6.4.3 路径构建</h4><p>th:action=”@{/login}”</p><h4 id="6-4-4-模板抽取"><a href="#6-4-4-模板抽取" class="headerlink" title="6.4.4 模板抽取"></a>6.4.4 模板抽取</h4><p>th:insert/replace/include</p><h4 id="6-4-5-页面跳转"><a href="#6-4-5-页面跳转" class="headerlink" title="6.4.5 页面跳转"></a>6.4.5 页面跳转</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token keyword">public</span> String <span class="token function">main</span><span class="token punctuation">(</span>User user<span class="token punctuation">,</span> HttpSession session<span class="token punctuation">,</span> Model model<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"123456"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//把登陆成功的用户保存起来</span>        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"loginUser"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//登录成功重定向到main.html;  重定向防止表单重复提交</span>        <span class="token keyword">return</span> <span class="token string">"redirect:/main.html"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"账号密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//回到登录页面</span>        <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="6-4-6-数据渲染"><a href="#6-4-6-数据渲染" class="headerlink" title="6.4.6 数据渲染"></a>6.4.6 数据渲染</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/dynamic_table"</span><span class="token punctuation">)</span><span class="token keyword">public</span> String <span class="token function">dynamic_table</span><span class="token punctuation">(</span>Model model<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//表格内容的遍历</span>    List<span class="token operator">&lt;</span>User<span class="token operator">></span> users <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                     <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"123444"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                     <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"haha"</span><span class="token punctuation">,</span> <span class="token string">"aaaaa"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                     <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"hehe "</span><span class="token punctuation">,</span> <span class="token string">"aaddd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"users"</span><span class="token punctuation">,</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">"table/dynamic_table"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>display table table-bordered<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden-table-info<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thead</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>#<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>用户名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>密码<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thead</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gradeX<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>user,stats:${users}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${stats.count}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Trident<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${user.userName}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Internet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token punctuation">></span></span>[[${user.password}]]<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span></code></pre><h2 id="七、Web开发—拦截器"><a href="#七、Web开发—拦截器" class="headerlink" title="七、Web开发—拦截器"></a>七、Web开发—拦截器</h2><p>1、编写一个<font color=#0000FF >拦截器实现HandlerInterceptor接口</font></p><p>2、拦截器注册到容器中<font color=#0000FF >（实现WebMvcConfigurer的addInterceptors）</font></p><p>3、<font color=#0000FF >指定拦截规则</font>【如果是拦截所有，静态资源也会被拦截】</p><h3 id="7-1-HandlerInterceptor-接口"><a href="#7-1-HandlerInterceptor-接口" class="headerlink" title="7.1 HandlerInterceptor 接口"></a>7.1 HandlerInterceptor 接口</h3><p>配置自定义的拦截器，实现HandlerInterceptor 接口</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 登录检查 * 1、配置好拦截器要拦截哪些请求 * 2、把这些配置放在容器中 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 目标方法执行之前     * @param request     * @param response     * @param handler     * @return     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        String requestURI <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"preHandle拦截的请求路径是{}"</span><span class="token punctuation">,</span>requestURI<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//登录检查逻辑</span>        HttpSession session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object loginUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"loginUser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//放行</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//拦截住。未登录。跳转到登录页</span>        request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"请先登录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//        re.sendRedirect("/");</span>        request<span class="token punctuation">.</span><span class="token function">getRequestDispatcher</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 目标方法执行完成以后     * @param request     * @param response     * @param handler     * @param modelAndView     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> ModelAndView modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"postHandle执行{}"</span><span class="token punctuation">,</span>modelAndView<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 页面渲染以后     * @param request     * @param response     * @param handler     * @param ex     * @throws Exception     */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> Exception ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"afterCompletion执行异常{}"</span><span class="token punctuation">,</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="7-2-配置拦截器"><a href="#7-2-配置拦截器" class="headerlink" title="7.2 配置拦截器"></a>7.2 配置拦截器</h3><p>在Config类中注册自定义的拦截器</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 1、编写一个拦截器实现HandlerInterceptor接口 * 2、拦截器注册到容器中（实现WebMvcConfigurer的addInterceptors） * 3、指定拦截规则【如果是拦截所有，静态资源也会被拦截】 */</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdminWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span>InterceptorRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//所有请求都被拦截包括静态资源</span>                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span><span class="token string">"/login"</span><span class="token punctuation">,</span><span class="token string">"/css/**"</span><span class="token punctuation">,</span><span class="token string">"/fonts/**"</span><span class="token punctuation">,</span><span class="token string">"/images/**"</span><span class="token punctuation">,</span><span class="token string">"/js/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//放行的请求</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="7-3-拦截器原理"><a href="#7-3-拦截器原理" class="headerlink" title="7.3 拦截器原理"></a>7.3 拦截器原理</h3><p>XXX</p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316171132.png" style="zoom: 67%;" /><h2 id="八、Web开发—文件上传"><a href="#八、Web开发—文件上传" class="headerlink" title="八、Web开发—文件上传"></a>八、Web开发—文件上传</h2><h3 id="8-1-页面表单"><a href="#8-1-页面表单" class="headerlink" title="8.1 页面表单"></a>8.1 页面表单</h3><ul><li><p>表单提交中设计到文件上传时，<font color=#FF0000 >method必须是<strong>post</strong></font>，并且必须加上<font color=#FF0000 > <strong>enctype=”multipart/form-data”</strong></font></p></li><li><p><font color=#FF0000 >id=”<strong>exampleInputFile</strong>“：表示单文件上传</font></p></li><li><p><font color=#FF0000 ><strong>multiple</strong>：表示多文件上传</font></p></li></ul><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@{/upload}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>exampleInputEmail1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>邮箱<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>exampleInputEmail1<span class="token punctuation">"</span></span>               <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Enter email<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>exampleInputFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>头像<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>headerImg<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>exampleInputFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>exampleInputFile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>生活照<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>photos<span class="token punctuation">"</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>提交<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre><h3 id="8-2-文件上传代码"><a href="#8-2-文件上传代码" class="headerlink" title="8.2 文件上传代码"></a>8.2 文件上传代码</h3><ul><li><font color=#FF0000 ><strong>MultipartFile</strong>：用来接收单个图片</font></li><li><font color=#FF0000 ><strong>MultipartFile[]</strong>：用来接收多个图片</font></li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**     * MultipartFile 自动封装上传过来的文件     * @param email     * @param username     * @param headerImg     * @param photos     * @return     */</span><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/upload"</span><span class="token punctuation">)</span><span class="token keyword">public</span> String <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">)</span> String email<span class="token punctuation">,</span>                     <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> String username<span class="token punctuation">,</span>                     <span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"headerImg"</span><span class="token punctuation">)</span> MultipartFile headerImg<span class="token punctuation">,</span>                     <span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"photos"</span><span class="token punctuation">)</span> MultipartFile<span class="token punctuation">[</span><span class="token punctuation">]</span> photos<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"上传的信息：email={}，username={}，headerImg={}，photos={}"</span><span class="token punctuation">,</span>             email<span class="token punctuation">,</span>username<span class="token punctuation">,</span>headerImg<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>photos<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>headerImg<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//保存到文件服务器，OSS服务器</span>        String originalFilename <span class="token operator">=</span> headerImg<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        headerImg<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"H:\\cache\\"</span><span class="token operator">+</span>originalFilename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>photos<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>MultipartFile photo <span class="token operator">:</span> photos<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>photo<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                String originalFilename <span class="token operator">=</span> photo<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                photo<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"H:\\cache\\"</span><span class="token operator">+</span>originalFilename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token string">"main"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="8-2-文件上传自动配置原理"><a href="#8-2-文件上传自动配置原理" class="headerlink" title="8.2 文件上传自动配置原理"></a>8.2 文件上传自动配置原理</h3><p>XXX</p><h2 id="九、Web开发—异常处理"><a href="#九、Web开发—异常处理" class="headerlink" title="九、Web开发—异常处理"></a>九、Web开发—异常处理</h2><h3 id="9-1-错误处理的默认规则"><a href="#9-1-错误处理的默认规则" class="headerlink" title="9.1 错误处理的默认规则"></a>9.1 错误处理的默认规则</h3><ul><li>默认情况下，Spring Boot提供<code>/error</code>处理所有错误的映射</li></ul><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316172324.png" alt=""></p><ul><li>对于机器客户端，它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息。对于浏览器客户端，响应一个“ whitelabel”错误视图，以HTML格式呈现相同的数据</li></ul><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316172340.png" alt=""></p><ul><li>要对其进行自定义，添加<code>View</code>解析为<code>error</code></li><li>要完全替换默认行为，可以实现 <code>ErrorController</code>并注册该类型的Bean定义，或添加<code>ErrorAttributes类型的组件</code>以使用现有机制但替换其内容。</li><li>error/下的4xx，5xx页面会被自动解析；</li></ul><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316172449.png" alt=""></p><h3 id="9-2-定制错误处理逻辑"><a href="#9-2-定制错误处理逻辑" class="headerlink" title="9.2 定制错误处理逻辑"></a>9.2 定制错误处理逻辑</h3><p>XXX</p><h3 id="9-3-异常处理自动配置原理"><a href="#9-3-异常处理自动配置原理" class="headerlink" title="9.3 异常处理自动配置原理"></a>9.3 异常处理自动配置原理</h3><p>XXX</p><h3 id="9-4-异常处理步骤流程"><a href="#9-4-异常处理步骤流程" class="headerlink" title="9.4 异常处理步骤流程"></a>9.4 异常处理步骤流程</h3><p>XXX</p><h2 id="十、Web开发—Web原生组件注入（Servlet、Filter、Listener）"><a href="#十、Web开发—Web原生组件注入（Servlet、Filter、Listener）" class="headerlink" title="十、Web开发—Web原生组件注入（Servlet、Filter、Listener）"></a>十、Web开发—Web原生组件注入（Servlet、Filter、Listener）</h2><h3 id="10-1-使用Servlet-API"><a href="#10-1-使用Servlet-API" class="headerlink" title="10.1 使用Servlet API"></a>10.1 使用Servlet API</h3><ul><li><p>@ServletComponentScan(basePackages = <strong>“com.atguigu.admin”</strong>) :指定原生Servlet组件都放在那里</p></li><li><p>@WebServlet(urlPatterns = <strong>“/my”</strong>)：效果：直接响应，<strong>没有经过Spring的拦截器？</strong></p><ul><li>根据精确优先原则，DispatcherServlet处理”/“请求，MyServlet处理”/my”请求，更精确，所以由原生的servlet（Tomcat）处理,而只有由DispatcherServlet处理的请求才会经过spring的拦截器</li><li><font color=#FF0000 >因此优先来到/my路径,而不是先到/路径,因此不会走Spring流程,而是走Tomcat流程,故/my路径不会被拦截器拦截</font></li></ul></li><li><p>@WebFilter(urlPatterns={<strong>“/css/*“</strong>,<strong>“/images/*“</strong>})</p></li><li><p>@WebListener</p></li></ul><p><strong>扩展</strong>：<strong>DispatchServlet 如何注册进来</strong></p><ul><li>容器中自动配置了  DispatcherServlet  属性绑定到 WebMvcProperties；对应的配置文件配置项是 <strong>spring.mvc。</strong></li><li><strong>通过</strong> <strong>ServletRegistrationBean</strong><DispatcherServlet> 把 DispatcherServlet  配置进来。</li><li>默认映射的是 / 路径。</li></ul><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210316184621.png" style="zoom:80%;" /><p>Tomcat-Servlet；</p><p>多个Servlet都能处理到同一层路径，精确优选原则</p><p>A： /my/</p><p>B： /my/1</p><h3 id="10-2-使用RegistrationBean"><a href="#10-2-使用RegistrationBean" class="headerlink" title="10.2 使用RegistrationBean"></a>10.2 使用RegistrationBean</h3><p><code>ServletRegistrationBean</code>、<code>FilterRegistrationBean</code>和<code>ServletListenerRegistrationBean</code></p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRegistConfig</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> ServletRegistrationBean <span class="token function">myServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        MyServlet myServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>myServlet<span class="token punctuation">,</span><span class="token string">"/my"</span><span class="token punctuation">,</span><span class="token string">"/my02"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> FilterRegistrationBean <span class="token function">myFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        MyFilter myFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        return new FilterRegistrationBean(myFilter,myServlet());</span>        FilterRegistrationBean filterRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterRegistrationBean</span><span class="token punctuation">(</span>myFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>        filterRegistrationBean<span class="token punctuation">.</span><span class="token function">setUrlPatterns</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"/my"</span><span class="token punctuation">,</span><span class="token string">"/css/*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> filterRegistrationBean<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> ServletListenerRegistrationBean <span class="token function">myListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        MySwervletContextListener mySwervletContextListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySwervletContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServletListenerRegistrationBean</span><span class="token punctuation">(</span>mySwervletContextListener<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="十一、Web开发—嵌入式Servlet容器"><a href="#十一、Web开发—嵌入式Servlet容器" class="headerlink" title="十一、Web开发—嵌入式Servlet容器"></a>十一、Web开发—嵌入式Servlet容器</h2><h3 id="11-1-切换嵌入式Servlet容器"><a href="#11-1-切换嵌入式Servlet容器" class="headerlink" title="11.1 切换嵌入式Servlet容器"></a>11.1 切换嵌入式Servlet容器</h3><ul><li><p>默认支持的webServer</p><ul><li><code>Tomcat</code>, <code>Jetty</code>, or <code>Undertow</code></li><li><code>ServletWebServerApplicationContext 容器启动寻找ServletWebServerFactory 并引导创建服务器</code></li></ul></li><li><p>切换服务器</p></li></ul><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><ul><li>原理<ul><li>SpringBoot应用启动发现当前是Web应用。web场景包-导入tomcat</li><li>web应用会创建一个web版的ioc容器 <code>ServletWebServerApplicationContext</code> </li><li><code>ServletWebServerApplicationContext</code>  启动的时候寻找 <strong><code>ServletWebServerFactory</code></strong><code>（Servlet 的web服务器工厂---&gt; Servlet 的web服务器）</code>  </li><li>SpringBoot底层默认有很多的WebServer工厂；<code>TomcatServletWebServerFactory</code>, <code>JettyServletWebServerFactory</code>, or <code>UndertowServletWebServerFactory</code></li><li><code>底层直接会有一个自动配置类。ServletWebServerFactoryAutoConfiguration</code></li><li><code>ServletWebServerFactoryAutoConfiguration导入了ServletWebServerFactoryConfiguration（配置类）</code></li><li><code>ServletWebServerFactoryConfiguration 配置类 根据动态判断系统中到底导入了那个Web服务器的包。（默认是web-starter导入tomcat包），容器中就有 TomcatServletWebServerFactory</code></li><li><code>TomcatServletWebServerFactory 创建出Tomcat服务器并启动；TomcatWebServer 的构造器拥有初始化方法initialize---this.tomcat.start();</code></li><li><code>内嵌服务器，就是手动把启动服务器的代码调用（tomcat核心jar包存在）</code></li></ul></li></ul><h3 id="11-2-定制Servlet容器"><a href="#11-2-定制Servlet容器" class="headerlink" title="11.2 定制Servlet容器"></a>11.2 定制Servlet容器</h3><ul><li><p>实现  <strong>WebServerFactoryCu</strong>stomizer<ConfigurableServletWebServerFactory> </p><ul><li>把配置文件的值和<strong><code>ServletWebServerFactory 进行绑定</code></strong></li></ul></li><li><p>修改配置文件 <strong>server.xxx</strong></p></li><li><p>直接自定义 <strong>ConfigurableServletWebServerFactory</strong> </p></li></ul><p><strong>xxxxx</strong><font color=#FF0000 >Customizer</font>：<strong>定制化器，可以改变xxxx的默认规则</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span>WebServerFactoryCustomizer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>server<span class="token punctuation">.</span>ConfigurableServletWebServerFactory<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomizationBean</span> <span class="token keyword">implements</span> <span class="token class-name">WebServerFactoryCustomizer</span><span class="token operator">&lt;</span>ConfigurableServletWebServerFactory<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">customize</span><span class="token punctuation">(</span>ConfigurableServletWebServerFactory server<span class="token punctuation">)</span> <span class="token punctuation">{</span>        server<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="十二、Web开发—定制化原理"><a href="#十二、Web开发—定制化原理" class="headerlink" title="十二、Web开发—定制化原理"></a>十二、Web开发—定制化原理</h2><h3 id="12-1-定制化的常见方式"><a href="#12-1-定制化的常见方式" class="headerlink" title="12.1 定制化的常见方式"></a>12.1 定制化的常见方式</h3><ul><li>修改配置文件；</li><li><strong>xxxxxCustomizer；</strong></li><li><strong>编写自定义的配置类  xxxConfiguration；+</strong> <strong>@Bean替换、增加容器中默认组件；视图解析器</strong> </li><li><font color=#FF0000 ><strong>Web应用 编写一个配置类实现 WebMvcConfigurer 即可定制化web功能；+ @Bean给容器中再扩展一些组件</strong></font></li></ul><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdminWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><ul><li>@EnableWebMvc + WebMvcConfigurer —— @Bean  可以全面接管SpringMVC，所有规则全部自己重新配置； 实现定制和扩展功能<ul><li>原理</li><li>1、WebMvcAutoConfiguration  默认的SpringMVC的自动配置功能类。静态资源、欢迎页…..</li><li>2、一旦使用 @EnableWebMvc 、。会 @Import(DelegatingWebMvcConfiguration.<strong>class</strong>)</li><li>3、<strong>DelegatingWebMvcConfiguration</strong> 的 作用，只保证SpringMVC最基本的使用<ul><li>把所有系统中的 WebMvcConfigurer 拿过来。所有功能的定制都是这些 WebMvcConfigurer  合起来一起生效</li><li>自动配置了一些非常底层的组件。<strong>RequestMappingHandlerMapping</strong>、这些组件依赖的组件都是从容器中获取</li><li><strong>public class</strong> DelegatingWebMvcConfiguration <strong>extends</strong> <strong>WebMvcConfigurationSupport</strong></li></ul></li><li>4、<strong>WebMvcAutoConfiguration</strong> 里面的配置要能生效 必须  @ConditionalOnMissingBean(<strong>WebMvcConfigurationSupport</strong>.<strong>class</strong>)</li><li>5、@EnableWebMvc  导致了 <strong>WebMvcAutoConfiguration  没有生效。</strong></li></ul></li></ul><h3 id="12-2-原理分析套路"><a href="#12-2-原理分析套路" class="headerlink" title="12.2 原理分析套路"></a>12.2 原理分析套路</h3><p><font color=#FF0000 ><strong>场景starter</strong></font> - <strong>xxxxAutoConfiguration - 导入xxx组件 - 绑定xxxProperties</strong> – <font color=#FF0000 ><strong>绑定配置文件项</strong> </font></p>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
            <tag> Java框架 </tag>
            
            <tag> Web开发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【SpringBoot】02-SpringBoot入门</title>
      <link href="/2021/03/12/springboot-02-springboot-ru-men/"/>
      <url>/2021/03/12/springboot-02-springboot-ru-men/</url>
      
        <content type="html"><![CDATA[<h2 id="一、SpringBoot入门"><a href="#一、SpringBoot入门" class="headerlink" title="一、SpringBoot入门"></a>一、SpringBoot入门</h2><h3 id="1-1-前置条件"><a href="#1-1-前置条件" class="headerlink" title="1.1 前置条件"></a>1.1 前置条件</h3><ul><li>Java 8</li><li>Maven 3.3+</li><li>idea 2019</li></ul><p><strong>Maven设置</strong></p><p>修改maven下的conf\settings.xml文件</p><pre class=" language-xml"><code class="language-xml">1、修改成本地仓库<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localRepository</span><span class="token punctuation">></span></span>D:/Program Files/Programming tool/Maven3.6/repository<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localRepository</span><span class="token punctuation">></span></span>2、修改镜像<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrors</span><span class="token punctuation">></span></span>     <span class="token comment" spellcheck="true">&lt;!-- 阿里镜像地址 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirror</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>nexus-aliyun<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mirrorOf</span><span class="token punctuation">></span></span>central<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrorOf</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Nexus aliyun<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>http://maven.aliyun.com/nexus/content/groups/public<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirror</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mirrors</span><span class="token punctuation">></span></span>3、配置jdk 1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profiles</span><span class="token punctuation">></span></span>   <span class="token comment" spellcheck="true">&lt;!-- 配置JDK --></span>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>jdk-1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activation</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activeByDefault</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activeByDefault</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdk</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdk</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activation</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.compilerVersion</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.compilerVersion</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profiles</span><span class="token punctuation">></span></span></code></pre><h3 id="1-2-入门程序—HelloWord"><a href="#1-2-入门程序—HelloWord" class="headerlink" title="1.2 入门程序—HelloWord"></a>1.2 入门程序—HelloWord</h3><p>需求：浏览器发送/hello请求，响应 Hello，Spring Boot 2 </p><h4 id="1-2-1-创建Maven工程"><a href="#1-2-1-创建Maven工程" class="headerlink" title="1.2.1 创建Maven工程"></a>1.2.1 创建Maven工程</h4><h4 id="1-2-2-引入依赖"><a href="#1-2-2-引入依赖" class="headerlink" title="1.2.2 引入依赖"></a>1.2.2 引入依赖</h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></code></pre><h4 id="1-2-3-创建主程序"><a href="#1-2-3-创建主程序" class="headerlink" title="1.2.3 创建主程序"></a>1.2.3 创建主程序</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**   * 主程序类   * @SpringBootApplication：这是一个SpringBoot应用   */</span> <span class="token annotation punctuation">@SpringBootApplication</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainApplication</span> <span class="token punctuation">{</span>     <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>         SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>MainApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></code></pre><h4 id="1-2-4-编写业务"><a href="#1-2-4-编写业务" class="headerlink" title="1.2.4 编写业务"></a>1.2.4 编写业务</h4><p>&emsp;&emsp;@RestController 是将@Controller和@ResponseBody合二为一，该注解告诉Spring将得到的字符串直接返回给调用者。</p><pre class=" language-Java"><code class="language-Java">@RestController public class HelloController {     @RequestMapping("/hello")     public String handle01(){         return "Hello, Spring Boot 2!";     }  }</code></pre><h4 id="1-2-5-测试"><a href="#1-2-5-测试" class="headerlink" title="1.2.5 测试"></a>1.2.5 测试</h4><p>&emsp;&emsp;直接运行main方法，即可。</p><h4 id="1-2-6-简化配置"><a href="#1-2-6-简化配置" class="headerlink" title="1.2.6 简化配置"></a>1.2.6 简化配置</h4><p>&emsp;&emsp;使用application.properties或者是application.yaml文件，进行配置。</p><h4 id="1-2-7-简化部署"><a href="#1-2-7-简化部署" class="headerlink" title="1.2.7 简化部署"></a>1.2.7 简化部署</h4><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 简化部署：项目打成jar包 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span></code></pre><p>&emsp;&emsp;把项目打成jar包，直接在目标服务器执行即可。</p><h2 id="二、了解自动配置原理"><a href="#二、了解自动配置原理" class="headerlink" title="二、了解自动配置原理"></a>二、了解自动配置原理</h2><h3 id="2-1-SpringBoot特点"><a href="#2-1-SpringBoot特点" class="headerlink" title="2.1 SpringBoot特点"></a>2.1 SpringBoot特点</h3><h4 id="2-1-1-依赖管理"><a href="#2-1-1-依赖管理" class="headerlink" title="2.1.1 依赖管理"></a>2.1.1 依赖管理</h4><ul><li>父项目做依赖管理</li></ul><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>spring-boot-starter-parent的父项目如下几乎声明了所有开发中常用的依赖的版本号,会自动版本仲裁机制<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span></code></pre><ul><li>开发导入starter场景启动器<ul><li>见到很多spring-boot-starter-*： *代表的就是某种场景</li><li>只要引入starter，那么这个场景的所有常规需要的依赖便会自动引入</li><li>SpringBoot多有支持的场景：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</a> </li><li>第三方提供的简化开发的场景启动器，格式如下：*-spring-boot-starter</li><li>spring-boot-starter是所有场景启动器的最底层依赖</li></ul></li></ul><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.3.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><ul><li><p>无需关注版本号，自动版本仲裁</p><ul><li>引入依赖默认都可以不写版本 </li><li>引入非版本仲裁的jar，要写版本号。</li></ul></li><li><p>可以修改默认版本号</p><ul><li>第一种方法：查看spring-boot-dependencies里面规定当前依赖的版本 用的 key。</li><li>第二种方法： 在当前项目里面重写配置</li></ul><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">></span></span>5.1.43<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></code></pre></li></ul><h4 id="2-1-2-自动配置"><a href="#2-1-2-自动配置" class="headerlink" title="2.1.2 自动配置"></a>2.1.2 自动配置</h4><ul><li><p>自动配好Tomcat</p><ul><li>引入Tomcat依赖。</li><li>配置Tomcat</li></ul></li><li><p>自动配好SpringMVC</p><ul><li>引入SpringMVC全套组件</li><li>自动配好SpringMVC常用组件（功能）</li></ul></li><li><p>自动配好Web常见功能，如：字符编码问题</p><ul><li>SpringBoot帮我们配置好了所有web开发的常见场景</li></ul></li><li><p>默认的包结构</p><ul><li><p>主程序所在包及其下面的所有子包里面的组件都会被默认扫描进来</p></li><li><p>想要改变扫描路径，使用 @SpringBootApplication(scanBasePackages=”com.jie”) 或者是使用 @ComponentScan(“com.jie”)</p></li></ul></li></ul><pre class=" language-java"><code class="language-java">scanBasePackages <span class="token operator">=</span> <span class="token string">"com.jie"</span> <span class="token operator">:</span>设置默认扫描包扫描路径，方便将main程序所在包的外面包的组件全部扫描进来</code></pre><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>scanBasePackages<span class="token operator">=</span><span class="token string">"com.jie"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//该注解等同于下面的三个注释</span><span class="token annotation punctuation">@SpringBootConfiguration</span><span class="token annotation punctuation">@EnableAutoConfiguration</span><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">"com.jie"</span><span class="token punctuation">)</span></code></pre><ul><li>各种配置拥有默认值<ul><li>默认配置最终都是映射到某个类上，如：文件上传–MultipartProperties</li><li>配置文件的值最终会绑定每个类上，这个类会在容器中创建对象</li></ul></li><li><font color=#FF0000 >按需加载</font>所有自动配置项<ul><li>非常多的starter</li><li>引入了哪些场景这个场景的自动配置才会开启</li><li>SpringBoot所有的自动配置功能都在 spring-boot-autoconfigure 包里面</li></ul></li></ul><h3 id="2-2-容器功能"><a href="#2-2-容器功能" class="headerlink" title="2.2 容器功能"></a>2.2 容器功能</h3><h4 id="2-2-1-组件添加"><a href="#2-2-1-组件添加" class="headerlink" title="2.2.1 组件添加"></a>2.2.1 组件添加</h4><h5 id="1、-Configuration"><a href="#1、-Configuration" class="headerlink" title="1、@Configuration"></a>1、@Configuration</h5><ul><li>基本使用</li><li><strong>Full模式与Lite模式</strong><ul><li>示例</li><li>最佳实践<ul><li>配置 类组件之间<font color=#FF0000 >无依赖关系用Lite模式</font>加速容器启动过程，减少判断</li><li>配置类组件之间<font color=#FF0000 >有依赖关系用Full模式</font>，方法会被调用得到之前<font color=#FF0000 >单实例组件</font></li></ul></li></ul></li></ul><p><strong>注意：</strong></p><ol><li>@Configuration：表明是一个配置类，相当于原来的配置文件，配置类本身也是一个组件</li><li>配置类里面使用@Bean标注在方法上给容器注册组件，默认是<font color=#FF0000 >单例</font>的<ol><li>默认以方法名作为组件id（也可以在@Bean中指定名称），返回类型就是组件类型。返回的值就是组件在容器中的实例</li><li>单例模式：外部无论对配置类中的这个组件注册方法调用多少次，获取的都是之前注册容器中的单实例对象</li></ol></li><li>proxyBeanMethods：代理bean的方法<ol><li>Full模式：proxyBeanMethods = true</li><li>Lite模式：proxyBeanMethods = false</li><li>组件依赖</li></ol></li></ol><pre class=" language-java"><code class="language-java">######Configuration使用示例######<span class="token comment" spellcheck="true">/** * 1、配置类里面使用@Bean标注在方法上给容器注册组件，默认也是单例的 * 2、配置类本身也是组件 * 3、proxyBeanMethods：代理bean的方法 *      Full模式：proxyBeanMethods = true *      Lite模式：proxyBeanMethods = false *      组件依赖 *      使用： *          配置类组件之间无依赖关系用Lite模式加速容器启动过程，减少判断 *          配置类组件之间有依赖关系，方法会被调用得到之前单实例组件，用Full模式 */</span><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// @Configuration：告诉springboot 这是一个配置类，相当于原来的配置文件</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * /@Bean：给容器添加组件 以方法名作为组件的id，返回类型就是组件类型。返回的值就是组件在容器中的实例     * 单例模式：外部无论对配置类中的这个组件注册方法调用多少次，获取的都是之前注册容器中的单实例对象     */</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> User <span class="token function">user01</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// User组件依赖了Pet组件</span>        user<span class="token punctuation">.</span><span class="token function">setPet</span><span class="token punctuation">(</span><span class="token function">tomcatPet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> user<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"tom"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 默认以方法名作为组件id，但是也可以在@Bean中指定名称</span>    <span class="token keyword">public</span> Pet <span class="token function">tomcatPet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Pet</span><span class="token punctuation">(</span><span class="token string">"tomcat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>######<span class="token annotation punctuation">@Configuration</span>测试代码如下######<span class="token annotation punctuation">@SpringBootConfiguration</span><span class="token annotation punctuation">@EnableAutoConfiguration</span><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">"com.jie"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainApplication</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1、返回IOC容器</span>        ConfigurableApplicationContext run <span class="token operator">=</span> SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>MainApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2、查看容器里面的组件</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> names <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String name <span class="token operator">:</span> names<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 3、从容器中获取组件</span>        Pet tom01 <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"tom"</span><span class="token punctuation">,</span> Pet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Pet tom02 <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"tom"</span><span class="token punctuation">,</span> Pet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"组件:"</span><span class="token operator">+</span><span class="token punctuation">(</span>tom01 <span class="token operator">==</span> tom02<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// true</span>        <span class="token comment" spellcheck="true">// 配置类本身也是组件</span>        MyConfig bean <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>MyConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果@Configuration(proxyBeanMethods = true)代理对象调用方法，</span>        <span class="token comment" spellcheck="true">//  SpringBoot总会先检查这个组件是否在容器中，保持组件的单实例</span>        User user <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">user01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        User user1 <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">user01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"bean:"</span><span class="token operator">+</span><span class="token punctuation">(</span>user <span class="token operator">==</span> user1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 如果@Configuration(proxyBeanMethods = true)：true</span>        <span class="token comment" spellcheck="true">// 如果@Configuration(proxyBeanMethods = false)：false</span>        User user01 <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"user01"</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Pet tom <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"tom"</span><span class="token punctuation">,</span>Pet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户的宠物："</span><span class="token operator">+</span><span class="token punctuation">(</span>user01<span class="token punctuation">.</span><span class="token function">getPet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h5 id="2、-Bean、-Component、-Controller、-Service、-Repository"><a href="#2、-Bean、-Component、-Controller、-Service、-Repository" class="headerlink" title="2、@Bean、@Component、@Controller、@Service、@Repository"></a>2、@Bean、@Component、@Controller、@Service、@Repository</h5><h5 id="3、-ComponentScan、-Import"><a href="#3、-ComponentScan、-Import" class="headerlink" title="3、@ComponentScan、@Import"></a>3、@ComponentScan、@Import</h5><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 4、@Import({User.class, DBHelper.class}) * 给容器中自动创建出这两个类型的组件、默认组件的名字就是全类名 */</span> <span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> DBHelper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//告诉SpringBoot这是一个配置类 == 配置文件 </span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><h5 id="4、-Conditional"><a href="#4、-Conditional" class="headerlink" title="4、@Conditional"></a>4、@Conditional</h5><p>条件装配：满足Conditional指定的条件，才进行组件注入</p><p><strong>注意：</strong></p><ol><li>使用@ConditionalOnBean需要注意Bean注册的先后顺序，onClass则不用</li><li>相关注解写在类上时，只有当容器中存在了才会加载该内中的容器</li><li>当我们把@Conditional这个注解放到类上面。那么这个配置类也不能注入到容器里面</li></ol><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210313105215.png" style="zoom:80%;" /><h4 id="2-2-2-原生配置文件引入"><a href="#2-2-2-原生配置文件引入" class="headerlink" title="2.2.2 原生配置文件引入"></a>2.2.2 原生配置文件引入</h4><h5 id="1、-ImportResource"><a href="#1、-ImportResource" class="headerlink" title="1、@ImportResource"></a>1、@ImportResource</h5><p>&emsp;&emsp;直接读取原来的xml配置文件</p><pre class=" language-xml"><code class="language-xml">===================beans.xml===================<span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span> &lt;beans xmlns="http://www.springframework.org/schema/beans"        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"        xmlns:context="http://www.springframework.org/schema/context"        xsi:schemaLocation="http://www.springframework.org/schema/bean                           http://www.springframework.org/schema/beans/spring-beans.    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>haha<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.atguigu.boot.bean.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zhangsan<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>age<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>18<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hehe<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.atguigu.boot.bean.Pet<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tomcat<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span></code></pre><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@ImportResource</span><span class="token punctuation">(</span><span class="token string">"classpath:beans.xml"</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>测试<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>     <span class="token keyword">boolean</span> haha <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token string">"haha"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token keyword">boolean</span> hehe <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token string">"hehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"haha："</span><span class="token operator">+</span>haha<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//true </span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hehe："</span><span class="token operator">+</span>hehe<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//true</span></code></pre><h4 id="2-2-3-配置绑定"><a href="#2-2-3-配置绑定" class="headerlink" title="2.2.3 配置绑定"></a>2.2.3 配置绑定</h4><p>&emsp;&emsp;原来的方法：使用Java读取到properties文件中的内容，并且把它封装到JavaBean中，以供随时使用</p><h5 id="1、在实体类上加注解-Component-ConfigurationProperties"><a href="#1、在实体类上加注解-Component-ConfigurationProperties" class="headerlink" title="1、在实体类上加注解 @Component + @ConfigurationProperties"></a>1、在实体类上加注解 @Component + @ConfigurationProperties</h5><p><strong>注意：</strong></p><ol><li>@Component：表明将实体类加入到容器中</li><li>@ConfigurationProperties(prefix = “mycar”)：表明在配置文件中，设置该实体类值的前缀是什么</li></ol><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * 只有在容器中的组件，才会拥有SpringBoot提供的强大功能 */</span><span class="token annotation punctuation">@ToString</span><span class="token annotation punctuation">@Data</span><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"mycar"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String brand<span class="token punctuation">;</span>    <span class="token keyword">private</span> Integer price<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h5 id="2、在config类上加注解-EnableConfigurationProperties-在实体类上加-ConfigurationProperties"><a href="#2、在config类上加注解-EnableConfigurationProperties-在实体类上加-ConfigurationProperties" class="headerlink" title="2、在config类上加注解@EnableConfigurationProperties + 在实体类上加 @ConfigurationProperties"></a>2、在config类上加注解@EnableConfigurationProperties + 在实体类上加 @ConfigurationProperties</h5><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>Car<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//1、开启Car配置绑定功能 </span><span class="token comment" spellcheck="true">//2、把这个Car这个组件自动注册到容器中 </span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyConfig</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><h3 id="2-3-自动配置原理入门"><a href="#2-3-自动配置原理入门" class="headerlink" title="2.3 自动配置原理入门"></a>2.3 自动配置原理入门</h3><h4 id="2-3-1-引导加载自动配置类"><a href="#2-3-1-引导加载自动配置类" class="headerlink" title="2.3.1 引导加载自动配置类"></a>2.3.1 引导加载自动配置类</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@SpringBootConfiguration</span> <span class="token annotation punctuation">@EnableAutoConfiguration</span> <span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>excludeFilters <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FilterType<span class="token punctuation">.</span>CUSTOM<span class="token punctuation">,</span> classes <span class="token operator">=</span> TypeExcludeFilter<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> FilterType<span class="token punctuation">.</span>CUSTOM<span class="token punctuation">,</span> classes <span class="token operator">=</span> AutoConfigurationExcludeFilter<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">SpringBootApplication</span><span class="token punctuation">{</span><span class="token punctuation">}</span> </code></pre><h5 id="1、-SpringBootConfiguration"><a href="#1、-SpringBootConfiguration" class="headerlink" title="1、@SpringBootConfiguration"></a>1、@SpringBootConfiguration</h5><p>&emsp;&emsp;@Configuration。代表当前是一个配置类</p><h5 id="2、-ComponentScan"><a href="#2、-ComponentScan" class="headerlink" title="2、@ComponentScan"></a>2、@ComponentScan</h5><p>&emsp;&emsp;指定扫描哪些，Spring注解；</p><h5 id="3、-EnableAutoConfiguration"><a href="#3、-EnableAutoConfiguration" class="headerlink" title="3、@EnableAutoConfiguration"></a>3、@EnableAutoConfiguration</h5><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@AutoConfigurationPackage</span> <span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>AutoConfigurationImportSelector<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">EnableAutoConfiguration</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>(1) @AutoConfigurationPackage </p><p>&emsp;&emsp;自动配置包，指定了默认的包规则</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>AutoConfigurationPackages<span class="token punctuation">.</span>Registrar<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//给容器中导入一个组件 </span><span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">AutoConfigurationPackage</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">//利用Registrar给容器中导入一系列组件 </span><span class="token comment" spellcheck="true">//将指定的一个包下的所有组件导入进来？MainApplication 所在包下。</span></code></pre><p>(2) @Import(AutoConfigurationImportSelector.class)</p><pre class=" language-java"><code class="language-java"><span class="token number">1</span>、利用<span class="token function">getAutoConfigurationEntry</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>给容器中批量导入一些组件 <span class="token number">2</span>、调用List<span class="token operator">&lt;</span>String<span class="token operator">></span> configurations <span class="token operator">=</span> <span class="token function">getCandidateConfigurations</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span>获取到所有需要导入到容器中的配置类 <span class="token number">3</span>、利用工厂加载 Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> <span class="token function">loadSpringFactories</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> ClassLoader classLoader<span class="token punctuation">)</span>；得到所有的组件 <span class="token number">4</span>、从META<span class="token operator">-</span>INF<span class="token operator">/</span>spring<span class="token punctuation">.</span>factories位置来加载一个文件。     默认扫描我们当前系统里面所有META<span class="token operator">-</span>INF<span class="token operator">/</span>spring<span class="token punctuation">.</span>factories位置的文件     spring<span class="token operator">-</span>boot<span class="token operator">-</span>autoconfigure<span class="token operator">-</span><span class="token number">2.3</span><span class="token punctuation">.</span><span class="token number">4</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">.</span>jar包里面也有META<span class="token operator">-</span>INF<span class="token operator">/</span>spring<span class="token punctuation">.</span>factories </code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210313143555.png" alt=""></p><p>&emsp;&emsp;文件里面写死了spring-boot一启动就要给容器中加载的所有配置类 ，总共有127个（后续版本有可能改变）。</p><h4 id="2-3-2-按需开启自动配置项"><a href="#2-3-2-按需开启自动配置项" class="headerlink" title="2.3.2 按需开启自动配置项"></a>2.3.2 按需开启自动配置项</h4><p>&emsp;&emsp;虽然我们127个场景的所有自动配置启动的时候默认全部加载。xxxxAutoConfiguration ，但是按照<font color=#0000FF >条件装配规则（@Conditional）</font>，最终会按需配置。</p><h4 id="2-3-3-修改默认配置"><a href="#2-3-3-修改默认配置" class="headerlink" title="2.3.3 修改默认配置"></a>2.3.3 修改默认配置</h4><p>&emsp;&emsp;SpringBoot默认会在底层配好所有的组件。但是如果用户自己配置了以用户的优先</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span> <span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span>MultipartResolver<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//容器中有这个类型组件 </span><span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> DispatcherServlet<span class="token punctuation">.</span>MULTIPART_RESOLVER_BEAN_NAME<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//容器中没有这个名字 multipartResolve</span><span class="token keyword">public</span> MultipartResolver <span class="token function">multipartResolver</span><span class="token punctuation">(</span>MultipartResolver resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment" spellcheck="true">//给@Bean标注的方法传入了对象参数，这个参数的值就会从容器中找。 </span>    <span class="token comment" spellcheck="true">//SpringMVC multipartResolver。防止有些用户配置的文件上传解析器名称不符合规范，通过该方法统一改成默认名称。</span>    <span class="token comment" spellcheck="true">// Detect if the user has created a MultipartResolver but named it incorrectly </span>    <span class="token keyword">return</span> resolver<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><h4 id="2-3-4-总结"><a href="#2-3-4-总结" class="headerlink" title="2.3.4 总结"></a>2.3.4 总结</h4><ol><li>SpringBoot先加载所有的自动配置类  xxxxxAutoConfiguration</li><li>生效的配置类就会给容器中装配很多组件，只要容器中有这些组件，相当于这些功能就有了</li><li>每个自动配置类按照条件进行生效，默认都会绑定配置文件指定的值。xxxxProperties里面拿。xxxProperties和配置文件进行了绑定</li><li>定制化配置<ul><li>用户直接自己@Bean替换底层的组件</li><li>用户去看这个组件是获取的配置文件什么值就去修改。</li></ul></li></ol><p><font color=#FF0000 ><strong>xxxxxAutoConfiguration —&gt; 组件  —&gt; xxxxProperties里面拿值  —-&gt; application.properties</strong></font></p><h2 id="三、开发小技巧"><a href="#三、开发小技巧" class="headerlink" title="三、开发小技巧"></a>三、开发小技巧</h2><h3 id="3-1-Lombok"><a href="#3-1-Lombok" class="headerlink" title="3.1 Lombok"></a>3.1 Lombok</h3><p>简化JavaBean开发。</p><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 简化JavaBean开发 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><pre class=" language-java"><code class="language-java"><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>简化JavaBean开发<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token comment" spellcheck="true">/** * 用户 * 使用lombok简化JavaBean开发，使用注解方式开发 */</span><span class="token annotation punctuation">@Data</span>   <span class="token comment" spellcheck="true">// 生成get/set方法</span><span class="token annotation punctuation">@ToString</span>   <span class="token comment" spellcheck="true">// 生成toString方法</span><span class="token annotation punctuation">@EqualsAndHashCode</span>  <span class="token comment" spellcheck="true">// 生成hashCode</span><span class="token annotation punctuation">@NoArgsConstructor</span>  <span class="token comment" spellcheck="true">// 生成无参构造器</span><span class="token comment" spellcheck="true">//@AllArgsConstructor     // 生成全参构造器</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>    <span class="token keyword">private</span> Pet pet<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 因为该构造器中没有包含全部参数，所以需要自定义生成</span>    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> Integer age<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>简化日志开发<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>     <span class="token annotation punctuation">@Slf4j</span>     <span class="token annotation punctuation">@RestController</span>     <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{</span>         <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">)</span>         <span class="token keyword">public</span> String <span class="token function">handle01</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> String name<span class="token punctuation">)</span><span class="token punctuation">{</span>             log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"请求进来了...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">return</span> <span class="token string">"Hello, Spring Boot 2!"</span><span class="token operator">+</span><span class="token string">"你好："</span><span class="token operator">+</span>name<span class="token punctuation">;</span>         <span class="token punctuation">}</span>     <span class="token punctuation">}</span></code></pre><h3 id="3-2-dev-tools"><a href="#3-2-dev-tools" class="headerlink" title="3.2 dev-tools"></a>3.2 dev-tools</h3><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- 热部署 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre><p>&emsp;&emsp;项目或者页面修改以后：Ctrl+F9，进行重新编译</p><h3 id="3-3-Spring-Initailizr（项目初始化向导）"><a href="#3-3-Spring-Initailizr（项目初始化向导）" class="headerlink" title="3.3 Spring Initailizr（项目初始化向导）"></a>3.3 Spring Initailizr（项目初始化向导）</h3><h4 id="3-3-1-选择我们需要的开发场景"><a href="#3-3-1-选择我们需要的开发场景" class="headerlink" title="3.3.1 选择我们需要的开发场景"></a>3.3.1 选择我们需要的开发场景</h4><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210313145734.png" alt=""></p><h4 id="3-3-2-自动依赖引入"><a href="#3-3-2-自动依赖引入" class="headerlink" title="3.3.2 自动依赖引入"></a>3.3.2 自动依赖引入</h4><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210313145813.png" alt=""></p><h4 id="3-3-3-自动创建项目结构"><a href="#3-3-3-自动创建项目结构" class="headerlink" title="3.3.3 自动创建项目结构"></a>3.3.3 自动创建项目结构</h4><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210313145850.png" alt=""></p><h4 id="3-3-4-自动编写好主配置类"><a href="#3-3-4-自动编写好主配置类" class="headerlink" title="3.3.4 自动编写好主配置类"></a>3.3.4 自动编写好主配置类</h4><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210313145923.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
            <tag> Java框架 </tag>
            
            <tag> 后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【SpringBoot】01-SpringBoot简介</title>
      <link href="/2021/03/12/springboot-01-springboot-jian-jie/"/>
      <url>/2021/03/12/springboot-01-springboot-jian-jie/</url>
      
        <content type="html"><![CDATA[<h2 id="一、Spring的生态"><a href="#一、Spring的生态" class="headerlink" title="一、Spring的生态"></a>一、Spring的生态</h2><p>&emsp;&emsp;<a href="https://spring.io/projects/spring-boot" target="_blank" rel="noopener">https://spring.io/projects/spring-boot</a></p><p>&emsp;&emsp;Spring生态涵盖了：</p><p>&emsp;&emsp;1、web开发</p><p>&emsp;&emsp;2、数据访问</p><p>&emsp;&emsp;3、安全控制</p><p>&emsp;&emsp;4、分布式</p><p>&emsp;&emsp;5、消息服务</p><p>&emsp;&emsp;6、移动开发</p><p>&emsp;&emsp;7、批处理</p><p>&emsp;&emsp;……</p><h2 id="二、Spring5重大升级"><a href="#二、Spring5重大升级" class="headerlink" title="二、Spring5重大升级"></a>二、Spring5重大升级</h2><h3 id="2-1-响应式编程"><a href="#2-1-响应式编程" class="headerlink" title="2.1 响应式编程"></a>2.1 响应式编程</h3><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/image-20210312204934170.png" alt=""></p><h3 id="2-2-内部源码设计"><a href="#2-2-内部源码设计" class="headerlink" title="2.2 内部源码设计"></a>2.2 内部源码设计</h3><p>&emsp;&emsp;基于Java8的一些新特性，如：接口默认实现。重新设计源码架构。</p><h2 id="三、SpringBoot"><a href="#三、SpringBoot" class="headerlink" title="三、SpringBoot"></a>三、SpringBoot</h2><p>&emsp;&emsp;SpringBoot能快速创建出生产级别的Spring应用。</p><h3 id="3-1-SpringBoot优点"><a href="#3-1-SpringBoot优点" class="headerlink" title="3.1 SpringBoot优点"></a>3.1 SpringBoot优点</h3><ul><li>创建独立Spring应用</li><li>内嵌web服务器</li><li>自动starter依赖，简化构建配置</li><li>自动配置Spring以及第三方功能</li><li>提供生产级别的监控、健康检查及外部化配置</li><li>无代码生成、无需编写XML</li></ul><p>&emsp;&emsp;SpringBoot是整合Spring技术栈的一站式框架。<br>&emsp;&emsp;SpringBoot是简化Spring技术栈的快速开发脚手架。</p><h2 id="四、时代背景"><a href="#四、时代背景" class="headerlink" title="四、时代背景"></a>四、时代背景</h2><h3 id="4-1-微服务"><a href="#4-1-微服务" class="headerlink" title="4.1 微服务"></a>4.1 微服务</h3><ul><li>微服务是一种架构风格 </li><li>一个应用拆分为一组小型服务 </li><li>每个服务运行在自己的进程内，也就是可独立部署和升级 </li><li>服务之间使用轻量级HTTP交互 </li><li>服务围绕业务功能拆分 </li><li>可以由全自动部署机制独立部署 </li><li>去中心化，服务自治。服务可以使用不同的语言、不同的存储技术</li></ul><h3 id="4-2-分布式"><a href="#4-2-分布式" class="headerlink" title="4.2 分布式"></a>4.2 分布式</h3><p><strong>1、分布式的困难</strong></p><ul><li>远程调用</li><li>服务发现</li><li>负载均衡</li><li>服务容错</li><li>配置管理</li><li>服务监控</li><li>链路追踪</li><li>日志管理</li><li>任务调度</li><li>……</li></ul><p><strong>2、分布式的解决</strong></p><ul><li>SpringBoot + SpringCloud</li></ul><h3 id="4-3-云原生"><a href="#4-3-云原生" class="headerlink" title="4.3 云原生"></a>4.3 云原生</h3><p><strong>上云的困难</strong></p><ul><li>服务自愈</li><li>弹性伸缩</li><li>服务隔离</li><li>自动化部署</li><li>灰度发布</li><li>流量治理</li><li>……</li></ul><h2 id="五、如何学习SpringBoot"><a href="#五、如何学习SpringBoot" class="headerlink" title="五、如何学习SpringBoot"></a>五、如何学习SpringBoot</h2><p><strong>1、官网文档架构</strong></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210312210711.png" alt=""></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210312210735.png" alt=""></p><p><strong>2、查看版本新特性</strong></p><p>&emsp;&emsp;<a href="https://github.com/spring-projects/spring-boot/wiki#release-notes" target="_blank" rel="noopener">https://github.com/spring-projects/spring-boot/wiki#release-notes</a></p>]]></content>
      
      
      <categories>
          
          <category> SpringBoot </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SpringBoot </tag>
            
            <tag> Java框架 </tag>
            
            <tag> 后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-递归】递归</title>
      <link href="/2020/07/26/shu-ju-jie-gou-di-gui-di-gui/"/>
      <url>/2020/07/26/shu-ju-jie-gou-di-gui-di-gui/</url>
      
        <content type="html"><![CDATA[<h2 id="一、递归的解题模板"><a href="#一、递归的解题模板" class="headerlink" title="一、递归的解题模板"></a>一、递归的解题模板</h2><h3 id="1-1-解题步骤"><a href="#1-1-解题步骤" class="headerlink" title="1.1 解题步骤"></a>1.1 解题步骤</h3><ol><li>判断当前情况是否非法，如果非法就立即返回，这一步也被称为完整性检查（Sanity Check）。例如，看看当前处理的情况是否越界，是否出现了不满足条件的情况。通常，这一部分代码都是写在最前面的。</li><li>判断是否满足结束递归的条件。在这一步当中，处理的基本上都是一些推导过程当中所定义的初始情况。</li><li>将问题的规模缩小，递归调用。在归并排序和快速排序中，我们将问题的规模缩小了一半，而在汉诺塔和解码的例子中，我们将问题的规模缩小了一个。</li><li>利用在小规模问题中的答案，结合当前的数据进行整合，得出最终的答案。</li></ol><h3 id="1-2-代码实现"><a href="#1-2-代码实现" class="headerlink" title="1.2 代码实现"></a>1.2 代码实现</h3><pre class=" language-java"><code class="language-java">function <span class="token function">fn</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 第一步：判断输入或者状态是否非法？</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token operator">/</span>state is invalid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 第二步：判读递归是否应当结束?</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>match condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> some value<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 第三步：缩小问题规模</span>    result1 <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span>    result2 <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>n2<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment" spellcheck="true">// 第四步: 整合结果</span>    <span class="token keyword">return</span> <span class="token function">combine</span><span class="token punctuation">(</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="1-3-递归复杂度分析"><a href="#1-3-递归复杂度分析" class="headerlink" title="1.3 递归复杂度分析"></a>1.3 递归复杂度分析</h3><p>&emsp;&emsp;分析递归算法推荐两种方法：迭代法和公式法</p><ol><li><p><strong>迭代法</strong></p><p>&emsp;&emsp;假设这个递归函数的运行时间是 T(n)。两次调用递归函数，每次都使问题的规模减少 1 个，得到两倍的 T(n-1)。因此得出：T(n) = 1 + 2×T(n - 1) + 1，即T(n) = 2×T(n - 1) + O(1)。用迭代法将 T(n) 进行展开。</p><img src="../images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%80%92%E5%BD%92%E3%80%91%E9%80%92%E5%BD%92/image-20200726171421540.png" style="zoom: 67%;" /></li></ol><ol start="2"><li><strong>公式法</strong></li></ol><p>&emsp;&emsp;当递归函数的时间执行函数满足如下的关系式时，我们可以利用公式法：T(n) = a×T(n/b) + f(n)。</p><p>&emsp;&emsp;<font color=#FF0000 >其中，f(n) 是每次递归完毕之后额外的计算执行时间。例如，在归并排序中，每次递归处理完两边的数组后，我们需要执行合并的操作，那么这个操作的执行时间就是 f(n)。</font></p><img src="../images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%80%92%E5%BD%92%E3%80%91%E9%80%92%E5%BD%92/image-20200726171958756.png" alt="image-20200726171958756" style="zoom:67%;" /><h2 id="二、回溯的解题模板"><a href="#二、回溯的解题模板" class="headerlink" title="二、回溯的解题模板"></a>二、回溯的解题模板</h2><h3 id="2-1-解题步骤"><a href="#2-1-解题步骤" class="headerlink" title="2.1 解题步骤"></a>2.1 解题步骤</h3><ol><li>判断当前情况是否非法，如果非法就立即返回；</li><li>当前情况是否已经满足递归结束条件，如果是就将当前结果保存起来并返回；</li><li>当前情况下，遍历所有可能出现的情况并进行下一步的尝试；</li><li>递归完毕后，立即回溯，回溯的方法就是取消前一步进行的尝试。</li></ol><h3 id="2-2-代码模板"><a href="#2-2-代码模板" class="headerlink" title="2.2 代码模板"></a>2.2 代码模板</h3><pre class=" language-java"><code class="language-java">function <span class="token function">fn</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 第一步：判断输入或者状态是否非法？</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token operator">/</span>state is invalid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 第二步：判读递归是否应当结束?</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>match condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> some value<span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 遍历所有可能出现的情况</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>all possible cases<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 第三步: 尝试下一步的可能性</span>        solution<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">case</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 递归</span>        result <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 第四步：回溯到上一步</span>        solution<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token keyword">case</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="2-3-例题分析"><a href="#2-3-例题分析" class="headerlink" title="2.3 例题分析"></a>2.3 例题分析</h3><p>&emsp;&emsp;LeetCode 第 39 题：给定一个无重复元素的数组 candidates 和一个目标数 target ，找出 candidates 中所有可以使数字和为 target 的组合。candidates 中的数字可以无限制重复被选取。</p><p>说明：</p><ul><li>所有数字（包括 target）都是正整数。</li><li>解集不能包含重复的组合。</li></ul><p>&emsp;&emsp;<strong>回溯法思路</strong></p><ol><li>从一个空的集合开始，小心翼翼地往里面添加元素。</li><li>每次添加，检查一下当前的总和是否等于给定的目标。</li><li>如果总和已经超出了目标，说明没有必要再尝试其他的元素了，返回并尝试其他的元素；</li><li>如果总和等于目标，就把当前的组合添加到结果当中，表明我们找到了一种满足要求的组合，同时返回，并试图寻找其他的集合。</li></ol><p>&emsp;&emsp;<strong>代码实现</strong></p><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">combinationSum</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidates<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> results<span class="token punctuation">;</span>    <span class="token function">backtracking</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> results <span class="token operator">-</span> 换另外一种颜色高亮<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> results<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">void</span> backtracking <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidates<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> solution<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> results<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> candidates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        solution<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>candidates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">backtracking</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> target <span class="token operator">-</span> candidates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> solution<span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>        solution<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;在主函数里：</p><ol><li>定义一个 results 数组用来保存最终的结果；</li><li>调用函数 backtracking，并将初始的情况以及 results 传递进去，这里的初始情况就是从第一个元素开始尝试，而且初始的子集为空。</li></ol><p>&emsp;&emsp;在 backtracking 函数里：</p><ol><li>检查当前的元素总和是否已经超出了目标给定的值，每添加进一个新的元素时，就将它从目标总和中减去；</li><li>如果总和已经超出了目标给定值，就立即返回，去尝试其他的数值；<br> 如果总和刚好等于目标值，就把当前的子集添加到结果中。</li></ol><p>&emsp;&emsp;在循环体内：</p><ol><li>每次添加了一个新的元素，立即递归调用 backtracking，看是否找到了合适的子集</li><li>递归完毕后，要把上次尝试的元素从子集里删除，这是最重要的。</li></ol><p>&emsp;&emsp;以上，就完成了回溯。</p>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
          <category> 递归 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 递归 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬虫入门</title>
      <link href="/2020/05/07/pa-chong-ru-men/"/>
      <url>/2020/05/07/pa-chong-ru-men/</url>
      
        <content type="html"><![CDATA[<h2 id="一、爬虫的基本套路"><a href="#一、爬虫的基本套路" class="headerlink" title="一、爬虫的基本套路"></a>一、爬虫的基本套路</h2><p>&emsp;&emsp;1.打开资源</p><p>&emsp;&emsp;2.定位资源</p><p>&emsp;&emsp;3.解析资源</p><p>&emsp;&emsp;4.下载资源</p><h3 id="1-1-打开目标网址"><a href="#1-1-打开目标网址" class="headerlink" title="1.1 打开目标网址"></a>1.1 打开目标网址</h3><p>&emsp;&emsp;在python中，可以使用 <strong>requests</strong> 这一工具包来发送HTTP请求。为了了解程序所“看到” 页面是什么样子的，我们需要把程序所得到HTML文件保存到本地，然后再用浏览器打开，就能和程序感同身受了。从而达到“人机合一”的境界。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">"https://www.nanrentu.cc/sgtp/"</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#打印请求结果的状态码</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#打印请求到的网页源码</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"result.html"</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>&emsp;&emsp;代码解析：</p><p>&emsp;&emsp;第3行：使用<code>requests</code>类库，以<code>get</code>的方式请求网址，并将服务器返回的结果封装成一个对象，用变量<code>response</code>来接收它。</p><p>&emsp;&emsp;第4行：一般可以根据状态码来判断是否请求成功，正常的状态码是200，异常状态码就很多了，比如404（找不到网页）、301（重定向）等。</p><p>&emsp;&emsp;第5行：打印网页的源码。注意，只是源码。不像是浏览器，在获取到源码之后，还会进一步地取请求源码中引用的图片等信息，如果有JS，浏览器还会执行JS，对页面显示的内容进行修改。使用requests进行请求，我们能够直接获取到的，只有最初始的网页源码。也正是因为这样，不加载图片、不执行JS等等，爬虫请求的速度会非常快。</p><p>&emsp;&emsp;在浏览器打开result.html是这样子的</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC8zLzUvMTcwYTg1OThjMWJkOTg3MQ.jpg" alt=""></p><p>&emsp;&emsp;这怎么和在浏览器中看到的不一样呢？</p><p>&emsp;&emsp;这个时候我就要亮出一件绝世宝贝————Chrome调试台（按F12）来给您分析一波了。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC8zLzUvMTcwYTg1OTg0NGM5YWNmYg.jpg" alt=""></p><p>&emsp;&emsp;其实我们在浏览器中看到的页面并不仅仅是HTML页面，而是css、js、html以及各种媒体资源综合在一起并有浏览器最终渲染而出页面，红框的部分，标出了在这个过程中所加载的各个资源。</p><h3 id="1-2-找到目标资源"><a href="#1-2-找到目标资源" class="headerlink" title="1.2 找到目标资源"></a>1.2 找到目标资源</h3><p>&emsp;&emsp;写过前端页面的朋友都知道CSS样式用过各种选择器来绑定到对应的节点上，那么我们也可以通过CSS的选择器来选中我们想要的元素，从而提取信息。Chrome中已经准备了CSS选择器神器，可以生成我们想要元素的选择器。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC8zLzUvMTcwYTg1OThlMTA1YmZhOQ.jpg" alt="复制css选择器"></p><h3 id="1-3-解析页面"><a href="#1-3-解析页面" class="headerlink" title="1.3 解析页面"></a>1.3 解析页面</h3><p>&emsp;&emsp;这个时候要介绍页面解析神器<strong>pyquery</strong>，这个工具库可以通过我们所复制的CSS选择器，在 HTML 页面中查找对应元素，并且能很便捷地提取各种属性。</p><p>&emsp;&emsp;将代码改成如下这样：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> pyquery <span class="token keyword">import</span> PyQuery <span class="token keyword">as</span> pqurl <span class="token operator">=</span> <span class="token string">"https://www.nanrentu.cc/sgtp/"</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"result.html"</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 开始解析</span>    doc <span class="token operator">=</span> pq<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 把复制的选择器粘贴进去</span>    <span class="token comment" spellcheck="true"># 选择对应的节点</span>    imgElement <span class="token operator">=</span> doc<span class="token punctuation">(</span><span class="token string">'body > div:nth-child(5) > div > div > div:nth-child(2) > ul > li:nth-child(3) > a > img'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 提取属性，获取图片链接</span>    imgSrc <span class="token operator">=</span> imgElement<span class="token punctuation">.</span>attr<span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 将图片链接输出在屏幕上</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>imgSrc<span class="token punctuation">)</span></code></pre><h3 id="1-4-存储目标"><a href="#1-4-存储目标" class="headerlink" title="1.4 存储目标"></a>1.4 存储目标</h3><p>&emsp;&emsp;下载图片的过程其实和抓取HTML页面的流程是一样的，也是利用 <strong>requests</strong> 发送请求从而获取到数据流再保存到本地。</p><pre class=" language-Python"><code class="language-Python">import requestsfrom pyquery import PyQuery as pqurl = "https://www.nanrentu.cc/sgtp/"response = requests.get(url)if response.status_code == 200:    with open("result.html",'w',encoding="utf-8") as f:        f.write(response.text)    doc = pq(response.text)    imgElement = doc('body > div:nth-child(5) > div > div > div:nth-child(2) > ul > li:nth-child(3) > a > img')    imgSrc = imgElement.attr('src')    print(imgSrc)    # 下载图片    imgResponse = requests.get(imgSrc)    if imgResponse.status_code == 200:        # 填写文件路径 以二进制的形式写入文件        with open('./images/boy.jpg', 'wb') as f:            f.write(imgResponse.content)            f.close()</code></pre><h2 id="二、爬虫升级"><a href="#二、爬虫升级" class="headerlink" title="二、爬虫升级"></a>二、爬虫升级</h2><p>&emsp;&emsp;通过上述步骤我们只能获取到一张图片，那接下来，我们就<font color=#FF0000 >升级一波选择器</font>，将图片全部下载下来。</p><h3 id="2-1-重构代码"><a href="#2-1-重构代码" class="headerlink" title="2.1 重构代码"></a>2.1 重构代码</h3><p>&emsp;&emsp;为了以后写代码方便，要先进行一个简单的重构，让代码条理更清晰。</p><p>&emsp;&emsp;&emsp;1.增加入口函数</p><p>&emsp;&emsp;&emsp;2.封装对于图片的操作</p><p>&emsp;&emsp;重构后的代码：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> pyquery <span class="token keyword">import</span> PyQuery <span class="token keyword">as</span> pq<span class="token keyword">def</span> <span class="token function">saveImage</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    imgResponse <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>    fileName <span class="token operator">=</span> <span class="token string">"./images/%s.jpg"</span> <span class="token operator">%</span> name    <span class="token keyword">if</span> imgResponse<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>imgResponse<span class="token punctuation">.</span>content<span class="token punctuation">)</span>            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    baseUrl <span class="token operator">=</span> <span class="token string">"https://www.nanrentu.cc/sgtp/"</span>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span>    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"result.html"</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>        doc <span class="token operator">=</span> pq<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>        imgElement <span class="token operator">=</span> doc<span class="token punctuation">(</span><span class="token string">'body > div:nth-child(5) > div > div > div:nth-child(2) > ul > li:nth-child(3) > a > img'</span><span class="token punctuation">)</span>        imgSrc <span class="token operator">=</span> imgElement<span class="token punctuation">.</span>attr<span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>imgSrc<span class="token punctuation">)</span>        saveImage<span class="token punctuation">(</span>imgSrc<span class="token punctuation">,</span><span class="token string">'boy'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="2-2-升级选择器"><a href="#2-2-升级选择器" class="headerlink" title="2.2 升级选择器"></a>2.2 升级选择器</h3><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAyMC8zLzUvMTcwYTg1OTk2NjY2MzAwZg.jpg" alt=""></p><p>&emsp;&emsp;多拿着鼠标点点这个调试台，一层层地看这个HTML文件的元素层级，找到其中相同重复的地方，这就是我们的突破口所在。</p><p>&emsp;&emsp;我们可以看出图片都在一个类名为 h-piclist 的 <ul> 标签中，那么我们可写出以下的选择器 <font color=#FF0000 ><code>.h-piclist &gt; li &gt; a &gt; img</code></font>。这样就选中了这一页所有的图片元素。接着用一个 for 循环遍历就可以了。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">from</span> pyquery <span class="token keyword">import</span> PyQuery <span class="token keyword">as</span> pq<span class="token comment" spellcheck="true"># 引入UUID为图片命名</span><span class="token keyword">import</span> uuid<span class="token keyword">def</span> <span class="token function">saveImage</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>    imgResponse <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>    fileName <span class="token operator">=</span> <span class="token string">"./images/%s.jpg"</span> <span class="token operator">%</span> name    <span class="token keyword">if</span> imgResponse<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>imgResponse<span class="token punctuation">.</span>content<span class="token punctuation">)</span>            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    baseUrl <span class="token operator">=</span> <span class="token string">"https://www.nanrentu.cc/sgtp/"</span>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>baseUrl<span class="token punctuation">)</span>    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"result.html"</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>        doc <span class="token operator">=</span> pq<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 选则这一页中所有的目标图片元素</span>        imgElements <span class="token operator">=</span> doc<span class="token punctuation">(</span><span class="token string">'.h-piclist > li > a > img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 遍历这些图片元素</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> imgElements<span class="token punctuation">:</span>            imgSrc <span class="token operator">=</span> i<span class="token punctuation">.</span>attr<span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>imgSrc<span class="token punctuation">)</span>            saveImage<span class="token punctuation">(</span>imgSrc<span class="token punctuation">,</span>uuid<span class="token punctuation">.</span>uuid1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hex<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="三、爬虫伪装"><a href="#三、爬虫伪装" class="headerlink" title="三、爬虫伪装"></a>三、爬虫伪装</h2><p>&emsp;&emsp;爬虫的伪装，目的是为了让对方网站更加确信来访者不是爬虫程序，而是一个活生生的人。人们通过操控浏览器来访问网站，那么爬虫程序只需要模仿浏览器就可以了。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/20200316100548544.png" alt=""></p><p>&emsp;&emsp;打开Chrome并打开调试台，切换到NetWork选项卡，此时访问 <a href="https://www.nanrentu.cc/sgtp/，" target="_blank" rel="noopener">https://www.nanrentu.cc/sgtp/，</a> 这是时候会看到调试台里出现了很多链接信息，这么多链接到底哪个是我们所需要的呢？回想一下上一篇内容，首先是要获得HTML文档，再从此文档中提取出图片的链接，所以目标有了，就是找到浏览器获取到这个HTML文档的那个链接。</p><p>&emsp;&emsp;Chrome知道这么多链接信息肯定会让开发者陷入茫然，所以给链接进行了归类，点击上方Doc分类，再点击那唯一的一条链接，就会看到获取此HTML文档链接的详细信息了。此时我们关注主要Request Headers 这个里面的内容。浏览器通过http协议与服务器交互获取信息，爬虫是通过模仿浏览器发出http协议获取信息，其中最重要的一个模仿点就是Request Headers。</p><h3 id="3-1-http协议里面的“瓶瓶罐罐”"><a href="#3-1-http协议里面的“瓶瓶罐罐”" class="headerlink" title="3.1 http协议里面的“瓶瓶罐罐”"></a>3.1 http协议里面的“瓶瓶罐罐”</h3><pre class=" language-html"><code class="language-html">:authority: www.nanrentu.cc:method: GET   // 自定义请求头 请求方法:path: /sgtp/  // 自定义请求头 请求路径:scheme: https // 自定义请求头 请求方式// 所接受的内容格式accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9// 所接受的编码方式accept-encoding: gzip, deflate, br// 所接受的语言accept-language: zh-CN,zh;q=0.9// 缓存控制：告诉服务器客户端希望得到一个最新的资源cache-control: max-age=0cookie: UM_distinctid=170a5a00fa25bf-075185606c88b7-396d7407-100200-170a5a00fa3507; Hm_lvt_45e50d2aec057f43a3112beaf7f00179=1583326696,1583756661; CNZZDATA1274895726=1196969733-1583323670-%7C1583752625; Hm_lpvt_45e50d2aec057f43a3112beaf7f00179=1583756721sec-fetch-dest: documentsec-fetch-mode: navigatesec-fetch-site: nonesec-fetch-user: ?1// 屏蔽HTTPS页面出现HTTP请求警报upgrade-insecure-requests: 1user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36</code></pre><p>&emsp;&emsp;这么多的信息不用都给爬虫加上，因为这网站的防爬措施等级不高，暂时只要关键的两个就可以了。</p><ul><li><font color=#FF0000 >cookie</font>： 这是存储在浏览器里面一段文本，有时包含了验证信息和一些特殊的请求信息</li><li><font color=#FF0000 >user-agent</font>：用于标识此请求是由什么工具所发出的</li></ul><pre class=" language-Python"><code class="language-Python"># 建立一个名叫headers的字典headers = {    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36',    'cookie': 'UM_distinctid=170a5a00fa25bf-075185606c88b7-396d7407-100200-170a5a00fa3507; CNZZDATA1274895726=1196969733-1583323670-%7C1583925652; Hm_lvt_45e50d2aec057f43a3112beaf7f00179=1583326696,1583756661,1583926583; Hm_lpvt_45e50d2aec057f43a3112beaf7f00179=1583926583'}# 发送请求时带上请求头response = requests.get(baseUrl,headers=headers)</code></pre><h3 id="3-2-顺藤摸瓜"><a href="#3-2-顺藤摸瓜" class="headerlink" title="3.2 顺藤摸瓜"></a>3.2 顺藤摸瓜</h3><p>&emsp;&emsp;一个网站是由若干个网页组合而成的，网页中充满着各种超链接，从这网页链接到那个网页，如果我们想要更多图片，那就得首先分析出串联起他们那些超链接，然后就可以顺藤摸瓜咯。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/20200316100632511.png" alt=""></p><p>&emsp;&emsp;当把鼠标发放到标题上时，标题的颜色发生了变化，证明这一元素为超连接，点击标题浏览器会自动打开一个tab标签页，来显示网页，注意到下方的页码标签，是这些元素串联起了整个图集。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/20200316100726373.png" alt=""></p><p>&emsp;&emsp;点击“末页”观察url发生了什么变化</p><p>&emsp;&emsp;末页的url：<a href="https://www.nanrentu.cc/sgtp/36805_7.html" target="_blank" rel="noopener">https://www.nanrentu.cc/sgtp/36805_7.html</a></p><p>&emsp;&emsp;首页的url：<a href="https://www.nanrentu.cc/sgtp/36805.html" target="_blank" rel="noopener">https://www.nanrentu.cc/sgtp/36805.html</a></p><h4 id="3-2-1-提取标题链接"><a href="#3-2-1-提取标题链接" class="headerlink" title="3.2.1 提取标题链接"></a>3.2.1 提取标题链接</h4><p>&emsp;&emsp;打开调试台切换到Elements选项卡就能开始探索提取了。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/20200316101245659.png" alt="提取标题链接"></p><h4 id="3-2-2-提取末页链接，得到组图页数"><a href="#3-2-2-提取末页链接，得到组图页数" class="headerlink" title="3.2.2 提取末页链接，得到组图页数"></a>3.2.2 提取末页链接，得到组图页数</h4><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/20200316100817850.png" alt=""></p><p>&emsp;&emsp;通过观察HTML元素结构，可发现包含末页的 <li> 标签为其父元素<ul>的倒数第二个子元素，所以可得出以下的css选择器</p><p>&emsp;&emsp;<font color=#FF0000 >.page &gt; ul &gt; li:nth-last-child(2) &gt; a</font></p><h4 id="3-2-3-根据首尾链接构造URL"><a href="#3-2-3-根据首尾链接构造URL" class="headerlink" title="3.2.3 根据首尾链接构造URL"></a>3.2.3 根据首尾链接构造URL</h4><p>&emsp;&emsp;为了构造url更加方便，我们可以把首页 <a href="https://www.nanrentu.cc/sgtp/36805.html" target="_blank" rel="noopener">https://www.nanrentu.cc/sgtp/36805.html</a> 变为 <a href="https://www.nanrentu.cc/sgtp/36805_1.html" target="_blank" rel="noopener">https://www.nanrentu.cc/sgtp/36805_1.html</a>, 在浏览器中打开带有后缀的这个网址，依然能够成功访问到首页，不要问我为什么？这可能就是程序员之间的一种默契吧~</p><h4 id="3-2-4-存储图片，摸瓜成功"><a href="#3-2-4-存储图片，摸瓜成功" class="headerlink" title="3.2.4 存储图片，摸瓜成功"></a>3.2.4 存储图片，摸瓜成功</h4><pre class=" language-Python"><code class="language-Python">import requestsfrom pyquery import PyQuery as pqimport uuidheaders = {    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36',    'cookie': 'UM_distinctid=170a5a00fa25bf-075185606c88b7-396d7407-100200-170a5a00fa3507; CNZZDATA1274895726=1196969733-1583323670-%7C1583925652; Hm_lvt_45e50d2aec057f43a3112beaf7f00179=1583326696,1583756661,1583926583; Hm_lpvt_45e50d2aec057f43a3112beaf7f00179=1583926583'}def saveImage(imgUrl,name):    imgResponse = requests.get(imgUrl)    fileName = "./images/%s.jpg" % name    if imgResponse.status_code == 200:        with open(fileName, 'wb') as f:            f.write(imgResponse.content)            f.close()def getPic(urlArray):    for url in urlArray:        res = requests.get(url,headers=headers)        if res.status_code == 200:            doc = pq(res.text)            imgSrc = doc('.info-pic-list > a > img').attr('src')            print(imgSrc)            saveImage(imgSrc,uuid.uuid1().hex)def createUrl(indexUrl,allPage):    baseUrl = indexUrl.split('.html')[0]    urlArray = []    for i in range(1,allPage):        tempUrl = baseUrl+"_"+str(i)+".html"        urlArray.append(tempUrl)    return urlArraydef getBoys(link):    # 摸瓜第1步：获取首页连接    picIndex = link.attr('href')    #  摸瓜第2步：打开首页，提取末页链接，得出组图页数    res = requests.get(picIndex,headers=headers)    print("当前正在抓取的 picIndex: " + picIndex)    if res.status_code == 200:        with open("picIndex.html",'w',encoding="utf-8") as f:            f.write(res.text)        doc = pq(res.text)        lastLink = doc('.page > ul > li:nth-last-child(2) > a').attr('href')        # 字符串分割，得出全部的页数        if(lastLink is None):            return        # 以.html 为分割符进行分割，取结果数组中的第一项        temp = lastLink.split('.html')[0]        # 再以下划线 _ 分割，取结果数组中的第二项,再转为数值型        allPage = int(temp.split('_')[1])        # 摸瓜第3步：根据首尾链接构造url        urlArray = createUrl(picIndex,allPage)        # 摸瓜第4步：存储图片，摸瓜成功        getPic(urlArray)def main():    baseUrl = "https://www.nanrentu.cc/sgtp/"    response = requests.get(baseUrl,headers=headers)    if response.status_code == 200:        with open("index.html",'w',encoding="utf-8") as f:            f.write(response.text)        doc = pq(response.text)        # 得到所有图集的标题连接        titleLinks = doc('.h-piclist > li > a').items()        # 遍历这些连接        for link in titleLinks:            getBoys(link)if __name__ == "__main__":    main()</code></pre><p>&emsp;&emsp;回顾整个爬虫程序，它是连续式流水线作业，每一步之间都是环环相扣，所以在写程序前自己一定要把整个流水线的每个环节都考虑清楚，把它们之间的顺序依赖关系化成一个简易的流程图，对着流程图再写程序就会清晰很多。我们可以把每一个模块都写成一个函数，先对函数做好单元测试，再把这些函数按顺序组合起来就行啦。</p><p>&emsp;&emsp;这个流程图只用单项箭头画出了获取一张图片的全部过程。</p><p><img src="/images/%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/aHR0cHM6Ly9zMS5heDF4LmNvbS8yMDIwLzAzLzEyLzhlb2FEQS5wbmc.jpg" alt="爬虫流程"></p><h2 id="四、提高爬虫速率——多线程"><a href="#四、提高爬虫速率——多线程" class="headerlink" title="四、提高爬虫速率——多线程"></a>四、提高爬虫速率——多线程</h2><p>&emsp;&emsp;当然在整个程序当中，不可能一开始就搞个并行执行，串行是并行的基础，它们两者相辅相成。只有当程序出现分支（进入for循环）此时多线程可以派上用场，为每一个分支开启一个线程从而加速程序的执行。</p><p>&emsp;&emsp;对于萌新可以粗暴简单地理解：<font color=#FF0000 >没有for循环，就不用多线程</font>。</p><p>&emsp;&emsp;对于有一定编程经验的同学可以这样理解：<font color=#FF0000 >当程序中出现耗时操作时，要另开一个线程处理此操作。所谓耗时操做比如：文件IO、网络IO……</font>。</p><h3 id="4-1-定义一个线程类"><a href="#4-1-定义一个线程类" class="headerlink" title="4.1 定义一个线程类"></a>4.1 定义一个线程类</h3><p>&emsp;&emsp;Python3中提供了<a href="https://www.runoob.com/python3/python3-multithreading.html" target="_blank" rel="noopener">threading</a>模块用于帮助用户构建多线程程序。我们首先将基于此模块来自定义一个线程类，用于消灭遍历图集时所需要的等待。</p><h4 id="4-1-1-线程ID"><a href="#4-1-1-线程ID" class="headerlink" title="4.1.1 线程ID"></a>4.1.1 线程ID</h4><p>&emsp;&emsp;程序执行时会开启很多个线程，为了后期方便管理这些线程，可以在线程类的构造方法中添加threadID这一参数，为每个线程赋予唯一的ID号。</p><h4 id="4-1-2-所执行目标方法的参数"><a href="#4-1-2-所执行目标方法的参数" class="headerlink" title="4.1.2 所执行目标方法的参数"></a>4.1.2 所执行目标方法的参数</h4><p>&emsp;&emsp;一般来说定义一个线程类主要目的是让此线程去执行一个耗时的方法，所以这个线程类的构造方法中所需要传入所要执行目的方法的参数。比如 handleTitleLinks 这个类主要用来执行getBoys() （参见文末中的完整代码）这一方法。getBoys() 所需一个标题的连接作为参数，所以在handleTitleLinks的构造方法中也需要传入一个链接。</p><h4 id="4-1-3-调用目标方法"><a href="#4-1-3-调用目标方法" class="headerlink" title="4.1.3 调用目标方法"></a>4.1.3 调用目标方法</h4><p>&emsp;&emsp;线程类需要一个run(),在此方法中传入参数，调用所需执行的目标方法即可。</p><pre class=" language-Python"><code class="language-Python">class handleTitleLinks (threading.Thread):    def __init__(self,threadID,link):        threading.Thread.__init__(self)        self.threadID = threadID        self.link = link    def run(self):        print ("start handleTitleLinks：" + self.threadID)        getBoys(self.link)        print ("exit handleTitleLinks：" + self.threadID)</code></pre><h3 id="4-2-实例化线程对象代替目标方法"><a href="#4-2-实例化线程对象代替目标方法" class="headerlink" title="4.2 实例化线程对象代替目标方法"></a>4.2 实例化线程对象代替目标方法</h3><p>&emsp;&emsp;当把线程类定义好之后，找到曾经耗时的目标方法，实例化一个线程对象将其代替即可。</p><pre class=" language-Python"><code class="language-Python">def main():    baseUrl = "https://www.nanrentu.cc/sgtp/"    response = requests.get(baseUrl,headers=headers)    if response.status_code == 200:        with open("index.html",'w',encoding="utf-8") as f:            f.write(response.text)        doc = pq(response.text)        # 得到所有图集的标题连接        titleLinks = doc('.h-piclist > li > a').items()        # 遍历这些连接        for link in titleLinks:            # 替换目标方法，开启线程            handleTitleLinks(uuid.uuid1().hex,link).start()            # getBoys(link)</code></pre><h3 id="4-3-如法炮制"><a href="#4-3-如法炮制" class="headerlink" title="4.3 如法炮制"></a>4.3 如法炮制</h3><p>&emsp;&emsp;我们已经定义了一个线程去处理每个图集，但是在处理每个图集的过程中还会有分支（参见程序并行执行图）去下载图集中的图片。此时需要再定义一个线程用来下载图片，即定义一个线程去替换getImg()。</p><pre class=" language-Python"><code class="language-Python">class handleGetImg (threading.Thread):    def __init__(self,threadID,urlArray):        threading.Thread.__init__(self)        self.threadID = threadID        self.url = url    def run(self):        print ("start handleGetImg：" + self.threadID)        getPic(self.urlArray)        print ("exit handleGetImg：" + self.threadID)</code></pre><h3 id="4-4-完整代码"><a href="#4-4-完整代码" class="headerlink" title="4.4 完整代码"></a>4.4 完整代码</h3><pre class=" language-Python"><code class="language-Python">#!/usr/bin/python3import requestsfrom pyquery import PyQuery as pqimport uuidimport threadingheaders = {    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36',    'cookie': 'UM_distinctid=170a5a00fa25bf-075185606c88b7-396d7407-100200-170a5a00fa3507; CNZZDATA1274895726=1196969733-1583323670-%7C1583925652; Hm_lvt_45e50d2aec057f43a3112beaf7f00179=1583326696,1583756661,1583926583; Hm_lpvt_45e50d2aec057f43a3112beaf7f00179=1583926583'}def saveImage(imgUrl,name):    imgResponse = requests.get(imgUrl)    fileName = "./images/%s.jpg" % name    if imgResponse.status_code == 200:        with open(fileName, 'wb') as f:            f.write(imgResponse.content)            f.close()# 根据链接找到图片并下载           def getImg(url):    res = requests.get(url,headers=headers)    if res.status_code == 200:        doc = pq(res.text)        imgSrc = doc('.info-pic-list > a > img').attr('src')        print(imgSrc)        saveImage(imgSrc,uuid.uuid1().hex)# 遍历组图链接def getPic(urlArray):    for url in urlArray:        # 替换方法        handleGetImg(uuid.uuid1().hex,url).start()        # getImg(url)def createUrl(indexUrl,allPage):    baseUrl = indexUrl.split('.html')[0]    urlArray = []    for i in range(1,allPage):        tempUrl = baseUrl+"_"+str(i)+".html"        urlArray.append(tempUrl)    return urlArraydef getBoys(link):    # 摸瓜第1步：获取首页连接    picIndex = link.attr('href')    #  摸瓜第2步：打开首页，提取末页链接，得出组图页数    res = requests.get(picIndex,headers=headers)    print("当前正在抓取的 picIndex: " + picIndex)    if res.status_code == 200:        with open("picIndex.html",'w',encoding="utf-8") as f:            f.write(res.text)        doc = pq(res.text)        lastLink = doc('.page > ul > li:nth-last-child(2) > a').attr('href')        # 字符串分割，得出全部的页数        if(lastLink is None):            return        # 以.html 为分割符进行分割，取结果数组中的第一项        temp = lastLink.split('.html')[0]        # 再以下划线 _ 分割，取结果数组中的第二项,再转为数值型        allPage = int(temp.split('_')[1])        # 摸瓜第3步：根据首尾链接构造url        urlArray = createUrl(picIndex,allPage)        # 摸瓜第4步：存储图片，摸瓜成功        getPic(urlArray)def main():    baseUrl = "https://www.nanrentu.cc/sgtp/"    response = requests.get(baseUrl,headers=headers)    if response.status_code == 200:        with open("index.html",'w',encoding="utf-8") as f:            f.write(response.text)        doc = pq(response.text)        # 得到所有图集的标题连接        titleLinks = doc('.h-piclist > li > a').items()        # 遍历这些连接        for link in titleLinks:            # 替换方法，开启线程            handleTitleLinks(uuid.uuid1().hex,link).start()            # getBoys(link)# 处理组图链接的线程类class handleTitleLinks (threading.Thread):    def __init__(self,threadID,link):        threading.Thread.__init__(self)        self.threadID = threadID        self.link = link    def run(self):        print ("start handleTitleLinks：" + self.threadID)        getBoys(self.link)        print ("exit handleTitleLinks：" + self.threadID)# 下载图片的线程类class handleGetImg (threading.Thread):    def __init__(self,threadID,url):        threading.Thread.__init__(self)        self.threadID = threadID        self.url = url    def run(self):        print ("start handleGetImg：" + self.threadID)        getImg(self.url)        print ("exit handleGetImg：" + self.threadID)if __name__ == "__main__":    main()</code></pre>]]></content>
      
      
      <categories>
          
          <category> 爬虫 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爬虫 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【作业二】逻辑回归-收入分类</title>
      <link href="/2020/04/22/zuo-ye-er-luo-ji-hui-gui-shou-ru-fen-lei/"/>
      <url>/2020/04/22/zuo-ye-er-luo-ji-hui-gui-shou-ru-fen-lei/</url>
      
        <content type="html"><![CDATA[<h2 id="一、作业要求"><a href="#一、作业要求" class="headerlink" title="一、作业要求"></a>一、作业要求</h2><p>&emsp;&emsp;根据收集来的资料，判断每个人其年收入是否高于50000美元，用<strong>Logistic regression</strong>和<strong>Generative model</strong>两种方法来实现</p><p>&emsp;&emsp;数据下载地址：<a href="https://pan.baidu.com/s/17mJnAGLtRadHtdZLX1k43A" target="_blank" rel="noopener">https://pan.baidu.com/s/17mJnAGLtRadHtdZLX1k43A</a> </p><p>&emsp;&emsp;提取码：vcj8</p><h2 id="二、Logistic-regression实现"><a href="#二、Logistic-regression实现" class="headerlink" title="二、Logistic regression实现"></a>二、<strong>Logistic regression</strong>实现</h2><pre class=" language-Python"><code class="language-Python">import numpy as npimport matplotlib as mplimport matplotlib.pyplot as pltimport pandas as pdnp.random.seed(0)</code></pre><h3 id="2-1-添加路径"><a href="#2-1-添加路径" class="headerlink" title="2.1 添加路径"></a>2.1 添加路径</h3><pre class=" language-python"><code class="language-python">X_train_file <span class="token operator">=</span> <span class="token string">'./data/X_train'</span>Y_train_file <span class="token operator">=</span> <span class="token string">'./data/Y_train'</span>X_test_file <span class="token operator">=</span> <span class="token string">'./data/X_test'</span>output_file <span class="token operator">=</span> <span class="token string">'./output/output_{}.csv'</span>   <span class="token comment" spellcheck="true">#用于测试集的预测输出</span></code></pre><h3 id="2-2-加载数据"><a href="#2-2-加载数据" class="headerlink" title="2.2 加载数据"></a>2.2 加载数据</h3><p>&emsp;&emsp;加载数据,直接导入已经处理好的数据X_train,Y_train,X_test</p><pre class=" language-Python"><code class="language-Python">def _datapreprocess(X_train_file, Y_train_file, X_test_file):    with open(X_train_file) as f:        next(f)        # s.strip(rm) ：删除s字符串中开头、结尾处，位于 rm删除序列的字符        # split ：分割；[1:]是取第1列之后的        X_train_all = np.array([line.strip('\n').split(',')[1:]  for line in f], dtype=float)    with open(Y_train_file) as f:        next(f)        Y_train_all = np.array([line.strip('\n').split(',')[1]  for line in f], dtype=float)    with open(X_test_file) as f:        next(f)        X_test = np.array([line.strip('\n').split(',')[1:]  for line in f], dtype=float)    return X_train_all, Y_train_all, X_test</code></pre><h3 id="2-3-归一化"><a href="#2-3-归一化" class="headerlink" title="2.3 归一化"></a>2.3 归一化</h3><p>&emsp;&emsp;编写一个_normalize()函数对数据进行预处理：归一化，即每个数据特征的均值和标准差进行归一化</p><pre class=" language-Python"><code class="language-Python">def _normalize(X, train=True, specified_column=None, X_mean=None, X_std=None):    # 此函数对 X 的特定列进行归一化    # 均值和方差在处理测试数据时，还会再用    # 参数解析：    #     X：要被处理的数据    #     train：为true时，处理训练数据；为false时，处理测试数据    #     specified_column：被归一化的特定列的索引，若为false，则所有列都被归一化    if specified_column == None:        #为每个数据添加索值        specified_column = np.arange(X.shape[1])    if train:        #求取每个数据的平均值和标准差        X_mean = np.mean(X[:, specified_column], 0).reshape(1,-1)        X_std = np.std(X[:, specified_column], 0).reshape(1,-1)    #归一化数据        X[:, specified_column] = (X[:, specified_column] - X_mean) / (X_std + 1e-8)    #返回归一化后的数据，均值，标准差    return X, X_mean, X_std</code></pre><h3 id="2-4-分割验证集"><a href="#2-4-分割验证集" class="headerlink" title="2.4 分割验证集"></a>2.4 分割验证集</h3><p>&emsp;&emsp;根据valid_ratio来划分训练集和验证集</p><pre class=" language-Python"><code class="language-Python">def _train_valid_split(X, Y, valid_ratio = 0.25):    train_size = int(len(X) * (1 - valid_ratio))    X_train = X[:train_size]    X_valid = X[train_size:]    Y_train = Y[:train_size]    Y_valid = Y[train_size:]    return X_train, X_valid, Y_train, Y_valid</code></pre><h3 id="2-5-打乱数据"><a href="#2-5-打乱数据" class="headerlink" title="2.5 打乱数据"></a>2.5 打乱数据</h3><p>&emsp;&emsp;打乱数据顺序，类似于重新洗牌，进行分批次训练（即每次将一部分数据喂给模型进行训练，计算损失）</p><pre class=" language-Python"><code class="language-Python">#打乱数据顺序，重新为minibatch分配def _shuffle(X, Y):    # 该函数打散两个等长的list/array----- X 和 Y    randomize = np.arange(len(X))  # 返回len(X)的序列    np.random.shuffle(randomize)    X_train = X[randomize]    Y_train = Y[randomize]    return X_train, Y_train</code></pre><h3 id="2-6-激活函数"><a href="#2-6-激活函数" class="headerlink" title="2.6 激活函数"></a>2.6 激活函数</h3><pre class=" language-Python"><code class="language-Python">def _sigmoid(z):    # numpy.clip(a, a_min, a_max, out=None): clip这个函数将将数组中的元素限制在a_min, a_max之间，    # 大于a_max的就使得它等于 a_max，小于a_min,的就使得它等于a_min。    return np.clip(1 / (1.0 + np.exp(-z)), 1e-8, 1-(1e-8)) # 相当于结果是在 0 ~ 1</code></pre><h3 id="2-7-前向传播"><a href="#2-7-前向传播" class="headerlink" title="2.7 前向传播"></a>2.7 前向传播</h3><p>&emsp;&emsp;前向传播然后利用sigmoid激活函数计算激活值</p><pre class=" language-Python"><code class="language-Python">def _f(X, w, b):    # logistic regression    # 参数解析：    #     X：输入数据-------> [batch_size, data_dimension]    #     w: 权重-----------> [data_dimension, ]    #     b: 偏置 ----------> 标量    # 输出：    #     预测概率    output = _sigmoid(np.matmul(X, w) + b) #  np.matmul：两个numpy数组的矩阵相乘    return output</code></pre><p>&emsp;&emsp;<font color=#FF0000 >matmul与dot</font>的差异主要在两个方面：</p><p>&emsp;&emsp;&emsp;（1）不允许乘标量</p><p>&emsp;&emsp;&emsp;（2）stack的矩阵将矩阵按元素对待被一起广播</p><h3 id="2-8-预测"><a href="#2-8-预测" class="headerlink" title="2.8 预测"></a>2.8 预测</h3><pre class=" language-Python"><code class="language-Python">def _predict(X, w, b):    predict = np.round(_f(X, w, b)).astype(np.int)   # round(x) ：返回浮点数x的四舍五入值。    return predict</code></pre><h3 id="2-9-准确度"><a href="#2-9-准确度" class="headerlink" title="2.9 准确度"></a>2.9 准确度</h3><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422212816090.png" alt="acc计算公式"></p><pre class=" language-Python"><code class="language-Python">def _accuracy(Y_pred, Y_label):    acc = 1 - np.mean(np.abs(Y_pred - Y_label))    return acc</code></pre><h3 id="2-10-交叉熵"><a href="#2-10-交叉熵" class="headerlink" title="2.10 交叉熵"></a>2.10 交叉熵</h3><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422213215418.png" alt="均方差"></p><p>   &emsp;&emsp;<strong>逻辑回归配合MSE损失函数时，采用梯度下降法进行学习时，会出现模型一开始训练时，学习速率非常慢的情况</strong></p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422213405553.png" alt="交叉熵-二分类"></p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422213434442.png" alt="交叉熵-多分类"></p><pre class=" language-Python"><code class="language-Python">def _cross_entropy_loss(y_pred, Y_label): # 在计算交叉熵时，后面还要再除个 N     cross_entropy = -np.dot(Y_label, np.log(y_pred)) - np.dot((1 - Y_label), np.log(1 - y_pred))    return cross_entropy</code></pre><h3 id="2-11-计算梯度"><a href="#2-11-计算梯度" class="headerlink" title="2.11 计算梯度"></a>2.11 计算梯度</h3><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422213621460.png" alt="梯度更新"></p><pre class=" language-Python"><code class="language-Python">def _gradient(X, Y_label, w, b):    y_pred = _f(X, w, b)    pred_error = Y_label - y_pred    w_grad = -np.sum(pred_error * X.T, 1)  # error与X.T乘完后再加 1    b_grad = -np.sum(pred_error)    return w_grad, b_grad</code></pre><h3 id="2-12-训练"><a href="#2-12-训练" class="headerlink" title="2.12 训练"></a>2.12 训练</h3><p>&emsp;    我们使用小批次梯度下降法来训练。训练资料被分成许多小批次，针封每一个小批次，我们分别计算其梯度以及损失，并根据该批次来更新模型的参数。当一次epoch完成，也就是整个训练集的所有小批次都被使用过一次以后，我们将所有训练资料打散并且重新分成新的小批次，进行下一个epoch，直到事先设定的epochs数量完成为止。</p><p>&emsp;&emsp;针对每个epoch训练的步骤：for epoch in range(epochs)<br>    &emsp;&emsp;&emsp;&emsp;1. 打散：对X_train，Y_train打散<br>    &emsp;&emsp;&emsp;&emsp;2. 分批次训练：for idx in range(int(np.floor(train_size / batch_size)))<br>        &emsp;&emsp;&emsp;&emsp;2.1 取小批次的 X 和 Y<br>        &emsp;&emsp;&emsp;&emsp;2.2 计算小批次的 w 和 b<br>        &emsp;&emsp;&emsp;&emsp;2.3 更新 w 和 b<br>    &emsp;&emsp;&emsp;&emsp;3.计算训练集和验证集的准确率和损失值<br>        &emsp;&emsp;&emsp;&emsp;3.1 计算y_pred(float型) ——&gt; 计算交叉熵时用<br>        &emsp;&emsp;&emsp;&emsp;3.2 计算Y_pred（四舍五入） ——&gt; 计算准确率时用<br>        &emsp;&emsp;&emsp;&emsp;3.3 计算准确率<br>        &emsp;&emsp;&emsp;&emsp;3.4 计算损失值</p><pre class=" language-Python"><code class="language-Python">def train(X_train, Y_train, X_valid, Y_valid, data_dim, train_size, valid_size, epochs, batch_size, lr):    # 将w和b初始化为0    w = np.zeros((data_dim))    #  w.shape -------> (510, )    b = np.zeros((1, ))         #  b.shape -------> (1, )    epochs = epochs    batch_size = batch_size    lr = lr    # 创建列表用来保存训练集和验证集的损失值和准确度    train_loss = []    valid_loss = []    train_acc = []    valid_acc = []    # 用来更新学习率    step = 1    # 训练    for epoch in range(epochs):        # 每个epoch都会重新洗牌        X_train, Y_train = _shuffle(X_train, Y_train)        # 分批次训练        for idx in range(int(np.floor(train_size / batch_size))):            X = X_train[idx*batch_size : (idx + 1)*batch_size]            Y = Y_train[idx*batch_size : (idx + 1)*batch_size]            # 计算梯度值            w_grad, b_grad = _gradient(X, Y, w, b)            # 更新参数w和b            # 学习率随着迭代时间增加而减少            w -= lr / np.sqrt(step) * w_grad            b -= lr / np.sqrt(step) * b_grad            step += 1        # 参数总共更新了max_iter × （train_size/batch_size）次             # 计算训练集的损失值和准确度        y_train_pred = _f(X_train, w, b)        Y_train_pred = np.round(y_train_pred)        train_acc.append(_accuracy(Y_train_pred, Y_train))        train_loss.append(_cross_entropy_loss(y_train_pred, Y_train) / train_size)        # 计算验证集的损失值和准确度        y_valid_pred = _f(X_valid, w, b)        Y_valid_pred = np.round(y_valid_pred)        valid_acc.append(_accuracy(Y_valid_pred, Y_valid))        valid_loss.append(_cross_entropy_loss(y_valid_pred, Y_valid) / valid_size)    return train_acc, train_loss, valid_acc, valid_loss, w, b</code></pre><h3 id="2-13-画损失和准确率曲线"><a href="#2-13-画损失和准确率曲线" class="headerlink" title="2.13 画损失和准确率曲线"></a>2.13 画损失和准确率曲线</h3><pre class=" language-Python"><code class="language-Python">def plot_curve(train_acc, train_loss, valid_acc, valid_loss):    # train_acc, train_loss, valid_acc, valid_loss长度都为epochs    # loss    plt.plot(train_loss)    plt.plot(valid_loss)    plt.title('Loss')    plt.legend(['train', 'valid'])    plt.savefig('./output/loss.png')    plt.show()    # acc    plt.plot(train_acc)    plt.plot(valid_acc)    plt.title('Acc')    plt.legend(['train', 'valid'])    plt.savefig('./output/acc.png')    plt.show()</code></pre><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422214032989.png" alt="损失和准确率曲线图"></p><h3 id="2-14-预测"><a href="#2-14-预测" class="headerlink" title="2.14 预测"></a>2.14 预测</h3><pre class=" language-Python"><code class="language-Python">def test(X_test, w, b, output_file, X_test_file):    predictions = _predict(X_test, w, b)    with open(output_file.format('logistic'), 'w') as f:        f.write('id,label\n')        for i, label in enumerate(predictions):            f.write('{},{}\n'.format(i, label))    # 打印一下数据前10项特征对应的权重    ind = np.argsort(np.abs(w))[::-1]    with open(X_test_file) as f:        content = f.readline().strip('\n').split(',')    features = np.array(content)    for i in ind[0:10]:        print(features[i], w[i])</code></pre><h3 id="2-15-main-函数"><a href="#2-15-main-函数" class="headerlink" title="2.15 main()函数"></a>2.15 main()函数</h3><pre class=" language-Python"><code class="language-Python">def main():    # 1.添加路径    X_train_file = './data/X_train'    Y_train_file = './data/Y_train'    X_test_file = './data/X_test'    output_file = './output/output_{}.csv'   #用于测试集的预测输出    # 2.加载数据    X_train_all, Y_train_all, X_test = _datapreprocess(X_train_file, Y_train_file, X_test_file)    #print(X_train_all.shape[1], Y_train_all.shape, X_test.shape)    # 3.归一化X_train 和 X_test数据    X_train_all, X_mean, X_std = _normalize(X_train_all, train=True)    X_test, _, _ = _normalize(X_test, train=False, specified_column=None, X_mean=X_mean, X_std=X_std )    # 4.设置训练集-验证集    valid_ratio = 0.1    X_train, X_valid, Y_train, Y_valid = _train_valid_split(X_train_all, Y_train_all, valid_ratio=valid_ratio)    train_size = X_train.shape[0]    valid_size = X_valid.shape[0]    test_size = X_test.shape[0]    data_dim = X_train.shape[1]#     print('Size of training set:{}'.format(train_size))#     print('Size of validation set:{}'.format(valid_size))#     print('Size of testing set:{}'.format(test_size))#     print('Dimension of data:{}'.format(data_dim))    # 5.训练  设置其他超参数（迭代次数，分批次大小，学习率）    epochs = 10    batch_size = 8    lr = 0.2    train_acc, train_loss, valid_acc, valid_loss, w, b = train(X_train,                                                                Y_train,                                                                X_valid,                                                                Y_valid,                                                                data_dim,                                                               train_size,                                                               valid_size,                                                               epochs,                                                                batch_size,                                                                lr)#     print('Training loss:{}'.format(train_loss[-1]))#     print('Validation loss:{}'.format(valid_loss[-1]))#     print('Training accuracy:{}'.format(train_acc[-1]))#     print('Validation accuracy:{}'.format(valid_acc[-1]))    # 6.画准确率曲线    plot_curve(train_acc, train_loss, valid_acc, valid_loss)    # 7.预测    test(X_test, w, b, output_file, X_test_file)if __name__ == '__main__':    main()</code></pre><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422215828322.png" alt="逻辑回归结果"></p><h2 id="三、Generative-model实现"><a href="#三、Generative-model实现" class="headerlink" title="三、Generative model实现"></a>三、<strong>Generative model</strong>实现</h2><p>&emsp;&emsp;生成概率模型其实是先假设数据的概率分布（正太、伯努利、泊松），然后用概率公式去计算x所属于的类型p(C1∣x)</p><p>&emsp;&emsp;一般的，我们假设x的分布为高斯分布（最为常见的概率分布模型），为什么会往往选择高斯分布呢，概率论中的中心极限定理告诉我们答案。</p><p>&emsp;&emsp;一维的概率分布一般是钟形曲线，大家都比较了解，那么高维的分布是（均值为μ,协方差为∑）：</p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422214527857.png" alt="高维高斯分布函数"></p><p>&emsp;&emsp;如果假设高斯分布是独立的，则所用方法就是朴素贝叶斯分类。理论细节推导，请参考李宏毅老师的教学：Classification (v3).pdf</p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422214747409.png" alt="朴素贝叶斯分类"></p><p>&emsp;&emsp;Generative model方法跟Logistic regression方法类似，不同之处在于Generative model可以直接计算出w和b的最佳解，而Logistic regression是将w和b进行初始化，通过迭代训练来更新w和b。</p><h3 id="3-1-加载数据"><a href="#3-1-加载数据" class="headerlink" title="3.1 加载数据"></a>3.1 加载数据</h3><p>&emsp;&emsp;训练集与测试集的处理方式跟logistic regression一模一样，然而因为generative model有可解析的最佳解，因此不必使用到验证集（valid_ratio = 0）</p><pre class=" language-Python"><code class="language-Python"># 加载数据,我们直接导入已经处理好的数据X_train,Y_train,X_testwith open(X_train_file) as f:    next(f)    # s.strip(rm) ：删除s字符串中开头、结尾处，位于 rm删除序列的字符    # split ：分割；[1:]是取第1列之后的    X_train_all = np.array([line.strip('\n').split(',')[1:]  for line in f], dtype=float)with open(Y_train_file) as f:    next(f)    Y_train_all = np.array([line.strip('\n').split(',')[1]  for line in f], dtype=float)with open(X_test_file) as f:    next(f)    X_test = np.array([line.strip('\n').split(',')[1:]  for line in f], dtype=float)# 归一化数据X_train_all, X_mean, X_std = _normalize(X_train_all, train=True)X_test, _, _ = _normalize(X_test, train=False, specified_column=None, X_mean=X_mean, X_std=X_std )X_train, X_valid, Y_train, Y_valid = _train_valid_split(X_train_all, Y_train_all, valid_ratio=0)train_size = X_train.shape[0]valid_size = X_valid.shape[0]test_size = X_test.shape[0]data_dim = X_train.shape[1]print(X_train_all.shape[1], Y_train_all.shape, X_test.shape)print('Size of training set:{}'.format(train_size))print('Size of validation set:{}'.format(valid_size))print('Size of testing set:{}'.format(test_size))print('Dimension of data:{}'.format(data_dim))</code></pre><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422215003200.png" alt="数据集大小"></p><h3 id="3-2-分别计算两个类别的均值和协方差"><a href="#3-2-分别计算两个类别的均值和协方差" class="headerlink" title="3.2 分别计算两个类别的均值和协方差"></a>3.2 分别计算两个类别的均值和协方差</h3><p>&emsp;&emsp;我们假设数据点服从高维高斯分布，那么，我们需要找到这个高斯分布的函数，也就是为μ,和协方差∑。<br> &emsp;&emsp;这个函数满足，它的所有数据点的生成概率是最大的，假设有79个数据点，他的高斯函数的求法</p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422215158987.png" alt="求高斯函数的均值和协方差"></p><pre class=" language-Python"><code class="language-Python"># 计算均值X_train_0 = np.array([x for x, y in zip(X_train_all, Y_train_all) if y == 0])X_train_1 = np.array([x for x, y in zip(X_train_all, Y_train_all) if y == 1])print('X_train_0.shape:', X_train_0.shape, '\n', 'X_train_1.shape:', X_train_1.shape)mean_0 = np.mean(X_train_0, axis= 0)mean_1 = np.mean(X_train_1, axis= 0)print('mean_0.shape:', mean_0.shape, '\n', 'mean_1.shape:', mean_1.shape)# 计算协方差(两类共享一个协方差)cov_0 = np.zeros((data_dim, data_dim))cov_1 = np.zeros((data_dim, data_dim))for x in X_train_0:    cov_0 += np.dot(np.transpose([x - mean_0]), [x - mean_0]) / X_train_0.shape[0]for x in X_train_1:    cov_1 += np.dot(np.transpose([x - mean_1]), [x - mean_1]) / X_train_1.shape[0]# 两类共享一个协方差cov = (cov_0 * X_train_0.shape[0] + cov_1 * X_train_1.shape[0]) / (X_train_0.shape[0] + X_train_1.shape[0])</code></pre><h3 id="3-3-计算-w-和-b"><a href="#3-3-计算-w-和-b" class="headerlink" title="3.3 计算 w 和 b"></a>3.3 计算 w 和 b</h3><p>&emsp;&emsp;权重矩阵与偏差向量可以直接被计算出来<br>&emsp;&emsp;下面是计算w和b的原理图，由最大似然估计和贝叶斯公式推导而来，有兴趣的同学可以自己按照视频内容推导一下</p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422215411870.png" alt="计算 w 和 b"></p><pre class=" language-Python"><code class="language-Python"># 计算协方差矩阵的逆# 由于协方差矩阵可能几乎是奇异的，因此np.linalg.inv() 可能会产生较大的数值误差# 通过SVD分解，可以高效准确地求逆矩阵u, s, v = np.linalg.svd(cov, full_matrices=False)inv = np.matmul(v.T * 1 / s, u.T)# 计算 w 和 b w = np.dot(inv, mean_0 - mean_1)b = (-0.5) * np.dot(mean_0, np.dot(inv, mean_0)) + 0.5 * np.dot(mean_1, np.dot(inv, mean_1))\            + np.log(float(X_train_0.shape[0]) / X_train_1.shape[0])# 计算训练集上的准确率Y_train_pred = 1- _predict(X_train , w, b)train_acc = _accuracy(Y_train_pred, Y_train)print(train_acc)</code></pre><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422215519240.png" alt="生成模型的准确率结果"></p><h3 id="3-4-测试"><a href="#3-4-测试" class="headerlink" title="3.4 测试"></a>3.4 测试</h3><pre class=" language-Python"><code class="language-Python"># 预测 测试集的labelpredictions = 1 - _predict(X_test, w, b)with open(output_file.format('generative'), 'w') as f:    f.write('id,label\n')    for i, label in  enumerate(predictions):        f.write('{},{}\n'.format(i, label))# 打印一下数据前10项特征对应的权重ind = np.argsort(np.abs(w))[::-1]with open(X_test_file) as f:    content = f.readline().strip('\n').split(',')features = np.array(content)for i in ind[0:10]:    print(features[i], w[i])</code></pre><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%BA%8C%E3%80%91%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92-%E6%94%B6%E5%85%A5%E5%88%86%E7%B1%BB/image-20200422215706038.png" alt="生成模型测试结果"></p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p><p>&emsp;&emsp;</p>]]></content>
      
      
      <categories>
          
          <category> 机器学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
            <tag> 逻辑回归 </tag>
            
            <tag> 概率生成模型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-二分法】二分搜索法</title>
      <link href="/2020/04/18/shu-ju-jie-gou-er-fen-fa-er-fen-sou-suo-fa/"/>
      <url>/2020/04/18/shu-ju-jie-gou-er-fen-fa-er-fen-sou-suo-fa/</url>
      
        <content type="html"><![CDATA[<h3 id="1-二分搜索法定义"><a href="#1-二分搜索法定义" class="headerlink" title="1.二分搜索法定义"></a>1.二分搜索法定义</h3><p>&emsp;&emsp;<strong>二分查找</strong>（英语：binary search），也称<strong>折半搜索</strong>（英语：half-interval search）、<strong>对数搜索</strong>（英语：logarithmic search），是一种在<font color=#FF0000 ><strong>有序数组</strong></font>中查找某一特定元素的<font color=#FF0000 ><strong>搜索算法</strong></font>。</p><p>&emsp;&emsp;搜索过程从数组的中间元素开始，如果中间元素正好是要查找的元素，则搜索过程结束；</p><p>&emsp;&emsp;如果某一特定元素大于或者小于中间元素，则在数组大于或小于中间元素的那一半中查找，而且跟开始一样从中间元素开始比较。</p><p>&emsp;&emsp;如果在某一步骤数组为空，则代表找不到。</p><p>&emsp;&emsp;这种搜索算法每一次比较都使搜索范围缩小一半。</p><h3 id="2-二分搜索法代码"><a href="#2-二分搜索法代码" class="headerlink" title="2.二分搜索法代码"></a>2.二分搜索法代码</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binary</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> max <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> mid<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>min <span class="token operator">&lt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mid <span class="token operator">=</span> <span class="token punctuation">(</span>min <span class="token operator">+</span> max<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                max <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                min <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> mid<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;对于上面这段代码而言，问题出在第 6 行代码处：</p><pre class=" language-java"><code class="language-java">mid <span class="token operator">=</span> <span class="token punctuation">(</span>min <span class="token operator">+</span> max<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span></code></pre><p>&emsp;&emsp;这句代码在 min 和 max 很大的时候，会出现溢出的情况，从而导致数组访问出错。</p><p>&emsp;&emsp;那怎么改进呢？一般的做法是这样的：<font color=#FF0000 ><strong>将加法变成减法</strong></font>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binary</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> max <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> mid<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>min <span class="token operator">&lt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 防止溢出</span>            mid <span class="token operator">=</span>  min <span class="token operator">+</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                max <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                min <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> mid<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;还有一种更高逼格的写法，也是官方的二分搜索法的实现写法：使用 <font color=#FF0000 ><strong>位运算</strong></font>。</p><pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binary</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> max <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> mid<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>min <span class="token operator">&lt;=</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 无符号位运算符的优先级较低，先括起来</span>            mid <span class="token operator">=</span> <span class="token punctuation">(</span>min <span class="token operator">+</span> max<span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 使用"+"，然后"无符号右移(java才有)"是推荐写法</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">></span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                max <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                min <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> mid<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="3-二分搜索模板"><a href="#3-二分搜索模板" class="headerlink" title="3.二分搜索模板"></a>3.二分搜索模板</h3><p>&emsp;&emsp;参考文章：<a href="https://mp.weixin.qq.com/s/1ojQ9aHdTTz8-Vt9fSAI8w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/1ojQ9aHdTTz8-Vt9fSAI8w</a></p><h4 id="3-1模板一"><a href="#3-1模板一" class="headerlink" title="3.1模板一"></a>3.1模板一</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end <span class="token operator">=</span> nums<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> mid <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 防止计算越界</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        start <span class="token operator">=</span> mid<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        end <span class="token operator">=</span> mid<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;二分查找算法如果没有实现好，会有两种后果：</p><ul><li>&emsp;&emsp;<font color=#FF0000 >死循环</font></li><li>&emsp;&emsp;<font color=#FF0000 >跳过本该查找的位置</font></li></ul><h4 id="3-2-模板二"><a href="#3-2-模板二" class="headerlink" title="3.2 模板二"></a>3.2 模板二</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> end <span class="token operator">=</span> nums<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> mid <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        start <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        end <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>根据条件返回 end 或者 start</code></pre><p>&emsp;&emsp;但是这个模版也有不好的地方，如果输入数组是 [1]，那么 while 循环结束后，要么是 start 超出数组范围，要么是 end 变成 -1，也就是说最后你不仅需要判断 start 和 end 对应的元素是不是要找的元素，还需要判断 start 和 end 是否是在合法的范围内，如果你这样做了，程序不会出错，你习惯了上面的模版，你可以继续使用，但是要知道会存在这么一个情况。</p><h4 id="3-3-模板三"><a href="#3-3-模板三" class="headerlink" title="3.3 模板三"></a>3.3 模板三</h4><ul><li><p>（1）<font color=#FF0000 ><strong>首先把循环可以进行的条件写成 <code>while(left &lt; right)</code>，在退出循环的时候，一定有 <code>left == right</code> 成立，此时返回 <code>left</code> 或者 <code>right</code> 都可以</strong></font></p></li><li><p>（2）思考左、右边界，如果左、右边界不包括目标数值，会导致错误结果</p><ul><li>&emsp;如果 <code>left</code> 和 <code>right</code> 表示的是数组的索引，就要考虑“索引是否有效” ，即“索引是否越界” 是重要的定界依据；</li><li>&emsp;左右边界一定要包括目标元素。</li></ul></li><li><p>（3）中位数先写 <code>int mid = (left + right) &gt;&gt;&gt; 1 ;</code> 根据循环里分支的编写情况，再做调整</p><p>&emsp;当数组的元素个数是偶数的时候，中位数有左中位数和右中位数之分。</p><p>&emsp;使用 <code>int mid = left + (right - left) / 2 ;</code> 得到左中位数的索引；</p><p>&emsp;使用 <code>int mid = left + (right - left + 1) / 2 ;</code> 得到右中位数的索引。</p></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> mid <span class="token operator">=</span> left <span class="token operator">+</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">;</span>            等价于<span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> mid <span class="token operator">=</span> left <span class="token operator">+</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">;</span>            等价于<span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><p>&emsp;&emsp;什么时候使用左中位数，什么时候使用右中位数呢？选中位数的依据是为了避免死循环，得根据分支的逻辑来选择中位数，而分支逻辑的编写也有技巧。</p><ul><li>（4）先写逻辑上容易想到的分支逻辑，这个分支逻辑通常是<font color=#FF0000 >排除中位数的逻辑</font></li><li>（5）循环内只写两个分支，一个分支排除中位数，另一个分支不排除中位数，循环中不单独对中位数作判断</li></ul><p>&emsp;&emsp;既然是“夹逼”法，没有必要在每一轮循环开始前单独判断当前中位数是否是目标元素，因此分支数少了一支，代码执行效率更高。</p><p><img src="/images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%88%86%E6%B3%95%E3%80%91%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E6%B3%95/640.webp" alt="二分查找模板"></p><p>&emsp;&emsp;还以 LeetCode 第 35 题为例，通过之前的分析，我们需要找到“大于或者等于目标值的第 1 个数的<strong>索引</strong>”。对于这道题而言：</p><p>&emsp;&emsp;1. 如果中位数小于目标值，它就应该被排除，左边界 <code>left</code> 就至少是 <code>mid + 1</code>；</p><p>&emsp;&emsp;2. 如果中位数大于等于目标值，还不能够肯定它就是我们要找的数，因为要找的是等于目标值的第 1 个数的<strong>索引</strong>，<strong>中位数以及中位数的左边都有可能是符合题意的数</strong>，因此右边界就不能把 <code>mid</code> 排除，因此右边界 <code>right</code> 至多是 <code>mid</code>，此时右边界不向左边收缩。</p><ul><li>（6）根据<font color=#FF0000 >分支逻辑选择中位数的类型</font>，可能是左中位数，也可能是右位数，选择的标准是避免死循环</li></ul><p><img src="/images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%88%86%E6%B3%95%E3%80%91%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E6%B3%95/640.jpg" alt="造成死循环的代码"></p><p><strong>&emsp;&emsp;选择中位数的依据是</strong>：避免出现死循环。我们需要确保：</p><blockquote><p>1、如果分支的逻辑，在选择左边界的时候，不能排除中位数，那么中位数就选“右中位数”，只有这样区间才会收缩，否则进入死循环；</p><p>2、同理，如果分支的逻辑，在选择右边界的时候，不能排除中位数，那么中位数就选“左中位数”，只有这样区间才会收缩，否则进入死循环。</p></blockquote><p>&emsp;&emsp;<strong>！！！每次可以用<code>left = 3</code>，<code>right = 4</code>来测试下是否会陷入死循环</strong></p><ul><li>（7）退出循环的时候，可能需要对“夹逼”剩下的那个数单独做一次判断，这一步称之为“后处理</li></ul><p>&emsp;&emsp;二分查找法之所以高效，是因为它利用了数组有序的特点，在每一次的搜索过程中，都可以排除将近一半的数，<font color=#FF0000 ><strong>使得搜索区间越来越小，直到区间成为一个数</strong></font>。回到这一节最开始的疑问：“区间左右边界相等（即收缩成 1 个数）时，这个数是否会漏掉”，解释如下：</p><p>&emsp;&emsp;1、<font color=#FF0000 ><strong>如果你的业务逻辑保证了你要找的数一定在左边界和右边界所表示的区间里出现</strong></font>，那么可以放心地返回 <code>left</code> 或者 <code>right</code>，无需再做判断；</p><p>&emsp;&emsp;2、如果你的业务逻辑不能保证你要找的数一定在左边界和右边界所表示的区间里出现，那么只要在退出循环以后，再针对<font color=#FF0000 > <code>nums[left]</code> </font>或者 <font color=#FF0000 ><code>nums[right]</code> </font>（此时 <code>nums[left] == nums[right]</code>）单独作一次判断，看它是不是你要找的数即可，这一步操作常常叫做“后处理”。</p><p>&emsp;&emsp;<strong>！！！如果你能确定候选区间里目标元素一定存在，则不必做“后处理”。</strong></p><ul><li>（8）取中位数的时候，要避免在计算上出现整型溢出</li></ul><p>&emsp;&emsp;<font color=#FF0000 ><code>int mid = left + (right - left) / 2;</code> </font> <code>right - left</code> 也有可能超过 int 类型能表示的最大值，只不过一般情况下 <code>left</code> 和 <code>right</code> 表示的是数组索引值，<code>left</code> 是非负数，因此 <code>right - left</code> 溢出的可能性很小。因此，它是正确的写法。</p><p>&emsp;&emsp;<font color=#FF0000 >int mid = (left + right) &gt;&gt;&gt; 1;</font><strong>如果这样写， <code>left + right</code> 在发生整型溢出以后，会变成负数，此时如果除以 2 ，<code>mid</code> 是一个负数，但是经过无符号右移，可以得到在不溢出的情况下正确的结果</strong>。</p><p>&emsp;&emsp;在 Java 中，无符号右移运算符 <code>&gt;&gt;&gt;</code> 和右移运算符 <code>&gt;&gt;</code> 的区别如下：</p><p>&emsp;&emsp;1. 右移运算符 <code>&gt;&gt;</code>：在右移时，丢弃右边指定位数，左边补上符号位；</p><p>&emsp;&emsp;2. 无符号右移运算符 <code>&gt;&gt;&gt;</code> ：在右移时，丢弃右边指定位数，左边补上 0，也就是说，对于正数来说，二者一样，而负数通过 <code>&gt;&gt;&gt;</code> 后能变成正数。</p><h3 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h3><h4 id="4-1技巧"><a href="#4-1技巧" class="headerlink" title="4.1技巧"></a>4.1技巧</h4><blockquote><p>先写分支逻辑，并且先写排除中位数的逻辑分支（因为更多时候排除中位数的逻辑容易想，但是前面我也提到过，这并不绝对），另一个分支的逻辑你就不用想了，写出第 1 个分支的反面代码即可（下面的说明中有介绍），再根据分支的情况选择使用左中位数还是右中位数；</p></blockquote><p>&emsp;&emsp;我简单总结了一下，左右分支的规律就如下两点：</p><p>&emsp;&emsp;（1）如果第 1 个分支的逻辑是“左边界排除中位数”（<font color=#FF0000 ><code>left = mid + 1</code></font>），那么第 2 个分支的逻辑就一定是“右边界不排除中位数”（<font color=#FF0000 ><code>right = mid</code></font>），反过来也成立；</p><p>&emsp;&emsp;（2）如果第 2 个分支的逻辑是“右边界排除中位数”（<font color=#FF0000 ><code>right = mid - 1</code></font>），那么第 2 个分支的逻辑就一定是“左边界不排除中位数”（<font color=#FF0000 ><code>left = mid</code></font>），反之也成立。</p><h4 id="4-2-注意事项"><a href="#4-2-注意事项" class="headerlink" title="4.2 注意事项"></a>4.2 注意事项</h4><blockquote><p>左中位数还是右中位数选择的标准根据分支的逻辑而来，标准是每一次循环都应该让区间收缩，当候选区间只剩下 2 个元素的时候，为了避免死循环发生，选择正确的中位数类型。如果你实在很晕，不防就使用有 2 个元素的测试用例，就能明白其中的原因，另外在代码出现死循环的时候，建议你可以将左边界、右边界、你选择的中位数的值，还有分支逻辑都打印输出一下，出现死循环的原因就一目了然了；</p></blockquote><blockquote><p>如果能确定要找的数就在候选区间里，那么退出循环的时候，区间最后收缩成为 1 个数后，直接把这个数返回即可；如果你要找的数有可能不在候选区间里，区间最后收缩成为 1 个数后，还要单独判断一下这个数是否符合题意。</p></blockquote><h4 id="4-3-参考模板"><a href="#4-3-参考模板" class="headerlink" title="4.3 参考模板"></a>4.3 参考模板</h4><p><img src="/images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%88%86%E6%B3%95%E3%80%91%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E6%B3%95/640-1587455129065.jpg" alt=""></p><p><img src="/images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E4%BA%8C%E5%88%86%E6%B3%95%E3%80%91%E4%BA%8C%E5%88%86%E6%90%9C%E7%B4%A2%E6%B3%95/640-1587455139736.webp" alt="img"></p><p>&emsp;&emsp;<strong>说明</strong>：一般是先默认将中位数写成左中位数，再根据分支的情况，看看是否有必要调整成右中位数，即是不是要在 <code>(right - left)</code> 这个括号里面加 1 。</p><blockquote><p><font color=#FF0000 ><strong>虽说是两个模板，区别在于选中位数，中位数根据分支逻辑来选，原则是区间要收缩，且不出现死循环，退出循环的时候，视情况，有可能需要对最后剩下的数单独做判断</strong>。</font></p></blockquote><h4 id="4-4-递归代码模板"><a href="#4-4-递归代码模板" class="headerlink" title="4.4 递归代码模板"></a>4.4 递归代码模板</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 二分搜索函数的定义里，除了要指定数组 nums 和目标查找数 target 之外，还要指定查找区间的起点和终点位置，分别用 low 和 high 去表示。</span><span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 为了避免无限循环，先判断，如果起点位置大于终点位置，表明这是一个非法的区间，已经尝试了所有的搜索区间还是没能找到结果，返回 -1。 </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">></span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">// 取正中间那个数的下标 middle。    </span>    <span class="token keyword">int</span> middle <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 判断一下正中间的那个数是不是要找的目标数 target，是，就返回下标 middle。        </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>middle<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> middle<span class="token punctuation">;</span>        <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 如果发现目标数在左边，就递归地从左半边进行二分搜索。    </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> nums<span class="token punctuation">[</span>middle<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> target<span class="token punctuation">,</span> low<span class="token punctuation">,</span> middle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> target<span class="token punctuation">,</span> middle <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//否则从右半边递归地进行二分搜索。}</span></code></pre><h4 id="4-5-非递归代码模板"><a href="#4-5-非递归代码模板" class="headerlink" title="4.5 非递归代码模板"></a>4.5 非递归代码模板</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">,</span> <span class="token keyword">int</span> low<span class="token punctuation">,</span> <span class="token keyword">int</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 在 while 循环里，判断搜索的区间范围是否有效    </span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;=</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 计算正中间的数的下标        </span>        <span class="token keyword">int</span> middle <span class="token operator">=</span> low <span class="token operator">+</span> <span class="token punctuation">(</span>high <span class="token operator">-</span> low<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 判断正中间的那个数是不是要找的目标数 target。如果是，就返回下标 middle    </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>middle<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> middle<span class="token punctuation">;</span>            <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 如果发现目标数在左边，调整搜索区间的终点为 middle - 1；否则，调整搜索区间的起点为 middle + 1    </span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">&lt;</span> nums<span class="token punctuation">[</span>middle<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   high <span class="token operator">=</span> middle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    low <span class="token operator">=</span> middle <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token punctuation">}</span>       <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 如果超出了搜索区间，表明无法找到目标数，返回 -1      </span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;<strong>核心步骤</strong></p><ol><li>确定搜索的范围和区间</li><li>取中间的数判断是否满足条件</li><li>如果不满足条件，判定应该往哪个半边继续进行搜索</li></ol><h4 id="4-6-二分搜素的变形"><a href="#4-6-二分搜素的变形" class="headerlink" title="4.6 二分搜素的变形"></a>4.6 二分搜素的变形</h4><h5 id="4-6-1-找确定的边界"><a href="#4-6-1-找确定的边界" class="headerlink" title="4.6.1 找确定的边界"></a>4.6.1 找确定的边界</h5><p>&emsp;&emsp;边界分上边界和下边界，有时候也被成为右边界和左边界。确定的边界指边界的数值等于要找的目标数。</p><p>&emsp;&emsp;把第一次出现的地方叫下边界（lower bound），把最后一次出现的地方叫上边界（upper bound）。</p><p>&emsp;&emsp;那么成为 8 的下边界的条件应该有两个：</p><ol><li>该数必须是 8；</li><li>该数的左边一个数必须不是 8：</li></ol><ul><li>8 的左边有数，那么该数必须小于 8；</li><li>8 的左边没有数，即 8 是数组的第一个数。</li></ul><p>&emsp;&emsp;而成为 8 的上边界的条件也应该有两个：</p><ol><li>该数必须是 8；</li><li>该数的右边一个数必须不是 8：</li></ol><ul><li>8 的右边有数，那么该数必须大于8；</li><li>8 的右边没有数，即 8 是数组的最后一个数。</li></ul><h5 id="4-6-2-找模糊的边界"><a href="#4-6-2-找模糊的边界" class="headerlink" title="4.6.2 找模糊的边界"></a>4.6.2 找模糊的边界</h5><p>&emsp;&emsp;二分搜索可以用来查找一些模糊的边界。模糊的边界指，边界的值并不等于目标的值，而是大于或者小于目标的值。</p><p>&emsp;&emsp;判断一个数是不是第一个大于 6 的数，只要它满足如下的条件：</p><ol><li>该数要大于 6；</li><li>该数有可能是数组里的第一个数，或者它之前的一个数比 6 小。</li></ol><h5 id="4-6-3-旋转过的排序数组"><a href="#4-6-3-旋转过的排序数组" class="headerlink" title="4.6.3 旋转过的排序数组"></a>4.6.3 旋转过的排序数组</h5><p>&emsp;<strong>&emsp;如何判断左边是不是排好序的那个部分呢？</strong></p><ul><li>只要比较 nums[low] 和 nums[middle]。nums[low] &lt;= nums[middle] 时，能判定左边这部分一定是排好序的，否则，右边部分一定是排好序的。</li></ul><p>&emsp;&emsp;<strong>判定某一边是排好序的，有什么用处呢？能准确地判断目标值是否在这个区间里。</strong></p><ul><li>如果 nums[low] &lt;= target &amp;&amp; target &lt; nums[middle]，则应该在这个区间里搜索目标值。反之，目标值肯定在另外一边。</li></ul><h5 id="4-6-4-不定长的边界"><a href="#4-6-4-不定长的边界" class="headerlink" title="4.6.4 不定长的边界"></a>4.6.4 不定长的边界</h5><p>&emsp;&emsp;可以把这个问题看成是不知道长度的数组，数组从头开始记录都是时间戳，到了某个位置就成为了空：{2019-01-14, 2019-01-17, … , 2019-08-04, …. , null, null, null …}。</p><p>&emsp;&emsp;借用二分搜索的思想，反着进行搜索：</p><ol><li>一开始设置 low = 0，high = 1</li><li>只要 logs[high] 不为 null，high *= 2</li><li>当 logs[high] 为 null 的时候，可以在区间 [0, high] 进行普通的二分搜索</li></ol>]]></content>
      
      
      <categories>
          
          <category> 二分法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 二分法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-数组】LeetCode 第 41 号问题：缺失的第一个正数</title>
      <link href="/2020/04/17/shu-ju-jie-gou-shu-zu-leetcode-di-41-hao-wen-ti-que-shi-de-di-yi-ge-zheng-shu/"/>
      <url>/2020/04/17/shu-ju-jie-gou-shu-zu-leetcode-di-41-hao-wen-ti-que-shi-de-di-yi-ge-zheng-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="1-题目描述"><a href="#1-题目描述" class="headerlink" title="1.题目描述"></a>1.题目描述</h3><p>&emsp;&emsp;给定一个未排序的整数数组，找出其中没有出现的最小的正整数。</p><p><img src="/images/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%95%B0%E7%BB%84%E3%80%91LeetCode-%E7%AC%AC-41-%E5%8F%B7%E9%97%AE%E9%A2%98%EF%BC%9A%E7%BC%BA%E5%A4%B1%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%AD%A3%E6%95%B0/image-20200417165014091.png" alt=""></p><h3 id="2-题目解析"><a href="#2-题目解析" class="headerlink" title="2.题目解析"></a>2.题目解析</h3><p>&emsp;&emsp;这道题如果不加上  <em>O(n)</em> 时间和  <em>O(1)</em> 空间这样的限定条件，应该再简单不过，但是加上了这两个要求，一下子使问题变得棘手。</p><p>&emsp;&emsp;首先这道题给定的条件很有限，输入参数就 <font color=#FF0000 ><strong>只有数组</strong></font> ，如果非要用  <em>O(n)</em> 时间和  <em>O(1)</em> 空间来做的话，表示我们除了<font color=#FF0000 ><strong>输入数组</strong></font>以外，不能借助任何其他的数据结构。</p><p>&emsp;&emsp;数组应该是属于一类最最基础的数据结构，除去 length 之外，<font color=#FF0000 >就只有两个属性 <em>index*和 *value</em></font>，那这道题就变成了 <font color=#FF0000 ><strong>如何利用数组的 value 和 index 之间的关系来找到最小缺失正整数</strong> </font>，如果想到了这一点，就已经成功了一半。</p>]]></content>
      
      
      <categories>
          
          <category> 数组 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【数据结构-数组】如何高效对有序数组/链表去重？</title>
      <link href="/2020/04/15/shu-ju-jie-gou-shu-zu-shu-zu-ji-qiao/"/>
      <url>/2020/04/15/shu-ju-jie-gou-shu-zu-shu-zu-ji-qiao/</url>
      
        <content type="html"><![CDATA[<h3 id="1-数组简介"><a href="#1-数组简介" class="headerlink" title="1.数组简介"></a>1.数组简介</h3><p>&emsp;&emsp;数组，将元素存储到内存的连续位置中，是最基本的数据结构。在任何和编程相关的面试中，都会被问到和数组相关的问题，可以说是非常热门的考题之一。比如：将数组反转、对数组进行排序、搜索数组中的元素等。</p><h3 id="2-数组优缺点"><a href="#2-数组优缺点" class="headerlink" title="2.数组优缺点"></a>2.数组优缺点</h3><h4 id="2-1优点"><a href="#2-1优点" class="headerlink" title="2.1优点"></a>2.1优点</h4><p>&emsp;&emsp;数组数据结构的主要优点是如果知道索引就可以通过 O(l) 进行快速搜索，</p><h4 id="2-2数组缺点"><a href="#2-2数组缺点" class="headerlink" title="2.2数组缺点"></a>2.2数组缺点</h4><p>&emsp;&emsp;在数组中添加和删除元素的速度会很慢，因为数组一旦被创建，就无法更改其大小。如果需要创建更长或更短的数组，得先创建一个新数组，再把原数组中的所有元素复制到新创建的数组中。</p><h3 id="3-数组解题技巧"><a href="#3-数组解题技巧" class="headerlink" title="3.数组解题技巧"></a>3.数组解题技巧</h3><ul><li>&emsp;&lt;1&gt; 对于数组来说，<font color=#FF0000 >在尾部插入、删除元素是比较高效的</font>，时间复杂度是 O(1)，但是如果在中间或者开头插入、删除元素，就会涉及数据的搬移，时间复杂度为 O(N)。我们要<font color=#FF0000 >尽可能只对数组尾部的元素进行操作</font>，以避免额外的时间复杂度。</li><li>&emsp;&lt;2&gt; <strong>对于数组相关的算法问题，有一个通用的技巧：要尽量避免在中间删除元素，那我就先想办法把这个元素换到最后去</strong>。这样的话，最终待删除的元素都拖在数组尾部，一个一个 pop 掉就行了，每次操作的时间复杂度也就降低到 O(1) 了。按照这个思路呢，又可以衍生出解决类似需求的通用方式：<font color=#FF0000 >快慢指针</font>。</li><li>&emsp;&lt;3&gt;当从头到尾遍历数组，感到复杂时，可以尝试<font color=#FF0000 >从尾到头遍历。</font></li></ul><h3 id="4-精选面试题：如何高效对有序数组-链表去重？"><a href="#4-精选面试题：如何高效对有序数组-链表去重？" class="headerlink" title="4.精选面试题：如何高效对有序数组/链表去重？"></a>4.精选面试题：如何高效对有序数组/链表去重？</h3><p>&emsp;&emsp;先看题目</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210412154029.png" alt="题目"></p><p>&emsp;&emsp;显然，由于数组已经排序，所以重复的元素一定连在一起，找出它们并不难，但如果使用暴力解法的话，整个时间复杂度是会达到 O(N^2)。而且题目要求我们原地修改，也就是说不能用辅助数组，空间复杂度得是 O(1)。</p><p>&emsp;&emsp;我们使用快慢指针进行解题：让慢指针<code>slow</code>走左后面，快指针<code>fast</code>走在前面探路，找到一个不重复的元素就告诉<code>slow</code>并让<code>slow</code>前进一步。这样当<code>fast</code>指针遍历完整个数组<code>nums</code>后，<code>nums[0..slow]</code>就是不重复元素，之后的所有元素都是重复元素。</p><p>&emsp;&emsp;java代码：</p><pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">removeDuplicates</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> num <span class="token operator">=</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> slow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> fast<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>fast <span class="token operator">&lt;</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>slow<span class="token punctuation">]</span> <span class="token operator">!=</span> array<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                slow<span class="token operator">++</span><span class="token punctuation">;</span>                array<span class="token punctuation">[</span>slow<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            fast<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> slow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"array["</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"] = "</span> <span class="token operator">+</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> slow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;Python代码：</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span>  <span class="token function">removeDuplicates</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">:</span>    num <span class="token operator">=</span> len<span class="token punctuation">(</span>list<span class="token punctuation">)</span>    slow<span class="token punctuation">,</span> fast <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>    <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>fast <span class="token operator">&lt;</span> num<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>slow<span class="token punctuation">]</span> <span class="token operator">!=</span> list<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            slow <span class="token operator">+=</span> <span class="token number">1</span>            list<span class="token punctuation">[</span>slow<span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">[</span>fast<span class="token punctuation">]</span>        fast <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>slow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'list[%d]=%d'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> slow <span class="token operator">+</span> <span class="token number">1</span></code></pre><p>&emsp;&emsp;C语言代码：</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">int</span> <span class="token function">removeDuplicates</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> array<span class="token punctuation">,</span> <span class="token keyword">int</span> arraylength<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> slow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> fast <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> num <span class="token operator">=</span> arraylength<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token keyword">while</span><span class="token punctuation">(</span>fast <span class="token operator">&lt;</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span>slow<span class="token punctuation">]</span> <span class="token operator">!=</span> array<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            slow <span class="token operator">++</span><span class="token punctuation">;</span>            array<span class="token punctuation">[</span>slow<span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span>fast<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token keyword">else</span><span class="token punctuation">{</span>            fast <span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>slow<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"array[%d]:%d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> slow <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> arraylength <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> array<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">removeDuplicates</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> arraylength<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>&emsp;&emsp;看下算法执行的过程：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210412154055.gif" alt="有序数组去重"></p><p>&emsp;&emsp;再简单扩展一下，如果给你一个有序链表，如何去重呢？其实和数组是一模一样的，唯一的区别是把数组赋值操作变成操作指针而已：</p><p>&emsp;&emsp;java代码：</p><pre class=" language-java"><code class="language-java"></code></pre><p>&emsp;&emsp;Python代码：</p><pre class=" language-python"><code class="language-python"></code></pre><p>&emsp;&emsp;看下算法执行的过程：</p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210412154106.gif" alt="有序链表去重"></p>]]></content>
      
      
      <categories>
          
          <category> 数组 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构 </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【作业一】线性回归-PM2.5预测</title>
      <link href="/2020/04/13/zuo-ye-yi-xian-xing-hui-gui-pm2.5-yu-ce/"/>
      <url>/2020/04/13/zuo-ye-yi-xian-xing-hui-gui-pm2.5-yu-ce/</url>
      
        <content type="html"><![CDATA[<h2 id="一、作业说明及数据获取"><a href="#一、作业说明及数据获取" class="headerlink" title="一、作业说明及数据获取"></a>一、作业说明及数据获取</h2><p>给定训练集train.csv，要求根据前9个小时的空气监测情况预测第10个小时的PM2.5含量。</p><p>训练集介绍：</p><ul><li><p>(1) CSV文件，包含台湾丰原地区240天的气象观测资料(取每个月前20天的数据做训练集，12月X20天=240天，每月后10天数据用于测试，对学生不可见);</p></li><li><p>(2) 每天的监测时间点为0时，1时……到23时，共24个时间节点;</p></li><li><p>(3) 每天的检测指标包括CO、NO、PM2.5、PM10等气体浓度，是否降雨、刮风等气象信息，共计18项；</p></li><li><p>(4) 数据下载地址：<a href="https://pan.baidu.com/s/17mJnAGLtRadHtdZLX1k43A" target="_blank" rel="noopener">https://pan.baidu.com/s/17mJnAGLtRadHtdZLX1k43A</a> </p><p>​    提取码：vcj8</p></li></ul><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/image-20200413153133242.png" alt="train.csv文件内容"></p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/image-20200413153302263.png" alt="test.csv文件部分内容"></p><h2 id="二、程序实现"><a href="#二、程序实现" class="headerlink" title="二、程序实现"></a>二、程序实现</h2><h3 id="2-1-加载CSV文件"><a href="#2-1-加载CSV文件" class="headerlink" title="2.1 加载CSV文件"></a>2.1 加载CSV文件</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">load_csv</span><span class="token punctuation">(</span>train_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>train_path<span class="token punctuation">,</span> usecols<span class="token operator">=</span>range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'big5'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># usecols=range(3,27)：表示选择第3列到第27列数据</span><span class="token comment" spellcheck="true">#     pf = pd.read_csv(path, encoding='big5')</span><span class="token comment" spellcheck="true">#     data = pf.iloc[:, 3:]  # 另一种选择数据的方法</span>    <span class="token keyword">return</span> data</code></pre><h3 id="2-2-数据预处理"><a href="#2-2-数据预处理" class="headerlink" title="2.2 数据预处理"></a>2.2 数据预处理</h3><p>&emsp;&emsp;浏览数据可知，数据中存在一定量的空数据NR，且多存在于RAINFALL一项。对于空数据，常规的处理方法无非就是删除法和补全法两种。查阅资料后发现，RAINFALL表示当天对应时间点是否降雨，有降雨值为1，无降雨值为NR，类似于布尔变量。因此可以采用补全法处理空数据：将空数据NR全部补为0即可。</p><p>&emsp;&emsp;根据作业要求可知，需要用到连续9个时间点的气象观测数据，来预测第10个时间点的PM2.5含量。针对每一天来说，其包含的信息维度为(18,24)(18项指标，24个时间节点)。可以将0到8时的数据截取出来，形成一个维度为(18,9)的数据帧，作为训练数据，将9时的PM2.5含量取出来，作为该训练数据对应的label；同理可取1到9时的数据作为训练用的数据帧，10时的PM2.5含量作为label……以此分割，可将每天的信息分割为15个shape为(18,9)的数据帧和与之对应的15个label。</p><p>&emsp;&emsp;训练集中共包含240天的数据，因此共可获得240X15=3600个数据帧和与之对应的3600个label。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dataprocess</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 将空数据NR替换为0</span>    data <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'NR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># data ----> [4320, 24]</span><span class="token comment" spellcheck="true">#   data[data == 'NR'] = 0.0  </span>    <span class="token comment" spellcheck="true"># 将data数据类型转换为&lt;class 'numpy.ndarray'></span><span class="token comment" spellcheck="true">#   array = np.array(data).astype(float)</span>    array <span class="token operator">=</span> data<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>float<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># array ----> [4320, 24]</span>    <span class="token comment" spellcheck="true"># 第一种训练集数据划分：每天24小时，可以将0到8时的数据截取出来，形成一个维度为(18,9)的数        据帧，作为训练数据，将9时的PM2.5含量取出来，作为该训练数据对应的label；同理可取1到9时       的数据作为训练用的数据帧，10时的PM2.5含量作为label......以此分割，可将每天的信息分       割为15个shape为(18,9)的数据帧和与之对应的15个label。</span>    x_list<span class="token punctuation">,</span> y_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4320</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            mat <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">18</span><span class="token punctuation">,</span> j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span>            label <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">,</span> j<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span>            x_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mat<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># mat 是作为一个整体添加的，相当于x_list里的一个元素, x_list的个数相当于样本的个数</span>            y_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>        x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>x_list<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># x ----> [3600, 162]</span>        y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_list<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># y ----> [3600, 1]</span><span class="token comment" spellcheck="true">#     x_list, y_list = [], []</span><span class="token comment" spellcheck="true">#     month_data = {}</span><span class="token comment" spellcheck="true">#     for month in range(12):</span><span class="token comment" spellcheck="true">#         sample = np.empty([18, 480])</span><span class="token comment" spellcheck="true">#         for day in range(20):</span><span class="token comment" spellcheck="true">#             sample[:, day * 24 : (day+1) *24] = array[18 * (20*month+day): 18 * (20*month+day+1), :]</span><span class="token comment" spellcheck="true">#         month_data[month] = sample</span><span class="token comment" spellcheck="true">#     for i in range(12):</span><span class="token comment" spellcheck="true">#         for j in range(480-9):</span><span class="token comment" spellcheck="true">#             mat = month_data[i][:, j:j+9]</span><span class="token comment" spellcheck="true">#             label = month_data[i][9,j+9]</span><span class="token comment" spellcheck="true">#             x_list.append(mat)</span><span class="token comment" spellcheck="true">#             y_list.append(label)</span><span class="token comment" spellcheck="true">#         x = np.array(x_list).reshape(-1, 18*9)</span><span class="token comment" spellcheck="true">#         y = np.array(y_list).reshape(-1,1)</span><span class="token comment" spellcheck="true">#     x_train = x[:int(len(x)*0.8),:,:].reshape(-1, 18*9)</span><span class="token comment" spellcheck="true">#     x_validation = x[int(len(x)*0.8):,:,:].reshape(-1, 18*9)</span><span class="token comment" spellcheck="true">#     y_train = y[:int(len(y)*0.8)]</span><span class="token comment" spellcheck="true">#     y_validation = y[int(len(y)*0.8)]</span>    <span class="token keyword">return</span> x<span class="token punctuation">,</span>y</code></pre><p>&emsp;&emsp;第二种训练集数据划分：在从csv文件中提取数据帧和label时，第一种方法是以天为单位，每天分割出15个数据帧和15个label。事实上，时间是连续的，可以将每月的20天首尾连接，再从其中分割数据帧和label，可使数据帧样本数量大大提升。</p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/20200410145553875.png" alt="提取特征"></p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/20200410150256239.png" alt="提取特征"></p><pre class=" language-python"><code class="language-python">     x_list<span class="token punctuation">,</span> y_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true"># 將原始 4320 * 24 的数据依照每个月分成 12个18 (features) * 480 (hours) 的数据。 </span>     month_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>     <span class="token keyword">for</span> month <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>         sample <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">480</span><span class="token punctuation">]</span><span class="token punctuation">)</span>         <span class="token keyword">for</span> day <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             sample<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> day <span class="token operator">*</span> <span class="token number">24</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>day<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">[</span><span class="token number">18</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">*</span>month<span class="token operator">+</span>day<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token number">18</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token operator">*</span>month<span class="token operator">+</span>day<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>         month_data<span class="token punctuation">[</span>month<span class="token punctuation">]</span> <span class="token operator">=</span> sample     <span class="token comment" spellcheck="true"># 每个月20天有 480hrs，每 9 小时形成一个 data，每月有 471 个 data，故总数据为 471 * 12 个 ，而每个 data 有 9 * 18 的 features (一小时 18 个 features * 9 小时)。对应的 labels 有 471 * 12 个(第 10 个小时的 PM2.5)</span>     <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">:</span>         <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">480</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             mat <span class="token operator">=</span> month_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span>             label <span class="token operator">=</span> month_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span>j<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span>             x_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mat<span class="token punctuation">)</span>             y_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>         x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>x_list<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># x ----> [5652, 162]</span>         y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_list<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># y ----> [5652, 1]</span></code></pre><h3 id="2-3-标准化"><a href="#2-3-标准化" class="headerlink" title="2.3 标准化"></a>2.3 标准化</h3><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/image-20200419210629193.png" alt="标准化两种形式"></p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    mean_x <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#18 * 9 </span>    std_x <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#18 * 9 </span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#12 * 471</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#18 * 9 </span>            <span class="token keyword">if</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>                x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> mean_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span>    <span class="token keyword">return</span> x<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x</code></pre><h3 id="2-4-训练train"><a href="#2-4-训练train" class="headerlink" title="2.4 训练train"></a>2.4 训练train</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>    y_real <span class="token operator">=</span> y    learning_rate <span class="token operator">=</span> lr    iter_time <span class="token operator">=</span> epochs    dim <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">+</span> <span class="token number">1</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 在原x数据后面再加一维  x1 ----> [3600, 163]</span>    x1 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>float<span class="token punctuation">)</span>    x1_transpose <span class="token operator">=</span> x1<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span>    w_adagrad <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    eps <span class="token operator">=</span> <span class="token number">0.0000000001</span>    <span class="token keyword">for</span> t <span class="token keyword">in</span> range<span class="token punctuation">(</span>iter_time<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># 损失函数loss用rmse</span>        loss <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>np<span class="token punctuation">.</span>power<span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">-</span> y_real<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">471</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># print(loss.shape)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">%</span><span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 变量w的梯度 w_gradient -----> [163, 1]</span>        w_gradient <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x1_transpose<span class="token punctuation">,</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">-</span> y_real<span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># 变量w的梯度平方和</span>        w_adagrad <span class="token operator">+=</span> w_gradient <span class="token operator">**</span> <span class="token number">2</span>        <span class="token comment" spellcheck="true"># 梯度更新</span>        w <span class="token operator">-=</span> learning_rate <span class="token operator">*</span> w_gradient <span class="token operator">/</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>w_adagrad <span class="token operator">+</span> eps<span class="token punctuation">)</span>    <span class="token keyword">return</span> w</code></pre><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/image-20200413161334114.png" alt="训练结果"></p><h3 id="2-5-测试"><a href="#2-5-测试" class="headerlink" title="2.5 测试"></a>2.5 测试</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x<span class="token punctuation">)</span><span class="token punctuation">:</span>    pf <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> header <span class="token operator">=</span> None<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'big5'</span><span class="token punctuation">)</span>    data <span class="token operator">=</span> pf<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    test_data <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'NR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    test_data <span class="token operator">=</span> test_data<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>    x_test <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> float<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        x_test<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">*</span>i <span class="token punctuation">:</span> <span class="token number">18</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x_test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>                x_test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x_test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> mean_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span>    x_test <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x_test<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>float<span class="token punctuation">)</span>    <span class="token keyword">return</span> x_test</code></pre><h3 id="2-6-main-函数"><a href="#2-6-main-函数" class="headerlink" title="2.6 main()函数"></a>2.6 main()函数</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    train_path <span class="token operator">=</span> <span class="token string">'./data/train.csv'</span>    data <span class="token operator">=</span> load_csv<span class="token punctuation">(</span>train_path<span class="token punctuation">)</span>    x<span class="token punctuation">,</span> y <span class="token operator">=</span> dataprocess<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    x<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x <span class="token operator">=</span> normalize<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    lr <span class="token operator">=</span> <span class="token number">100</span>    epochs <span class="token operator">=</span> <span class="token number">1000</span>    w <span class="token operator">=</span> train<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'weight.npy'</span><span class="token punctuation">,</span> train<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">)</span>    test_path <span class="token operator">=</span> <span class="token string">'./data/test.csv'</span>    x_test <span class="token operator">=</span> test<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x<span class="token punctuation">)</span>    w1 <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'weight.npy'</span><span class="token punctuation">)</span>    y_hat <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> w1<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 将预测结果保存到submit.csv</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./data/submit.csv'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> submit_file<span class="token punctuation">:</span>        csv_writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>submit_file<span class="token punctuation">)</span>        header <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true">#print(header)</span>        csv_writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>header<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            row <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id_'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> y_hat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>            csv_writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>row<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#print(row)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h3 id="2-7-整体代码"><a href="#2-7-整体代码" class="headerlink" title="2.7 整体代码"></a>2.7 整体代码</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span><span class="token comment" spellcheck="true"># coding: utf-8</span><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token keyword">import</span> csv<span class="token keyword">def</span> <span class="token function">load_csv</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token punctuation">,</span> usecols<span class="token operator">=</span>range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'big5'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#     pf = pd.read_csv(path, encoding='big5')</span><span class="token comment" spellcheck="true">#     data = pf.iloc[:, 3:]</span>    <span class="token keyword">return</span> data<span class="token keyword">def</span> <span class="token function">dataprocess</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'NR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#   data[data == 'NR'] = 0.0  </span><span class="token comment" spellcheck="true">#   array = np.array(data).astype(float)</span>    array <span class="token operator">=</span> data<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>float<span class="token punctuation">)</span>    x_list<span class="token punctuation">,</span> y_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4320</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            mat <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">18</span><span class="token punctuation">,</span> j<span class="token punctuation">:</span>j<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span>            label <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">,</span> j<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">]</span>            x_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mat<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># mat 是作为一个整体添加的，相当于x_list里的一个元素, x_list的个数相当于样本的个数</span>            y_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>        x <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>x_list<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span>          y <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>y_list<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#     month_data = {}</span><span class="token comment" spellcheck="true">#     for month in range(12):</span><span class="token comment" spellcheck="true">#         sample = np.empty([18, 480])</span><span class="token comment" spellcheck="true">#         for day in range(20):</span><span class="token comment" spellcheck="true">#             sample[:, day * 24 : (day+1) *24] = array[18 * (20*month+day): 18 * (20*month+day+1), :]</span><span class="token comment" spellcheck="true">#         month_data[month] = sample</span><span class="token comment" spellcheck="true">#     x_list, y_list = [], []</span><span class="token comment" spellcheck="true">#     for i in range(12):</span><span class="token comment" spellcheck="true">#         for j in range(480-9):</span><span class="token comment" spellcheck="true">#             mat = month_data[i][:, j:j+9]</span><span class="token comment" spellcheck="true">#             label = month_data[i][9,j+9]</span><span class="token comment" spellcheck="true">#             x_list.append(mat)</span><span class="token comment" spellcheck="true">#             y_list.append(label)</span><span class="token comment" spellcheck="true">#         x = np.array(x_list).reshape(-1, 18*9)</span><span class="token comment" spellcheck="true">#         y = np.array(y_list).reshape(-1,1)</span><span class="token comment" spellcheck="true">#     x_train = x[:int(len(x)*0.8),:,:].reshape(-1, 18*9)</span><span class="token comment" spellcheck="true">#     x_validation = x[int(len(x)*0.8):,:,:].reshape(-1, 18*9)</span><span class="token comment" spellcheck="true">#     y_train = y[:int(len(y)*0.8)]</span><span class="token comment" spellcheck="true">#     y_validation = y[int(len(y)*0.8)]</span>    <span class="token keyword">return</span> x<span class="token punctuation">,</span>y<span class="token keyword">def</span> <span class="token function">normalize</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    mean_x <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#18 * 9 </span>    std_x <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>x<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#18 * 9 </span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#12 * 471</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#18 * 9 </span>            <span class="token keyword">if</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>                x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> mean_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span>    <span class="token keyword">return</span> x<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>    y_real <span class="token operator">=</span> y    learning_rate <span class="token operator">=</span> lr    iter_time <span class="token operator">=</span> epochs    dim <span class="token operator">=</span> <span class="token number">18</span> <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">+</span> <span class="token number">1</span>    w <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    x1 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>float<span class="token punctuation">)</span>    x1_transpose <span class="token operator">=</span> x1<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span>    learning_rate <span class="token operator">=</span> <span class="token number">100</span>    iter_time <span class="token operator">=</span> <span class="token number">1000</span>    w_adagrad <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>dim<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    eps <span class="token operator">=</span> <span class="token number">0.0000000001</span>    <span class="token keyword">for</span> t <span class="token keyword">in</span> range<span class="token punctuation">(</span>iter_time<span class="token punctuation">)</span><span class="token punctuation">:</span>        loss <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>np<span class="token punctuation">.</span>power<span class="token punctuation">(</span>np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">-</span> y_real<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">471</span><span class="token operator">/</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#rmse</span>       <span class="token comment" spellcheck="true"># print(loss.shape)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token operator">%</span><span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span>        w_gradient <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x1_transpose<span class="token punctuation">,</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x1<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">-</span> y_real<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#dim*1</span>        w_adagrad <span class="token operator">+=</span> w_gradient <span class="token operator">**</span> <span class="token number">2</span>        w <span class="token operator">-=</span> learning_rate <span class="token operator">*</span> w_gradient <span class="token operator">/</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>w_adagrad <span class="token operator">+</span> eps<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># np.save('weight.npy', w)</span>    <span class="token keyword">return</span> w<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x<span class="token punctuation">)</span><span class="token punctuation">:</span>    pf <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> header <span class="token operator">=</span> None<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">'big5'</span><span class="token punctuation">)</span>    data <span class="token operator">=</span> pf<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    test_data <span class="token operator">=</span> data<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'NR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    test_data <span class="token operator">=</span> test_data<span class="token punctuation">.</span>to_numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>    x_test <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype <span class="token operator">=</span> float<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        x_test<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token number">18</span><span class="token operator">*</span>i <span class="token punctuation">:</span> <span class="token number">18</span><span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x_test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>                x_test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>x_test<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> mean_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> std_x<span class="token punctuation">[</span>j<span class="token punctuation">]</span>    x_test <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x_test<span class="token punctuation">)</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>float<span class="token punctuation">)</span>    <span class="token keyword">return</span> x_test<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    train_path <span class="token operator">=</span> <span class="token string">'./data/train.csv'</span>    data <span class="token operator">=</span> load_csv<span class="token punctuation">(</span>train_path<span class="token punctuation">)</span>    x<span class="token punctuation">,</span> y <span class="token operator">=</span> dataprocess<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    x<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x <span class="token operator">=</span> normalize<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    lr <span class="token operator">=</span> <span class="token number">100</span>    epochs <span class="token operator">=</span> <span class="token number">1000</span>    w <span class="token operator">=</span> train<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'weight.npy'</span><span class="token punctuation">,</span> train<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">)</span>    test_path <span class="token operator">=</span> <span class="token string">'./data/test.csv'</span>    x_test <span class="token operator">=</span> test<span class="token punctuation">(</span>test_path<span class="token punctuation">,</span> std_x<span class="token punctuation">,</span> mean_x<span class="token punctuation">)</span>    w1 <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'weight.npy'</span><span class="token punctuation">)</span>    y_hat <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> w1<span class="token punctuation">)</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'./data/submit.csv'</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'w'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> submit_file<span class="token punctuation">:</span>        csv_writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>submit_file<span class="token punctuation">)</span>        header <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">]</span>        <span class="token comment" spellcheck="true">#print(header)</span>        csv_writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>header<span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            row <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id_'</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> y_hat<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>            csv_writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>row<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">#print(row)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>&emsp;&emsp;保存的submit.csv文件部分内容如下:</p><p><img src="/images/%E3%80%90%E4%BD%9C%E4%B8%9A%E4%B8%80%E3%80%91%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92-PM2.5%E9%A2%84%E6%B5%8B/image-20200413173310799.png" alt="submit.csv文件部分内容"></p>]]></content>
      
      
      <categories>
          
          <category> 机器学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
            <tag> 线性回归 </tag>
            
            <tag> PM2.5预测 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客搭建</title>
      <link href="/2020/04/10/bo-ke-da-jian/"/>
      <url>/2020/04/10/bo-ke-da-jian/</url>
      
        <content type="html"><![CDATA[<p>&emsp;通过 GitHub + hexo 来搭建个人博客！！</p><p>参考链接：</p><p>&emsp;1.超全面！如何用 GitHub 从零开始搭建一个博客 ？</p><p>&emsp;&emsp;<a href="https://www.cxyxiaowu.com/6407.html" target="_blank" rel="noopener">https://www.cxyxiaowu.com/6407.html</a></p><p>&emsp;2.【新手向】从零开始搭建一个酷炫免费的个人博客</p><p>&emsp;&emsp;<a href="https://mp.weixin.qq.com/s?__biz=MzUyNjQxNjYyMg==&amp;mid=2247484589&amp;idx=1&amp;sn=7ef61ad418eb4b16d3587a5859f5ce8e&amp;chksm=fa0e6b2ccd79e23afc1767f07afeec6f3dd3de0be44be01c7548afd6476015b0c3d91528088c&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzUyNjQxNjYyMg==&amp;mid=2247484589&amp;idx=1&amp;sn=7ef61ad418eb4b16d3587a5859f5ce8e&amp;chksm=fa0e6b2ccd79e23afc1767f07afeec6f3dd3de0be44be01c7548afd6476015b0c3d91528088c&amp;scene=21#wechat_redirect</a></p><h2 id="一、GitHub创建个人仓库"><a href="#一、GitHub创建个人仓库" class="headerlink" title="一、GitHub创建个人仓库"></a>一、GitHub创建个人仓库</h2><p>&emsp;1.登录到 GitHub：<a href="https://github.com/join?source=header-home" target="_blank" rel="noopener">https://github.com/join?source=header-home</a></p><p>&emsp;2.登录成功之后，点击 GitHub 中的 New repository 创建新仓库，仓库的名字可以随便起，不过这个仓库是作为我们的博客仓库的，所以尽量将名字以 {username}.github.io 的形式来起。</p><p>&emsp;&emsp;比如，我的GitHub用户名是lewky，我就会把这个仓库命名为lewky.github.io。（为什么要这样起名，后面会说明）</p><p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410150210713.png" alt=""></p><h2 id="二、相关软件安装及配"><a href="#二、相关软件安装及配" class="headerlink" title="二、相关软件安装及配"></a>二、相关软件安装及配</h2><h3 id="2-1-安装-Node-js"><a href="#2-1-安装-Node-js" class="headerlink" title="2.1 安装 Node.js"></a>2.1 安装 Node.js</h3><p>&emsp;&emsp;首先在自己的电脑上安装 Node.js，下载地址：<a href="https://pan.baidu.com/s/1lOE7p3GIX516fQIW_gAtZg" target="_blank" rel="noopener">https://pan.baidu.com/s/1lOE7p3GIX516fQIW_gAtZg</a> ，提取码：udo2 </p><p>&emsp;&emsp;最好安装这个低版本的，安装高版本的，有可能会报错：</p><p>fatal something’s wrong. maybe you can find the solution here: <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">https://hexo.io/docs/troubleshooting.html</a> typeerror [err_invalid_arg_type]: <font color=#FF0000 >the “mode” argument must be integer.</font> received an instance of object at copyfile (fs.js:1972:10) at trycatcher (/users/zhouhailin/blog/node_modules/bluebird/js/release/util.js:16:23) at ret (eval at makenodepromisifiedeval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), <anonymous>:13:39) at /users/zhouhailin/blog/node_modules/hexo-fs/lib/fs.js:144:39 at trycatcher (/users/zhouhailin/blog/node_modules/bluebird/js/release/util.js:16:23)</p><h3 id="2-2-安装Git"><a href="#2-2-安装Git" class="headerlink" title="2.2 安装Git"></a>2.2 安装Git</h3><p>&emsp;&emsp;这是使用 Git 的目的是为了将我们的网站从本地提交上服务器（GitHub）上面去。我认为 Git 操作是程序员应该具备的一个基本操作，具体的 Git 操作细节可以查看廖雪峰的教程，讲的十分详细： <a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000</a></p><p>&emsp;&emsp;下载地址同样在上面的百度网盘里</p><h4 id="2-2-1-Git配置"><a href="#2-2-1-Git配置" class="headerlink" title="2.2.1 Git配置"></a>2.2.1 Git配置</h4><p>​        <img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410151626711.png" style="zoom:67%;" /></p><p>&emsp;&emsp;进入Git Bash终端进行如下操作，设置user.name 和 user.email 配置信息</p><pre><code>git config --global user.name &quot;你的GitHub用户名&quot;git config --global user.email &quot;你的GitHub注册邮箱&quot;</code></pre><h4 id="2-2-2-SSH-key的创建与配置"><a href="#2-2-2-SSH-key的创建与配置" class="headerlink" title="2.2.2 SSH key的创建与配置"></a>2.2.2 SSH key的创建与配置</h4><p>&emsp;&emsp;最关键的一步来了，我们需要生成一对密钥对，然后将公钥配置到GitHub账号上。</p><p>&emsp;<strong>1.生成RSA密钥对</strong></p><p>&emsp;&emsp;通过注册的邮箱生成 ssh 密钥文件:</p><pre><code>ssh-keygen -t rsa -C &quot;你的GitHub注册邮箱&quot;</code></pre><p>&emsp;&emsp;然后直接三个回车即可，默认不需要设置密码。最后得到了两个文件：<code>id_rsa</code>和<code>id_rsa.pub</code>。</p><p>&emsp;<strong>2.拷贝密钥</strong></p><p>&emsp;&emsp;打开 <code>id_rsa.pub 文件</code>，将里面的内容全部复制。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410152745234.png" style="zoom:67%;" /><p>&emsp;<strong>3.在 GitHub 上配置SSH key</strong></p><p>&emsp;&emsp;<em>·*</em>进入Setting页面</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410153129263.png" style="zoom:67%;" /><p>&emsp;&emsp;<strong>·</strong>选择 SSH and GPG keys</p><p>&emsp;&emsp;<strong>·</strong>点击 New SSH key</p><p>&emsp;&emsp;<strong>·</strong>填写Title（用来给公钥起一个名字，以便和其他的公钥区分开来）</p><p>&emsp;&emsp;<strong>·</strong>然后在 Key 里将我们刚刚复制的公钥复制进去</p><p>&emsp;&emsp;<strong>·</strong>最后点击 Add SSH key，这时候 GitHub 会要你输入账号密码进行确认。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410153702312.png" style="zoom:67%;" /><p>&emsp;<strong>4.测试GitHub SSH</strong></p><p>&emsp;&emsp;添加好 <code>SSH Key</code>后，进行测试。使用 Git Bash 输入：</p><pre><code>ssh -T git@github.com</code></pre><p>&emsp;&emsp;你将会看到：</p><pre><code>The authenticity of host &#39;github.com (207.97.227.239)&#39; can&#39;t be established.RSA key fingerprint is 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48.Are you sure you want to continue connecting (yes/no)?</code></pre><p>&emsp;&emsp;选择 <code>yes</code></p><pre><code>Hi jiesheng88! You&#39;ve successfully authenticated, but GitHub does not provide shell access.</code></pre><p>​        <img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210312160747.png" alt=""></p><p>&emsp;&emsp;如果看到<code>Hi</code>后面是你的用户名，就说明成功了。</p><h3 id="2-3-Hexo安装"><a href="#2-3-Hexo安装" class="headerlink" title="2.3 Hexo安装"></a>2.3 Hexo安装</h3><p>&emsp;&emsp;Hexo 是一个快速、简洁且高效的博客框架。Hexo 使用 Markdown（或其他渲染引擎）解析文章，在几秒内，即可利用靓丽的主题生成静态网页。</p><p>&emsp;&emsp;在使用npm之前可以更改配置，使用国内的镜像加速下载。</p><pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> config <span class="token keyword">set</span> registry https://registry.npm.taobao.org<span class="token function">npm</span> config <span class="token keyword">set</span> loglevel http<span class="token function">npm</span> config <span class="token keyword">set</span> progress <span class="token boolean">false</span></code></pre><p>&emsp;&emsp;<strong>每输入一行，回车，没有任何提示，说明操作成功</strong></p><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210312171558.png" alt=""></p><p>&emsp;&emsp;<strong>npm的配置被存储在 ~/.npmrc，可以随时改</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">vi</span> ~/.npmrc</code></pre><p><img src="https://gitee.com/jiesheng8888/imgs/raw/master/PicGoImgs/20210312171914.png" alt=""></p><p>&emsp;&emsp;使用 Git Bash 输入：</p><pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g hexo-cli</code></pre><p>&emsp;&emsp;安装完毕之后，确保环境变量配置好，能正常使用 <code>hexo</code> 命令。</p><h2 id="三、通过hexo搭建博客"><a href="#三、通过hexo搭建博客" class="headerlink" title="三、通过hexo搭建博客"></a>三、通过hexo搭建博客</h2><h3 id="3-1初始化博客"><a href="#3-1初始化博客" class="headerlink" title="3.1初始化博客"></a>3.1初始化博客</h3><p>&emsp;&emsp;在你想创建博客的文件夹下（我是想把博客放在D:\Program Files文件夹下），点击鼠标右键，选择Git Bash Here，即可进入Git Bash 。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410155030466.png" style="zoom:67%;" /><p>&emsp;&emsp;使用 Git Bash 输入，其中myBlog是你要保存的博客文件夹的名称：</p><pre><code>hexo init myBlog</code></pre><p>​    <img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410155608097.png" style="zoom: 80%;" /></p><p>&emsp;&emsp;接下来，进入文件夹 <code>myBlog</code>,然后调用 Hexo 的 generate 命令，将 Hexo 编译生成 HTML 代码，命令如下：</p><pre><code>hexo generate</code></pre><p>&emsp;&emsp;可以看到输出结果里面包含了 js、css、font 等内容，并发现他们都处在了项目根目录下的 public 文件夹下面了。</p><p>&emsp;&emsp;然后我们利用 Hexo 提供的 serve 命令把博客在本地运行起来，命令如下：</p><pre><code>hexo serve</code></pre><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410155704384.png" style="zoom:80%;" /><p>&emsp;&emsp;然后，打开浏览器输入地址：</p><pre><code>localhost:4000</code></pre><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410160053650.png" style="zoom: 80%;" /><p>&emsp;&emsp;执行到这里事实上博客就已经搭建好了，接下来就是去完善它。</p><p><strong>&emsp;！！！注意：下面的命令都是在 <code>myBlog</code>文件里进行操作的。</strong></p><h3 id="3-2-部署"><a href="#3-2-部署" class="headerlink" title="3.2 部署"></a>3.2 部署</h3><p>&emsp;&emsp;接下来我们来将这个初始化的博客进行一下部署，放到 GitHub Pages 上面验证一下其可用性。成功之后我们可以再进行后续的修改，比如修改主题、修改页面配置等等。</p><p>&emsp;&emsp;那么怎么把这个页面部署到 GitHub Pages 上面呢，其实 Hexo 已经给我们提供一个命令，利用它我们可以直接将博客一键部署，不需要手动去配置服务器或进行其他的各项配置。</p><p>&emsp;&emsp;在部署之前，我们需要先知道博客的部署地址，它需要对应 GitHub 的一个 Repository 的地址，这个信息需要我们来配置一下。</p><p>&emsp;&emsp;打开myBlog文件夹下的 _config.yml 文件，找到 Deployment 这个地方：</p><pre><code># Deployment## Docs: https://hexo.io/docs/deployment.htmldeploy:  type:</code></pre><p>&emsp;&emsp;把刚才新建的 Repository 的地址贴过来，然后指定分支为 master 分支，最终修改为如下内容：</p><pre><code># Deployment## Docs: https://hexo.io/docs/deployment.htmldeploy:  type: git  repo: git@github.com:/{user}/{repository}.git  branch: master</code></pre><p>&emsp;&emsp;<strong>请注意，这里的仓库地址如果写成：<code>https://github.com/{user}/{repository}.git</code>可能会在后边的部署时无法成功，需要将<code>https://github.com</code>改成<code>git@github.com:</code>。</strong></p><p>&emsp;&emsp;我的就修改为如下内容：</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410162701389.png" style="zoom:80%;" /><p>&emsp;&emsp;另外我们还需要额外安装一个支持 Git 的部署插件，名字叫做 hexo-deployer-git，有了它我们才可以顺利将其部署到 GitHub 上面，如果不安装的话，在执行部署命令时会报错。</p><p>&emsp;&emsp;安装这个插件，在myBlog文件夹下执行安装命令如下：</p><pre><code>npm install hexo-deployer-git --save</code></pre><p>&emsp;&emsp;安装成功之后，执行部署命令：</p><pre><code>hexo deploy</code></pre><p>&emsp;&emsp;运行结果类似如下：</p><pre><code>INFO  Deploying: gitINFO  Clearing .deploy_git folder...INFO  Copying files from public folder...INFO  Copying files from extend dirs...On branch masternothing to commit, working directory cleanCounting objects: 46, done.Delta compression using up to 8 threads.Compressing objects: 100% (36/36), done.Writing objects: 100% (46/46), 507.66 KiB | 0 bytes/s, done.Total 46 (delta 3), reused 0 (delta 0)remote: Resolving deltas: 100% (3/3), done.To git@github.com:NightTeam/nightteam.github.io.git * [new branch]      HEAD -&gt; masterBranch master set up to track remote branch master from git@github.com:NightTeam/nightteam.github.io.git.INFO  Deploy done: git</code></pre><p>&emsp;&emsp;如果出现类似上面的内容，就证明我们的博客已经成功部署到 GitHub Pages 上面了。</p><p>&emsp;&emsp;通过如下图所示的Settings 进入该仓库的设置页面，找到 Github Pages 这一项，选择以 Master 分支作为 source，然后保存；接下来这个仓库就会被部署到 https://{username}.github.io/{仓库名}。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410163524556.png" style="zoom:80%;" /><p>&emsp;&emsp;如果你希望直接通过 https://{username}.github.io/ 来访问你的博客，可以将仓库名改为 {username}.github.io；这样就不需要在url后边添加上仓库名来访问了。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410163835119.png" style="zoom:80%;" /><p>&emsp;&emsp;比如，我GitHub的usename是jiesheng88，Repository 名称取的是 jiesheng88.github.io，那我就访问 <a href="http://jiesheng88.github.io，" target="_blank" rel="noopener">http://jiesheng88.github.io，</a></p><p>&emsp;&emsp;这时候就可以看到跟本地一模一样的博客内容了（下面是加了主题的）。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410164144550.png" style="zoom:80%;" /><p>&emsp;&emsp;GitHub 的 master 分支实际上是博客文件夹下面的 public 文件夹下的所有内容，Hexo 把编译之后的静态页面内容上传到 GitHub 的 master 分支上面去了。</p><p>&emsp;&emsp;如果我博客的源码也想放到 GitHub 上面怎么办呢？其实很简单，新建一个其他的分支就好了，比如我这边就新建了一个 source 分支，代表博客源码的意思。</p><p>&emsp;&emsp;具体的添加过程就很简单了，在Git Bash里逐条添加如下命令：</p><pre><code>git initgit checkout -b sourcegit add -Agit commit -m &quot;init blog&quot;git remote add origin git@github.com:{username}/{username}.github.io.gitgit push origin source</code></pre><p>&emsp;&emsp;成功之后，可以到 GitHub 上再切换下默认分支，比如我就把默认的分支设置为了 source，当然不换也可以。</p><h3 id="3-3-更换Hexo博客主题"><a href="#3-3-更换Hexo博客主题" class="headerlink" title="3.3 更换Hexo博客主题"></a>3.3 更换Hexo博客主题</h3><p>&emsp;&emsp;hexo 默认的主题可能显得有点呆板，你可以在 <a href="https://hexo.io/themes/index.html" target="_blank" rel="noopener">https://hexo.io/themes/index.html</a>&emsp;&emsp;</p><p>&emsp;&emsp;进行主题的挑选更换。将下好的主题安放在<code>themes</code>文件夹内，同时在<code>_config.yml</code>中进行主题修改就好了。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410165053440.png" style="zoom:80%;" /><p>&emsp;&emsp;我选择了<code>hexo-theme-matery</code> 这款主题。具体配置过程，看下面文档说明。</p><p>&emsp;&emsp;Hexo博客主题之hexo-theme-matery的介绍：<a href="https://blinkfox.github.io/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao/#toc-heading-24" target="_blank" rel="noopener">https://blinkfox.github.io/2018/09/28/qian-duan/hexo-bo-ke-zhu-ti-zhi-hexo-theme-matery-de-jie-shao/#toc-heading-24</a></p><p>&emsp;&emsp;一般大佬们提供的主题都会提供文档说明，按照说明进行简单的设置就能拥有一个酷炫的页面了。</p><h3 id="3-4-添加文章"><a href="#3-4-添加文章" class="headerlink" title="3.4 添加文章"></a>3.4 添加文章</h3><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410160327894.png" style="zoom:80%;" /><h4 id="3-4-1-直接导入文章"><a href="#3-4-1-直接导入文章" class="headerlink" title="3.4.1 直接导入文章"></a>3.4.1 直接导入文章</h4><p>&emsp;&emsp;你可以将你平时写的文章直接导入到 <code>_posts</code> 文件夹里，注意文章类型得是 <code>md</code>格式。</p><p>&emsp;&emsp;<strong>！！在文章开头通过如下格式添加必要信息：</strong></p><pre><code>---title: 标题 # 自动创建，如 hello-worlddate: 日期 # 自动创建，如 2019-09-22 01:47:21tags: - 标签1- 标签2- 标签3categories:- 分类1- 分类2---</code></pre><h4 id="3-4-2-写新文章"><a href="#3-4-2-写新文章" class="headerlink" title="3.4.2 写新文章"></a>3.4.2 写新文章</h4><p>&emsp;&emsp;你可以执行下列命令来创建一篇新文章。</p><pre><code>hexo new [layout] &lt;title&gt;</code></pre><p>&emsp;&emsp;你可以在命令中指定文章的布局（layout），默认为 <code>post</code>，可以通过修改 <code>_config.yml</code> 中的 <code>default_layout</code> 参数来指定默认布局。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410160641123.png" style="zoom:80%;" /><p>&emsp;&emsp;这样在 <code>_posts</code> 文件夹里也生成了一篇新的文章。</p><img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410160701789.png" style="zoom:80%;" /><h4 id="3-4-3-Markdown-写作"><a href="#3-4-3-Markdown-写作" class="headerlink" title="3.4.3 Markdown 写作"></a>3.4.3 Markdown 写作</h4><p>&emsp;&emsp;Markdown是一种可以使用普通文本编辑器编写的标记语言，通过简单的标记语法，它可以使普通文本内容具有一定的格式。</p><p>&emsp;&emsp;这里推荐 Typora 这款 Markdown 写作软件。Typora 是一款免费的 MD 编辑器，它是优雅简洁与强大开放的完美结合体。官网直达 <a href="https://typora.io" target="_blank" rel="noopener">https://typora.io</a></p><h4 id="3-4-4-Typora-插入图片"><a href="#3-4-4-Typora-插入图片" class="headerlink" title="3.4.4 Typora 插入图片"></a>3.4.4 Typora 插入图片</h4><p>&emsp;&emsp;事先声明，所有博客文件均保存在 <code>/source/_posts</code>文件夹下</p><p>&emsp;&emsp;首先在 <code>source</code>目录下建一个文件夹叫images，用来保存博客中的图片</p><p>&emsp;&emsp;然后打开Typora的 <code>文件 &gt; 偏好设置</code>，进行如下设置。</p><p>​    <img src="/images/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/image-20200410213829004.png" alt="设置根目录"></p><p>&emsp;&emsp;这样的话所有的博客中的图片都将会保存到 <code>/source/images/该博客md文件名/图片名称</code></p><p>&emsp;&emsp;但是仅仅这样设置还不够，这样设置在typora中倒是能看图片了，但是使用的却是相对于当前md文件的相对路径，可是如果启动hexo，是要用服务器访问的，而服务器显然无法根据这个相对路径正确访问到图片，因此还需要在typora中进行进一步设置。</p><p>&emsp;&emsp;在typora菜单栏点击 <code>格式-&gt;图像-&gt;设置图片根目录</code>，将<code>myBlog/source</code>作为其根目录即可。</p><p>&emsp;&emsp;<strong>一定要先设置了图片根目录后再插入图片，否则图片路径会不正确喔！</strong></p><p>&emsp;&emsp;<strong>也可以使用Gitee+PicGo实现免费图床，这样就可以不用在本地存储图片，可以参考以下博客：</strong></p><p>&emsp;&emsp;1、PicGo + Gitee(码云)实现markdown图床：<a href="https://zhuanlan.zhihu.com/p/102594554" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/102594554</a></p><p>&emsp;&emsp;2、Typora+PicGo图床配置以及PicGo上传失败的解决办法：<a href="https://blog.csdn.net/weixin_42875245/article/details/108554926" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42875245/article/details/108554926</a></p><h2 id="四、部署脚本"><a href="#四、部署脚本" class="headerlink" title="四、部署脚本"></a>四、部署脚本</h2><p>&emsp;&emsp;最后我这边还增加了一个简易版的部署脚本，其实就是重新 gererate 下文件，然后重新部署。在根目录下新建一个 deploy.sh 的脚本文件，内容如下：</p><pre><code>hexo cleanhexo generatehexo deploy</code></pre><p>&emsp;&emsp;这样我们在部署发布的时候只需要执行：</p><pre><code>sh deploy.sh</code></pre><p>&emsp;&emsp;就可以完成博客的更新了，非常简单。</p>]]></content>
      
      
      <categories>
          
          <category> 博客 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 博客搭建 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
